# Exam

- [Exam](#exam)
  - [Pentest Summary](#pentest-summary)
  - [Security Enhancement Suggestions](#security-enhancement-suggestions)
    - [Secure Public Facing Web Applciation](#secure-public-facing-web-applciation)
    - [Follow least-privilege principle](#follow-least-privilege-principle)
    - [Avoid storing cleartext credential](#avoid-storing-cleartext-credential)
    - [Fine-grained IAM management](#fine-grained-iam-management)
  - [Preparations](#preparations)
  - [Initial Access - Inventory Web Application - Abuse Unrestricted File Upload](#initial-access---inventory-web-application---abuse-unrestricted-file-upload)
  - [Credential Access - Abuse Inventory App vulnerability to obtain Managed Identity tokens](#credential-access---abuse-inventory-app-vulnerability-to-obtain-managed-identity-tokens)
  - [Lateral Movement - Access credential in Key Vault](#lateral-movement---access-credential-in-key-vault)
  - [Privilege Escalation - Access Automation Account and Stored Credentials](#privilege-escalation---access-automation-account-and-stored-credentials)
  - [Privilege Escalation - Get cleartext secret in blob epbackup-space as User3769563720055157779](#privilege-escalation---get-cleartext-secret-in-blob-epbackup-space-as-user3769563720055157779)
  - [Privilege Escalation - Get cleartext secret in blob epbackup-space as Helper App's Managed Identity](#privilege-escalation---get-cleartext-secret-in-blob-epbackup-space-as-helper-apps-managed-identity)
  - [Actions on Objectives - Access final flag in the Key Vault as the Managed Identity of UserApp](#actions-on-objectives---access-final-flag-in-the-key-vault-as-the-managed-identity-of-userapp)
  - [Tools](#tools)
  - [References](#references)
    - [simple-webshell.phtml](#simple-webshellphtml)
    - [get-token.phtml](#get-tokenphtml)
    - [get-keyvault-token.phtml](#get-keyvault-tokenphtml)

---

## Pentest Summary

The following table shows the accessed resources in the pentest.

<br/>

| **Tenant ID** | **Az Resource** | **Name** | **Method to exploit** |
| --- | --- | --- | --- |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Inventory Webapp | Exploited the unrestricted upload function |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Managed Identity | Inventory webapp service prinicipal | Exploit the upload function and use PHP `system` command to get the managed identity access and ARM tokens |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Key Vault | inventorycreds-19782062 | Access using the Inventory webapp Managed Identity  |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure AD User | User6673757339746967328@defcorpspace.onmicrosoft.com | Use the Inventory webapp's managed identity to access the Key Vault and get the credential of this user |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Automation Account | backupautomation-1978206228366054214 | User6673757339746967328@defcorpspace.onmicrosoft.com is able to edit the runbook in the Automation Account backupautomation-1978206228366054214. |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure AD User | User3769563720055157779@defcorpspace.onmicrosoft.com | Use the automation runbook to get the saved credential "credential" in the Automation Account |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Storage Account | epbackup1978206228 | Use the credential of User3769563720055157779@defcorpspace.onmicrosoft.com to access |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Blob | epbackup-space | Use the credential of User3769563720055157779@defcorpspace.onmicrosoft.com to access via Azure Storage Explorer |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Managed Identity | 16b6a33e-0d2b-456d-96fb-cbfce4c6000c | Obtained the managed identity secret in manifest.txt found in the blob container epbackup-space |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Blob | epbackup-planetary | Use the managed identity credential 16b6a33e-0d2b-456d-96fb-cbfce4c6000c |
| 4e7a1151-36d0-457e-b489-729cf0fb315a | Managed Identity | f2381716-b286-4605-a2f7-1234f8019631 | Obtained the managed identity secret in manifest.txt found in the blob container epbackup-planetary |
| 4e7a1151-36d0-457e-b489-729cf0fb315a | Key Vault | planetary-43556228109789 | Use the managed identity f2381716-b286-4605-a2f7-1234f8019631 to access the Key Vault and get the final flag in the value of the vault object finalflag-fprime |


<br/>

---