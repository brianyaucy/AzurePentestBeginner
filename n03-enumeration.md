# 03 - Enumerations

- [03 - Enumerations](#03---enumerations)
  - [Azure Portal](#azure-portal)
  - [Default user permissions](#default-user-permissions)
  - [AzureAD Module](#azuread-module)
  - [AzureAD Module - Users](#azuread-module---users)
  - [AzureAD Module - Groups](#azuread-module---groups)
  - [AzureAD Module - Roles](#azuread-module---roles)
  - [AzureAD Module - Devices](#azuread-module---devices)
  - [AzureAD Module - Apps](#azuread-module---apps)
  - [AzureAD Module - Service Principals](#azuread-module---service-principals)

---

## Azure Portal

The Azure Portal (https://portal.azure.com/) is a web console that can be used to manage Azure account and its resources.

It is a GUI alternative to tools like PowerShell modules and Azure cli.

<br/>

---

## Default user permissions

A normal user has many interesting permissions in Azure AD!

- Read all users, Groups, Applications, Devices, Roles, Subscriptions, and their public properties
- Invite Guests
- Create Security groups
- Read non-hidden Group memberships
- Add guests to Owned groups
- Create new application
- Add up to 50 devices to Azure

<br/>

---

## AzureAD Module

AzureAD is a PowerShell module from Microsoft for managing Azure AD. It does not show all the properties of Azure AD objects and the documentation is not good. Still useful to some extent!

It can be used only to interact with Azure AD, no access to Azure resources. 

Please note that if the module is not present on your machine, you can use `Install-Module AzureAD` command (needs internet). Alternatively, Download it from PowerShell Gallery, rename the `.nukpkg` to `.zip` and extract it:

- https://www.powershellgallery.com/packages/AzureAD

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
```

<br/>

To be able to use PowerShell module, we must connect to Azure AD first:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force

$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)

Connect-AzureAD -Credential $creds
```

![picture 28](images/ec47975fac9875b852bd20a6d7b3f3e237b4dcacf0b6c41587ea3efac3a3ef90.png)  

<br/>

To get the current session state:

```
Get-AzureADCurrentSessionInfo
```

![picture 30](images/c137cdd61725d59ce4fc12af7d6d7b12fd942e633a04bb7020c355046f123051.png)  

<br/.>

To get details of the current tenant:

```
Get-AzureADTenantDetail
```

![picture 31](images/0a8c55e38dbdac6cb19c1875073b05bd89bdd7bcbb3374bd6bc8d9012dd5a06d.png)  


<br/>

---

## AzureAD Module - Users

To enumerate all users:

```
Get-AzureADUser -All $true

Get-AzureADUser -All $true | Export-Csv -Path C:\Users\studentuser190\Desktop\users.csv
```

![picture 29](images/655ee7f97c952ed4f295d3d73bb69977283eee976a62a0b93c3a58d62bfe0fd4.png)  


<br/>

Enumerate a specific user:

```
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com

Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | Select *
```

![picture 32](images/47cf219f0c9c42f002ef3ff57b744e816a57368bf33c97d408abcaa9362ff399.png)  

![picture 33](images/14971db2de3621f66047cfcdab2213ebb060f2eb978244935feda83d39f93656.png)  

<br/>

Search for a user based on string in first characters of `DisplayName` or `userPrincipalName` (**wildcard not supported**):

```
Get-AzureADUser -SearchString "admin"
```

![picture 34](images/578157563172c17ea0fb10149a1c3fa80b08c20409d5744aa74eb2fcb464472d.png)  

<br/>

Search for users who contain the word "admin" in their Display name:

```
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}
```

![picture 35](images/aae92327552c3bf63cc9c99b74fe31f81671399c581a9c35e9524772a48bd108.png)  

<br/>

List all the attributes for a user:

```
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | fl *

Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | %{$_.PSObject.Properties.Name}
```

![picture 36](images/0fabd8bf9be8985ced4a78d9a3d4aa4d9a9fe8b70bf540b8078e42b592d86c5d.png)  

![picture 37](images/9f5e3fa344f83eba0961b14fd7016e009b460503f670286f1b1989b001461cb0.png)  

<br/>

Search attributes for all users that contain the string "password":

```
Get-AzureADUser |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) -$_ -$($Properties.$_)"}}}
```

<br/>

All users who are synced from on-prem

```
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

<br/>

All users who are from Azure AD

```
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

![picture 38](images/1a2ca252959be0fc695366fda7c9b1372f04c6c9739e6e080b1a3d7972d2ba18.png)  


<br/>

Objects created by any user (use `-ObjectId` for a specific user).
(This take some time to run.)

```
Get-AzureADUser | Get-AzureADUserCreatedObject
```

![picture 39](images/0cdece74662eb9a413e133db36908fdf6acf05131cd8e9a3a631d42d6a07c30e.png)  

<br/>

Objects owned by a specific user:

```
Get-AzureADUserOwnedObject -ObjectId test@defcorphq.onmicrosoft.com
```

![picture 40](images/941bb22c95c4005826963bb7cc0ff1671c14f699ed2182be2c56b4346002a52b.png)  

<br/>

---

## AzureAD Module - Groups

List all Groups:

```
Get-AzureADGroup -All $true
```

![picture 41](images/e7aa6e0933c3196cc7b152b3e20e567cd5467e48925a473e3fba06ed185215e7.png)  

<br/>

Enumerate a specific group:

```
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

![picture 42](images/c9efee06d89b4dc3c90ae670dcfe7bb1dc23262d2442191c5b2770f6e55c4f36.png)  

<br/>

Search for a group based on string in first characters of DisplayName (wildcard not supported):

```
Get-AzureADGroup -SearchString "admin" | fl *
```

<br/>

To search for groups which contain the word "admin" in their name:

```
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}
```

![picture 43](images/4d7a461fd6d9c471ca9e10bf1d1e886eb2aeeee30514aa60bdd4c970f1384413.png)  

<br/>

Get Groups that allow Dynamic membership (Note the cmdlet name - it is NOT `Get-AzureADGroup`):

```
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
```

<br/>

All groups that are synced from on-prem (note that security groups are not synced):

```
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

<br/>

All groups that are from Azure AD:

```
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

![picture 44](images/56951c771923d0f6167b479f52227c464723a509d376610b3803a7cd54d364de.png)  

<br/>

Get members of a group:

```
Get-AzureADGroupMember -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

![picture 45](images/24bc93973eb4dd8e7f60f04a14135099dd33f818d1aca403174fc7b1ec898349.png)  

<br/>

Get groups and roles where the specified user is a member:

```
Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership

Get-AzureADUserMembership -ObjectId test@defcorphq.onmicrosoft.com
```

![picture 46](images/a18cf6eb409725a2edb360d58669e8b540f2f743abf64c687ff6b3385214fa09.png)  

![picture 47](images/cf13e733dfa1249840f6fb4c3a0a8e8911c08b099a51ecfe0621c26f970f6ab3.png)  

<br/>

---

## AzureAD Module - Roles

Get all available role templates:

```
Get-AzureADDirectoryroleTemplate
```

![picture 48](images/7c5272d874b146b9bccd38d627dcd7ce1a8baf57b79b74748cea6560ca3702a7.png)  


<br/>

Get all roles:

```
Get-AzureADDirectoryRole
```

![picture 49](images/d9f60640f94b8291b3399b40f87a8bf88cad1f211f59b46e2e2633af2476cbaa.png)  

<br/>

Enumerate users to whom roles are assigned:

```
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

![picture 50](images/b4142cf3f14b9360ddf7f2ce58346ef9a18e8bcf1eb9d75e161cda61ad829c9a.png)  

<br/>

To list custom roles, **AzureADPreview** module can be used:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds

Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
```

![picture 73](images/bd4bb09b95d157de1b02012b372d31c8ffec937e8cec387b495c2d2988d4303a.png)  


<br/>

---

## AzureAD Module - Devices

Get all Azure joined and registered devices:

```
Get-AzureADDevice -All $true | fl *
```

![picture 51](images/1d0fe43d7be2e831dc86fe7d1a537237d020a442e909b664ac92b9dfba691b06.png)  

<br/>

Get the device configuration object (note the RegistrationQuota in the output):

```
Get-AzureADDeviceConfiguration | fl *
```

![picture 52](images/354f8d941f298464a580bc9ccd4a266e86162e76bc5f4dacf0cdac2522e43fdb.png)  

<br/>

List Registered owners of all the devices:

```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
```

![picture 53](images/4670df9389ab4c7aa6a40346b3b0b1cde0004e6e5a6dd7c6625cee32cb58f920.png)  

<br/>

List Registered users of all the devices:

```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
```

![picture 54](images/ea1c5b313f9befbd5c0af071bc3f1b643da294eeec6b0b9928e49b01957c6e42.png)  

<br/>

List devices owned by a user:

```
Get-AzureADUserOwnedDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```

![picture 55](images/745ef2796cea61a8eca5e38620df6c45e0ed71b5f05e2a52db67c551f1751f0d.png)  

<br/>

List devices registered by a user:

```
Get-AzureADUserRegisteredDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```

![picture 56](images/bf1cb48aee385aaeae231ad7033e9f5520d2a8a58427a84026f11de41af8c1c3.png)  

<br/>

List devices managed using Intune:

```
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
```

![picture 57](images/f7649ffe38f2a3a28313c527bc751b371be96cc5f75583c2a1362abbe359141f.png)  

<br/>

---

## AzureAD Module - Apps

Get all the application objects registered with the current tenant (visible in App Registrations in Azure portal). An application object is the global representation of an app.

```
Get-AzureADApplication -All $true
```

![picture 58](images/c40ed18bbc333313ccbcef93bb20d0d8fc9c81cf82a7175fc5f78b3256d4d4ad.png)  


<br/>

Get all details about an application:

```
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | fl *
```

![picture 59](images/1f6812b342f1d7513aaf163879287450749375d473a6e44a2fd7d2522fcf68dd.png)  


<br/>

Get an application based on the display name:

```
Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}
```

![picture 60](images/387ffde194c3ea8570cf1f77c98a63492276af7b9da60a76eedf1dfd1cb986e2.png)  

Note:
The `Get-AzureADApplicationPasswordCredential` will show the applications with an application password but password value is not shown.

<br/>

Get owner of an application:

```
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | Get-AzureADApplicationOwner | fl *
```

![picture 61](images/2004290aba10c7979310eb0ff361073cf8580528c1ab0cfa278f5e6a914f2ee5.png)  

<br/>

Get Apps where a User has a role (exact role is not shown):

```
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
```

![picture 62](images/41ebe868a18b315757caf1a7c27019ee5ef78c4061fc90d74a52d3938e790a49.png)  

<br/>

Get Apps where a Group has a role (exact role is not shown):

```
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e | Get-AzureADGroupAppRoleAssignment | fl *
```

<br/>

---

## AzureAD Module - Service Principals

Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is the security object that has privileges. This is the 'service account'!

<br/>

Service Principals can be assigned Azure roles.

<br/>

Get all service principals:

```
Get-AzureADServicePrincipal -All $true
```

![picture 63](images/d1bf512eb1f91aadc35bc1cbc4c2c19e1e4ea8399e11dbae5ec1305f33ae26c9.png)  

<br/>

Get all details about a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | fl *
```

![picture 64](images/0a70087774f8c6dec8a47d72abe1ca5ad08f0076102752d4629761cdf830cb0b.png)  

<br/>

Get an service principal based on the display name:

```
Get-AzureADServicePrincipal -All $true | ?{ $_.DisplayName -match "app" }
```

![picture 65](images/37b0ce975dc6aa6d2f085acfe120fb3bac9e0d8858e02fa4df8f450ede131789.png)  

<br/>

Get owner of a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwner | fl *
```

<br/>

Get objects owned by a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwnedObject
```

<br/>

Get objects created by a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalCreatedObject
```

<br/>

Get group and role memberships of a service principal

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalMembership | fl *
```

```
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
```

![picture 66](images/ca65af1adcc657b328c89ce5728fe6f4dc6c9b98ef4dfba98442e861005bbce0.png)  

<br/>

