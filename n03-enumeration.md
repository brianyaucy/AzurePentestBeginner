# 03 - Enumerations

- [03 - Enumerations](#03---enumerations)
  - [Azure Portal](#azure-portal)
  - [Default user permissions](#default-user-permissions)
  - [AzureAD Module](#azuread-module)
  - [AzureAD Module - Users](#azuread-module---users)
  - [AzureAD Module - Groups](#azuread-module---groups)
  - [AzureAD Module - Roles](#azuread-module---roles)
  - [AzureAD Module - Devices](#azuread-module---devices)
  - [AzureAD Module - Apps](#azuread-module---apps)
  - [AzureAD Module - Service Principals](#azuread-module---service-principals)
  - [Az PowerShell](#az-powershell)
  - [Az Powershell - AAD Users](#az-powershell---aad-users)
  - [Az PowerShell - AAD Groups](#az-powershell---aad-groups)
  - [Az PowerShell - AAD Apps](#az-powershell---aad-apps)
  - [Az PowerShell - ADD Service Principals](#az-powershell---add-service-principals)

---

## Azure Portal

The Azure Portal (https://portal.azure.com/) is a web console that can be used to manage Azure account and its resources.

It is a GUI alternative to tools like PowerShell modules and Azure cli.

<br/>

---

## Default user permissions

A normal user has many interesting permissions in Azure AD!

- Read all users, Groups, Applications, Devices, Roles, Subscriptions, and their public properties
- Invite Guests
- Create Security groups
- Read non-hidden Group memberships
- Add guests to Owned groups
- Create new application
- Add up to 50 devices to Azure

<br/>

---

## AzureAD Module

AzureAD is a PowerShell module from Microsoft for managing Azure AD. It does not show all the properties of Azure AD objects and the documentation is not good. Still useful to some extent!

It can be used only to interact with Azure AD, no access to Azure resources. 

Please note that if the module is not present on your machine, you can use `Install-Module AzureAD` command (needs internet). Alternatively, Download it from PowerShell Gallery, rename the `.nukpkg` to `.zip` and extract it:

- https://www.powershellgallery.com/packages/AzureAD

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
```

<br/>

To be able to use PowerShell module, we must connect to Azure AD first:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force

$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)

Connect-AzureAD -Credential $creds
```

![picture 28](images/ec47975fac9875b852bd20a6d7b3f3e237b4dcacf0b6c41587ea3efac3a3ef90.png)  

<br/>

To get the current session state:

```
Get-AzureADCurrentSessionInfo
```

![picture 30](images/c137cdd61725d59ce4fc12af7d6d7b12fd942e633a04bb7020c355046f123051.png)  

<br/.>

To get details of the current tenant:

```
Get-AzureADTenantDetail
```

![picture 31](images/0a8c55e38dbdac6cb19c1875073b05bd89bdd7bcbb3374bd6bc8d9012dd5a06d.png)  


<br/>

---

## AzureAD Module - Users

To enumerate all users:

```
Get-AzureADUser -All $true

Get-AzureADUser -All $true | Export-Csv -Path C:\Users\studentuser190\Desktop\users.csv
```

![picture 29](images/655ee7f97c952ed4f295d3d73bb69977283eee976a62a0b93c3a58d62bfe0fd4.png)  


<br/>

Enumerate a specific user:

```
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com

Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | Select *
```

![picture 32](images/47cf219f0c9c42f002ef3ff57b744e816a57368bf33c97d408abcaa9362ff399.png)  

![picture 33](images/14971db2de3621f66047cfcdab2213ebb060f2eb978244935feda83d39f93656.png)  

<br/>

Search for a user based on string in first characters of `DisplayName` or `userPrincipalName` (**wildcard not supported**):

```
Get-AzureADUser -SearchString "admin"
```

![picture 34](images/578157563172c17ea0fb10149a1c3fa80b08c20409d5744aa74eb2fcb464472d.png)  

<br/>

Search for users who contain the word "admin" in their Display name:

```
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}
```

![picture 35](images/aae92327552c3bf63cc9c99b74fe31f81671399c581a9c35e9524772a48bd108.png)  

<br/>

List all the attributes for a user:

```
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | fl *

Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | %{$_.PSObject.Properties.Name}
```

![picture 36](images/0fabd8bf9be8985ced4a78d9a3d4aa4d9a9fe8b70bf540b8078e42b592d86c5d.png)  

![picture 37](images/9f5e3fa344f83eba0961b14fd7016e009b460503f670286f1b1989b001461cb0.png)  

<br/>

Search attributes for all users that contain the string "password":

```
Get-AzureADUser |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) -$_ -$($Properties.$_)"}}}
```

<br/>

All users who are synced from on-prem

```
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

<br/>

All users who are from Azure AD

```
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

![picture 38](images/1a2ca252959be0fc695366fda7c9b1372f04c6c9739e6e080b1a3d7972d2ba18.png)  


<br/>

Objects created by any user (use `-ObjectId` for a specific user).
(This take some time to run.)

```
Get-AzureADUser | Get-AzureADUserCreatedObject
```

![picture 39](images/0cdece74662eb9a413e133db36908fdf6acf05131cd8e9a3a631d42d6a07c30e.png)  

<br/>

Objects owned by a specific user:

```
Get-AzureADUserOwnedObject -ObjectId test@defcorphq.onmicrosoft.com
```

![picture 40](images/941bb22c95c4005826963bb7cc0ff1671c14f699ed2182be2c56b4346002a52b.png)  

<br/>

---

## AzureAD Module - Groups

List all Groups:

```
Get-AzureADGroup -All $true
```

![picture 41](images/e7aa6e0933c3196cc7b152b3e20e567cd5467e48925a473e3fba06ed185215e7.png)  

<br/>

Enumerate a specific group:

```
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

![picture 42](images/c9efee06d89b4dc3c90ae670dcfe7bb1dc23262d2442191c5b2770f6e55c4f36.png)  

<br/>

Search for a group based on string in first characters of DisplayName (wildcard not supported):

```
Get-AzureADGroup -SearchString "admin" | fl *
```

<br/>

To search for groups which contain the word "admin" in their name:

```
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}
```

![picture 43](images/4d7a461fd6d9c471ca9e10bf1d1e886eb2aeeee30514aa60bdd4c970f1384413.png)  

<br/>

Get Groups that allow Dynamic membership (Note the cmdlet name - it is NOT `Get-AzureADGroup`):

```
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
```

<br/>

All groups that are synced from on-prem (note that security groups are not synced):

```
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

<br/>

All groups that are from Azure AD:

```
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

![picture 44](images/56951c771923d0f6167b479f52227c464723a509d376610b3803a7cd54d364de.png)  

<br/>

Get members of a group:

```
Get-AzureADGroupMember -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

![picture 45](images/24bc93973eb4dd8e7f60f04a14135099dd33f818d1aca403174fc7b1ec898349.png)  

<br/>

Get groups and roles where the specified user is a member:

```
Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership

Get-AzureADUserMembership -ObjectId test@defcorphq.onmicrosoft.com
```

![picture 46](images/a18cf6eb409725a2edb360d58669e8b540f2f743abf64c687ff6b3385214fa09.png)  

![picture 47](images/cf13e733dfa1249840f6fb4c3a0a8e8911c08b099a51ecfe0621c26f970f6ab3.png)  

<br/>

---

## AzureAD Module - Roles

Get all available role templates:

```
Get-AzureADDirectoryroleTemplate
```

![picture 48](images/7c5272d874b146b9bccd38d627dcd7ce1a8baf57b79b74748cea6560ca3702a7.png)  


<br/>

Get all roles:

```
Get-AzureADDirectoryRole
```

![picture 49](images/d9f60640f94b8291b3399b40f87a8bf88cad1f211f59b46e2e2633af2476cbaa.png)  

<br/>

Enumerate users to whom roles are assigned:

```
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

![picture 50](images/b4142cf3f14b9360ddf7f2ce58346ef9a18e8bcf1eb9d75e161cda61ad829c9a.png)  

<br/>

To list custom roles, **AzureADPreview** module can be used:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds

Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
```

![picture 73](images/bd4bb09b95d157de1b02012b372d31c8ffec937e8cec387b495c2d2988d4303a.png)  


<br/>

---

## AzureAD Module - Devices

Get all Azure joined and registered devices:

```
Get-AzureADDevice -All $true | fl *
```

![picture 51](images/1d0fe43d7be2e831dc86fe7d1a537237d020a442e909b664ac92b9dfba691b06.png)  

<br/>

Get the device configuration object (note the RegistrationQuota in the output):

```
Get-AzureADDeviceConfiguration | fl *
```

![picture 52](images/354f8d941f298464a580bc9ccd4a266e86162e76bc5f4dacf0cdac2522e43fdb.png)  

<br/>

List Registered owners of all the devices:

```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
```

![picture 53](images/4670df9389ab4c7aa6a40346b3b0b1cde0004e6e5a6dd7c6625cee32cb58f920.png)  

<br/>

List Registered users of all the devices:

```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
```

![picture 54](images/ea1c5b313f9befbd5c0af071bc3f1b643da294eeec6b0b9928e49b01957c6e42.png)  

<br/>

List devices owned by a user:

```
Get-AzureADUserOwnedDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```

![picture 55](images/745ef2796cea61a8eca5e38620df6c45e0ed71b5f05e2a52db67c551f1751f0d.png)  

<br/>

List devices registered by a user:

```
Get-AzureADUserRegisteredDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
```

![picture 56](images/bf1cb48aee385aaeae231ad7033e9f5520d2a8a58427a84026f11de41af8c1c3.png)  

<br/>

List devices managed using Intune:

```
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
```

![picture 57](images/f7649ffe38f2a3a28313c527bc751b371be96cc5f75583c2a1362abbe359141f.png)  

<br/>

---

## AzureAD Module - Apps

Get all the application objects registered with the current tenant (visible in App Registrations in Azure portal). An application object is the global representation of an app.

```
Get-AzureADApplication -All $true
```

![picture 58](images/c40ed18bbc333313ccbcef93bb20d0d8fc9c81cf82a7175fc5f78b3256d4d4ad.png)  


<br/>

Get all details about an application:

```
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | fl *
```

![picture 59](images/1f6812b342f1d7513aaf163879287450749375d473a6e44a2fd7d2522fcf68dd.png)  


<br/>

Get an application based on the display name:

```
Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}
```

![picture 60](images/387ffde194c3ea8570cf1f77c98a63492276af7b9da60a76eedf1dfd1cb986e2.png)  

Note:
The `Get-AzureADApplicationPasswordCredential` will show the applications with an application password but password value is not shown.

<br/>

Get owner of an application:

```
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | Get-AzureADApplicationOwner | fl *
```

![picture 61](images/2004290aba10c7979310eb0ff361073cf8580528c1ab0cfa278f5e6a914f2ee5.png)  

<br/>

Get Apps where a User has a role (exact role is not shown):

```
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
```

![picture 62](images/41ebe868a18b315757caf1a7c27019ee5ef78c4061fc90d74a52d3938e790a49.png)  

<br/>

Get Apps where a Group has a role (exact role is not shown):

```
Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e | Get-AzureADGroupAppRoleAssignment | fl *
```

<br/>

---

## AzureAD Module - Service Principals

Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is the security object that has privileges. This is the 'service account'!

<br/>

Service Principals can be assigned Azure roles.

<br/>

Get all service principals:

```
Get-AzureADServicePrincipal -All $true
```

![picture 63](images/d1bf512eb1f91aadc35bc1cbc4c2c19e1e4ea8399e11dbae5ec1305f33ae26c9.png)  

<br/>

Get all details about a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | fl *
```

![picture 64](images/0a70087774f8c6dec8a47d72abe1ca5ad08f0076102752d4629761cdf830cb0b.png)  

<br/>

Get an service principal based on the display name:

```
Get-AzureADServicePrincipal -All $true | ?{ $_.DisplayName -match "app" }
```

![picture 65](images/37b0ce975dc6aa6d2f085acfe120fb3bac9e0d8858e02fa4df8f450ede131789.png)  

<br/>

Get owner of a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwner | fl *
```

<br/>

Get objects owned by a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwnedObject
```

<br/>

Get objects created by a service principal:

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalCreatedObject
```

<br/>

Get group and role memberships of a service principal

```
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalMembership | fl *
```

```
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
```

![picture 66](images/ca65af1adcc657b328c89ce5728fe6f4dc6c9b98ef4dfba98442e861005bbce0.png)  

<br/>

---

## Az PowerShell

**Az PowerShell** is a module from Microsoft for managing Azure resources. Please note that if the module is not present on your machine, you can use `Install-Module Az` command (needs internet).

> "The Azure Az PowerShell module is a rollup module. Installing it downloads the generally available Az PowerShell modules, and makes their cmdlets available for use."

<br/>

To be able to use PowerShell module, we must connect to Azure AD first:

```
Connect-AzAccount
```

<br/>

Using credentials from command line (`PSCredential` object and access tokens can be used too):

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzAccount -Credential $creds
```

<br/>

Az PowerShell can enumerate **both Azure AD and Azure Resources**.

All the Azure AD cmdlets have the format `*-AzAD*`:

```
Get-Command *azad*

Get-AzADUser
```

<br/>

Cmdlets for other Azure resources have the format `*Az*`:

```
Get-Command *azad* 

Get-AzResource
```

```
PS C:\Users\studentuser190> Get-Command *azad*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           Get-AzADServicePrincipalCredential                 3.4.0      Az.Resources
Alias           New-AzADServicePrincipalCredential                 3.4.0      Az.Resources
Alias           Remove-AzADServicePrincipalCredential              3.4.0      Az.Resources
Alias           Set-AzADApplication                                3.4.0      Az.Resources
Alias           Set-AzADServicePrincipal                           3.4.0      Az.Resources
Alias           Set-AzADUser                                       3.4.0      Az.Resources
Cmdlet          Add-AzADGroupMember                                3.4.0      Az.Resources
Cmdlet          Disable-AzAdvisorRecommendation                    1.1.1      Az.Advisor
Cmdlet          Enable-AzAdvisorRecommendation                     1.1.1      Az.Advisor
Cmdlet          Get-AzADAppCredential                              3.4.0      Az.Resources
Cmdlet          Get-AzADApplication                                3.4.0      Az.Resources
Cmdlet          Get-AzADGroup                                      3.4.0      Az.Resources
Cmdlet          Get-AzADGroupMember                                3.4.0      Az.Resources
Cmdlet          Get-AzADServicePrincipal                           3.4.0      Az.Resources
Cmdlet          Get-AzADSpCredential                               3.4.0      Az.Resources
Cmdlet          Get-AzADUser                                       3.4.0      Az.Resources
Cmdlet          Get-AzAdvisorConfiguration                         1.1.1      Az.Advisor
Cmdlet          Get-AzAdvisorRecommendation                        1.1.1      Az.Advisor
Cmdlet          New-AzADAppCredential                              3.4.0      Az.Resources
Cmdlet          New-AzADApplication                                3.4.0      Az.Resources
Cmdlet          New-AzADGroup                                      3.4.0      Az.Resources
Cmdlet          New-AzADServicePrincipal                           3.4.0      Az.Resources
Cmdlet          New-AzADSpCredential                               3.4.0      Az.Resources
Cmdlet          New-AzADUser                                       3.4.0      Az.Resources
Cmdlet          Remove-AzADAppCredential                           3.4.0      Az.Resources
Cmdlet          Remove-AzADApplication                             3.4.0      Az.Resources
Cmdlet          Remove-AzADGroup                                   3.4.0      Az.Resources
Cmdlet          Remove-AzADGroupMember                             3.4.0      Az.Resources
Cmdlet          Remove-AzADServicePrincipal                        3.4.0      Az.Resources
Cmdlet          Remove-AzADSpCredential                            3.4.0      Az.Resources
Cmdlet          Remove-AzADUser                                    3.4.0      Az.Resources
Cmdlet          Set-AzAdvisorConfiguration                         1.1.1      Az.Advisor
Cmdlet          Update-AzADApplication                             3.4.0      Az.Resources
Cmdlet          Update-AzADServicePrincipal                        3.4.0      Az.Resources
Cmdlet          Update-AzADUser                                    3.4.0      Az.Resources

```

```
PS C:\Users\studentuser190> Get-AzResource


Name              : bkpadconnect
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect
Tags              :

Name              : bkpadconnect/MicrosoftMonitoringAgent
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines/extensions
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MicrosoftMonito
                    ringAgent
Tags              :

Name              : defcorpcommon
ResourceGroupName : Finance
ResourceType      : Microsoft.Storage/storageAccounts
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Finance/providers/Microsoft.Storage/storageAccounts/defcorpcommon
Tags              :

Name              : processfile
ResourceGroupName : IT
ResourceType      : Microsoft.Web/sites
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/IT/providers/Microsoft.Web/sites/processfile
Tags              :

Name              : ResearchKeyVault
ResourceGroupName : Research
ResourceType      : Microsoft.KeyVault/vaults
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault
Tags              :

Name              : vaultfrontend
ResourceGroupName : Research
ResourceType      : Microsoft.Web/sites
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Web/sites/vaultfrontend
Tags              :

```

<br/>

Find cmdlets for a particular resource. For example, VMs:

```
Get-Command *azvm* 

Get-Command -Noun *vm* -Verb Get 

Get-Command *vm*
```

```
PS C:\Users\studentuser190> Get-Command *azvm*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           Get-AzVmssDiskEncryptionStatus                     4.10.0     Az.Compute
Alias           Get-AzVmssVMDiskEncryptionStatus                   4.10.0     Az.Compute
Alias           Invoke-AzVmAssessPatch                             4.10.0     Az.Compute
Alias           Invoke-AzVmPatchAssess                             4.10.0     Az.Compute
Alias           Repair-AzVmssServiceFabricUD                       4.10.0     Az.Compute
Cmdlet          Add-AzVMAdditionalUnattendContent                  4.10.0     Az.Compute
Cmdlet          Add-AzVMDataDisk                                   4.10.0     Az.Compute
Cmdlet          Add-AzVMNetworkInterface                           4.10.0     Az.Compute
Cmdlet          Add-AzVMSecret                                     4.10.0     Az.Compute
Cmdlet          Add-AzVmssAdditionalUnattendContent                4.10.0     Az.Compute
Cmdlet          Add-AzVmssDataDisk                                 4.10.0     Az.Compute
Cmdlet          Add-AzVmssDiagnosticsExtension                     4.10.0     Az.Compute
Cmdlet          Add-AzVmssExtension                                4.10.0     Az.Compute
Cmdlet          Add-AzVMSshPublicKey                               4.10.0     Az.Compute
Cmdlet          Add-AzVmssNetworkInterfaceConfiguration            4.10.0     Az.Compute
Cmdlet          Add-AzVmssSecret                                   4.10.0     Az.Compute
Cmdlet          Add-AzVmssSshPublicKey                             4.10.0     Az.Compute
Cmdlet          Add-AzVmssVMDataDisk                               4.10.0     Az.Compute
Cmdlet          Add-AzVmssWinRMListener                            4.10.0     Az.Compute
Cmdlet          ConvertTo-AzVMManagedDisk                          4.10.0     Az.Compute
Cmdlet          Disable-AzVMDiskEncryption                         4.10.0     Az.Compute
Cmdlet          Disable-AzVmssDiskEncryption                       4.10.0     Az.Compute
Cmdlet          Get-AzVM                                           4.10.0     Az.Compute
Cmdlet          Get-AzVMAccessExtension                            4.10.0     Az.Compute
Cmdlet          Get-AzVMADDomainExtension                          4.10.0     Az.Compute
Cmdlet          Get-AzVMAEMExtension                               4.10.0     Az.Compute
Cmdlet          Get-AzVMBootDiagnosticsData                        4.10.0     Az.Compute
Cmdlet          Get-AzVMChefExtension                              4.10.0     Az.Compute
Cmdlet          Get-AzVMCustomScriptExtension                      4.10.0     Az.Compute
Cmdlet          Get-AzVMDiagnosticsExtension                       4.10.0     Az.Compute
Cmdlet          Get-AzVMDiskEncryptionStatus                       4.10.0     Az.Compute
Cmdlet          Get-AzVMDscExtension                               4.10.0     Az.Compute
Cmdlet          Get-AzVMDscExtensionStatus                         4.10.0     Az.Compute
Cmdlet          Get-AzVMExtension                                  4.10.0     Az.Compute
Cmdlet          Get-AzVMExtensionImage                             4.10.0     Az.Compute
Cmdlet          Get-AzVMExtensionImageType                         4.10.0     Az.Compute
Cmdlet          Get-AzVMImage                                      4.10.0     Az.Compute
Cmdlet          Get-AzVMImageOffer                                 4.10.0     Az.Compute
Cmdlet          Get-AzVMImagePublisher                             4.10.0     Az.Compute
Cmdlet          Get-AzVMImageSku                                   4.10.0     Az.Compute
Cmdlet          Get-AzVMRunCommandDocument                         4.10.0     Az.Compute
Cmdlet          Get-AzVMSize                                       4.10.0     Az.Compute
Cmdlet          Get-AzVMSqlServerExtension                         4.10.0     Az.Compute
Cmdlet          Get-AzVmss                                         4.10.0     Az.Compute
Cmdlet          Get-AzVmssDiskEncryption                           4.10.0     Az.Compute
Cmdlet          Get-AzVmssRollingUpgrade                           4.10.0     Az.Compute
Cmdlet          Get-AzVmssSku                                      4.10.0     Az.Compute
Cmdlet          Get-AzVmssVM                                       4.10.0     Az.Compute
Cmdlet          Get-AzVmssVMDiskEncryption                         4.10.0     Az.Compute
Cmdlet          Get-AzVMUsage                                      4.10.0     Az.Compute
Cmdlet          Invoke-AzVmPatchAssessment                         4.10.0     Az.Compute
Cmdlet          Invoke-AzVMReimage                                 4.10.0     Az.Compute
Cmdlet          Invoke-AzVMRunCommand                              4.10.0     Az.Compute
Cmdlet          Invoke-AzVmssVMRunCommand                          4.10.0     Az.Compute
Cmdlet          New-AzVM                                           4.10.0     Az.Compute
Cmdlet          New-AzVMConfig                                     4.10.0     Az.Compute
Cmdlet          New-AzVMDataDisk                                   4.10.0     Az.Compute
Cmdlet          New-AzVMSqlServerAutoBackupConfig                  4.10.0     Az.Compute
Cmdlet          New-AzVMSqlServerAutoPatchingConfig                4.10.0     Az.Compute
Cmdlet          New-AzVMSqlServerKeyVaultCredentialConfig          4.10.0     Az.Compute
Cmdlet          New-AzVmss                                         4.10.0     Az.Compute
Cmdlet          New-AzVmssConfig                                   4.10.0     Az.Compute
Cmdlet          New-AzVmssIpConfig                                 4.10.0     Az.Compute
Cmdlet          New-AzVmssIpTagConfig                              4.10.0     Az.Compute
Cmdlet          New-AzVmssVaultCertificateConfig                   4.10.0     Az.Compute
Cmdlet          Publish-AzVMDscConfiguration                       4.10.0     Az.Compute
Cmdlet          Remove-AzVM                                        4.10.0     Az.Compute
Cmdlet          Remove-AzVMAccessExtension                         4.10.0     Az.Compute
Cmdlet          Remove-AzVMAEMExtension                            4.10.0     Az.Compute
Cmdlet          Remove-AzVMBackup                                  4.10.0     Az.Compute
Cmdlet          Remove-AzVMChefExtension                           4.10.0     Az.Compute
Cmdlet          Remove-AzVMCustomScriptExtension                   4.10.0     Az.Compute
Cmdlet          Remove-AzVMDataDisk                                4.10.0     Az.Compute
Cmdlet          Remove-AzVMDiagnosticsExtension                    4.10.0     Az.Compute
Cmdlet          Remove-AzVMDiskEncryptionExtension                 4.10.0     Az.Compute
Cmdlet          Remove-AzVMDscExtension                            4.10.0     Az.Compute
Cmdlet          Remove-AzVMExtension                               4.10.0     Az.Compute
Cmdlet          Remove-AzVMNetworkInterface                        4.10.0     Az.Compute
Cmdlet          Remove-AzVMSecret                                  4.10.0     Az.Compute
Cmdlet          Remove-AzVMSqlServerExtension                      4.10.0     Az.Compute
Cmdlet          Remove-AzVmss                                      4.10.0     Az.Compute
Cmdlet          Remove-AzVmssDataDisk                              4.10.0     Az.Compute
Cmdlet          Remove-AzVmssDiagnosticsExtension                  4.10.0     Az.Compute
Cmdlet          Remove-AzVmssExtension                             4.10.0     Az.Compute
Cmdlet          Remove-AzVmssNetworkInterfaceConfiguration         4.10.0     Az.Compute
Cmdlet          Remove-AzVmssVMDataDisk                            4.10.0     Az.Compute
Cmdlet          Repair-AzVmssServiceFabricUpdateDomain             4.10.0     Az.Compute
Cmdlet          Restart-AzVM                                       4.10.0     Az.Compute
Cmdlet          Restart-AzVmss                                     4.10.0     Az.Compute
Cmdlet          Save-AzVMImage                                     4.10.0     Az.Compute
Cmdlet          Set-AzVM                                           4.10.0     Az.Compute
Cmdlet          Set-AzVMAccessExtension                            4.10.0     Az.Compute
Cmdlet          Set-AzVMADDomainExtension                          4.10.0     Az.Compute
Cmdlet          Set-AzVMAEMExtension                               4.10.0     Az.Compute
Cmdlet          Set-AzVMBackupExtension                            4.10.0     Az.Compute
Cmdlet          Set-AzVMBginfoExtension                            4.10.0     Az.Compute
Cmdlet          Set-AzVMBootDiagnostic                             4.10.0     Az.Compute
Cmdlet          Set-AzVMChefExtension                              4.10.0     Az.Compute
Cmdlet          Set-AzVMCustomScriptExtension                      4.10.0     Az.Compute
Cmdlet          Set-AzVMDataDisk                                   4.10.0     Az.Compute
Cmdlet          Set-AzVMDiagnosticsExtension                       4.10.0     Az.Compute
Cmdlet          Set-AzVMDiskEncryptionExtension                    4.10.0     Az.Compute
Cmdlet          Set-AzVMDscExtension                               4.10.0     Az.Compute
Cmdlet          Set-AzVMExtension                                  4.10.0     Az.Compute
Cmdlet          Set-AzVMOperatingSystem                            4.10.0     Az.Compute
Cmdlet          Set-AzVMOSDisk                                     4.10.0     Az.Compute
Cmdlet          Set-AzVMPlan                                       4.10.0     Az.Compute
Cmdlet          Set-AzVMSourceImage                                4.10.0     Az.Compute
Cmdlet          Set-AzVMSqlServerExtension                         4.10.0     Az.Compute
Cmdlet          Set-AzVmss                                         4.10.0     Az.Compute
Cmdlet          Set-AzVmssBootDiagnostic                           4.10.0     Az.Compute
Cmdlet          Set-AzVmssDiskEncryptionExtension                  4.10.0     Az.Compute
Cmdlet          Set-AzVmssOrchestrationServiceState                4.10.0     Az.Compute
Cmdlet          Set-AzVmssOsProfile                                4.10.0     Az.Compute
Cmdlet          Set-AzVmssRollingUpgradePolicy                     4.10.0     Az.Compute
Cmdlet          Set-AzVmssStorageProfile                           4.10.0     Az.Compute
Cmdlet          Set-AzVmssVM                                       4.10.0     Az.Compute
Cmdlet          Start-AzVM                                         4.10.0     Az.Compute
Cmdlet          Start-AzVmss                                       4.10.0     Az.Compute
Cmdlet          Start-AzVmssRollingExtensionUpgrade                4.10.0     Az.Compute
Cmdlet          Start-AzVmssRollingOSUpgrade                       4.10.0     Az.Compute
Cmdlet          Stop-AzVM                                          4.10.0     Az.Compute
Cmdlet          Stop-AzVmss                                        4.10.0     Az.Compute
Cmdlet          Stop-AzVmssRollingUpgrade                          4.10.0     Az.Compute
Cmdlet          Test-AzVMAEMExtension                              4.10.0     Az.Compute
Cmdlet          Update-AzVM                                        4.10.0     Az.Compute
Cmdlet          Update-AzVmss                                      4.10.0     Az.Compute
Cmdlet          Update-AzVmssInstance                              4.10.0     Az.Compute
Cmdlet          Update-AzVmssVM                                    4.10.0     Az.Compute
```

<br/>

Get the information about the current context (Account, Tenant, Subscription etc.):

```
Get-AzContext | fl *
```

![picture 77](images/1908e8a0fb9e6ca59f5e319b3ac0a9dca2cba63ebb23250ce8992502dff59b6a.png)  


<br/>

List all available contexts:

```
Get-AzContext -ListAvailable | fl *
```

<br/>

Enumerate subscriptions accessible by the current user 

```
Get-AzSubscription | fl *
```

![picture 78](images/58986481d854be2f2b5d374aebd4e5010cf474f72a829c96b987bf6cd5c10db6.png)  


<br/>

Enumerate all resources visible to the current user 

```
Get-AzResource | Select Name, ResourceGroupName, ResourceType
```

![picture 79](images/cd36ab8dd39e30bb9661b6561539a6d833007d26146ff694d419352f87868ae8.png)  


<br/>

Enumerate all Azure RBAC role assignments 

```
Get-AzRoleAssignment | ft DisplayName, RoleDefinitionName, ObjectType, CanDelegate
```

![picture 80](images/87120d37187159d8561f23bd4aff3e5cf591822e39a88c0cd97375c4cb1f1f37.png)  

<br/>

---

## Az Powershell - AAD Users

Enumerate all users 

```
Get-AzADUser | Select UserPrincipalName, ObjectType, Accountenabled, Type
```

![picture 81](images/e6a51331a95b233bf3c3419c96f4ac07efbc08d7612a5a12e3af96d1e891cb95.png)  


<br/>


Enumerate a specific user:

```
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
```

![picture 82](images/e6d0228c292af3b39be8433837cb04621db40cee8fe8bbe32a282086fbf05933.png)  


<br/>

Search for a user based on string in first characters of DisplayName (wildcard not supported) 

```
Get-AzADUser -SearchString "admin"
```

![picture 83](images/fae3d038184a55bfcaac88c27ba46685db084f71b4855089c07468afa8393102.png)  


<br/>

Search for users who contain the word "admin" in their Display name: 

```
Get-AzADUser | ?{$_.Displayname -match "admin"}
```

![picture 84](images/637a5aef8eccb9f13a9ab10f7cba11a0b2dfb2366bb9d46139432bc2cef5ea1e.png)  

<br/>

---

## Az PowerShell - AAD Groups

List all groups:

```
Get-AzADGroup | ft SecurityEnabled, DisplayName, Description, Type
```

![picture 85](images/ad29efccbdc2d8ce6368848f804b180fed732f99984aed23eb12b60585fe1b54.png)  

<br/>

Enumerate a specific group:

```
Get-AzADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

![picture 86](images/28ba0934cf7bb3a5119c93605a8fddd68d19bab9e07a8bfc286a6e673969503d.png)  

<br/>

Search for a group based on string in first characters of DisplayName (wildcard not supported):

```
Get-AzADGroup -SearchString "admin" | fl *
```

<br/>

To search for groups which contain the word "admin" in their name: 

```
Get-AzADGroup |?{$_.Displayname -match "admin"}
```

![picture 87](images/b963dbe52a169ccd9500ea01cd8d33168a2e2143b1235ba7135215a59c29a596.png)  

<br/>

Get members of a group:

```
Get-AzADGroupMember -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e
```

<br/>

---

## Az PowerShell - AAD Apps

Get all the application objects registered with the current tenant (visible in App Registrations in Azure portal). An application object is the global representation of an app. 

```
Get-AzADApplication | Select DisplayName, ObjectId, AvailableToOtherTenants
```

![picture 88](images/17ded152da2ef1c6b6540de4500c163397e85505e409a9a8e076083d1e977fa1.png)  

<br/>

Get all details about an application:

```
Get-AzADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0
```

![picture 89](images/a1d634b4338fe8bdcb1bf6ab853beeb2f8039991210c60a5b395b891a09395d2.png)  

<br/>

Get an application based on the display name:

```
Get-AzADApplication | ?{$_.DisplayName -match "app"}
```

The `Get-AzADAppCredential` will show the applications with an application password but password value is not shown.

<br/>

---

## Az PowerShell - ADD Service Principals

Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is the security object that has privileges. This is the 'service account'!

Service Principals can be assigned Azure roles.

<br/>

Get all service principals:

```
Get-AzADServicePrincipal | Select DisplayName, Id
```

![picture 90](images/9b45a34214f9fafe2c33c8d3ff017e7d3727bca6ca435fdb93882e559ae95130.png)  

<br/>

Get all details about a service principal:

```
Get-AzADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45053e7c37a264
```

<br/>

Get an service principal based on the display name:

```
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
```

<br/>

