# 07 - Automation Account

- [07 - Automation Account](#07---automation-account)
  - [Automation Account](#automation-account)
  - [Run as Account](#run-as-account)
  - [Runbook](#runbook)
  - [Hybrid Worker](#hybrid-worker)
  - [Privilege Escalation - Automation Account](#privilege-escalation---automation-account)

---

## Automation Account

Azure's automation service that allows to automate tasks for Azure resources, on-prem infra and other cloud providers.

It supports:
- Process Automation using Runbooks
- Configuration Management (supports DSC)
- update management
- shared resources (credentials, certificates, connections etc) for both Windows and Linux resources hosted on Azure and on-prem.

<br/>

Some common scenarios for automation as per Microsoft:
- Deploy VMs across a hybrid environment using run books.
- Identify configuration changes
- Configure VMs
- Retrieve Inventory

<br/>

## Run as Account

**Run As Account** is used to provide authentication for managing Azure resources. It is created by default when an automation account is created. Possible to create it later too.

When a **Run As account** is created, it creates an Azure AD application with self-signed certificate, creates a **service principal** and assigns the **Contributor role** for the account in the current subscription.

- Contributor.on.the.entire.subscription!

The **Run As account** can only be used from inside a Runbook, so Contributor on a Runbook = profit!

<br/>

## Runbook

Runbook contains the automation logic and code that you want to execute.

Azure provides both Graphical and Textual (PowerShell, PowerShell Workflow and Python) Runbooks. You can use the Shared Resources (credentials, certificates, connections etc) and **the privileges of the Run As account from a Runbook**.

<br/>

**Always checkout Runbooks! They often have credentials that are not stored in the shared resources.**

<br/>

By default, only signed script can be run on a VM. 

Runbooks can run in Azure Sandbox or a Hybrid Runbook Worker.

<br/>

## Hybrid Worker

This is used when a Runbook is to be run on a non-azure machine. 

A user-defined hybrid runbook worker is a member of hybrid runbook worker group.

The **Log Analytics Agent** is deployed on the VM to register it as a hybrid worker.

The hybrid worker jobs **run as SYSTEM** on Windows and **nxautomation account** on Linux.

<br/>

## Privilege Escalation - Automation Account

Automation Account comes very handy in privilege escalation.

**Run As account** is by default **contributor** on the current subscription and **possible to have contributor permissions on other subscriptions** in the tenant. 

Often, **clear-text privileges** can be found in Runbooks. For example, a PowerShell runbook may have admin credentials for a VM to use PSRemoting.

We may abuse runbook to:
- access to connections, key vaults from a runbook. 
- be able to run commands on on-prem VMs if hybrid workers are in use.
- be able to run commands on VMs using DSC in configuration management.

<br/>

