# 15 - Azure Security

- [15 - Azure Security](#15---azure-security)
  - [Azure Security](#azure-security)
  - [Azure Security - Operations](#azure-security---operations)
  - [Azure Security - Opeations - Security Center](#azure-security---opeations---security-center)
  - [Azure Security - Operations - Security CenterSecure Score](#azure-security---operations---security-centersecure-score)
  - [Azure Security - Operations - Security Center - Azure Defender](#azure-security---operations---security-center---azure-defender)
  - [Azure Security - Operations - Security Center - Azure Defender Adaptive Application Controls](#azure-security---operations---security-center---azure-defender-adaptive-application-controls)
  - [Azure Security - Operations - Security Center - Azure Defender Just-in-time (JIT) VM Access](#azure-security---operations---security-center---azure-defender-just-in-time-jit-vm-access)
  - [Azure Security - Operations - Security Center - Azure Defender File Integrity Monitoring](#azure-security---operations---security-center---azure-defender-file-integrity-monitoring)
  - [Azure Security - Operations - Security Center - Azure Defender Adaptive Network Hardening (ANH)](#azure-security---operations---security-center---azure-defender-adaptive-network-hardening-anh)
  - [Azure Security - Operations - Monitor](#azure-security---operations---monitor)
  - [Azure Security - Identity and Access Management](#azure-security---identity-and-access-management)
  - [Azure Security - Identity and Access Management - MFA](#azure-security---identity-and-access-management---mfa)
  - [Azure Security - Identity and Access Management Security - Defaults](#azure-security---identity-and-access-management-security---defaults)
  - [Azure Security - Identity and Access Management - Conditional Access](#azure-security---identity-and-access-management---conditional-access)
  - [Azure Security - Identity and Access Management - Conditional Access - Policy - Assignments](#azure-security---identity-and-access-management---conditional-access---policy---assignments)
  - [Azure Security - Identity and Access Management-  Conditional Access - Policy - Access Controls](#azure-security---identity-and-access-management---conditional-access---policy---access-controls)
  - [Azure Security - Identity and Access Management - Conditional Access - Policy - Session Control](#azure-security---identity-and-access-management---conditional-access---policy---session-control)
  - [Azure Security - Identity and Access Management - Privileged Identity Management (PIM)](#azure-security---identity-and-access-management---privileged-identity-management-pim)
  - [Azure Security - Identity and Access Management - PIM - Azure AD Roles](#azure-security---identity-and-access-management---pim---azure-ad-roles)
  - [Azure Security - Identity and Access Management - PIM - Azure AD Roles - Alerts](#azure-security---identity-and-access-management---pim---azure-ad-roles---alerts)
  - [Azure Security - Identity and Access Management - PIM - Azure AD Roles - Access Review](#azure-security---identity-and-access-management---pim---azure-ad-roles---access-review)
  - [Azure Security - Identity and Access Management - PIM - Azure Resources - Alerts](#azure-security---identity-and-access-management---pim---azure-resources---alerts)
  - [Azure Security - Identity and Access Management - Azure AD Identity Protection](#azure-security---identity-and-access-management---azure-ad-identity-protection)
    - [User Risks](#user-risks)
    - [Sign-in Risks](#sign-in-risks)
  - [Azure Security - Identity and Access Management - Azure AD Identity Protection - Report](#azure-security---identity-and-access-management---azure-ad-identity-protection---report)
  - [Azure Security - Identity and Access Management - Azure AD Identity Protection - Protect](#azure-security---identity-and-access-management---azure-ad-identity-protection---protect)
  - [Azure Security - Microsoft 365 Defender](#azure-security---microsoft-365-defender)
  - [Azure Security - Azure Sentinel](#azure-security---azure-sentinel)

---

## Azure Security

In any enterprise environment, one of the most important aspects of security is visibility.

We cannot protect what we can't see! Fortunately, Azure provides enough visibility of Azure AD and Azure resources to apply security controls on them. However, this usually comes with considerable additional costs.

A large portion of discussion in the defense section is around Microsoft products.

<br/>

As per Microsoft, there are six functional areas for built-in Azure security capabilities:

- Operations
- Identity
- Applications
- Storage
- Networking
- Compute

<br/>

---

## Azure Security - Operations

• Azure Security Center – Unified infrastructure security management
• Azure Resource Manager – Allows secure, repeatable template-based deployment
• Application Insights – Analytics for applications
• Azure Monitor – Monitor Azure AD and Azure resources logs
• Azure Monitor logs – Monitor on-prem and other cloud logs
• Azure Advisor – Provides security, performance and reliability recommendations

<br/>

## Azure Security - Opeations - Security Center

• **Azure Security Center** provides a unified security management. 

• Azure resources are automatically provisioned in the Security Center. On-prem servers need to be on-boarded using Log analytics agents.

• Security Center provides – Resource security hygiene using secure score – Automatic recommendation to improve security posture – Asset inventory

• Security Center has no additional cost and provides what Microsoft calls Cloud Security Posture Management (CSPM)

<br/>

## Azure Security - Operations - Security CenterSecure Score

Secure score reviews security recommendations and provides an overall measure of the security posture.

Secure score by category shows the resources which need most attention.

You can improve your secure score by addressing all the recommendations in a control in the 'Recommendations' section.

Secure score is calculated once per day and it may take up to 48 hours for the changes to reflect in the score.

<br/>

## Azure Security - Operations - Security Center - Azure Defender

Azure Defender (previously Advanced Cloud Defense) is the pay-per-resource part of the security center.

Provides the Cloud Workload Protection (CWP) for Azure resources.

There are 'Defender plans' and alerts for Azure resources. Some of the interesting ones:

- **VMs** - Defender for Endpoint, Vulnerability scanning, Just-in-time access for management ports, File Integrity monitoring, Adaptive application controls (application allowlist).
- **App Service** - Web app vulnerabilities detection, monitoring of the VM where app service is running (consumption plan is not supported).
- **Storage** - Suspicious access and activities, upload of malicious content.
- **Key vault** - Suspicious access and activities.
- **Resource Manager** - Suspicious access, lateral movement from management plane to data plane.

<br/>

## Azure Security - Operations - Security Center - Azure Defender Adaptive Application Controls

**Adaptive application controls** allows enforcing application allow list (allow only specific applications to run) on Azure and non-Azure machines.

Only Audit mode is supported.

There is a learning period of two weeks before recommendations are shown for a VM.

It uses Applocker on Windows machines to enforce the recommendations. If Applocker is already configured on a VM, no recommendations are made.

<br/>

## Azure Security - Operations - Security Center - Azure Defender Just-in-time (JIT) VM Access

**Just-in-time (JIT)** VM allows securing the management ports of a VM against brute-force attacks and unauthorized network access. This protection is achieved by blocking the incoming traffic on the management ports for a configured VM and allowing access on per request basis for a limited time and from a limited IP or network range.

When a user requests access to a VM, security center checks the **roles (RBAC)** assigned to the user in subscription or relevant resource group. If the user has the required permissions, NSGs (and Azure firewall, if in use) are automatically modified to allow access.

By-default, 4 management ports (22, 3389, 5985 and 5986) are protected. More can be added

<br/>

A user needs to following role assignments on the subscription or the resource group associated with the VM to be able to request access:

- `Microsoft.Security/locations/jitNetworkAccessPolicies/initiate/action`
- `Microsoft.Security/locations/jitNetworkAccessPolicies/read`
- `Microsoft.Compute/virtualMachines/read`
- `Microsoft.Network/networkInterfaces/*/read`

A user with these role assignments can go the 'Connect' blade of the virtual machine and request access. Once the request is approved a time-bound allowed rule is added to the NSG (and Azure firewall, if in use) to allow the inbound access.

<br/>

## Azure Security - Operations - Security Center - Azure Defender File Integrity Monitoring

**File integrity monitoring (FIM)** examines files, registries and applications for changes to detect attacks. It checks if the current checksum of a file is different from the last scan. 

FIM supports Windows and Linux and by default monitors well known files and registry keys according to known attack patterns.

Once FIM is enabled, it is possible to add custom Registry keys, Windows files and Linux files (wildcard supported for tracking multiple files) and File content in the monitor list.

<br/>

## Azure Security - Operations - Security Center - Azure Defender Adaptive Network Hardening (ANH)

Adaptive network hardening helps in further hardening the network security groups (NSG).

If a NSG allows traffic from a fixed source subnet (say, 132.21.45.61/24), adaptive network hardening learns where the actual traffic comes from and recommends using the smaller set of IP addresses (132.21.45.61/29) which should be allowed to access the VMs.

Only VMs deployed through **Azure resource manager** are supported and 30 days of traffic is required for learning!

This feature supports only limited set of ports. (See slide notes).

<br/>

## Azure Security - Operations - Monitor

Azure Monitor collects data from Azure subscriptions and resources. We can see the logs in individual resources (under the Monitoring tab) and by going to the Monitor service in Azure portal.

Useful for monitoring, querying and analysing logs from multiple sources (Applications, OS, Tenant, Subscriptions, Resources) at one place. Queries are written in the Kusto Query Language (KQL).

<br/>

---

## Azure Security - Identity and Access Management

Protecting Identity is at the centre of Azure! Following controls are available for that.

Security identity:

- MFA 
- Microsoft Authenticator 
- Password policy enforcement
- Token-based authentication 
- Azure RBAC 
- Hybrid Identity

Secure Apps and data using Azure AD

- Cloud Apps Discovery 
- Identity Protection 
- Azure Active Directory Domain Services 
- Application Proxy

<br/>

## Azure Security - Identity and Access Management - MFA

MFA means, for authentication use two or more from the below:

- What do you know (e.g. password)
- What do you have (e.g. OTP, Temp PIN, Compliant device)
- Who do are (e.g. biometrics)

It is recommended to enable MFA for all the users in Azure AD except the break glass/emergency users.

<br/>

Following options are available for enabling MFA:

1. Security Defaults (All users must start using it within 14 days of first sign-in)
2. By changing user state (Users blade in Azure Active Directory)
3. Using Conditional Access Policy for more granular control

- With user risk and sign-in risk input from Azure Identity Protection
- With conditions like sign-in location, device trusts etc

<br/>

## Azure Security - Identity and Access Management Security - Defaults

There used to be Baseline Protection Policies (deprecated 29th February 2020). Instead of that, we can use Security Defaults for some preconfigured policies which are useful for most organizations. It is available under the Properties blade of an Azure AD as 'Manage Security Defaults'.

If Conditional Access policies are defined, we can't use Security Defaults.

Available without additional licensing.

Following policies are pushed by Security Defaults:

1. All users in the tenant must register for MFA within 14 days of their first sign-in.
2. Some Administrator roles always need MFA 
3. Privileged actions for Azure Resource Manager using Azure Portal, PowerShell or CLI needs additional authentication
4. Blocking Legacy Authentication (used by older office clients and mail protocols)

<br/>

## Azure Security - Identity and Access Management - Conditional Access

Conditional Access uses Signals to make Decisions and Enforce policies.

- *"Conditional Access policies at their simplest are if-then statements, if a user wants to access a resource, then they must complete an action."*
- For example, to access a resource a user is required to perform multi-factor authentication.

Conditional Access allows automated access control decisions based on predefined conditions. When creating a policy we can set it Report-only which is an audit mode (logs visible in Directory Sign-ins - check Conditional Access column).

Policies are enforced post-authentication! 

Azure Premium P1 license is required.

<br/>

![picture 218](images/9a9d334e3535e30a72c0f152070f5a9406300a66aa3377190d117f9bdf92a866.png)  

<br/>

## Azure Security - Identity and Access Management - Conditional Access - Policy - Assignments

The assignments portion covers the signals required for a policy:

1. Users, Groups or Roles who the policy includes or excludes. 
2. Cloud apps or other registered apps 
3. Conditions

- Sign-in risk 
- Device platform 
- Location 
- Client app - browser, mobile etc., device state - (managed or unmanaged)

<br/>

## Azure Security - Identity and Access Management-  Conditional Access - Policy - Access Controls

The access controls portion controls how policy is enforced. 

Grant (for Blocking or Granting access)

- Block
- Grant access - Use to enforce one or more of the following controls:

  - Require MFA 
  - Require device to be marked compliant 
  - Require Hybrid Azure AD joined device 
  - Require approved client app - An access attempt to the selected cloud apps needs to be made from an approved client app
  - Require app protection policy 
  - Intune app protection policy must be present on the client app before access is available to the selected cloud apps

<br/>

## Azure Security - Identity and Access Management - Conditional Access - Policy - Session Control

Session control is used to limit the experience:

1. App enforced restrictions - Currently only supported apps are exchange online, Office 365 and SharePoint online.
2. Condition access app control - Uses Microsoft Cloud App Security (MCAS) to enforce:

- Monitor Only
- Block downloads
- Custom Policies from MCAS are also supported

<br/>

## Azure Security - Identity and Access Management - Privileged Identity Management (PIM)

Using PIM, we can control access to resources in AAD, Azure resources and Office 365. 

PIM requires **Azure AD Premium P2 license** or **Enterprise Mobility + Security (EMS) E5** or **Microsoft 365 M5**

Compromise of high privilege users is a continuous risk. We can use PIM to:

- List administrators 
- Just-In-Time (JIT) and time bound administrative access (thus reducing the number of administrators)
- Force multi-factor-authentication (MFA) 
- Approval workflows for high privileges to Azure AD, Privileged access groups and Azure resources 
- Access Reviews 
- Reporting and Alerting for privileged roles

<br/>

## Azure Security - Identity and Access Management - PIM - Azure AD Roles

In PIM a user may have assignment type eligible or active for a role.

- Eligible means a user can activate the role for performing privileged tasks. It needs a user to perform some actions (like MFA check, request approval etc.) to use the role.
- Active means a user can use the role without doing anything else.

<br/>

This is how PIM works for users eligible for privileged roles:

1. When an eligible users want to use their privileged role, they can activate the role just-in-time.
2. For activating the role, they complete pre-defined steps like MFA, approval, specifying a reason etc.
3. After completing the steps, the user gets the role for a limited preconfigured time (time-bound).
4. Audit logs (Resource audit) captures all the activities

<br/>

## Azure Security - Identity and Access Management - PIM - Azure AD Roles - Alerts

There are seven built-in alerts to spot common misconfiguration of roles. All the alerts are enabled by-default and can be disabled individually.

If an alert is active, we can look at its details by clicking on it.

| **Alert** | **Risk Level** |
| --- | --- |
| The organization doesn't have Azure AD Premium P2 | High |
| Roles don't require multi-factor authentication for activation | Medium |
| Administrators aren't using their privileged roles | Low |
| Roles are being assigned outside of Privileged Identity Management | High |
| Roles are being activated too frequently | Medium |
| Potential stale accounts in a privileged role | Medium |
| There are too many global administrators | Low |

<br/>

## Azure Security - Identity and Access Management - PIM - Azure AD Roles - Access Review

We can run access reviews on Azure AD roles to make sure that continued access rests with only the correct set of people.

We can create Access Review from the Access Reviews blade of PIM. 

Access reviews can be one time or continuous.

<br/>

## Azure Security - Identity and Access Management - PIM - Azure Resources - Alerts

For Azure resources managed using PIM, there are three Alerts. If an alert is active, we can look at its details by clicking on it.

| **Alert** | **Risk Level** |
| --- | --- |
| Too many owners assigned to a resource | Medium |
| Too many permanent owners assigned to a resource | Medium |
| Duplicate role created | Medium |

<br/>

## Azure Security - Identity and Access Management - Azure AD Identity Protection

Azure AD identity Protection provides risk detection and automated actions for securing identities. 

Full features of Azure AD Identity Protection needs **Azure AD Premium P2**.

There are two types of risks:
1. User risks
2. Sign-in risks

For each of the above, there are two types of detections:

1. Real time (5-10 mins)
2. Offline (2-24 hours)

The user and sign-in risks can be used with Conditional Access policies too.

Measures the security posture using Identity Secure Score (updated every 48 hours)Measures the security posture using Identity Secure Score (updated every 48 hours)

<br/>

### User Risks

| **Risk Detection Classification** | **Description** | **Detection Type** |
| --- | --- | --- |
| Leaked Credentials | This detection indicates that Microsoft 'leaked credentials service' found a match between publicly shared leaked credentials and Azure AD user credentials. | Offline |
| Azure AD Threat Intelligence | This detection is based on anomalous user activity or activity consistent with attack patterns. | Offline |

<br/>

### Sign-in Risks

| **Risk Detection Classification** | **Description** | **Detection Type** |
| --- | --- | --- |
| Anonymous IP address | This detection means sign-in from anonymous IP address (like Tor) | Real-time |
| Atypical Travel | This detections checks if a user signed-in from two locations which are geographically distant and the user does not typically travel to one of the locations. The time required to travel between two locations is also considered as one of the factors. There is a learning period of 14 days or 10 logins to learn user behaviour. | Offline |
| Malware Linked IP address | This detects sign-in from IP addresses infected with a malware which is known to connect to a bot server | Offline |
| Admin confirmed user compromised | When an admin has marked 'Confirm user compromised' in the Risky uses blade in Azure Portal | Offline |
| Malicious IP address | Sign-in from a from an IP address with high login failure rates | Offline |
| Unfamiliar sign-in properties | This detections considers user sign-in history (location, IP etc.) and triggers on anomalous sign-ins (for example, sing-in from new location). There is a minimum learning period of five days. | Real time |
| Suspicious inbox manipulation rules | Discovered by Microsoft Cloud App Security (MCAS), this detections triggers alerts when suspicious rules are set on an inbox. | Offline |
| Impossible travel | Discovered by MCAS, similar to atypical time travel | Offline |
| New Country | Discovered by MCAS, on change of country from location history | Offline |
| Activity from anonymous IP address | Discovered by MCAS, on activity from an anonymous porxy | Offline |
| Suspicious inbox forwarding | Discovered by MCAS, on suspicious rules like forwarding of all emails | Offline |

<br/>

## Azure Security - Identity and Access Management - Azure AD Identity Protection - Report

We can check the Report blade for various detections and summary of individual detection. Details for individual entries can be seen by selecting them.

Reports are available for:

1. Risky users
2. Risky sign-ins
3. Risky detections

<br/>

## Azure Security - Identity and Access Management - Azure AD Identity Protection - Protect

We can define Policies under the Protect blade to create automated actions and remediation.

There are three default policies to select from with possibility of excluding users.

For both the User risk and sign-in risk policies, it is possible to:

1. Apply policy on all users or specific users and groups 
2. Set Condition based on risk severity
3. Configure control to be enforced - Block access, Allow access or Allow access with password change.

<br/>

---

## Azure Security - Microsoft 365 Defender

Note:
"Microsoft 365 Defender is a unified pre- and post-breach enterprise defense suite that natively coordinates detection, prevention, investigation, and response across endpoints, identities, email, and applications to provide integrated protection against sophisticated attacks."

Available at https://security.microsoft.com/

Provides a unified portal for Defender for Endpoint, Defender for Office 365, Defender for Identity, Azure AD Identity protection and Microsoft Cloud App security.

Measures security posture using Microsoft Secure Score.

<br/>

---

## Azure Security - Azure Sentinel

A "cloud-native" security information even management (SIEM) and security orchestration automated response (SOAR). 

Sentinel can collect data from multiple sources (including Microsoft 35 Defender) including non-Microsoft resources using connectors.

Data monitoring is done using Workbooks.

Additional capabilities include:

1. Analytics - Used to correlate alerts to incidents. 
2. Automation of common tasks. For example, creation of tickets. 
3. Hunting - Using built-in or custom queries hunt for possible threats 
4. Investigate incidents 
5. Entity behavior

<br/>

