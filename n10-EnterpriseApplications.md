# 10 - Enterprise Applications

- [10 - Enterprise Applications](#10---enterprise-applications)
  - [Enterprise Application](#enterprise-application)
  - [Client Secrets](#client-secrets)
  - [Abusing Client Secrets](#abusing-client-secrets)
  - [Azure Resource Manager (ARM) Tempaltes](#azure-resource-manager-arm-tempaltes)
  - [ARM Template History](#arm-template-history)

----

## Enterprise Application

Any application registered in Azure AD has two representations:

1. **Application object** that is present only in the tenant where app is registered. This is visible under `App Registrations` in the Azure portal.
2. **Service Principal** that is present in every directory where application is used (in case of a multi-tenant application). This is visible under `Enterprise Applications` in the Azure portal. **Azure RBAC roles use service principal.**

<br/>

Note:
"An application has one application object in its home directory that is referenced by one or more service principals in each of the directories where it operates (including the application's home directory)"

<br/>

## Client Secrets

**Client Secrets** is an application object supports multiple client secrets (application passwords). 

A user that is owner or have application administrator role over an application can add an application password.

An application password can be used to login to a tenant as a service principal. MFA is usually not applied on a service principal!

<br/>

## Abusing Client Secrets

If we can compromise a user that has enough permissions to create a client secret/application password for an application object, we can:

1. Login as the service principal for that application
2. Bypass MFA
3. Access all the resources where roles are assigned to the service principal
4. Add credentials to an enterprise applications for persistence after compromising a tenant

<br/>

## Azure Resource Manager (ARM) Tempaltes

ARM is the 'infrastructure as code' service for Azure to deploy resources using code.

ARM templates are JSON files containing deployment configuration for Azure resources.

ARM templates also support a language called **Bicep** (in preview).

<br/>

## ARM Template History

Each resource group maintains a deployment history for up to 800 deployments. The history is automatically deleted when the count exceeds 775 deployments.

**Deployment history is a rich source of information!** 

Any user with permissions `Microsoft.Resources/deployments/read` and `Microsoft.Resources/subscriptions/resourceGroups/read` can read the deployment history.

<br/>

Useful information can be extracted from deployment history - it gives us the ability to have information about the resources that are not presently deployed but may be deployed again in future!

A deployment parameter that contains sensitive information like passwords should have '`SecureString`' type. In case of a poorly written deployment template - that uses 'String' for such a parameter - we can get password in clear-text!

![picture 127](images/48868988dde7b8b495a07f08773b581108c63622275577349eced13eb247c8ee.png)  

<br/>

