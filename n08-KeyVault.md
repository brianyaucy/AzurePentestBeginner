# 08 - Key Vault

- [08 - Key Vault](#08---key-vault)
  - [Key Vault](#key-vault)
  - [Identifier](#identifier)
  - [Key Vault Access Management](#key-vault-access-management)
  - [Key Vault Privilege Escalation](#key-vault-privilege-escalation)

---

## Key Vault

**Key Vault** is an Azure service for storing secrets like passwords, connection strings, certificates, private keys etc. 

With right permissions and access, Azure resources that support managed identities (VMs, App Service, Functions, Container etc.) can securely retrieve secrets from the key vault.

Object types available with a key vault:
- Cryptographic Keys - RSA, EC etc.
- Secrets - Passwords, connection strings 
- Certificates - Life cycle management
- Storage account keys - Key vault can manage and rotate access keys for storage accounts

<br/>

---

## Identifier

Objects in a key vault are identified using Object Identifier URL. 

The base URL is of the format : https://`{vault-name}`.vault.azure.net/`{object-type}`/`{object-name}`/`{object-version}`

- `vault-name`: is the globally unique name of the key vault
- `object-type`: can be "keys", "secrets" or "certificates"
- `object-name`: is unique name of the object within the key vault
- `object-version`: is system generated and optionally used to address a unique version of an object.

<br/>

---

## Key Vault Access Management

Access to a vault is controlled though two planes:

- **Management plane**: To manage the key vault and access policies. Only Azure role based access control (RBAC) is supported.
- **Data plane**: To manage the data (keys, secrets and certificates) in the key vault. This supports key vault access policies or Azure RBAC.

Note:
[IMPORTANT]
A role like `Contributor` that has permissions in the management place to manage access policies can get access to the secrets by modifying the access policies.

<br/>

---

## Key Vault Privilege Escalation

If we can compromise an azure resource whose managed identity can read secrets from a key vault (due to an access policy or assigned one of the capable roles or a custom role), it may be possible to gain access to more resources.

Note that it is not possible to control access to individual object types. That is, **if a user is given access to certificates in a vault, they can read all the certificates in that vault.**

Overly permissive access policies may result in access to data stored in a vault.

<br/>

| Built-in Role | Description | Can access secrets? |
| --- | --- | --- |
| Key Vault Contributor | Can manage key vaults | No |
| Key Vault Administrator | Perform all data plane operations. Cannot manage role assignment. | Yes |
| Key Vault Certificates Officer | Perform any action on certificates. Cannot manage permissions. | Yes - Certificate |
| Key Vault Crypto Officer | Perform any action on keys. Cannot manage permissions. | Yes - Keys |
| Key Vault Secrets Officer | Perform any action on secrets. Cannot manage permissions. | Yes - Secrets | 
| Key Vault Secrets User | Read secret content | Yes - Secrets |
| Key Vault Crypto Service Encryption User | Read metadata and perform wrap/unwrap operations on keys | No |
| Key Vault Crypto User | Perform cryptographic operations using keys | No |
| Key Vault Reader | Read metadata of key vaults and its certificates, keys, and secrets. | No |

<br/>

