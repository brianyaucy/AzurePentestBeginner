# 12 - AD Joined Machines

- [12 - AD Joined Machines](#12---ad-joined-machines)
  - [Azure AD Joined machines](#azure-ad-joined-machines)
  - [Primary Refresh Token (PRT)](#primary-refresh-token-prt)
  - [Authentication between Azure AD joined machines](#authentication-between-azure-ad-joined-machines)
  - [Lateral Movement - Azure AD joined machines](#lateral-movement---azure-ad-joined-machines)
  - [Lateral Movement - Pass-the-Certificate](#lateral-movement---pass-the-certificate)

---

## Azure AD Joined machines

An Azure AD joined machine is the one that supports an organizational Azure AD account to sign-in and is organization managed (unlike an Azure AD registered device which is for BYOD and mobile devices are lightly managed).

When a machine is joined to Azure AD, following users/roles are made a member of the local administrators group for management:

- Global Administrators
- Device Administrators
- User who joined the machine to Azure

Other Azure users can also be joined to local administrators group of Azure AD joined machines.

<br/>

## Primary Refresh Token (PRT)

Recall that refresh tokens can be used to request new access tokens for a particular application. **Primary Refresh Token (PRT)** is a special refresh token used for single sign-on (SSO)!

- It can be used to obtain access and refresh tokens to any application. 
- Issued to a user for a specific device 
- Valid for **14 days** and is **continuously renewed every 4 hours** 
- CloudAP SSP requests and caches PRT on a device 
- If PRT has MFA claims then the claim is transferred to app tokens to prevent MFA challenge for every application.

<br/>

## Authentication between Azure AD joined machines

Authentication between two Azure AD joined machines uses is based on **NegoEx (Extended Negotiation Security Mechanism)**** PKU2U (Public Key Cryptography Based User to-User Authentication)**.

In super simplified terms:

1. The machine (client) initiating the connection needs a certificate from Azure AD for a user.
2. Client creates a **JSON Web Token (JWT)** header containing PRT and other details, sign it using the **Derived key** (using the session key and the security context) and sends it to Azure AD.
3. Azure AD verifies the JWT signature using client session key and security context, checks validity of PRT and responds with the certificate.

<br/>

## Lateral Movement - Azure AD joined machines

If we compromise an Azure AD joined machine and it is possible to **extract PRT and other keys for a user**.

If the user has administrative access to other Azure AD joined machines, we can laterally move to the other machines!

We enumerated that `samcgray@defcorphq.onmicrosoft.com` joined
'jumpvm' and 'infradminsrv' devices to Azure AD so the user should be a member of local administrators on both.

We have already compromised jumpvm by resetting password of `VMContributorX`, added a local user to the VM and accessed it using PSRemoting.

<br/>

## Lateral Movement - Pass-the-Certificate

Check if jumpvm is Azure AD joined:

```
dsregcmd /status
```

<br/>

We can extract PRT, Session Key and Tenant ID from `jumpvm` using Mimikatz:

```
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap" "exit"'
```

<br/>

Extract context key and derived key:

```
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "dpapi::cloudapkd /keyvalue:<keyvalue> /unprotect" "exit"'
```

<br/>

Note that we are not considering opsec risks of using `Invoke-Mimikatz` on an Azure VM here.

<br/>

Request a certificate from Azure AD for `samcgray@defcorphq.onmicrosoft.com` using **PrtToCert**:

- https://github.com/morRubin/PrtToCert

<br/>

Use the certificate with slightly modified version of **AzureADJoinedMachinePTC** to add a user with administrative privileges on `infradminsrv`. We will use the version from `C:\AzAD\Tools` directory.

- https://github.com/morRubin/AzureADJoinedMachinePTC

<br/>

